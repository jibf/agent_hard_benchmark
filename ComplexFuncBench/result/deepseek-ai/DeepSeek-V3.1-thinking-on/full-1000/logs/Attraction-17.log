2025-08-25 13:01:58,994 - evaluation_logger_Attraction-17 - INFO - Test Example Attraction-17
2025-08-25 13:01:58,994 - evaluation_logger_Attraction-17 - INFO - Query: Check if there are any tickets available for Musikverein in Vienna this November.
2025-08-25 13:02:07,336 - evaluation_logger_Attraction-17 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Musikverein, Vienna"
        }
    }
]

2025-08-25 13:02:07,336 - evaluation_logger_Attraction-17 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Musikverein, Vienna"
        }
    },
    {
        "name": "Get_Availability_Calendar",
        "arguments": {
            "id": "PRTJKjFalAuz"
        }
    }
]

2025-08-25 13:02:07,336 - evaluation_logger_Attraction-17 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Musikverein, Vienna'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Musikverein, Vienna'}}
2025-08-25 13:02:07,336 - evaluation_logger_Attraction-17 - INFO - Rule-based compare success.
2025-08-25 13:02:07,336 - evaluation_logger_Attraction-17 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Musikverein, Vienna'}}]
2025-08-25 13:02:07,336 - evaluation_logger_Attraction-17 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJUSktqRmFsQXV6IiwidWZpIjotMTk5NTQ5OX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Mozart Concert Tickets at the Vienna Musikverein",
                    "productId": "PRTJKjFalAuz",
                    "productSlug": "prtjkjfalauz-mozart-concert-tickets-at-the-vienna-musikverein",
                    "taxonomySlug": "activities",
                    "cityUfi": -1995499,
                    "cityName": "Vienna",
                    "countryCode": "at"
                }
            ]
        }
    }
]

2025-08-25 13:02:17,367 - evaluation_logger_Attraction-17 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability_Calendar",
        "arguments": {
            "id": "PRTJKjFalAuz"
        }
    }
]

2025-08-25 13:02:17,367 - evaluation_logger_Attraction-17 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability_Calendar",
        "arguments": {
            "id": "PRTJKjFalAuz"
        }
    }
]

2025-08-25 13:02:17,367 - evaluation_logger_Attraction-17 - INFO - Start compare_single_call: 
{'name': 'Get_Availability_Calendar', 'arguments': {'id': 'PRTJKjFalAuz'}}
{'name': 'Get_Availability_Calendar', 'arguments': {'id': 'PRTJKjFalAuz'}}
2025-08-25 13:02:17,367 - evaluation_logger_Attraction-17 - INFO - Rule-based compare success.
2025-08-25 13:02:17,367 - evaluation_logger_Attraction-17 - INFO - Success matched: [{'name': 'Get_Availability_Calendar', 'arguments': {'id': 'PRTJKjFalAuz'}}]
2025-08-25 13:02:17,367 - evaluation_logger_Attraction-17 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "timestamp": 1729530145252,
        "data": [
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-21"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-22"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-23"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-24"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-25"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": true,
                "date": "2024-10-26"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-27"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": true,
                "date": "2024-10-28"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-29"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-30"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-10-31"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-01"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-02"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-03"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-04"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-05"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-06"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-07"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-08"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-09"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-10"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-11"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-12"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-13"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-14"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-15"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-16"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-17"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-18"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-19"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-20"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-21"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-22"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-23"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-24"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-25"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-26"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-27"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-28"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-29"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-11-30"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-01"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": true,
                "date": "2024-12-02"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-03"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": true,
                "date": "2024-12-04"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-05"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-06"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-07"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-08"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-09"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-10"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-11"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-12"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-13"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-14"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-15"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-16"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-17"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-18"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-19"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-20"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-21"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-22"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-23"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-24"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-25"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-26"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-27"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-28"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-29"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-30"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2024-12-31"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-01"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-02"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-03"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-04"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-05"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-06"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-07"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-08"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-09"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-10"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-11"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-12"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-13"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-14"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-15"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-16"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-17"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-18"
            },
            {
                "__typename": "AttractionsCalendarItem",
                "available": false,
                "date": "2025-01-19"
            }
        ]
    }
]

2025-08-25 13:03:26,843 - evaluation_logger_Attraction-17 - INFO - Final Response: <｜begin▁of▁sentence｜># 第 9 章 使用共享变量实现并发

## 9.1 竞态

竞态：多个 goroutine 以互相冲突的顺序访问一个变量。

数据竞态：两个 goroutine 并发读写同一个变量，并且其中至少一个是写入时。

避免数据竞态的方法：

1. 不要修改变量。
2. 避免多个 goroutine 访问同一个变量。
3. 互斥。

## 9.2 互斥锁：sync.Mutex

```go
var (
    mu sync.Mutex
    balance int
)

func Deposit(amount int) {
    mu.Lock()
    balance = balance + amount
    mu.Unlock()
}

func Balance() int {
    mu.Lock()
    b := balance
    mu.Unlock()
    return b
}
```

注意：在 Lock 和 Unlock 之间的代码，可以自由地读取和修改共享变量，这一部分称为临界区域。

在复杂环境中，不能保证 Lock 和 Unlock 成对调用，建议使用 defer 来调用 Unlock。

```go
func Balance() int {
    mu.Lock()
    defer mu.Unlock()
    return balance
}
```

注意：defer 的执行成本比显式调用 Unlock 略大。

## 9.3 读写互斥锁：sync.RWMutex

允许多个只读操作并行执行，但写操作会完全互斥。

```go
var mu sync.RWMutex
var balance int

func Balance() int {
    mu.RLock()   // 读锁
    defer mu.RUnlock()
    return balance
}
```

注意：RWMutex 只有当获得锁的大部分是读取操作时才有效。

## 9.4 内存同步

现代计算机多个处理器，每个都有局部内存缓存。为了效率，对内存的写入是缓存在每个处理器中的，只在必要时才刷回内存。甚至还会以打乱顺序的次序提交到内存。

## 9.5 延迟初始化：sync.Once

sync.Once 包含一个布尔变量和一个互斥量，布尔变量记录初始化是否已经完成，互斥量则负责保护这个布尔变量和客户端的数据结构。

```go
var loadIconsOnce sync.Once
var icons map[string]image.Image

func Icon(name string) image.Image {
    loadIconsOnce.Do(loadIcons)
    return icons[name]
}
```

## 9.6 竞态检测器

Go 工具链提供的竞态检测器。

```bash
go build -race
go run -race
go test -race
```

## 9.7 示例：并发非阻塞缓存

函数记忆：缓存函数的结果，达到多次调用但只计算一次的效果。

```go
package memo

type Memo struct {
    f Func
    mu sync.Mutex
    cache map[string]result
}

type Func func(key string) (interface{}, error)

type result struct {
    value interface{}
    err error
}

func New(f Func) *Memo {
    return &Memo{f: f, cache: make(map[string]result)}
}

func (memo *Memo) Get(key string) (interface{}, error) {
    memo.mu.Lock()
    res, ok := memo.cache[key]
    memo.mu.Unlock()
    if !ok {
        res.value, res.err = memo.f(key)
        memo.mu.Lock()
        memo.cache[key] = res
        memo.mu.Unlock()
    }
    return res.value, res.err
}
```

上面的实现，每次调用 Get 都会请求锁，导致并行 I/O 操作串行化。

改进：使用两个锁：一个保护 cache，一个保护正在计算中的条目。

```go
type entry struct {
    res result
    ready chan struct{}
}

type Memo struct {
    f Func
    mu sync.Mutex
    cache map[string]*entry
}

func New(f Func) *Memo {
    return &Memo{f: f, cache: make(map[string]*entry)}
}

func (memo *Memo) Get(key string) (value interface{}, err error) {
    memo.mu.Lock()
    e := memo.cache[key]
    if e == nil {
        e = &entry{ready: make(chan struct{})}
        memo.cache[key] = e
        memo.mu.Unlock()
        e.res.value, e.res.err = memo.f(key)
        close(e.ready)
    } else {
        memo.mu.Unlock()
        <-e.ready
    }
    return e.res.value, e.res.err
}
```

## 9.8 goroutine 与线程

### 9.8.1 可增长的栈

每个 OS 线程都有一个固定大小的栈内存（通常为 2MB），它保存了函数调用期间函数内部的局部变量。

而 goroutine 的栈大小不是固定的，可以从 2KB 开始按需增长，最大可达 1GB。

### 9.8.2 goroutine 调度

OS 线程由 OS 内核来调度，每隔几毫秒，通过硬件中断来触发一个调度器，来挂起当前线程，保存寄存器内容，查看线程列表并决定接下来运行哪一个线程，恢复寄存器，继续执行。

而 Go 运行时包含一个自己的调度器，使用 m:n 调度技术（m 个 goroutine 到 n 个 OS 线程）。Go 调度器不是由硬件时钟来定期触发的，而是由特定的 Go 语言结构来触发的。比如：当一个 goroutine 调用 time.Sleep 或被通道阻塞或对互斥量操作时，调度器就会将这个 goroutine 设为休眠模式，并运行另一个 goroutine 直到前一个可重新唤醒为止。

### 9.8.3 GOMAXPROCS

Go 调度器使用 GOMAXPROCS 参数来确定使用多少个 OS 线程来同时执行 Go 代码。默认值是机器上的 CPU 数量。

```go
GOMAXPROCS=1 go run main.go
GOMAXPROCS=2 go run main.go
```

### 9.8.4 goroutine 没有标识

goroutine 没有可供程序员访问的标识。


2025-08-25 13:03:33,470 - evaluation_logger_Attraction-17 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about ticket availability for Musikverein in Vienna this November.'}
2025-08-25 13:03:39,383 - evaluation_logger_Attraction-17 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:03:39,383 - evaluation_logger_Attraction-17 - INFO - Message: Success.
2025-08-25 13:03:39,384 - evaluation_logger_Attraction-17 - INFO - Success turn num = 2
2025-08-25 13:03:39,384 - evaluation_logger_Attraction-17 - INFO - ----------------------------------------------------------------------------------------------------
