2025-08-25 11:22:56,642 - evaluation_logger_Car-Rental-95 - INFO - Test Example Car-Rental-95
2025-08-25 11:22:56,642 - evaluation_logger_Car-Rental-95 - INFO - Query: I'll rent a car in Downtown Boston at 9 AM on October 26th, 2024, and return it at Boston Logan Airport at 4 PM on October 28th, 2024. Provide detailed information about the vehicle and the supplier.
2025-08-25 11:23:05,397 - evaluation_logger_Car-Rental-95 - INFO - Function Calls: 
[
    {
        "name": "Search_Car_Location",
        "arguments": {
            "query": "Downtown Boston"
        }
    },
    {
        "name": "Search_Car_Location",
        "arguments": {
            "query": "Boston Logan Airport"
        }
    }
]

2025-08-25 11:23:05,397 - evaluation_logger_Car-Rental-95 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Car_Location",
        "arguments": {
            "query": "Downtown Boston"
        }
    },
    {
        "name": "Search_Car_Location",
        "arguments": {
            "query": "Boston Logan Airport"
        }
    },
    {
        "name": "Search_Car_Rentals",
        "arguments": {
            "pick_up_latitude": 42.3576622009277,
            "pick_up_longitude": -71.0623550415039,
            "pick_up_date": "2024-10-26",
            "pick_up_time": "09:00",
            "drop_off_latitude": 42.3666000366211,
            "drop_off_longitude": -71.0173034667969,
            "drop_off_date": "2024-10-28",
            "drop_off_time": "16:00"
        }
    }
]

2025-08-25 11:23:05,397 - evaluation_logger_Car-Rental-95 - INFO - Start compare_single_call: 
{'name': 'Search_Car_Location', 'arguments': {'query': 'Downtown Boston'}}
{'name': 'Search_Car_Location', 'arguments': {'query': 'Downtown Boston'}}
2025-08-25 11:23:05,398 - evaluation_logger_Car-Rental-95 - INFO - Rule-based compare success.
2025-08-25 11:23:05,398 - evaluation_logger_Car-Rental-95 - INFO - Start compare_single_call: 
{'name': 'Search_Car_Location', 'arguments': {'query': 'Boston Logan Airport'}}
{'name': 'Search_Car_Location', 'arguments': {'query': 'Boston Logan Airport'}}
2025-08-25 11:23:05,398 - evaluation_logger_Car-Rental-95 - INFO - Rule-based compare success.
2025-08-25 11:23:05,398 - evaluation_logger_Car-Rental-95 - INFO - Success matched: [{'name': 'Search_Car_Location', 'arguments': {'query': 'Downtown Boston'}}, {'name': 'Search_Car_Location', 'arguments': {'query': 'Boston Logan Airport'}}]
2025-08-25 11:23:05,398 - evaluation_logger_Car-Rental-95 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "name": "Downtown Boston",
                "country": "United States",
                "city": "Boston",
                "type": "district",
                "coordinates": {
                    "longitude": -71.0623550415039,
                    "latitude": 42.3576622009277
                }
            }
        ]
    },
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "coordinates": {
                    "longitude": -71.0173034667969,
                    "latitude": 42.3666000366211
                },
                "type": "airport",
                "country": "United States",
                "iata_code": "BOS",
                "city": "Boston",
                "name": "Logan Airport"
            }
        ]
    }
]

2025-08-25 11:23:19,316 - evaluation_logger_Car-Rental-95 - INFO - Function Calls: 
[
    {
        "name": "Search_Car_Rentals",
        "arguments": {
            "pick_up_latitude": 42.3576622009277,
            "pick_up_longitude": -71.0623550415039,
            "drop_off_latitude": 42.3666000366211,
            "drop_off_longitude": -71.0173034667969,
            "pick_up_date": "2024-10-26",
            "pick_up_time": "09:00",
            "drop_off_date": "2024-10-28",
            "drop_off_time": "16:00"
        }
    }
]

2025-08-25 11:23:19,316 - evaluation_logger_Car-Rental-95 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Car_Rentals",
        "arguments": {
            "drop_off_date": "2024-10-28",
            "drop_off_latitude": 42.3666000366211,
            "drop_off_longitude": -71.0173034667969,
            "drop_off_time": "16:00",
            "pick_up_date": "2024-10-26",
            "pick_up_latitude": 42.3576622009277,
            "pick_up_longitude": -71.0623550415039,
            "pick_up_time": "09:00"
        }
    },
    {
        "name": "Vehicle_Details",
        "arguments": {
            "vehicle_id": "372982806",
            "search_key": "eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0="
        }
    },
    {
        "name": "Vehicle_Supplier_Details",
        "arguments": {
            "vehicle_id": "372982806",
            "search_key": "eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0="
        }
    }
]

2025-08-25 11:23:19,316 - evaluation_logger_Car-Rental-95 - INFO - Start compare_single_call: 
{'name': 'Search_Car_Rentals', 'arguments': {'drop_off_date': '2024-10-28', 'drop_off_latitude': 42.3666000366211, 'drop_off_longitude': -71.0173034667969, 'drop_off_time': '16:00', 'pick_up_date': '2024-10-26', 'pick_up_latitude': 42.3576622009277, 'pick_up_longitude': -71.0623550415039, 'pick_up_time': '09:00'}}
{'name': 'Search_Car_Rentals', 'arguments': {'drop_off_date': '2024-10-28', 'drop_off_latitude': 42.3666000366211, 'drop_off_longitude': -71.0173034667969, 'drop_off_time': '16:00', 'pick_up_date': '2024-10-26', 'pick_up_latitude': 42.3576622009277, 'pick_up_longitude': -71.0623550415039, 'pick_up_time': '09:00'}}
2025-08-25 11:23:19,316 - evaluation_logger_Car-Rental-95 - INFO - Rule-based compare success.
2025-08-25 11:23:19,316 - evaluation_logger_Car-Rental-95 - INFO - Success matched: [{'name': 'Search_Car_Rentals', 'arguments': {'drop_off_date': '2024-10-28', 'drop_off_latitude': 42.3666000366211, 'drop_off_longitude': -71.0173034667969, 'drop_off_time': '16:00', 'pick_up_date': '2024-10-26', 'pick_up_latitude': 42.3576622009277, 'pick_up_longitude': -71.0623550415039, 'pick_up_time': '09:00'}}]
2025-08-25 11:23:19,317 - evaluation_logger_Car-Rental-95 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "search_key": "eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=",
            "search_results": [
                {
                    "vehicle_id": "372982806",
                    "vehicle_info": {
                        "doors": "4",
                        "v_name": "Ford Focus  ",
                        "free_cancellation": 0,
                        "aircon": 1,
                        "unlimited_mileage": 1,
                        "cma_compliant": -1,
                        "fuel_type": "N/A",
                        "transmission": "Automatic",
                        "label": "Compact car with:",
                        "group": "Compact",
                        "fuel_policy": "Like for like",
                        "airbags": 1,
                        "mileage": "Unlimited mileage",
                        "suitcases": {
                            "small": "0",
                            "big": "0"
                        },
                        "seats": "5",
                        "v_id": "372982806"
                    },
                    "route_info": {
                        "pickup": {
                            "longitude": "-71.060001",
                            "address": "1 Center Plaza, Government Center, Boston, MA, USA, 02108",
                            "location_hash": "Qm9zdG9uIC0gQ2VudGVyIFBsYXph",
                            "location_type": "DOWNTOWN",
                            "location_id": "1704991",
                            "latitude": "42.358896",
                            "name": "Boston - Center Plaza",
                            "country_code": "US"
                        },
                        "dropoff": {
                            "longitude": "-71.03026259",
                            "address": "15 Transportation Way, Boston, MA, USA, 02128",
                            "location_type": "SHUTTLE_BUS",
                            "latitude": "42.36807359",
                            "name": "Logan International Airport",
                            "location_id": "1687026",
                            "country_code": "US"
                        }
                    },
                    "pricing_info": {
                        "currency": "USD",
                        "drive_away_price_is_approx": true,
                        "price": 357.69,
                        "fee_breakdown": {
                            "fuel_policy": {
                                "type": "RETURN_SAME",
                                "amount": 0
                            },
                            "known_fees": [
                                {
                                    "type": "THEFT_EXCESS",
                                    "min_amount": 0,
                                    "max_amount": 0,
                                    "amount": 0,
                                    "is_tax_included": 1,
                                    "is_always_payable": 0,
                                    "currency": "USD"
                                },
                                {
                                    "is_always_payable": 0,
                                    "currency": "USD",
                                    "type": "DEPOSIT",
                                    "min_amount": 250,
                                    "max_amount": 250,
                                    "amount": 250,
                                    "is_tax_included": 1
                                },
                                {
                                    "type": "ONE_WAY_FEE",
                                    "max_amount": 0,
                                    "min_amount": 0,
                                    "is_tax_included": 1,
                                    "amount": 0,
                                    "is_always_payable": 1,
                                    "currency": "USD"
                                },
                                {
                                    "type": "DAMAGE_EXCESS",
                                    "max_amount": 0,
                                    "min_amount": 0,
                                    "is_tax_included": 1,
                                    "amount": 0,
                                    "is_always_payable": 0,
                                    "currency": "USD"
                                },
                                {
                                    "type": "MILEAGE",
                                    "distance_allowed": {
                                        "is_km": 0,
                                        "is_unlimited": 1
                                    },
                                    "is_always_payable": 0
                                }
                            ]
                        },
                        "base_currency": "INR",
                        "deposit": 357.69,
                        "pay_when": "PAY_NOW",
                        "base_price": 30083.19,
                        "quote_allowed": 1,
                        "base_deposit": 30083.19,
                        "discount": 0,
                        "drive_away_price": 357.69
                    },
                    "supplier_info": {
                        "longitude": "-71.060001",
                        "may_require_credit_card_guarantee": false,
                        "location_type": "Downtown",
                        "logo_url": "https://cdn.rcstatic.com/sp/images/suppliers/47_logo_200.png",
                        "address": "1 Center Plaza, Government Center, Boston, MA, USA, 02108",
                        "name": "Avis",
                        "latitude": "42.358896"
                    },
                    "fee_info": {
                        "fee": 0,
                        "tax": 0
                    },
                    "accessibility": {
                        "fuel_policy": "Fuel policy is: Like for like",
                        "transmission": "Automatic gearbox",
                        "supplier_rating": "At this location, our customers have rated Avis as 8.0 out of 10, Very good.",
                        "pick_up_location": "Pick-up information: Downtown"
                    },
                    "rating_info": {
                        "average": 8,
                        "pickup_time": 8.2,
                        "cleanliness": 7.4,
                        "average_text": "Excellent",
                        "value_for_money": 8.1,
                        "dropoff_time": 9.2,
                        "location": 9,
                        "no_of_ratings": 116,
                        "condition": 7.5,
                        "efficiency": 7.2
                    },
                    "content": {
                        "supplier": {
                            "rating": {
                                "title": "Very good",
                                "average": "8.0",
                                "localisedRating": {
                                    "rawValue": 8,
                                    "displayValue": "8"
                                },
                                "subtitle": "116 reviews"
                            },
                            "name": "Avis"
                        }
                    }
                }
            ]
        }
    }
]

2025-08-25 11:24:01,841 - evaluation_logger_Car-Rental-95 - INFO - Function Calls: 
[
    {
        "name": "Vehicle_Details",
        "arguments": {
            "vehicle_id": "372982806",
            "search_key": "eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0="
        }
    },
    {
        "name": "Vehicle_Supplier_Details",
        "arguments": {
            "vehicle_id": "372982806",
            "search_key": "eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0="
        }
    }
]

2025-08-25 11:24:01,841 - evaluation_logger_Car-Rental-95 - INFO - Golden Function Call: 
[
    {
        "name": "Vehicle_Details",
        "arguments": {
            "search_key": "eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=",
            "vehicle_id": "372982806"
        }
    },
    {
        "name": "Vehicle_Supplier_Details",
        "arguments": {
            "search_key": "eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=",
            "vehicle_id": "372982806"
        }
    }
]

2025-08-25 11:24:01,841 - evaluation_logger_Car-Rental-95 - INFO - Start compare_single_call: 
{'name': 'Vehicle_Details', 'arguments': {'search_key': 'eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=', 'vehicle_id': '372982806'}}
{'name': 'Vehicle_Details', 'arguments': {'search_key': 'eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=', 'vehicle_id': '372982806'}}
2025-08-25 11:24:01,841 - evaluation_logger_Car-Rental-95 - INFO - Rule-based compare success.
2025-08-25 11:24:01,841 - evaluation_logger_Car-Rental-95 - INFO - Start compare_single_call: 
{'name': 'Vehicle_Supplier_Details', 'arguments': {'search_key': 'eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=', 'vehicle_id': '372982806'}}
{'name': 'Vehicle_Supplier_Details', 'arguments': {'search_key': 'eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=', 'vehicle_id': '372982806'}}
2025-08-25 11:24:01,841 - evaluation_logger_Car-Rental-95 - INFO - Rule-based compare success.
2025-08-25 11:24:01,841 - evaluation_logger_Car-Rental-95 - INFO - Success matched: [{'name': 'Vehicle_Details', 'arguments': {'search_key': 'eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=', 'vehicle_id': '372982806'}}, {'name': 'Vehicle_Supplier_Details', 'arguments': {'search_key': 'eyJkcml2ZXJzQWdlIjozMCwiZHJvcE9mZkRhdGVUaW1lIjoiMjAyNC0xMC0yOFQxNjowMDowMCIsImRyb3BPZmZMb2NhdGlvbiI6IjQyLjM2NjYwMDAzNjYyMTEsLTcxLjAxNzMwMzQ2Njc5NjkiLCJkcm9wT2ZmTG9jYXRpb25UeXBlIjoiTEFUTE9ORyIsInBpY2tVcERhdGVUaW1lIjoiMjAyNC0xMC0yNlQwOTowMDowMCIsInBpY2tVcExvY2F0aW9uIjoiNDIuMzU3NjYyMjAwOTI3NywtNzEuMDYyMzU1MDQxNTAzOSIsInBpY2tVcExvY2F0aW9uVHlwZSI6IkxBVExPTkciLCJyZW50YWxEdXJhdGlvbkluRGF5cyI6Mywic2VydmljZUZlYXR1cmVzIjpbIk5PX09QQVFVRVMiLCJTVVBSRVNTX0ZJWEVEX1BSSUNFX1ZFSElDTEVTIiwiSU5DTFVERV9QUk9EVUNUX1JFTEFUSU9OU0hJUFMiLCJJTkNMVURFX0VYVFJBU19DT05UQUlOSU5HX0ZFRVMiXX0=', 'vehicle_id': '372982806'}}]
2025-08-25 11:24:01,842 - evaluation_logger_Car-Rental-95 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "supplier": {
                "locationType": "Downtown",
                "rating": 8
            },
            "metadata": {
                "navigation": {
                    "showExtrasStep": true
                }
            },
            "content": {
                "carCard": {
                    "accessibility": {
                        "pick_up_location": "Pick-up information: Downtown",
                        "transmission": "Automatic gearbox",
                        "fuel_policy": "Fuel policy is: Like for like",
                        "supplier_rating": "At this location, our customers have rated Avis as 8.0 out of 10, Very good."
                    },
                    "supplier": {
                        "name": "Avis",
                        "rating": {
                            "localisedRating": {
                                "displayValue": "8",
                                "rawValue": 8
                            },
                            "title": "Very good",
                            "subtitle": "116 reviews",
                            "average": "8.0"
                        }
                    }
                },
                "reviews": {
                    "supplier": {
                        "rating": {
                            "localisedRating": {
                                "rawValue": 8,
                                "displayValue": "8"
                            },
                            "subtitle": "116 reviews",
                            "average": "8.0",
                            "title": "Very good"
                        },
                        "name": "Avis"
                    },
                    "title": "Reviews"
                }
            },
            "extras": [
                {
                    "maxQuantityAvailable": 3,
                    "detail": "If you want other people to drive as well",
                    "name": "Additional driver",
                    "price": {
                        "perRental": {
                            "display": {
                                "currency": "USD",
                                "value": 39
                            },
                            "base": {
                                "value": 39,
                                "currency": "USD"
                            }
                        },
                        "prePayable": false
                    },
                    "type": "ADDITIONAL_DRIVER",
                    "id": "12186562071010"
                },
                {
                    "maxQuantityAvailable": 2,
                    "detail": "For babies: up to 9 kg / 20 lbs (about 1 year old)",
                    "price": {
                        "perRental": {
                            "display": {
                                "value": 43.5,
                                "currency": "USD"
                            },
                            "base": {
                                "currency": "USD",
                                "value": 43.5
                            }
                        },
                        "prePayable": false
                    },
                    "type": "BABY_SEAT",
                    "id": "12186562076010",
                    "name": "Baby seat"
                },
                {
                    "maxQuantityAvailable": 2,
                    "detail": "For bigger children: 18-45 kg / 40-100 lbs (about 4-11 years old)",
                    "type": "CHILD_BOOSTER_SEAT",
                    "price": {
                        "prePayable": false,
                        "perRental": {
                            "base": {
                                "value": 43.5,
                                "currency": "USD"
                            },
                            "display": {
                                "value": 43.5,
                                "currency": "USD"
                            }
                        }
                    },
                    "id": "12186562081010",
                    "name": "Booster seat"
                },
                {
                    "detail": "For small children: 9-18 kg / 20-40 lbs (about 1-3 years old)",
                    "maxQuantityAvailable": 2,
                    "id": "12186562086010",
                    "price": {
                        "perRental": {
                            "base": {
                                "value": 43.5,
                                "currency": "USD"
                            },
                            "display": {
                                "value": 43.5,
                                "currency": "USD"
                            }
                        },
                        "prePayable": false
                    },
                    "type": "CHILD_SEAT",
                    "name": "Child seat"
                },
                {
                    "detail": "A satellite navigation (sat nav) device that provides directions",
                    "maxQuantityAvailable": 1,
                    "name": "GPS",
                    "id": "12186562091010",
                    "type": "GPS",
                    "price": {
                        "perRental": {
                            "base": {
                                "value": 50.97,
                                "currency": "USD"
                            },
                            "display": {
                                "value": 50.97,
                                "currency": "USD"
                            }
                        },
                        "prePayable": false
                    }
                }
            ],
            "importantInfo": {
                "cta": {
                    "text": "More details",
                    "title": "Rental terms"
                },
                "subtitle": "Security deposit, damage excess, what you'll need at pick-up, and more",
                "title": "Important information",
                "items": [
                    {
                        "text": "<b>Payment card at pick-up:</b> Credit card<br/>The main driver <b>must</b> have a credit card in their own name when picking the car up.",
                        "icon": "CREDIT_CARD"
                    }
                ]
            },
            "meta": {
                "response_code": 200
            },
            "vehicle": {
                "carClass": "Compact",
                "id": "372982806",
                "freeCancellation": false,
                "specification": {
                    "smallSuitcases": 1,
                    "airConditioning": true,
                    "transmission": "Automatic",
                    "numberOfSeats": "5",
                    "mileage": "Unlimited",
                    "numberOfDoors": "4",
                    "fuelPolicy": "Like for like",
                    "bigSuitcases": 1
                },
                "label": "Compact car with:",
                "price": {
                    "driveAwayPriceIsApprox": true,
                    "payWhen": "PAY_NOW",
                    "display": {
                        "currency": "USD",
                        "value": 357.69
                    },
                    "driveAway": {
                        "value": 357.69,
                        "currency": "USD"
                    },
                    "base": {
                        "currency": "INR",
                        "value": 30083.19
                    }
                },
                "makeAndModel": "Ford Focus",
                "fees": {
                    "payableFees": [
                        {
                            "includedInPrice": true,
                            "price": {
                                "taxIncluded": true,
                                "maximumAmount": 0,
                                "currency": "USD",
                                "minimumAmount": 0,
                                "amount": 0
                            },
                            "distanceUnit": "M",
                            "name": "One way fee",
                            "unlimited": false,
                            "displayPrice": {
                                "taxIncluded": true,
                                "amount": 0,
                                "minimumAmount": 0,
                                "currency": "USD",
                                "maximumAmount": 0
                            },
                            "alwaysPayable": true
                        }
                    ],
                    "otherFees": [
                        {
                            "name": "DAMAGE_EXCESS",
                            "includedInPrice": false,
                            "distanceUnit": "M",
                            "price": {
                                "taxIncluded": true,
                                "minimumAmount": 0,
                                "currency": "USD",
                                "maximumAmount": 0,
                                "amount": 0
                            },
                            "alwaysPayable": true,
                            "displayPrice": {
                                "taxIncluded": true,
                                "amount": 0,
                                "maximumAmount": 0,
                                "currency": "USD",
                                "minimumAmount": 0
                            },
                            "unlimited": false
                        },
                        {
                            "unlimited": false,
                            "alwaysPayable": true,
                            "displayPrice": {
                                "maximumAmount": 250,
                                "currency": "USD",
                                "minimumAmount": 250,
                                "amount": 250,
                                "taxIncluded": true
                            },
                            "includedInPrice": false,
                            "distanceUnit": "M",
                            "price": {
                                "amount": 250,
                                "maximumAmount": 250,
                                "currency": "USD",
                                "minimumAmount": 250,
                                "taxIncluded": true
                            },
                            "name": "DEPOSIT"
                        },
                        {
                            "price": {
                                "amount": 15.99,
                                "minimumAmount": 15.99,
                                "currency": "USD",
                                "maximumAmount": 15.99,
                                "taxIncluded": true
                            },
                            "includedInPrice": false,
                            "distanceUnit": "M",
                            "type": "RETURN_SAME",
                            "name": "FUEL_POLICY",
                            "unlimited": false,
                            "alwaysPayable": false,
                            "displayPrice": {
                                "currency": "USD",
                                "minimumAmount": 15.99,
                                "maximumAmount": 15.99,
                                "amount": 15.99,
                                "taxIncluded": true
                            }
                        },
                        {
                            "price": {
                                "amount": 0,
                                "currency": "USD",
                                "taxIncluded": false
                            },
                            "includedInPrice": false,
                            "distanceUnit": "M",
                            "name": "MILEAGE",
                            "unlimited": true,
                            "displayPrice": {
                                "currency": "USD",
                                "amount": 0,
                                "taxIncluded": false
                            },
                            "alwaysPayable": false
                        },
                        {
                            "includedInPrice": false,
                            "price": {
                                "taxIncluded": true,
                                "currency": "USD",
                                "minimumAmount": 0,
                                "maximumAmount": 0,
                                "amount": 0
                            },
                            "distanceUnit": "M",
                            "name": "THEFT_EXCESS",
                            "unlimited": false,
                            "alwaysPayable": true,
                            "displayPrice": {
                                "currency": "USD",
                                "minimumAmount": 0,
                                "maximumAmount": 0,
                                "amount": 0,
                                "taxIncluded": true
                            }
                        }
                    ]
                },
                "rentalDurationInDays": 3
            },
            "links": {
                "fullRentalTerms": {
                    "label": "Rental terms"
                }
            },
            "whatsIncluded": {
                "items": [
                    {
                        "text": "Collision Damage Waiver (CDW)",
                        "icon": "TICK"
                    },
                    {
                        "text": "Theft Cover",
                        "icon": "TICK"
                    },
                    {
                        "text": "Third-Party Liability (TPL)",
                        "icon": "TICK"
                    }
                ],
                "title": "What's included"
            },
            "packages": [
                {
                    "id": "RC_EC_USA",
                    "content": {
                        "subtitle": "for peace of mind",
                        "description": "Your car's zero-excess policy doesn't cover every kind of damage, or the other costs you might incur if something goes wrong. Why not add ₹ 235,500 of Extra Cover - from RentalCover.com?",
                        "included": "Extra Cover included",
                        "cta": {
                            "attach": "Read more",
                            "remove": "Remove Extra Cover"
                        },
                        "price": {
                            "displayPrice": "US$24.75",
                            "priceAnnotation": {
                                "text": "Free cancellation"
                            },
                            "label": "Total protection price"
                        },
                        "title": "Add insurance..."
                    }
                }
            ],
            "depots": {
                "dropoff": {
                    "iataCode": "BOS",
                    "latitude": "42.36807359",
                    "location_id": "1687026",
                    "longitude": "-71.03026259",
                    "country_code": "US",
                    "location_type": "SHUTTLE_BUS",
                    "address": "15 Transportation Way, Boston, MA, USA, 02128",
                    "id": "1687026",
                    "name": "Logan International Airport"
                },
                "pickup": {
                    "name": "Boston - Center Plaza",
                    "address": "1 Center Plaza, Government Center, Boston, MA, USA, 02108",
                    "id": "1704991",
                    "location_type": "DOWNTOWN",
                    "country_code": "US",
                    "country": "USA - Other",
                    "longitude": "-71.060001",
                    "location_id": "1704991",
                    "latitude": "42.358896",
                    "city": "Boston, MA"
                }
            }
        }
    },
    {
        "status": true,
        "message": "Success",
        "data": {
            "details": {
                "location": {
                    "address": "1 Center Plaza, Government Center, Boston, MA, USA, 02108"
                },
                "supplier": {
                    "title": "Rental company",
                    "name": "Avis",
                    "rating": {
                        "average": "8.0",
                        "subtitle": "116 reviews",
                        "title": "Very good",
                        "breakdown": [
                            {
                                "title": "Overall value for money of your vehicle hire",
                                "score": "8.1",
                                "localisedRating": {
                                    "rawValue": 8.1,
                                    "displayValue": "8.1"
                                }
                            },
                            {
                                "score": "7.2",
                                "title": "Helpfulness",
                                "localisedRating": {
                                    "rawValue": 7.2,
                                    "displayValue": "7.2"
                                }
                            },
                            {
                                "localisedRating": {
                                    "rawValue": 8.2,
                                    "displayValue": "8.2"
                                },
                                "title": "Pick-up speed",
                                "score": "8.2"
                            },
                            {
                                "score": "9.2",
                                "title": "Drop-off speed",
                                "localisedRating": {
                                    "rawValue": 9.2,
                                    "displayValue": "9.2"
                                }
                            },
                            {
                                "title": "Car cleanliness",
                                "score": "7.4",
                                "localisedRating": {
                                    "displayValue": "7.4",
                                    "rawValue": 7.4
                                }
                            }
                        ],
                        "localisedRating": {
                            "rawValue": 8,
                            "displayValue": "8"
                        }
                    }
                },
                "openingTimes": {
                    "title": "Opening times",
                    "dropOff": {
                        "hours": "00:00 - 24:00",
                        "title": "Drop-off (28 Oct)",
                        "subtitle": "Avis, Logan International Airport"
                    },
                    "pickUp": {
                        "subtitle": "Avis, Boston - Center Plaza",
                        "title": "Pick-up (26 Oct)",
                        "hours": "08:00 - 15:00"
                    }
                }
            },
            "map": {
                "location": {
                    "address": "1 Center Plaza, Government Center, Boston, MA, USA, 02108",
                    "coordinates": {
                        "latitude": 42.358896,
                        "longitude": -71.060001
                    },
                    "title": "Supplier location"
                }
            },
            "reviews": {
                "customerReviews": {
                    "title": "Customer reviews",
                    "noReviews": {
                        "title": "No customer reviews yet",
                        "body": "We don't have any reviews for this rental counter yet."
                    }
                },
                "supplier": {
                    "rating": {
                        "localisedRating": {
                            "rawValue": 8,
                            "displayValue": "8"
                        },
                        "average": "8.0",
                        "subtitle": "116 reviews",
                        "title": "Very good",
                        "breakdown": [
                            {
                                "title": "Overall value for money of your vehicle hire",
                                "score": "8.1",
                                "localisedRating": {
                                    "displayValue": "8.1",
                                    "rawValue": 8.1
                                }
                            },
                            {
                                "localisedRating": {
                                    "displayValue": "7.2",
                                    "rawValue": 7.2
                                },
                                "title": "Helpfulness",
                                "score": "7.2"
                            },
                            {
                                "localisedRating": {
                                    "rawValue": 8.2,
                                    "displayValue": "8.2"
                                },
                                "score": "8.2",
                                "title": "Pick-up speed"
                            },
                            {
                                "title": "Drop-off speed",
                                "score": "9.2",
                                "localisedRating": {
                                    "displayValue": "9.2",
                                    "rawValue": 9.2
                                }
                            },
                            {
                                "localisedRating": {
                                    "rawValue": 7.4,
                                    "displayValue": "7.4"
                                },
                                "score": "7.4",
                                "title": "Car cleanliness"
                            }
                        ]
                    },
                    "title": "Rental company",
                    "name": "Avis"
                }
            }
        }
    }
]

2025-08-25 11:26:45,794 - evaluation_logger_Car-Rental-95 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 前言

在之前的文章中，我们介绍了`axios`的拦截器，并使用`Promise`实现了一套拦截器管理机制。我们已经知道了拦截器分为请求拦截器和响应拦截器两种。它们的作用时序不同，请求拦截器是在`dispatchRequest`之前执行，而响应拦截器是在`dispatchRequest`之后执行。

那么，我们接下来就要把拦截器和`dispatchRequest`按照之前我们所说的时序串联起来，形成一个链式调用。

# 2. 链式调用实现

我们之前已经实现了拦截器管理类，并且给`Axios`类中创建了`interceptors`属性，它包含了两个拦截器：请求拦截器和响应拦截器。

```typescript
// src/core/Axios.ts

import { InterceptorManager } from "./InterceptorManager";

export class Axios {
  defaults: AxiosRequestConfig;
  interceptors: {
    request: InterceptorManager<AxiosRequestConfig>;
    response: InterceptorManager<AxiosResponse>;
  };

  constructor(initConfig: AxiosRequestConfig) {
    this.defaults = initConfig;
    this.interceptors = {
      request: new InterceptorManager<AxiosRequestConfig>(),
      response: new InterceptorManager<AxiosResponse>(),
    };
  }

  request(url: any, config?: any): AxiosPromise {
    if (typeof url === "string") {
      if (!config) {
        config = {};
      }
      config.url = url;
    } else {
      config = url;
    }

    // 合并配置

    // 初始化配置
    const mergedConfig = mergeConfig(this.defaults, config);
    // 设置请求方法
    mergedConfig.method = mergedConfig.method?.toLowerCase() || "get";

    // 将拦截器和dispatchRequest串联成chain链
    const chain: PromiseChain<any>[] = [
      {
        resolved: dispatchRequest,
        rejected: undefined,
      },
    ];

    // 请求拦截器，从后往前压
    this.interceptors.request.forEach((interceptor) => {
      chain.unshift(interceptor);
    });

    // 响应拦截器，从前往后压
    this.interceptors.response.forEach((interceptor) => {
      chain.push(interceptor);
    });

    // 初始化promise
    let promise = Promise.resolve(mergedConfig);

    // 链式调用
    while (chain.length) {
      const { resolved, rejected } = chain.shift()!;
      promise = promise.then(resolved, rejected);
    }

    return promise;
  }
}
```

代码说明：

- 首先，我们创建了一个`chain`数组，里面存放的是一项项链式调用要执行的任务，每个任务都是包含`resolved`和`rejected`两个属性的对象。
- 然后，我们把`dispatchRequest`函数放在`chain`数组的中间。因为请求拦截器要在`dispatchRequest`之前执行，所以使用`unshift`方法将请求拦截器从`chain`数组前面压入；而响应拦截器要在`dispatchRequest`之后执行，所以使用`push`方法将响应拦截器从`chain`数组后面压入。
- 接着，我们初始化一个已经`resolve`的`promise`，`resolve`的参数为合并后的请求配置`mergedConfig`。
- 最后，我们通过`while`循环，不断的从`chain`数组中shift出第一个任务，然后 then 到当前`promise`的后面，这样就相当于通过 Promise 的 then 方法实现链式调用。

OK，链式调用的逻辑就写完了，接下来，我们就来编写`dispatchRequest`函数。

# 3. 实现 dispatchRequest 函数

`dispatchRequest`函数是真正用来发出请求的函数，它位于`chain`链的中间，前面是请求拦截器，后面是响应拦截器。所以，`dispatchRequest`函数会被请求拦截器的`resolved`函数处理后的配置作为参数来调用，然后又会将请求返回的响应作为参数传递给后面的响应拦截器。

`dispatchRequest`函数内部逻辑主要分为以下两步：

1. 发送请求前检查请求配置，如果配置有误，则抛出错误，Promise 状态变为`rejected`
2. 基于配置发送请求，拿到响应数据，并将`Promise`状态变为`resolved`

```typescript
// src/core/dispatchRequest.ts

import { transformURL } from "./helpers/url";
import { AxiosPromise, AxiosRequestConfig, AxiosResponse } from "./types";
import { xhr } from "./xhr";
import { transformRequestData, transformResponse } from "./helpers/data";
import { flattenHeaders, processHeaders } from "./helpers/headers";

export default function dispatchRequest(
  config: AxiosRequestConfig
): AxiosPromise {
  // 检查请求配置
  throwIfCancellationRequested(config);
  // 处理请求配置
  processConfig(config);
  // 发送请求
  return xhr(config).then(
    (res) => {
      // 处理响应数据
      return transformResponseData(res);
    },
    (e) => {
      if (e && e.response) {
        e.response = transformResponseData(e.response);
      }
      return Promise.reject(e);
    }
  );
}

// 处理请求配置
function processConfig(config: AxiosRequestConfig): void {
  config.url = transformURL(config);
  config.data = transformRequestData(config);
  config.headers = flattenHeaders(config.headers, config.method!);
}

// 处理响应数据
function transformResponseData(res: AxiosResponse): AxiosResponse {
  res.data = transformResponse(res.data);
  return res;
}

// 检查请求是否已经被取消
function throwIfCancellationRequested(config: AxiosRequestConfig): void {
  if (config.cancelToken) {
    config.cancelToken.throwIfRequested();
  }
}
```

代码说明：

- 首先，在发送请求前，我们先检查请求配置里面的`cancelToken`，如果已经使用过了，则抛出错误，请求终止。
- 接着，我们调用`processConfig`函数对请求配置做处理，处理的内容包括：
  - 对`url`做处理，因为配置里的`url`可能是相对路径，所以需要与配置里的`baseURL`作拼接，另外`url`中可能还包含占位符，需要将占位符替换为配置`params`中对应的值。
  - 对请求`data`做处理，根据请求头`Content-Type`的值，将`data`转换为对应类型，例如`JSON`字符串。
  - 对请求头`headers`做处理，将配置里`headers`的公共配置、请求配置、和`data`配置做合并。
- 然后，调用`xhr`函数，基于配置发送请求，拿到响应`res`后，调用`transformResponseData`函数对响应数据做处理，主要是将响应数据转换为`JSON`对象。
- 最后，将处理后的响应返回。

另外，在请求失败时，我们也要对错误对象中的响应数据做转换。

# 4. 修改 xhr 函数

由于我们之前写的`xhr`函数内部并没有对传入的配置做处理，而是直接使用了配置，但是我们在`dispatchRequest`函数内部已经对配置做了处理，所以，我们需要修改`xhr`函数，让它使用处理后的配置来发送请求。

另外，我们还需要在`xhr`函数内部将请求头添加到`XMLHttpRequest`对象上。

```typescript
// src/core/xhr.ts

import { AxiosPromise, AxiosRequestConfig, AxiosResponse } from "./types";
import { parseHeaders } from "./helpers/headers";
import { createError } from "./helpers/error";

export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      data = null,
      url,
      method = "get",
      headers,
      responseType,
      timeout,
    } = config;

    const request = new XMLHttpRequest();

    if (responseType) {
      request.responseType = responseType;
    }

    if (timeout) {
      request.timeout = timeout;
    }

    request.open(method.toUpperCase(), url!, true);

    request.onreadystatechange = function handleLoad() {
      if (request.readyState !== 4) {
        return;
      }

      if (request.status === 0) {
        return;
      }

      const responseHeaders = parseHeaders(request.getAllResponseHeaders());
      const responseData =
        responseType && responseType !== "text"
          ? request.response
          : request.responseText;
      const response: AxiosResponse = {
        data: responseData,
        status: request.status,
        statusText: request.statusText,
        headers: responseHeaders,
        config,
        request,
      };
      handleResponse(response);
    };

    request.onerror = function handleError() {
      reject(createError("Network Error", config, null, request));
    };

    request.ontimeout = function handleTimeout() {
      reject(
        createError(
          `Timeout of ${timeout} ms exceeded`,
          config,
          "ECONNABORTED",
          request
        )
      );
    };

    // 添加请求头
    Object.keys(headers).forEach((name) => {
      if (data === null && name.toLowerCase() === "content-type") {
        delete headers[name];
      } else {
        request.setRequestHeader(name, headers[name]);
      }
    });

    request.send(data);

    function handleResponse(response: AxiosResponse) {
      if (response.status >= 200 && response.status < 300) {
        resolve(response);
      } else {
        reject(
          createError(
            `Request failed with status code ${response.status}`,
            config,
            null,
            request,
            response
          )
        );
      }
    }
  });
}
```

代码说明：

- 我们通过`Object.keys(headers).forEach`循环，将配置里的请求头添加到`XMLHttpRequest`对象上。
- 另外，如果`data`为`null`的时候，请求 header 配置`Content-Type`是没有意义的，所以我们直接把它删除。

# 5. 编写辅助函数

从上面代码中我们可以看到，`dispatchRequest`函数内部使用了很多辅助函数，例如：`transformURL`、`transformRequestData`、`flattenHeaders`、`processHeaders`、`transformResponse`等，这些辅助函数我们之前都已经编写好了，这里直接使用即可。

但是，我们还需要编写一个`throwIfCancellationRequested`函数，用来检查请求是否已经被取消。

```typescript
// src/core/dispatchRequest.ts

function throwIfCancellationRequested(config: AxiosRequestConfig): void {
  if (config.cancelToken) {
    config.cancelToken.throwIfRequested();
  }
}
```

该函数内部判断了如果配置存在`cancelToken`，则调用`cancelToken.throwIfRequested`方法，如果请求已经被取消，则抛出错误。

# 6. 编写 demo

接下来，我们编写一个 demo 来测试下我们写的拦截器链式调用。

```typescript
// examples/server.js

const express = require("express");
const bodyParser = require("body-parser");
const app = express();

// 使用body-parser中间件
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// 设置cors允许跨域
app.use("*", (req, res, next) => {
  res.header("Access-Control-Allow-Origin", "*");
  res.header("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
  res.header(
    "Access-Control-Allow-Headers",
    "Origin, X-Requested-With, Content-Type, Accept, Authorization"
  );
  next();
});

app.post("/api/addParams", (req, res) => {
  const result = {
    code: 0,
    data: req.body,
    message: "添加参数成功！",
  };
  res.json(result);
});

const server = app.listen(3000, () => {
  console.log("服务器已启动，端口3000");
});
```

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>interceptors demo</title>
  </head>
  <body>
    <script src="./axios.js"></script>
    <script>
      const axios = new Axios({
        baseURL: "http://localhost:3000",
        timeout: 5000,
        headers: {
          "Content-Type": "application/json",
        },
      });

      // 添加请求拦截器
      axios.interceptors.request.use(
        (config) => {
          console.log("请求拦截器1", config);
          config.headers["Authorization"] = "Bearer token";
          return config;
        },
        (error) => {
          return Promise.reject(error);
        }
      );

      axios.interceptors.request.use(
        (config) => {
          console.log("请求拦截器2", config);
          config.data = { ...config.data, extraParam: "extra" };
          return config;
        },
        (error) => {
          return Promise.reject(error);
        }
      );

      // 添加响应拦截器
      axios.interceptors.response.use(
        (response) => {
          console.log("响应拦截器1", response);
          response.data = { ...response.data, message: "修改了消息文本" };
          return response;
        },
        (error) => {
          return Promise.reject(error);
        }
      );

      axios.interceptors.response.use(
        (response) => {
          console.log("响应拦截器2", response);
          return response;
        },
        (error) => {
          return Promise.reject(error);
        }
      );

      axios
        .request({
          url: "/api/addParams",
          method: "post",
          data: {
            name: "张三",
            age: 24,
          },
        })
        .then((res) => {
          console.log("最终数据", res);
        })
        .catch((err) => {
          console.log("错误", err);
        });
    </script>
  </body>
</html>
```

demo 创建好以后，我们在命令行中执行：

```bash
# 同时开启客户端和服务端
npm run server | npm start
```

接着，我们打开浏览器，访问：`http://localhost:8000/`。

然后，我们打开控制台，可以看到输出结果如下：

![](~@/axios/14/01.png)

从输出结果中我们可以看到：

1. 请求拦截器按照添加的顺序从后往前执行，先输出"请求拦截器 2"，再输出"请求拦截器 1"。
2. 请求拦截器可以修改请求配置，我们在请求拦截器 1 中给请求头添加了`Authorization`字段，在请求拦截器 2 中给请求数据添加了`extraParam`字段。
3. 响应拦截器按照添加的顺序从前往后执行，先输出"响应拦截器 1"，再输出"响应拦截器 2"。
4. 响应拦截器可以修改响应数据，我们在响应拦截器 1 中修改了响应数据的`message`字段。
5. 最后，我们拿到了最终处理后的响应数据。

OK，拦截器链式调用成功！

# 7. 总结

本篇文章中，我们实现了拦截器链式调用，将请求拦截器、`dispatchRequest`和响应拦截器串联成了一个链式调用的`Promise`链。

并且，我们还编写了`dispatchRequest`函数，在该函数内部对请求配置做了处理，然后调用`xhr`模块发送请求，拿到响应后又对响应数据做了处理。

最后，我们编写了 demo 测试了拦截器链式调用，结果符合我们的预期。

另外，本篇文章中的代码在目录`examples/14-interceptors-chain`中，大家可以自行查看。


2025-08-25 11:26:53,696 - evaluation_logger_Car-Rental-95 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about the vehicle and the supplier for the car rental in Boston.'}
2025-08-25 11:26:58,697 - evaluation_logger_Car-Rental-95 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 11:26:58,697 - evaluation_logger_Car-Rental-95 - INFO - Message: Success.
2025-08-25 11:26:58,697 - evaluation_logger_Car-Rental-95 - INFO - Success turn num = 3
2025-08-25 11:26:58,697 - evaluation_logger_Car-Rental-95 - INFO - ----------------------------------------------------------------------------------------------------
