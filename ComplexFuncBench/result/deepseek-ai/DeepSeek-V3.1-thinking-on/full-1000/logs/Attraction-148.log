2025-08-25 13:21:33,102 - evaluation_logger_Attraction-148 - INFO - Test Example Attraction-148
2025-08-25 13:21:33,102 - evaluation_logger_Attraction-148 - INFO - Query: I am in Japan and interested in tea. Check for tea activities in Tokyo with available tickets after 6 PM on December 5, 2024. If not, check Kyoto for tickets after 10:30 AM on December 6. I'd like to know the detailed activity information.
2025-08-25 13:21:41,012 - evaluation_logger_Attraction-148 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "tea activities Tokyo"
        }
    }
]

2025-08-25 13:21:41,013 - evaluation_logger_Attraction-148 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Tea, Tokyo"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prjdrfyjc5gk-the-art-of-tea-a-traditional-japanese-ceremony-experience",
            "date": "2024-12-05"
        }
    }
]

2025-08-25 13:21:41,675 - evaluation_logger_Attraction-148 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'tea activities Tokyo'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Tea, Tokyo'}}
2025-08-25 13:21:50,246 - evaluation_logger_Attraction-148 - DEBUG - LLM-based comparison output: {'is_equal': True, 'reason': "The queries 'tea activities Tokyo' and 'Tea, Tokyo' are equivalent as they both aim to search for tea-related attractions in Tokyo. The difference in phrasing does not change the intent of the search."}
2025-08-25 13:21:50,246 - evaluation_logger_Attraction-148 - INFO - LLM-based compare success.
2025-08-25 13:21:50,246 - evaluation_logger_Attraction-148 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Tea, Tokyo'}}]
2025-08-25 13:21:50,246 - evaluation_logger_Attraction-148 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJKRHJGWUpDNUdLIiwidWZpIjotMjQ2MjI3fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Tokyo: A Traditional Japanese Tea Ceremony with a Tea Master",
                    "productId": "PRJDrFYJC5GK",
                    "productSlug": "prjdrfyjc5gk-the-art-of-tea-a-traditional-japanese-ceremony-experience",
                    "taxonomySlug": "activities",
                    "cityUfi": -246227,
                    "cityName": "Tokyo",
                    "countryCode": "jp"
                }
            ]
        }
    }
]

2025-08-25 13:22:00,544 - evaluation_logger_Attraction-148 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prjdrfyjc5gk-the-art-of-tea-a-traditional-japanese-ceremony-experience",
            "date": "2024-12-05"
        }
    }
]

2025-08-25 13:22:00,544 - evaluation_logger_Attraction-148 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-12-05",
            "slug": "prjdrfyjc5gk-the-art-of-tea-a-traditional-japanese-ceremony-experience"
        }
    },
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Tea, Kyoto"
        }
    }
]

2025-08-25 13:22:00,544 - evaluation_logger_Attraction-148 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-05', 'slug': 'prjdrfyjc5gk-the-art-of-tea-a-traditional-japanese-ceremony-experience'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-05', 'slug': 'prjdrfyjc5gk-the-art-of-tea-a-traditional-japanese-ceremony-experience'}}
2025-08-25 13:22:00,544 - evaluation_logger_Attraction-148 - INFO - Rule-based compare success.
2025-08-25 13:22:00,544 - evaluation_logger_Attraction-148 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-12-05', 'slug': 'prjdrfyjc5gk-the-art-of-tea-a-traditional-japanese-ceremony-experience'}}]
2025-08-25 13:22:00,544 - evaluation_logger_Attraction-148 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-05T10:00:00+09:00",
                "timeSlotId": "ATS-PRJDrFYJC5GK-202412051000-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OF6fj6l3Y2AA",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 0-100)"
                                },
                                "id": "ATO-d00d173a-787d-4528-b0db-33db25adb9f8_PRJDrFYJC5GK_20241205_1000",
                                "offerItemId": "OIZTOVgGZK5F",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 12,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Tokyo: A Traditional Japanese Tea Ceremony with a Tea Master",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 12,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:22:09,945 - evaluation_logger_Attraction-148 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "tea activities Kyoto"
        }
    }
]

2025-08-25 13:22:09,945 - evaluation_logger_Attraction-148 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Tea, Kyoto"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prcnx9miryid-tea-ceremony-by-the-tea-master-in-kyoto-shiun-an",
            "date": "2024-12-06"
        }
    }
]

2025-08-25 13:22:10,617 - evaluation_logger_Attraction-148 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'tea activities Kyoto'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Tea, Kyoto'}}
2025-08-25 13:22:17,925 - evaluation_logger_Attraction-148 - DEBUG - LLM-based comparison output: {'is_equal': True, 'reason': "The queries 'tea activities Kyoto' and 'Tea, Kyoto' both aim to search for tea-related attractions in Kyoto. The difference in phrasing does not change the intent or the location being queried, making the function calls equivalent."}
2025-08-25 13:22:17,925 - evaluation_logger_Attraction-148 - INFO - LLM-based compare success.
2025-08-25 13:22:17,925 - evaluation_logger_Attraction-148 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Tea, Kyoto'}}]
2025-08-25 13:22:17,925 - evaluation_logger_Attraction-148 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJjTng5TWlyWUlEIiwidWZpIjotMjM1NDAyfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Tea ceremony by the tea master in Kyoto SHIUN AN",
                    "productId": "PRcNx9MirYID",
                    "productSlug": "prcnx9miryid-tea-ceremony-by-the-tea-master-in-kyoto-shiun-an",
                    "taxonomySlug": "tours",
                    "cityUfi": -235402,
                    "cityName": "Kyoto",
                    "countryCode": "jp"
                }
            ]
        }
    }
]

2025-08-25 13:22:28,580 - evaluation_logger_Attraction-148 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prcnx9miryid-tea-ceremony-by-the-tea-master-in-kyoto-shiun-an",
            "date": "2024-12-06"
        }
    }
]

2025-08-25 13:22:28,580 - evaluation_logger_Attraction-148 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-12-06",
            "slug": "prcnx9miryid-tea-ceremony-by-the-tea-master-in-kyoto-shiun-an"
        }
    }
]

2025-08-25 13:22:28,581 - evaluation_logger_Attraction-148 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-06', 'slug': 'prcnx9miryid-tea-ceremony-by-the-tea-master-in-kyoto-shiun-an'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-06', 'slug': 'prcnx9miryid-tea-ceremony-by-the-tea-master-in-kyoto-shiun-an'}}
2025-08-25 13:22:28,581 - evaluation_logger_Attraction-148 - INFO - Rule-based compare success.
2025-08-25 13:22:28,581 - evaluation_logger_Attraction-148 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-12-06', 'slug': 'prcnx9miryid-tea-ceremony-by-the-tea-master-in-kyoto-shiun-an'}}]
2025-08-25 13:22:28,581 - evaluation_logger_Attraction-148 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-06T11:00:00+09:00",
                "timeSlotId": "ATS-PRcNx9MirYID-202412061100-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Japanese - Tour guide",
                                "language": "ja",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Mandarin - Tour guide",
                                "language": "cmn",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OF3tUVM1aN5f",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-e29389c2-33e2-41da-b573-7f7743073246_PRcNx9MirYID_20241206_1100",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 18-59)"
                                },
                                "id": "ATO-f2b3dbcc-4eca-40b2-8409-ca3ea77c4172_PRcNx9MirYID_20241206_1100",
                                "offerItemId": "OIYA6qxANi01",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-71307591-ffad-4e4e-9e7d-4ffa93317389_PRcNx9MirYID_20241206_1100",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "cmn",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 13-17)"
                                },
                                "id": "ATO-a19d22bd-8488-4f9c-adbf-1bb7bf228851_PRcNx9MirYID_20241206_1100",
                                "offerItemId": "OIGDXDBRqJcs",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Child"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 18-59)"
                                },
                                "id": "ATO-c19bf495-0521-4d6e-a50a-8ef13ef97420_PRcNx9MirYID_20241206_1100",
                                "offerItemId": "OIYA6qxANi01",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "ja",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Tea ceremony by the tea master in Kyoto SHIUN AN",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 6,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            },
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-06T13:00:00+09:00",
                "timeSlotId": "ATS-PRcNx9MirYID-202412061300-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Japanese - Tour guide",
                                "language": "ja",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Mandarin - Tour guide",
                                "language": "cmn",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OF3tUVM1aN5f",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-6a84cb07-eccc-4661-9eae-965b08b5af15_PRcNx9MirYID_20241206_1300",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 18-59)"
                                },
                                "id": "ATO-8ca19ec4-56ac-41c6-be37-25860e21cc02_PRcNx9MirYID_20241206_1300",
                                "offerItemId": "OIYA6qxANi01",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-10faacb6-ce98-4ffa-bdec-d05128132b26_PRcNx9MirYID_20241206_1300",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "cmn",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 13-17)"
                                },
                                "id": "ATO-6fcf6ab1-48f2-4dd0-a98c-fa82407a9201_PRcNx9MirYID_20241206_1300",
                                "offerItemId": "OIGDXDBRqJcs",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Child"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-103f4f48-39b6-4d0f-b2ef-e6870b4729aa_PRcNx9MirYID_20241206_1300",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "ja",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            }
                        ],
                        "label": "Tea ceremony by the tea master in Kyoto SHIUN AN",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 6,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            },
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-06T14:00:00+09:00",
                "timeSlotId": "ATS-PRcNx9MirYID-202412061400-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Japanese - Tour guide",
                                "language": "ja",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Mandarin - Tour guide",
                                "language": "cmn",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OF3tUVM1aN5f",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-63dcb929-ab89-485f-b71e-8c5af7ccaaeb_PRcNx9MirYID_20241206_1400",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 18-59)"
                                },
                                "id": "ATO-d2125c90-f149-4e94-8246-f57e89282f79_PRcNx9MirYID_20241206_1400",
                                "offerItemId": "OIYA6qxANi01",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-6d60224d-4c71-4e62-9f19-711852d2e957_PRcNx9MirYID_20241206_1400",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "cmn",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 13-17)"
                                },
                                "id": "ATO-a2bbb341-e898-4c76-9495-d7b0c7282c54_PRcNx9MirYID_20241206_1400",
                                "offerItemId": "OIGDXDBRqJcs",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Child"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 60-100)"
                                },
                                "id": "ATO-27fe7773-2eff-4e55-aa4c-b66eef3fbb4e_PRcNx9MirYID_20241206_1400",
                                "offerItemId": "OIBSEVuHVQeZ",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 31.1,
                                    "currency": "EUR",
                                    "publicAmount": 31.1
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 33.51,
                                    "currency": "USD",
                                    "publicAmount": 33.51
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "ja",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Senior"
                            }
                        ],
                        "label": "Tea ceremony by the tea master in Kyoto SHIUN AN",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 6,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:24:51,511 - evaluation_logger_Attraction-148 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 前言

在上一篇文章中，我们实现了`axios`的基础功能，但到目前为止，我们都只是实现了一个很简单的`axios`基础功能，即可以发送请求并返回响应数据。但是我们还缺少很多功能，比如：我们可以对`axios`的请求配置对象进行合并；我们可以对请求的响应数据进行处理；我们还可以拦截请求和响应等等。

那么从这篇文章开始，我们就来一步步实现这些功能。我们首先来实现配置合并。

# 2. 需求分析

在官方`axios`中，`axios`对象上有一个`defaults`属性，该属性保存着默认的请求配置，另外，在发送请求的时候，我们还可以传入一个用户自定义配置来覆盖默认配置，并且`axios`还提供了两种配置合并的策略：一是默认的合并策略，二是对于`url`、`params`、`data`属性采用自定义合并策略，其他的采用默认合并策略。

那么，接下来，我们就来实现配置的合并功能。

# 3. 默认配置

首先，我们先给`axios`对象上添加一个`defaults`属性，该属性保存着默认的请求配置，如下：

```typescript
// src/defaults.ts
import { AxiosRequestConfig } from "./types";

const defaults: AxiosRequestConfig = {
  method: "get",
  timeout: 0,
  headers: {
    common: {
      Accept: "application/json, text/plain, */*",
    },
  },
};

const methodsNoData = ["get", "delete", "head", "options"];

methodsNoData.forEach((method) => {
  defaults.headers[method] = {};
});

const methodsWithData = ["post", "put", "patch"];

methodsWithData.forEach((method) => {
  defaults.headers[method] = {
    "Content-Type": "application/x-www-form-urlencoded",
  };
});

export default defaults;
```

我们创建`src/defaults.ts`文件，里面定义了默认配置`defaults`，并且我们还根据请求方法是否带有`data`请求体来给对应请求方法的`headers`添加了不同的`Content-Type`。

然后，我们在`src/index.ts`文件中引入该默认配置，并将其添加到`axios`对象上，如下：

```typescript
// src/index.ts
import defaults from "./defaults";
function createInstance(): AxiosStatic {
  const context = new Axios();
  const instance = Axios.prototype.request.bind(context);

  extend(instance, context);

  return instance as AxiosStatic;
}
const axios = createInstance();
axios.defaults = defaults; // 添加到axios对象上
export default axios;
```

OK，默认配置添加好了，接下来我们就来实现配置的合并。

# 4. 配置合并

配置合并这块的逻辑我们单独放在`src/core/mergeConfig.ts`中实现。

## 4.1 合并策略

在合并配置的过程中，对于不同的字段，我们有不同的合并策略，常见的有：

- 默认合并策略
- 只接受自定义配置合并策略
- 复杂对象合并策略

### 4.1.1 默认合并策略

默认合并策略非常简单，如果用户配置了某个属性，就采用用户配置的，如果用户没配置，就采用默认配置的。

### 4.1.2 只接受自定义配置合并策略

对于一些属性如`url`、`params`、`data`，它们只能从用户配置中取值，默认配置中即使有，也会被用户配置覆盖，并且不会进行深度合并。

### 4.1.3 复杂对象合并策略

对于一些属性如`headers`，它可能包含`common`、`post`、`get`等字段，而这些字段也是对象，对于这种复杂对象，我们使用深度合并策略。

## 4.2 策略模式实现合并

了解了不同的合并策略之后，接下来我们就来实现配置的合并。我们采用策略模式来实现，因为策略模式可以避免过多的`if else`判断。

首先，我们先定义几种不同的策略：

```typescript
// src/core/mergeConfig.ts
import { AxiosRequestConfig } from "../types";
import { deepMerge, isPlainObject } from "../helpers/util";

const strats = Object.create(null);

// 默认合并策略
function defaultStrat(val1: any, val2: any): any {
  return typeof val2 !== "undefined" ? val2 : val1;
}

// 只接受自定义配置合并策略
function fromVal2Strat(val1: any, val2: any): any {
  if (typeof val2 !== "undefined") {
    return val2;
  }
}

// 复杂对象合并策略
function deepMergeStrat(val1: any, val2: any): any {
  if (isPlainObject(val2)) {
    return deepMerge(val1, val2);
  } else if (typeof val2 !== "undefined") {
    return val2;
  } else if (isPlainObject(val1)) {
    return deepMerge(val1);
  } else if (typeof val1 !== "undefined") {
    return val1;
  }
}
```

- `defaultStrat`：默认合并策略，如果`val2`不为`undefined`，则返回`val2`，否则返回`val1`；
- `fromVal2Strat`：只接受自定义配置合并策略，如果`val2`不为`undefined`，则返回`val2`，否则返回`undefined`；
- `deepMergeStrat`：复杂对象合并策略，如果`val2`是普通对象，则用`val2`与`val1`进行深度合并；如果`val2`不是普通对象但是不为`undefined`，则返回`val2`；如果`val2`是`undefined`且`val1`是普通对象，则深拷贝`val1`并返回；如果`val2`是`undefined`且`val1`不是普通对象但是不为`undefined`，则返回`val1`；

其中，`deepMerge`函数我们还没有定义，它是用来深度合并两个对象的，我们把它定义在`src/helpers/util.ts`中，如下：

```typescript
// src/helpers/util.ts
export function deepMerge(...objs: any[]): any {
  const result = Object.create(null);
  objs.forEach((obj) => {
    if (obj) {
      Object.keys(obj).forEach((key) => {
        const val = obj[key];
        if (isPlainObject(val)) {
          if (isPlainObject(result[key])) {
            result[key] = deepMerge(result[key], val);
          } else {
            result[key] = deepMerge(val);
          }
        } else {
          result[key] = val;
        }
      });
    }
  });
  return result;
}
```

`deepMerge`函数可以接受多个对象，然后将它们深度合并成一个对象并返回。

定义好策略函数之后，我们接下来为不同的字段指定不同的策略：

```typescript
// 为headers属性指定深度合并策略
const stratKeysDeepMerge = ["headers"];
stratKeysDeepMerge.forEach((key) => {
  strats[key] = deepMergeStrat;
});

// 为url、params、data属性指定只接受自定义配置合并策略
const stratKeysFromVal2 = ["url", "params", "data"];
stratKeysFromVal2.forEach((key) => {
  strats[key] = fromVal2Strat;
});
```

- 首先，我们为`headers`属性指定了深度合并策略；
- 然后，我们为`url`、`params`、`data`属性指定了只接受自定义配置合并策略；

对于其他属性，我们使用默认合并策略。

## 4.3 mergeConfig 函数实现

有了策略函数和字段与策略的映射之后，我们就可以实现`mergeConfig`函数了：

```typescript
export default function mergeConfig(
  config1: AxiosRequestConfig,
  config2?: AxiosRequestConfig
): AxiosRequestConfig {
  if (!config2) {
    config2 = {};
  }

  const config = Object.create(null);

  for (let key in config2) {
    mergeField(key);
  }

  for (let key in config1) {
    if (!config2[key]) {
      mergeField(key);
    }
  }

  function mergeField(key: string): void {
    const strat = strats[key] || defaultStrat;
    config[key] = strat(config1[key], config2![key]);
  }

  return config;
}
```

`mergeConfig`函数接受两个参数：`config1`为默认配置，`config2`为用户自定义配置。首先，我们创建一个空对象`config`，它用来保存合并后的配置。然后我们先遍历`config2`，调用`mergeField`合并每个`key`对应的值，再遍历`config1`，并且只合并那些`config2`中没有的`key`对应的值。在`mergeField`函数中，我们会根据`key`去选择对应的合并策略函数，如果没有对应的策略函数，则使用默认合并策略。

这样，我们就实现了配置的合并。

# 5. 修改 axios.request 方法

配置合并功能实现好之后，接下来我们就要在发送请求的时候使用它。我们需要修改`src/core/Axios.ts`中的`request`方法，在发送请求之前先合并配置。

```typescript
// src/core/Axios.ts
import { AxiosRequestConfig, AxiosPromise, AxiosResponse } from "../types";
import { parseHeaders } from "../helpers/headers";
import { createError } from "../helpers/error";
import { isURLSameOrigin } from "../helpers/url";
import cookie from "../helpers/cookie";
import { isFormData } from "../helpers/util";
import defaults from "../defaults";
import mergeConfig from "./mergeConfig";

export default class Axios {
  defaults: AxiosRequestConfig;

  constructor(initConfig: AxiosRequestConfig) {
    this.defaults = initConfig;
  }

  request(url: any, config?: any): AxiosPromise {
    if (typeof url === "string") {
      if (!config) {
        config = {};
      }
      config.url = url;
    } else {
      config = url;
    }

    // 合并配置
    config = mergeConfig(this.defaults, config);

    // 设置请求方法，默认为get
    config.method = config.method.toLowerCase();

    // 调用请求拦截器
    // todo...

    return dispatchRequest(config);
  }

  // 其他方法...
}
```

在`request`方法中，我们调用`mergeConfig`函数将默认配置`this.defaults`和用户传入的`config`进行合并，并将合并后的新`config`作为请求配置。

另外，我们还需要修改`src/index.ts`中创建`axios`实例的部分，在创建`Axios`实例的时候把默认配置`defaults`传进去。

```typescript
// src/index.ts
import defaults from "./defaults";
function createInstance(): AxiosStatic {
  const context = new Axios(defaults); // 传入默认配置
  const instance = Axios.prototype.request.bind(context);

  extend(instance, context);

  return instance as AxiosStatic;
}
const axios = createInstance();
axios.defaults = defaults;
export default axios;
```

OK，这样我们就实现了配置的合并功能。

# 6. 编写 demo

接下来，我们编写`demo`来测试下配置合并功能是否正常。

```javascript
// examples/config/app.ts
import axios from "../../src/index";

axios({
  url: "/config/post",
  method: "post",
  data: {
    a: 1,
  },
  headers: {
    test: "321",
  },
}).then((res) => {
  console.log(res.data);
});
```

我们在`examples/config/app.ts`中发送一个请求，并且设置了自定义的`headers`，我们看下它能否与默认配置中的`headers`正确合并。

我们在`examples/server.js`中添加一个路由：

```javascript
// examples/server.js
const router = express.Router();

router.post("/config/post", function(req, res) {
  res.json(req.body);
});
```

然后启动服务，打开浏览器，看到请求已经正常发送，并且我们打开控制台可以看到请求头中已经包含了我们自定义的`headers`和默认配置中的`headers`。

![](~@/axios/05/01.png)

从图中可以看到，我们自定义的`test:321`和默认配置中的`Accept`以及根据请求方法`post`添加的`Content-Type`都已经在请求头中了，说明我们的配置合并功能是正常的。

# 7. 遗留问题

我们虽然已经实现了配置的合并，但是不知大家有没有发现，我们之前写的`axios`的`get`、`post`等方法都还没有用到配置合并，也就是说，如果我们这样调用：

```javascript
axios.get("/config/get", {
  headers: {
    test: "321",
  },
});
```

那么，这个`headers`是不会被合并到默认配置中的。这是因为我们之前写的这些方法都还没有实现配置合并，我们会在后续的文章中来实现。

# 8. 总结

本篇文章中，我们实现了配置的合并功能。首先，我们给`axios`对象添加了`defaults`属性，该属性保存着默认配置；然后，我们实现了配置合并函数`mergeConfig`，该函数采用策略模式针对不同的字段使用不同的合并策略；最后，我们在发送请求前调用该函数将默认配置和用户配置进行合并。

配置合并功能非常重要，它是我们后续实现拦截器、请求配置变换等功能的基础。


2025-08-25 13:24:57,947 - evaluation_logger_Attraction-148 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about tea activities in Tokyo or Kyoto.'}
2025-08-25 13:25:06,505 - evaluation_logger_Attraction-148 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:25:06,506 - evaluation_logger_Attraction-148 - INFO - Message: Success.
2025-08-25 13:25:06,506 - evaluation_logger_Attraction-148 - INFO - Success turn num = 4
2025-08-25 13:25:06,506 - evaluation_logger_Attraction-148 - INFO - ----------------------------------------------------------------------------------------------------
