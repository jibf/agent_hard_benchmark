2025-08-25 13:07:17,324 - evaluation_logger_Attraction-44 - INFO - Test Example Attraction-44
2025-08-25 13:07:17,324 - evaluation_logger_Attraction-44 - INFO - Query: I'm thinking about heading to Sydney. Can you tell me which museums are the trending?
2025-08-25 13:07:25,867 - evaluation_logger_Attraction-44 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Sydney"
        }
    }
]

2025-08-25 13:07:25,867 - evaluation_logger_Attraction-44 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Sydney"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNjAzMTM1fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 13:07:25,867 - evaluation_logger_Attraction-44 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Sydney'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Sydney'}}
2025-08-25 13:07:25,867 - evaluation_logger_Attraction-44 - INFO - Rule-based compare success.
2025-08-25 13:07:25,867 - evaluation_logger_Attraction-44 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Sydney'}}]
2025-08-25 13:07:25,867 - evaluation_logger_Attraction-44 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0xNjAzMTM1fQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -1603135,
                    "country": "Australia",
                    "cityName": "Sydney",
                    "productCount": 532,
                    "cc1": "au"
                }
            ]
        }
    }
]

2025-08-25 13:07:35,444 - evaluation_logger_Attraction-44 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNjAzMTM1fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 13:07:35,444 - evaluation_logger_Attraction-44 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNjAzMTM1fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 13:07:35,444 - evaluation_logger_Attraction-44 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNjAzMTM1fQ==', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNjAzMTM1fQ==', 'sortBy': 'trending'}}
2025-08-25 13:07:35,444 - evaluation_logger_Attraction-44 - INFO - Rule-based compare success.
2025-08-25 13:07:35,444 - evaluation_logger_Attraction-44 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNjAzMTM1fQ==', 'sortBy': 'trending'}}]
2025-08-25 13:07:35,444 - evaluation_logger_Attraction-44 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRZp5qoBsedv",
                    "name": "Sydney Tower Eye Experience",
                    "slug": "przp5qobsedv-sydney-tower-eye-experience",
                    "shortDescription": "A tour to admire Sydney's attractions from a high point of view",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 18.3,
                        "currency": "USD",
                        "publicAmount": 18.3
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 66,
                        "percentage": "92%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.2,
                            "total": 237
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Sydney",
                        "ufi": -1603135
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIw6UTiF83XW"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4f4X4NAJaH"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIA2MbewVAaE"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIIhYUdPUCBl"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OISh8ToJI3wj"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUIwgRvH9Ni"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OICYvFRm4fmG"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIv6QWf1mcX0"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIecErJIfKbV"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItfiasKBW6G"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZt7IbS5MQG"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIPYZYHXVoMX"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIQ3HHhnz1Lw"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIf7WWqjfIEJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI9ycGtHKV7q"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1cYTto9NeD"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIlFq9FXbeRA"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIU21rrzMwaj"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIiRikKhceUm"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI9YMQ7NKCTD"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIMu8Zl6QkNv"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForLandmarks",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRwIFqZ0fA7c",
                    "name": "Sydney Opera House Official Guided Walking Tour",
                    "slug": "prwifqz0fa7c-sydney-opera-house-official-guided-walking-tour",
                    "shortDescription": "A one-hour tour to discover the iconic building",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 31.19,
                        "currency": "USD",
                        "publicAmount": 31.19
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 41,
                        "percentage": "88%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 1209
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Sydney",
                        "ufi": -1603135
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIItAVA5DmbW"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIu7reP5vaH9"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZFlA03QYTJ"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvC54iTRqE5"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbJLEwBIAYN"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIsY6oyfjNm5"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIOkcqCKvufT"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OITk6GTXm1dy"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIn4QA9CdW56"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI3B3wwNFGz3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0deBh9qlKU"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItvcDprdaBk"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIr8hIEd3h4M"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIrsRhIaAc4K"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIjZnGNS9Ndt"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForLandmarks",
                            "value": true,
                            "rank": 3
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRCb09t3m9Mp",
                    "name": "SEA LIFE Admission",
                    "slug": "prcb09t3m9mp-sea-life-admission-with-combo-option",
                    "shortDescription": "A chance to visit the Sydney Aquarium",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 28.28,
                        "currency": "USD",
                        "publicAmount": 28.28
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 252,
                        "percentage": "92%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.4,
                            "total": 261
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Sydney",
                        "ufi": -1603135
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGAt0whnyWd"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIqluMq51Bgp"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIz6Yj8IhESD"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4LyV6i0UbJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIBHC3nYygfl"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIrI5S5xbJsi"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIPnCREImjX4"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OISAqJ2t98gk"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIE1CPkm0gpE"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXFaQqYotey"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKnpQwez4Mf"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIt5c5qG3mgB"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIPXkfKrGwiM"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIiheEx4y5oJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1kIC9ggiJO"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIB6wSF9S0FA"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIJ45dMlntOL"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIp3cjUT6zCc"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 4
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForAttractions",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRrnSsEJpfNb",
                    "name": "General Admission to Sydney Taronga Zoo",
                    "slug": "prrnssejpfnb-general-admission-to-sydney-taronga-zoo",
                    "shortDescription": "A visit to Australia's largest zoo to see and learn about its animals",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 36.73,
                        "currency": "USD",
                        "publicAmount": 36.73
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 43,
                        "percentage": "91%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.4,
                            "total": 202
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Sydney",
                        "ufi": -1603135
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIu1BoDhIC70"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIcC8UuPUCZo"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuDhS5evIMg"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 7
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForAttractions",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "popularFor3Travelers",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRdPSDXDyT3o",
                    "name": "Sydney Harbour Sightseeing Cruise",
                    "slug": "prdpsdxdyt3o-sydney-harbour-sightseeing-cruise",
                    "shortDescription": "A one-hour or 90-minute boat tour of Sydney's waterways with live commentary",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 22.18,
                        "currency": "USD",
                        "publicAmount": 22.18
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 84,
                        "percentage": "82%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.2,
                            "total": 215
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Sydney",
                        "ufi": -1603135
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIL5qVriFHVA"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRWKVwKe3Sk"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIHAEhJhz4pf"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIVZbuWEho4S"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForTours",
                            "value": true,
                            "rank": 1
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 470,
                "filteredProductCount": 470
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 366
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Activities",
                        "tagname": "activities",
                        "productCount": 55
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Transfers & services",
                        "tagname": "transfers-services",
                        "productCount": 32
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Attractions",
                        "tagname": "attractions",
                        "productCount": 8
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums",
                        "tagname": "museums",
                        "productCount": 5
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 432
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Sydney",
                        "tagname": "-1603135",
                        "productCount": 470
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 41
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 66
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 71
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 59
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 240
                    }
                ]
            }
        }
    }
]

2025-08-25 13:10:49,322 - evaluation_logger_Attraction-44 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文我们来分享 Spring Boot 自动配置的实现源码。在开始本文之前，希望胖友能够先阅读[《Spring Boot 自动化配置的源码解析》](http://www.iocoder.cn/Spring-Boot/autoconfigure/?self) 文章，先对 Spring Boot 的自动配置有一个整体的了解。

在[《Spring Boot 自动化配置的源码解析》](http://www.iocoder.cn/Spring-Boot/autoconfigure/?self) 中，我们看到 Spring Boot 通过 `@EnableAutoConfiguration` 注解，开启自动配置的功能。而 `@EnableAutoConfiguration` 注解，通过 `@Import` 注解，引入了 `AutoConfigurationImportSelector` 类。而在这个类中，会读取 `META-INF/spring.factories` 文件中，Key 为 `org.springframework.boot.autoconfigure.EnableAutoConfiguration` 的自动配置类。如下图所示：![ 配置类](Spring Boot 自动配置源码解析.assets/01.png)

- 注意，每个自动配置类，可能会包含 `@ConditionalOnXXX` 条件注解，用于判断是否生效。

所以，本文我们就来看看，Spring Boot 是如何读取 `META-INF/spring.factories` 文件，以及 `@ConditionalOnXXX` 条件注解的判断逻辑。

# 2. AutoConfigurationImportSelector

`org.springframework.boot.autoconfigure.AutoConfigurationImportSelector` ，实现 DeferredImportSelector、BeanClassLoaderAware、ResourceLoaderAware、BeanFactoryAware、EnvironmentAware、Ordered 接口，处理 `@EnableAutoConfiguration` 注解的导入。

## 2.1 构造方法

```java
// AutoConfigurationImportSelector.java

private static final String[] NO_IMPORTS = {};

private static final Log logger = LogFactory.getLog(AutoConfigurationImportSelector.class);

private static final String PROPERTY_NAME_AUTOCONFIGURE_EXCLUDE = "spring.autoconfigure.exclude";

private ConfigurableListableBeanFactory beanFactory;

private Environment environment;

private ClassLoader beanClassLoader;

private ResourceLoader resourceLoader;

/**
 * 自动配置的元数据
 */
private AutoConfigurationMetadata autoConfigurationMetadata;
```

- `autoConfigurationMetadata` 属性，自动配置的元数据。在[「2.3 getAutoConfigurationEntry」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 中，我们会看到它从 `META-INF/spring-autoconfigure-metadata.properties` 文件中加载。然后，在[「2.4 filter」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 中，我们会看到通过它，可以快速过滤掉不符合条件的自动配置类。

## 2.2 selectImports

实现 `#selectImports(AnnotationMetadata annotationMetadata)` 方法，执行自动配置。代码如下：

```java
// AutoConfigurationImportSelector.java

@Override
public String[] selectImports(AnnotationMetadata annotationMetadata) {
    // <1> 如果自动配置功能没有开启，则返回空数组
    if (!isEnabled(annotationMetadata)) {
        return NO_IMPORTS;
    }
    // <2> 获得自动配置的 AutoConfigurationMetadata
    AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(this.beanClassLoader);
    // <2> 获得自动配置的元信息
    AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(autoConfigurationMetadata, annotationMetadata);
    // <3> 返回符合条件的配置类
    return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());
}
```

- `<1>` 处，如果自动配置功能没有开启，则返回空数组。详细解析，见 [「2.2.1 isEnabled」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。
- `<2>` 处，调用 `AutoConfigurationMetadataLoader#loadMetadata(ClassLoader classLoader)` 方法，获得自动配置的 AutoConfigurationMetadata 。详细解析，见 [「3. AutoConfigurationMetadataLoader」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。
- `<3>` 处，调用 `#getAutoConfigurationEntry(AutoConfigurationMetadata autoConfigurationMetadata, AnnotationMetadata annotationMetadata)` 方法，获得自动配置的元信息。详细解析，见 [「2.3 getAutoConfigurationEntry」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。
- `<4>` 处，返回符合条件的配置类。

### 2.2.1 isEnabled

`#isEnabled(AnnotationMetadata metadata)` 方法，如果自动配置功能没有开启，则返回空数组。代码如下：

```java
// AutoConfigurationImportSelector.java

protected boolean isEnabled(AnnotationMetadata metadata) {
    // 当设置的是默认的容器时，返回 true
    if (getClass() == AutoConfigurationImportSelector.class) {
        return getEnvironment().getProperty(EnableAutoConfiguration.ENABLED_OVERRIDE_PROPERTY, Boolean.class, true);
    }
    return true;
}
```

- 可以通过 `spring.boot.enableautoconfiguration` 配置项，设置是否开启自动配置功能。当然，一般不会去关闭。

## 2.3 getAutoConfigurationEntry

`#getAutoConfigurationEntry(AutoConfigurationMetadata autoConfigurationMetadata, AnnotationMetadata annotationMetadata)` 方法，获得自动配置的元信息。代码如下：

```java
// AutoConfigurationImportSelector.java

protected AutoConfigurationEntry getAutoConfigurationEntry(AutoConfigurationMetadata autoConfigurationMetadata, AnnotationMetadata annotationMetadata) {
    // <1> 如果自动配置功能没有开启，则返回空数组
    if (!isEnabled(annotationMetadata)) {
        return EMPTY_ENTRY;
    }
    // <2> 获得注解的属性
    AnnotationAttributes attributes = getAttributes(annotationMetadata);
    // <3> 获得所有自动配置的类名。注意，这里会从 META-INF/spring.factories 文件中读取
    List<String> configurations = getCandidateConfigurations(annotationMetadata, attributes);
    // <4> 移除重复的配置类
    configurations = removeDuplicates(configurations);
    // <5> 获得需要排除的配置类。例如说，注解上 exclude 属性指定的配置类，又或者是配置文件 `spring.autoconfigure.exclude` 配置的配置类
    Set<String> exclusions = getExclusions(annotationMetadata, attributes);
    // 校验需要排除的配置类是否合法
    checkExcludedClasses(configurations, exclusions);
    // <6> 从 configurations 中，移除需要排除的配置类
    configurations.removeAll(exclusions);
    // <7> 对 configurations 进行过滤，剔除掉不满足条件的配置类。例如说，`@ConditionalOnClass` 条件注解，判断是否有对应的类
    configurations = filter(configurations, autoConfigurationMetadata);
    // <8> 触发自动配置导入事件
    fireAutoConfigurationImportEvents(configurations, exclusions);
    // <9> 创建 AutoConfigurationEntry 对象，并返回
    return new AutoConfigurationEntry(configurations, exclusions);
}
```

- `<1>` 处，如果自动配置功能没有开启，则返回空数组。
- `<2>` 处，调用 `#getAttributes(AnnotationMetadata metadata)` 方法，获得注解的属性。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  protected AnnotationAttributes getAttributes(AnnotationMetadata metadata) {
      String name = getAnnotationClass().getName();
      AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(name, true));
      Assert.notNull(attributes, () -> "No auto-configuration attributes found. Is " + metadata.getClassName() + " annotated with " + ClassUtils.getShortName(name) + "?");
      return attributes;
  }
  
  protected Class<?> getAnnotationClass() {
      return EnableAutoConfiguration.class;
  }
  ```

  - 获得 `@EnableAutoConfiguration` 注解的属性。

- `<3>` 处，调用 `#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)` 方法，获得所有自动配置的类名。注意，这里会从 `META-INF/spring.factories` 文件中读取。详细解析，见 [「2.3.1 getCandidateConfigurations」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

- `<4>` 处，调用 `#removeDuplicates(List<String> list)` 方法，移除重复的配置类。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  protected final List<String> removeDuplicates(List<String> list) {
  	return new ArrayList<>(new LinkedHashSet<>(list));
  }
  ```

  - 使用 LinkedHashSet 去重。

- `<5>` 处，调用 `#getExclusions(AnnotationMetadata metadata, AnnotationAttributes attributes)` 方法，获得需要排除的配置类。例如说，注解上 `exclude` / `excludeName` 属性指定的配置类，又或者是配置文件 `spring.autoconfigure.exclude` 配置的配置类。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  protected Set<String> getExclusions(AnnotationMetadata metadata, AnnotationAttributes attributes) {
      Set<String> excluded = new LinkedHashSet<>();
      // 注解上的 exclude 属性
      excluded.addAll(asList(attributes, "exclude"));
      // 注解上的 excludeName 属性
      excluded.addAll(asList(attributes, "excludeName"));
      // 配置文件中的 spring.autoconfigure.exclude 属性
      excluded.addAll(getExcludeAutoConfigurationsProperty());
      return excluded;
  }
  ```

- `<6>` 处，从 `configurations` 中，移除需要排除的配置类。

- `<7>` 处，调用 `#filter(List<String> configurations, AutoConfigurationMetadata autoConfigurationMetadata)` 方法，对 `configurations` 进行过滤，剔除掉不满足条件的配置类。例如说，`@ConditionalOnClass` 条件注解，判断是否有对应的类。详细解析，见 [「2.4 filter」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

- `<8>` 处，调用 `#fireAutoConfigurationImportEvents(List<String> configurations, Set<String> exclusions)` 方法，触发自动配置导入事件。详细解析，见 [「2.5 fireAutoConfigurationImportEvents」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

- `<9>` 处，创建 AutoConfigurationEntry 对象，并返回。

### 2.3.1 getCandidateConfigurations

`#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)` 方法，获得所有自动配置的类名。代码如下：

```java
// AutoConfigurationImportSelector.java

protected List<String> getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) {
    // 加载指定类型 EnableAutoConfiguration 对应的，在 `META-INF/spring.factories` 里的类名的数组
    List<String> configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());
    // 断言，是否为空
    Assert.notEmpty(configurations, "No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct.");
    return configurations;
}

protected Class<?> getSpringFactoriesLoaderFactoryClass() {
    return EnableAutoConfiguration.class;
}
```

- 调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型 `EnableAutoConfiguration` 对应的，在 `META-INF/spring.factories` 里的类名的数组。

- 关于 `SpringFactoriesLoader` 的源码解析，见 [《Spring Factories 机制》](http://www.iocoder.cn/Spring-Boot/Spring-Factories/?self) 文章。

## 2.4 filter

`#filter(List<String> configurations, AutoConfigurationMetadata autoConfigurationMetadata)` 方法，对 `configurations` 进行过滤，剔除掉不满足条件的配置类。代码如下：

```java
// AutoConfigurationImportSelector.java

private List<String> filter(List<String> configurations, AutoConfigurationMetadata autoConfigurationMetadata) {
    // 创建结果数组
    long startTime = System.nanoTime();
    String[] candidates = StringUtils.toStringArray(configurations);
    // 定义 skip 数组，是否跳过。因为可能存在多个条件注解，只要有一个不符合，就需要跳过
    boolean[] skip = new boolean[candidates.length];
    boolean skipped = false;
    // 遍历 AutoConfigurationImportFilter 数组，对每个 candidate 进行判断
    for (AutoConfigurationImportFilter filter : getAutoConfigurationImportFilters()) {
        // 设置 AutoConfigurationImportFilter 的属性
        invokeAwareMethods(filter);
        // 根据 filter 进行判断，是否匹配
        boolean[] match = filter.match(candidates, autoConfigurationMetadata);
        // 遍历 match 数组，判断每个 candidate 是否匹配
        for (int i = 0; i < match.length; i++) {
            // 如果有不匹配的，则标记为 skip
            if (!match[i]) {
                skip[i] = true;
                // 标记 skipped 为 true ，表示有 skip 的
                skipped = true;
            }
        }
    }
    // 如果没有需要 skip 的，则直接返回 configurations
    if (!skipped) {
        return configurations;
    }
    // 创建 result 数组，将不需要 skip 的 candidate 添加到其中
    List<String> result = new ArrayList<>(candidates.length);
    for (int i = 0; i < candidates.length; i++) {
        if (!skip[i]) {
            result.add(candidates[i]);
        }
    }
    // 打印日志
    if (logger.isTraceEnabled()) {
        int numberFiltered = configurations.size() - result.size();
        logger.trace("Filtered " + numberFiltered + " auto configuration class in " + TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime) + " ms");
    }
    return result;
}
```

- 核心逻辑：遍历 `AutoConfigurationImportFilter` 数组，对每个 `candidate` 配置类，调用其 `#match(String[] autoConfigurationClasses, AutoConfigurationMetadata autoConfigurationMetadata)` 方法，判断是否匹配。如果**不匹配**，则进行剔除。

- 那么，`AutoConfigurationImportFilter` 数组有哪些呢？在 `META-INF/spring.factories` 文件中，定义在 `org.springframework.boot.autoconfigure.AutoConfigurationImportFilter` 配置项。如下图所示：![AutoConfigurationImportFilter](Spring Boot 自动配置源码解析.assets/02.png)

  - 一共有三个，分别是：
    - `org.springframework.boot.autoconfigure.condition.OnClassCondition`
    - `org.springframework.boot.autoconfigure.condition.OnBeanCondition`
    - `org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition`

- 关于这三个类的源码解析，见 [「4. 条件注解」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

## 2.5 fireAutoConfigurationImportEvents

`#fireAutoConfigurationImportEvents(List<String> configurations, Set<String> exclusions)` 方法，触发自动配置导入事件。代码如下：

```java
// AutoConfigurationImportSelector.java

private void fireAutoConfigurationImportEvents(List<String> configurations, Set<String> exclusions) {
    // 获得 AutoConfigurationImportListener 数组
    List<AutoConfigurationImportListener> listeners = getAutoConfigurationImportListeners();
    // 如果非空，则触发事件
    if (!listeners.isEmpty()) {
        // 创建 AutoConfigurationImportEvent 事件
        AutoConfigurationImportEvent event = new AutoConfigurationImportEvent(this, configurations, exclusions);
        // 遍历 listeners 数组，逐个监听
        for (AutoConfigurationImportListener listener : listeners) {
            invokeAwareMethods(listener);
            listener.onAutoConfigurationImportEvent(event);
        }
    }
}
```

- 核心逻辑：遍历 `AutoConfigurationImportListener` 数组，逐个监听 `AutoConfigurationImportEvent` 事件。

- 那么，`AutoConfigurationImportListener` 数组有哪些呢？在 `META-INF/spring.factories` 文件中，定义在 `org.springframework.boot.autoconfigure.AutoConfigurationImportListener` 配置项。如下图所示：![AutoConfigurationImportListener](Spring Boot 自动配置源码解析.assets/03.png)

  - 一共有 ConditionEvaluationReportAutoConfigurationImportListener 一个。

- 关于 ConditionEvaluationReportAutoConfigurationImportListener 的源码解析，见 [「5. ConditionEvaluationReportAutoConfigurationImportListener」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

# 3. AutoConfigurationMetadataLoader

`org.springframework.boot.autoconfigure.AutoConfigurationMetadataLoader` ，自动配置的元数据加载器。

## 3.1 构造方法

```java
// AutoConfigurationMetadataLoader.java

protected static final String PATH = "META-INF/spring-autoconfigure-metadata.properties";
```

- `PATH` 静态属性，从 `META-INF/spring-autoconfigure-metadata.properties` 路径，加载自动配置的元数据。

## 3.2 loadMetadata

`#loadMetadata(ClassLoader classLoader)` 方法，加载自动配置的元数据。代码如下：

```java
// AutoConfigurationMetadataLoader.java

static AutoConfigurationMetadata loadMetadata(ClassLoader classLoader) {
    return loadMetadata(classLoader, PATH);
}

static AutoConfigurationMetadata loadMetadata(ClassLoader classLoader, String path) {
    try {
        // 获得指定路径 path 的 URL 数组
        Enumeration<URL> urls = (classLoader != null) ? classLoader.getResources(path) : ClassLoader.getSystemResources(path);
        // 创建 Properties 属性
        Properties properties = new Properties();
        // 遍历 URL 数组
        while (urls.hasMoreElements()) {
            // 加载 URL 对应的资源，添加到 properties 中
            URL url = urls.nextElement();
            Properties props = PropertiesLoaderUtils.loadProperties(new UrlResource(url));
            properties.putAll(props);
        }
        // 创建 PropertiesAutoConfigurationMetadata 对象
        return loadMetadata(properties);
    } catch (IOException ex) {
        throw new IllegalArgumentException("Unable to load @ConditionalOnClass location [" + path + "]", ex);
    }
}

static AutoConfigurationMetadata loadMetadata(Properties properties) {
    return new PropertiesAutoConfigurationMetadata(properties);
}
```

- 核心逻辑：从 `META-INF/spring-autoconfigure-metadata.properties` 路径，加载自动配置的元数据，并创建成 PropertiesAutoConfigurationMetadata 对象。

- 那么，`META-INF/spring-autoconfigure-metadata.properties` 文件里面是什么呢？我们来打开一个看看。如下图所示：![spring-autoconfigure-metadata.properties](Spring Boot 自动配置源码解析.assets/04.png)

  - 格式为：`自动配置类名.条件

2025-08-25 13:10:56,608 - evaluation_logger_Attraction-44 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any information about trending museums in Sydney.'}
2025-08-25 13:11:02,777 - evaluation_logger_Attraction-44 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:11:02,777 - evaluation_logger_Attraction-44 - INFO - Message: Success.
2025-08-25 13:11:02,777 - evaluation_logger_Attraction-44 - INFO - Success turn num = 2
2025-08-25 13:11:02,777 - evaluation_logger_Attraction-44 - INFO - ----------------------------------------------------------------------------------------------------
