2025-08-25 13:07:23,872 - evaluation_logger_Attraction-96 - INFO - Test Example Attraction-96
2025-08-25 13:07:23,872 - evaluation_logger_Attraction-96 - INFO - Query: With the 2024 Christmas holiday coming up, I'm planning a budget trip to Shanghai. Help me find the three cheapest sightseeing options in Shanghai during that time and check ticket availability for December 25.
2025-08-25 13:07:31,296 - evaluation_logger_Attraction-96 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Shanghai"
        }
    }
]

2025-08-25 13:07:31,296 - evaluation_logger_Attraction-96 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Shanghai"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xOTI0NDY1fQ==",
            "sortBy": "lowest_price"
        }
    }
]

2025-08-25 13:07:31,296 - evaluation_logger_Attraction-96 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Shanghai'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Shanghai'}}
2025-08-25 13:07:31,296 - evaluation_logger_Attraction-96 - INFO - Rule-based compare success.
2025-08-25 13:07:31,296 - evaluation_logger_Attraction-96 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Shanghai'}}]
2025-08-25 13:07:31,296 - evaluation_logger_Attraction-96 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJYZXEzR0N1MXhyIiwidWZpIjotMTkyNDQ2NX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Shanghai Private Transfer from Shanghai central to Shanghai Hongqiao Airport",
                    "productId": "PRXeq3GCu1xr",
                    "productSlug": "prxeq3gcu1xr-shanghai-private-transfer-from-shanghai-central-to-shanghai-hongqia",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -1924465,
                    "cityName": "Shanghai",
                    "countryCode": "cn"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJTd2FvOEhvWnRFIiwidWZpIjotMTkyNDQ2NX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Shanghai Private Transfer from Shanghai Airport (SHA) to central Shanghai",
                    "productId": "PRSwao8HoZtE",
                    "productSlug": "prswao8hozte-shanghai-private-transfer-from-shanghai-airport-sha-to-central-shan",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -1924465,
                    "cityName": "Shanghai",
                    "countryCode": "cn"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJjNU8yaUphcUVlIiwidWZpIjotMTkyNDQ2NX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Shanghai Hotel to Shanghai Pudong Airport (PVG)",
                    "productId": "PRc5O2iJaqEe",
                    "productSlug": "prc5o2ijaqee-shanghai-hotel-to-shanghai-pudong-airport-pvg",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -1924465,
                    "cityName": "Shanghai",
                    "countryCode": "cn"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFIySHlBQUo4bFFDIiwidWZpIjotMTkyNDQ2NX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Special Shanghai Tour:Modern Art Shanghai Tour",
                    "productId": "PR2HyAAJ8lQC",
                    "productSlug": "pr2hyaaj8lqc-special-shanghai-tourmodern-art-shanghai-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -1924465,
                    "cityName": "Shanghai",
                    "countryCode": "cn"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJwaTlhcnVGQkRIIiwidWZpIjotMTkyNDQ2NX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Shanghai Private Transfer from Shanghai Pudong Airport (PVG) to central Shanghai",
                    "productId": "PRpi9aruFBDH",
                    "productSlug": "prpi9arufbdh-shanghai-private-transfer-from-shanghai-pudong-airport-pvg-to-centr",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -1924465,
                    "cityName": "Shanghai",
                    "countryCode": "cn"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0xOTI0NDY1fQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -1924465,
                    "country": "China",
                    "cityName": "Shanghai",
                    "productCount": 1145,
                    "cc1": "cn"
                }
            ]
        }
    }
]

2025-08-25 13:07:42,005 - evaluation_logger_Attraction-96 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xOTI0NDY1fQ==",
            "sortBy": "lowest_price"
        }
    }
]

2025-08-25 13:07:42,005 - evaluation_logger_Attraction-96 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xOTI0NDY1fQ==",
            "sortBy": "lowest_price"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prk6elz3lkqt-shanghai-data-esim-05gbdaily-to-20gb-30dayvpn-included",
            "date": "2024-12-25"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prhtfjq81a2b-walk-along-suzhou-canal",
            "date": "2024-12-25"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "pr3ki68nwq4u-french-concession-audio-tour",
            "date": "2024-12-25"
        }
    }
]

2025-08-25 13:07:42,005 - evaluation_logger_Attraction-96 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xOTI0NDY1fQ==', 'sortBy': 'lowest_price'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xOTI0NDY1fQ==', 'sortBy': 'lowest_price'}}
2025-08-25 13:07:42,005 - evaluation_logger_Attraction-96 - INFO - Rule-based compare success.
2025-08-25 13:07:42,005 - evaluation_logger_Attraction-96 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xOTI0NDY1fQ==', 'sortBy': 'lowest_price'}}]
2025-08-25 13:07:42,005 - evaluation_logger_Attraction-96 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PRK6ElZ3lKqT",
                    "name": "Shanghai Data eSIM: 0.5GB/Daily to 20GB-30Day(VPN INCLUDED)",
                    "slug": "prk6elz3lkqt-shanghai-data-esim-05gbdaily-to-20gb-30dayvpn-included",
                    "shortDescription": "Get your hands on the magical eSIM & enjoy advantages over traditional SIM cards. \n\nWe offer the ...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 3.11,
                        "currency": "USD",
                        "publicAmount": 3.11
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4,
                            "total": 1
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Shanghai",
                        "ufi": -1924465
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIjqm3NxfL4a"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIjkf1pwMM9h"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIVBQm72Sa2c"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4bUmtN1MYV"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6t7Gwf3M3U"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRHTfjq81a2B",
                    "name": "Walk along Suzhou Canal",
                    "slug": "prhtfjq81a2b-walk-along-suzhou-canal",
                    "shortDescription": "Recently redeveloped, the banks of the Suzhou Greek are indeed one of the most pleasant places in...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 8,
                        "currency": "USD",
                        "publicAmount": 8
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Shanghai",
                        "ufi": -1924465
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIry19Cnl7Ip"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINTOFwW7782"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbzXqcvD7pQ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIjWvPh82VVi"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIv4yojNzuOn"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PR3KI68Nwq4u",
                    "name": "The History of the French Concession: A Self-Guided Audio Tour",
                    "slug": "pr3ki68nwq4u-french-concession-audio-tour",
                    "shortDescription": "IMPORTANT: In China, there is a GPS offset that makes your position on Google and Apple maps inco...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 9.99,
                        "currency": "USD",
                        "publicAmount": 9.99
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 1,
                        "percentage": "100%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 5,
                            "total": 2
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Shanghai",
                        "ufi": -1924465
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGUSius9v19"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRqN6ePh2uDQ",
                    "name": "Shanghai Yu Garden Ticket Booking",
                    "slug": "prqn6eph2udq-shanghai-yu-garden-ticket-booking",
                    "shortDescription": "Yu Garden is a famous ancient private garden that was built in Ming Dynasty (1368-1644) with a hi...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 14,
                        "currency": "USD",
                        "publicAmount": 14
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 3.4,
                            "total": 8
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Shanghai",
                        "ufi": -1924465
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIrJrhL9lZog"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZS25bzaawc"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIHByzKDvoGB"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRwsngfgd6Tn",
                    "name": "Shanghai Yu Garden Entrance Tickets Reservation Service",
                    "slug": "prwsngfgd6tn-private-day-trip-tongli-water-town-from-shanghai-with-lunch",
                    "shortDescription": "Book online in advance and enter the beautiful Shanghai Yu garden with the QR code (provided by t...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 17,
                        "currency": "USD",
                        "publicAmount": 17
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Shanghai",
                        "ufi": -1924465
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIhqwsnRhc9o"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIeHQ7ip1ZaN"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OII1LaSUxhpO"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRuwjPOqHL3"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 1116,
                "filteredProductCount": 1116
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 85
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums, arts & culture",
                        "tagname": "museums-arts-culture",
                        "productCount": 57
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 14
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 13
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Food & drinks",
                        "tagname": "food-drinks",
                        "productCount": 12
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 1056
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Shanghai",
                        "tagname": "-1924465",
                        "productCount": 1114
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Chedun",
                        "tagname": "-1900277",
                        "productCount": 1
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Jiwang",
                        "tagname": "-1913127",
                        "productCount": 1
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 10
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 24
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 91
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 92
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 899
                    }
                ]
            }
        }
    }
]

2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prk6elz3lkqt-shanghai-data-esim-05gbdaily-to-20gb-30dayvpn-included",
            "date": "2024-12-25"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prhtfjq81a2b-walk-along-suzhou-canal",
            "date": "2024-12-25"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "pr3ki68nwq4u-french-concession-audio-tour",
            "date": "2024-12-25"
        }
    }
]

2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-12-25",
            "slug": "prk6elz3lkqt-shanghai-data-esim-05gbdaily-to-20gb-30dayvpn-included"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-12-25",
            "slug": "prhtfjq81a2b-walk-along-suzhou-canal"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-12-25",
            "slug": "pr3ki68nwq4u-french-concession-audio-tour"
        }
    }
]

2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'prk6elz3lkqt-shanghai-data-esim-05gbdaily-to-20gb-30dayvpn-included'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'prk6elz3lkqt-shanghai-data-esim-05gbdaily-to-20gb-30dayvpn-included'}}
2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Rule-based compare success.
2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'prhtfjq81a2b-walk-along-suzhou-canal'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'prhtfjq81a2b-walk-along-suzhou-canal'}}
2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Rule-based compare success.
2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'pr3ki68nwq4u-french-concession-audio-tour'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'pr3ki68nwq4u-french-concession-audio-tour'}}
2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Rule-based compare success.
2025-08-25 13:07:54,558 - evaluation_logger_Attraction-96 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'prk6elz3lkqt-shanghai-data-esim-05gbdaily-to-20gb-30dayvpn-included'}}, {'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'prhtfjq81a2b-walk-along-suzhou-canal'}}, {'name': 'Get_Availability', 'arguments': {'date': '2024-12-25', 'slug': 'pr3ki68nwq4u-french-concession-audio-tour'}}]
2025-08-25 13:07:54,559 - evaluation_logger_Attraction-96 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": true,
                "start": "2024-12-25T00:00:00+08:00",
                "timeSlotId": "ATS-PRK6ElZ3lKqT-202412250000-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Written guide",
                                "language": "en",
                                "type": "written"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFYqTkkI4kxI",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 1-100)"
                                },
                                "id": "ATO-7ec517db-d955-4138-90dd-a7b603828d18_PRK6ElZ3lKqT_20241225_0000",
                                "offerItemId": "OIqMELuT4k7F",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 2.87,
                                    "currency": "EUR",
                                    "publicAmount": 2.87
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 3.11,
                                    "currency": "USD",
                                    "publicAmount": 3.11
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "written"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Shanghai : 0.5GB/Daily-3D",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    },
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Written guide",
                                "language": "en",
                                "type": "written"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFiuvwNVEow6",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 1-100)"
                                },
                                "id": "ATO-6e5fc223-adb6-4d8a-a723-0b6ba8cf691c_PRK6ElZ3lKqT_20241225_0000",
                                "offerItemId": "OImRnPWABKI8",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 5.04,
                                    "currency": "EUR",
                                    "publicAmount": 5.04
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 5.46,
                                    "currency": "USD",
                                    "publicAmount": 5.46
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "written"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Shanghai : 0.5GB/Daily-5D",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    },
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Written guide",
                                "language": "en",
                                "type": "written"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OF42v59xR14F",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 1-100)"
                                },
                                "id": "ATO-93bd68fc-700e-4f43-8c26-6dbea0f622f8_PRK6ElZ3lKqT_20241225_0000",
                                "offerItemId": "OI7OVXfDsvXF",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 6.12,
                                    "currency": "EUR",
                                    "publicAmount": 6.12
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 6.63,
                                    "currency": "USD",
                                    "publicAmount": 6.63
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "written"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Shanghai : 5GB/Daily-2D",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    },
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Written guide",
                                "language": "en",
                                "type": "written"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFW0qWIFh7V8",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 1-100)"
                                },
                                "id": "ATO-c55f4a17-8174-42d7-bedd-dc66e53cdd97_PRK6ElZ3lKqT_20241225_0000",
                                "offerItemId": "OIjkf1pwMM9h",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 7.56,
                                    "currency": "EUR",
                                    "publicAmount": 7.56
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 8.19,
                                    "currency": "USD",
                                    "publicAmount": 8.19
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "written"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Shanghai : 0.5GB/Daily-8D",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    },
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Written guide",
                                "language": "en",
                                "type": "written"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFlc4zv9Vrl4",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 1-100)"
                                },
                                "id": "ATO-95908574-078b-4b2c-bdc7-93ea09972079_PRK6ElZ3lKqT_20241225_0000",
                                "offerItemId": "OIUso3qtm3ea",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 9,
                                    "currency": "EUR",
                                    "publicAmount": 9
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 9.74,
                                    "currency": "USD",
                                    "publicAmount": 9.74
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "written"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Shanghai :0.5GB/Daily-10D",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    },
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-25T08:30:00+08:00",
                "timeSlotId": "ATS-PRHTfjq81a2B-202412250830-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Audio guide",
                                "language": "en",
                                "type": "audio"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Written guide",
                                "language": "en",
                                "type": "written"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFETyXPBzItU",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 70-90)"
                                },
                                "id": "ATO-008389e7-d0f7-4a93-870f-578592079cab_PRHTfjq81a2B_20241225_0830",
                                "offerItemId": "OIv4yojNzuOn",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 8,
                                    "currency": "USD",
                                    "publicAmount": 8
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "audio"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 70-90)"
                                },
                                "id": "ATO-00d7f1b3-440f-4244-9926-6f157d6ac4e9_PRHTfjq81a2B_20241225_0830",
                                "offerItemId": "OIv4yojNzuOn",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 8,
                                    "currency": "USD",
                                    "publicAmount": 8
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "written"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 18-22)"
                                },
                                "id": "ATO-f3922f2a-0cc0-4fbf-8e11-bc668cdf365e_PRHTfjq81a2B_20241225_0830",
                                "offerItemId": "OINTOFwW7782",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 8,
                                    "currency": "USD",
                                    "publicAmount": 8
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "written"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Child"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 70-90)"
                                },
                                "id": "ATO-9533e375-3c68-4f8f-ae81-a203b5bbbc49_PRHTfjq81a2B_20241225_0830",
                                "offerItemId": "OIv4yojNzuOn",
                                "type": "senior",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 8,
                                    "currency": "USD",
                                    "publicAmount": 8
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Senior"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 23-69)"
                                },
                                "id": "ATO-49e74496-02b8-4f7e-87cf-ebed34da2ec0_PRHTfjq81a2B_20241225_0830",
                                "offerItemId": "OIbzXqcvD7pQ",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 8,
                                    "currency": "USD",
                                    "publicAmount": 8
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Walk along Suzhou Canal",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": true,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    },
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": true,
                "start": "2024-12-25T00:00:00+08:00",
                "timeSlotId": "ATS-PR3KI68Nwq4u-202412250000-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Audio guide",
                                "language": "en",
                                "type": "audio"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFPDIqrvdMn9",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 6-99)"
                                },
                                "id": "ATO-b76cc585-e435-44a7-a776-61cab46f051c_PR3KI68Nwq4u_20241225_0000",
                                "offerItemId": "OIGUSius9v19",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 9.99,
                                    "currency": "USD",
                                    "publicAmount": 9.99
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "audio"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "The History of the French Concession: A Self-Guided Audio Tour",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:11:08,283 - evaluation_logger_Attraction-96 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring Boot 源码分析 —— 自动配置》](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/) 的**源码解析**。

在 Spring Boot 中，提供了 `@EnableAutoConfiguration` 注解，用于开启自动配置功能。`@EnableAutoConfiguration` 注解代码如下：

```java
// EnableAutoConfiguration.java

@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@AutoConfigurationPackage
@Import(AutoConfigurationImportSelector.class)
public @interface EnableAutoConfiguration {

	String ENABLED_OVERRIDE_PROPERTY = "spring.boot.enableautoconfiguration";

	/**
	 * Exclude specific auto-configuration classes such that they will never be applied.
	 * @return the classes to exclude
	 */
	Class<?>[] exclude() default {};

	/**
	 * Exclude specific auto-configuration class names such that they will never be
	 * applied.
	 * @return the class names to exclude
	 */
	String[] excludeName() default {};

}
```

- 注意，`@EnableAutoConfiguration` 注解上，有 `@Import(AutoConfigurationImportSelector.class)` 注解。关于 `@Import` 注解，可以看看 [《Spring 3.0 的新注解：@Import》](https://www.cnblogs.com/lcngu/p/5080702.html) 文章。

- 另外，`@EnableAutoConfiguration` 注解上，还有 `@AutoConfigurationPackage` 注解。它也是用于自动配置的功能，不过主要用于扫描注解的包。关于它，我们会在 [「3. @AutoConfigurationPackage」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 中详细解析。

# 2. AutoConfigurationImportSelector

`org.springframework.boot.autoconfigure.AutoConfigurationImportSelector` ，实现 DeferredImportSelector、BeanClassLoaderAware、ResourceLoaderAware、BeanFactoryAware、Ordered 接口，处理 `@EnableAutoConfiguration` 注解的导入。

## 2.1 构造方法

```java
// AutoConfigurationImportSelector.java

private static final String[] NO_IMPORTS = {};

private static final Log logger = LogFactory.getLog(AutoConfigurationImportSelector.class);

private static final String PROPERTY_NAME_AUTOCONFIGURE_EXCLUDE = "spring.autoconfigure.exclude";

private ConfigurableListableBeanFactory beanFactory;

private Environment environment;

private ClassLoader beanClassLoader;

private ResourceLoader resourceLoader;

/**
 * 创建 {@link AutoConfigurationEntry} 的集合。
 *
 * 在 {@link #selectImports(AnnotationMetadata)} 方法中，会调用到
 */
private ConfigurationClassFilter configurationClassFilter;
```

- `configurationClassFilter` 属性，创建 `AutoConfigurationEntry` 的集合。在 `#selectImports(AnnotationMetadata)` 方法中，会调用到。

## 2.2 selectImports

`#selectImports(AnnotationMetadata)` 方法，执行导入。代码如下：

```java
// AutoConfigurationImportSelector.java

@Override
public String[] selectImports(AnnotationMetadata annotationMetadata) {
    // <1> 判断自动配置开关是否打开
    if (!isEnabled(annotationMetadata)) {
        return NO_IMPORTS;
    }
    // <2> 获得自动配置的 AutoConfigurationEntry 对象
    AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(annotationMetadata);
    // <3> 返回符合条件的配置类的全类名数组
    return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());
}
```

- `<1>` 处，调用 `#isEnabled(AnnotationMetadata metadata)` 方法，判断自动配置开关是否打开。默认情况下，是开启的。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  protected boolean isEnabled(AnnotationMetadata metadata) {
  	if (getClass() == AutoConfigurationImportSelector.class) {
  		return getEnvironment().getProperty(EnableAutoConfiguration.ENABLED_OVERRIDE_PROPERTY, Boolean.class, true);
  	}
  	return true;
  }
  ```

- `<2>` 处，调用 `#getAutoConfigurationEntry(AnnotationMetadata annotationMetadata)` 方法，获得自动配置的 AutoConfigurationEntry 对象。详细解析，见 [「2.3 getAutoConfigurationEntry」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

- `<3>` 处，返回符合条件的配置类的全类名数组。

## 2.3 getAutoConfigurationEntry

`#getAutoConfigurationEntry(AnnotationMetadata annotationMetadata)` 方法，获得自动配置的 AutoConfigurationEntry 对象。代码如下：

```java
// AutoConfigurationImportSelector.java

protected AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) {
    // <1> 获得的是 @EnableAutoConfiguration 注解中的属性：exclude、excludeName
    if (!isEnabled(annotationMetadata)) {
        return EMPTY_ENTRY;
    }
    // <2> 获得注解的属性
    AnnotationAttributes attributes = getAttributes(annotationMetadata);
    // <3> 获得所有需要自动配置的配置类的全类名数组
    List<String> configurations = getCandidateConfigurations(annotationMetadata, attributes);
    // <4> 移除重复的配置类
    configurations = removeDuplicates(configurations);
    // <5> 获得需要排除的配置类。例如说，注解上的 exclude 和 excludeName 属性
    Set<String> exclusions = getExclusions(annotationMetadata, attributes);
    // <6> 校验需要排除的配置类是否合法
    checkExcludedClasses(configurations, exclusions);
    // <7> 从 configurations 中，移除需要排除的配置类
    configurations.removeAll(exclusions);
    // <8> 对 configurations 进行过滤，剔除掉 @Conditional 条件不匹配的配置类
    configurations = getConfigurationClassFilter().filter(configurations);
    // <9> 触发自动配置导入事件
    fireAutoConfigurationImportEvents(configurations, exclusions);
    // <10> 创建 AutoConfigurationEntry 对象
    return new AutoConfigurationEntry(configurations, exclusions);
}
```

- `<1>` 处，和 `#selectImports(AnnotationMetadata annotationMetadata)` 方法的 `<1>` 处，重复调用 `#isEnabled(AnnotationMetadata metadata)` 方法。因为，两个方法都覆写了，所以可能存在子类的情况。

- `<2>` 处，调用 `#getAttributes(AnnotationMetadata metadata)` 方法，获得注解的属性。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  protected AnnotationAttributes getAttributes(AnnotationMetadata metadata) {
      // 获得注解名
      String name = getAnnotationClass().getName();
      // 获得注解的属性
      AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(name, true));
      Assert.notNull(attributes, () -> "No auto-configuration attributes found. Is " + metadata.getClassName()
              + " annotated with " + ClassUtils.getShortName(name) + "?");
      return attributes;
  }
  
  protected Class<?> getAnnotationClass() {
      return EnableAutoConfiguration.class;
  }
  ```

  - 返回的是 `@EnableAutoConfiguration` 注解中的属性：`exclude`、`excludeName`。

- `<3>` 处，调用 `#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)` 方法，获得所有需要自动配置的配置类的全类名数组。详细解析，见 [「2.4 getCandidateConfigurations」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

- `<4>` 处，调用 `#removeDuplicates(List<?> list)` 方法，移除重复的配置类。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  protected final <T> List<T> removeDuplicates(List<T> list) {
  	return new ArrayList<>(new LinkedHashSet<>(list));
  }
  ```

- `<5>` 处，调用 `#getExclusions(AnnotationMetadata metadata, AnnotationAttributes attributes)` 方法，获得需要排除的配置类。例如说，注解上的 `exclude` 和 `excludeName` 属性。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  protected Set<String> getExclusions(AnnotationMetadata metadata, AnnotationAttributes attributes) {
      // 获得需要排除的配置类数组
      Set<String> excluded = new LinkedHashSet<>();
      // 从注解的 exclude 属性
      excluded.addAll(asList(attributes, "exclude"));
      // 从注解的 excludeName 属性
      excluded.addAll(Arrays.asList(attributes.getStringArray("excludeName")));
      // 从 `spring.autoconfigure.exclude` 配置项
      excluded.addAll(getExcludeAutoConfigurationsProperty());
      return excluded;
  }
  ```

- `<6>` 处，调用 `#checkExcludedClasses(List<String> configurations, Set<String> exclusions)` 方法，校验需要排除的配置类是否合法。代码如下：

  ```java
  // AutoConfigurationImportSelector.java
  
  private void checkExcludedClasses(List<String> configurations, Set<String> exclusions) {
  	List<String> invalidExcludes = new ArrayList<>(exclusions.size());
  	for (String exclusion : exclusions) {
  		if (ClassUtils.isPresent(exclusion, getClassLoader()) && !configurations.contains(exclusion)) {
  			invalidExcludes.add(exclusion);
  		}
  	}
  	if (!invalidExcludes.isEmpty()) {
  		handleInvalidExcludes(invalidExcludes);
  	}
  }
  
  /**
   * Handle any invalid excludes that have been specified.
   * @param invalidExcludes the list of invalid excludes (will always have at least one
   * element)
   */
  protected void handleInvalidExcludes(List<String> invalidExcludes) {
  	StringBuilder message = new StringBuilder();
  	for (String exclude : invalidExcludes) {
  		message.append("\t- ").append(exclude).append("\n");
  	}
  	throw new IllegalStateException("The following classes could not be excluded because they are"
  			+ " not auto-configuration classes:\n" + message);
  }
  ```

  - 如果排除的配置类不存在，或者不在 `configurations` 中，则会抛出 IllegalStateException 异常。

- `<7>` 处，从 `configurations` 中，移除需要排除的配置类。

- `<8>` 处，调用 `#getConfigurationClassFilter()` 方法，获得 `configurationClassFilter` 属性，然后调用 `ConfigurationClassFilter#filter(List<String> configurations)` 方法，对 `configurations` 进行过滤，剔除掉 `@Conditional` 条件不匹配的配置类。详细解析，见 [「2.5 ConfigurationClassFilter」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

- `<9>` 处，调用 `#fireAutoConfigurationImportEvents(List<String> configurations, Set<String> exclusions)` 方法，触发自动配置导入事件。详细解析，见 [「2.6 fireAutoConfigurationImportEvents」](http://svip.iocoder.cn/Spring-Boot/AutoConfiguration/#) 。

- `<10>` 处，创建 AutoConfigurationEntry 对象。

## 2.4 getCandidateConfigurations

`#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)` 方法，获得所有需要自动配置的配置类的全类名数组。代码如下：

```java
// AutoConfigurationImportSelector.java

protected List<String> getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) {
    // <1> 加载指定类型 EnableAutoConfiguration 对应的，在 `META-INF/spring.factories` 里的类名的数组
    List<String> configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(),
            getBeanClassLoader());
    // <2> 断言，判断是否非空
    Assert.notEmpty(configurations, "No auto configuration classes found in META-INF/spring.factories. If you "
            + "are using a custom packaging, make sure that file is correct.");
    return configurations;
}

protected Class<?> getSpringFactoriesLoaderFactoryClass() {
    return EnableAutoConfiguration.class;
}
```

- `<1>` 处，调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型 `EnableAutoConfiguration` 对应的，在 `META-INF/spring.factories` 里的类名的数组。

  - 在 `spring-boot-autoconfigure` 项目资源中的 `META-INF/spring.factories` 文件中，有一个 `org.springframework.boot.autoconfigure.EnableAutoConfiguration` 配置项，如下图所示：[![`org.springframework.boot.autoconfigure.EnableAutoConfiguration` 配置项](http://static.iocoder.cn/images/Spring-Boot/2021-01-07/01.jpg)](http://static.iocoder.cn/images/Spring-Boot/2021-01-07/01.jpg)`org.springframework.boot.autoconfigure.EnableAutoConfiguration` 配置项

- `<2>` 处，断言，判断是否非空。

## 2.5 ConfigurationClassFilter

ConfigurationClassFilter 是 AutoConfigurationImportSelector 的内部类，负责对配置类进行过滤。

### 2.5.1 构造方法

```java
// AutoConfigurationImportSelector.java

private ConfigurationClassFilter configurationClassFilter;

private ConfigurationClassFilter getConfigurationClassFilter() {
    if (this.configurationClassFilter == null) {
        // 获得所有 AutoConfigurationImportFilter 对应的，在 `META-INF/spring.factories` 里的类名的数组
        List<AutoConfigurationImportFilter> filters = getAutoConfigurationImportFilters();
        for (AutoConfigurationImportFilter filter : filters) {
            // 初始化
            invokeAwareMethods(filter);
        }
        // 创建 ConfigurationClassFilter 对象
        this.configurationClassFilter = new ConfigurationClassFilter(this.beanClassLoader, filters);
    }
    return this.configurationClassFilter;
}

/**
 * 获得所有 AutoConfigurationImportFilter 对应的，在 `META-INF/spring.factories` 里的类名的数组
 */
protected List<AutoConfigurationImportFilter> getAutoConfigurationImportFilters() {
    return SpringFactoriesLoader.loadFactories(AutoConfigurationImportFilter.class, this.beanClassLoader);
}

/**
 * 调用 Aware 相关接口的方法，进行初始化
 */
private void invokeAwareMethods(Object instance) {
    if (instance instanceof Aware) {
        if (instance instanceof BeanClassLoaderAware) {
            ((BeanClassLoaderAware) instance).setBeanClassLoader(this.beanClassLoader);
        }
        if (instance instanceof BeanFactoryAware) {
            ((BeanFactoryAware) instance).setBeanFactory(this.beanFactory);
        }
        if (instance instanceof EnvironmentAware) {
            ((EnvironmentAware) instance).setEnvironment(this.environment);
        }
        if (instance instanceof ResourceLoaderAware) {
            ((ResourceLoaderAware) instance).setResourceLoader(this.resourceLoader);
        }
    }
}
```

- 在 `spring-boot-autoconfigure` 项目资源中的 `META-INF/spring.factories` 文件中，`org.springframework.boot.autoconfigure.AutoConfigurationImportFilter` 配置项，如下图所示：[![`org.springframework.boot.autoconfigure.AutoConfigurationImportFilter` 配置项](http://static.iocoder.cn/images/Spring-Boot/2021-01-07/02.jpg)](http://static.iocoder.cn/images/Spring-Boot/2021-01-07/02.jpg)`org.springframework.boot.autoconfigure.AutoConfigurationImportFilter` 配置项

  - 这三个 Filter 的具体实现，我们就不去细看了。简单来说，就是通过 `@Conditional` 条件注解，来判断配置类是否匹配。

### 2.5.2 filter

`#filter(List<String> configurations)` 方法，执行过滤。代码如下：

```java
// AutoConfigurationImportSelector#ConfigurationClassFilter.java

List<String> filter(List<String> configurations) {
    // 初始化
    long startTime = System.nanoTime();
    // 转换成数组
    String[] candidates = StringUtils.toStringArray(configurations);
    // 标记，是否跳过。默认为 false
    boolean[] skip = new boolean[candidates.length];
    boolean skipped = false;
    // 遍历AutoConfigurationImportFilter 数组，逐个匹配
    for (AutoConfigurationImportFilter filter : this.filters) {
        // 执行匹配
        invokeAwareMethods(filter);
        // 匹配，结果返回 match 数组
        boolean[] match = filter.match(candidates, this.autoConfigurationMetadata);
        // 遍历 match 数组
        for (int i = 0; i < match.length; i++) {
            // 如果不匹配，则标记 skip 为 true ，标记 skipped 为 true
            if (!match[i]) {
                skip[i] = true;
                candidates[i] = null;
                skipped = true;
            }
        }
    }
    // 如果未跳过任何配置类，直接返回 configurations
    if (!skipped) {
        return configurations;
    }
    // 如果跳过了部分，则创建 result 数组，将未跳过的添加其中
    List<String> result = new ArrayList<>(candidates.length);
    for (int i = 0; i < candidates.length; i++) {
        if (!skip[i]) {
            result.add(candidates[i]);
        }
    }
    // 打印日志
    if (logger.isTraceEnabled()) {
        int numberFiltered = configurations.size() - result.size();
        logger.trace("Filtered " + numberFiltered + " auto configuration class in "
                + TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime) + " ms");
    }
    // 返回
    return result;
}
```

## 2.6 fireAutoConfigurationImportEvents

`#fireAutoConfigurationImportEvents(List<String> configurations, Set<String> exclusions)` 方法，触发自动配置导入事件。代码如下：

```java
// AutoConfigurationImportSelector.java

private void fireAutoConfigurationImportEvents(List<String> configurations, Set<String> exclusions) {
    // 获得 AutoConfigurationImportListener 数组
    List<AutoConfigurationImportListener> listeners = getAutoConfigurationImportListeners();
    // 如果非空，则触发事件
    if (!listeners.isEmpty()) {
        // 创建 AutoConfigurationImportEvent 事件
        AutoConfigurationImportEvent event = new AutoConfigurationImportEvent(this, configurations, exclusions);
        // 遍历 listeners 数组
        for (AutoConfigurationImportListener listener : listeners) {
            // 设置属性
            invokeAwareMethods(listener);
            // 触发事件
            listener.onAutoConfigurationImportEvent(event);
        }
    }
}

/**
 * 获得 AutoConfigurationImportListener 数组
 */
protected List<AutoConfigurationImportListener> getAutoConfiguration

2025-08-25 13:11:15,003 - evaluation_logger_Attraction-96 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about the cheapest sightseeing options in Shanghai or ticket availability for December 25.'}
2025-08-25 13:11:21,142 - evaluation_logger_Attraction-96 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:11:21,142 - evaluation_logger_Attraction-96 - INFO - Message: Success.
2025-08-25 13:11:21,142 - evaluation_logger_Attraction-96 - INFO - Success turn num = 3
2025-08-25 13:11:21,142 - evaluation_logger_Attraction-96 - INFO - ----------------------------------------------------------------------------------------------------
