2025-08-25 12:35:19,297 - evaluation_logger_Hotels-30 - INFO - Test Example Hotels-30
2025-08-25 12:35:19,298 - evaluation_logger_Hotels-30 - INFO - Query: My family and I are planning a trip to Tokyo from November 10th to November 20th, 2024. We want to find a hotel within 20 kilometers of Tokyo Tower, with a budget between 200 and 300 USD. Could you check the user reviews of all the satisfying hotels?
2025-08-25 12:35:28,643 - evaluation_logger_Hotels-30 - INFO - Function Calls: 
[
    {
        "name": "Location_to_Lat_Long",
        "arguments": {
            "query": "Tokyo Tower"
        }
    }
]

2025-08-25 12:35:28,644 - evaluation_logger_Hotels-30 - INFO - Golden Function Call: 
[
    {
        "name": "Location_to_Lat_Long",
        "arguments": {
            "query": "Tokyo Tower"
        }
    },
    {
        "name": "Search_Hotels_By_Coordinates",
        "arguments": {
            "latitude": "35.6585805",
            "longitude": "139.7454329",
            "arrival_date": "2024-11-10",
            "departure_date": "2024-11-20",
            "price_min": 200,
            "price_max": 300,
            "radius": 20
        }
    }
]

2025-08-25 12:35:28,644 - evaluation_logger_Hotels-30 - INFO - Start compare_single_call: 
{'name': 'Location_to_Lat_Long', 'arguments': {'query': 'Tokyo Tower'}}
{'name': 'Location_to_Lat_Long', 'arguments': {'query': 'Tokyo Tower'}}
2025-08-25 12:35:28,644 - evaluation_logger_Hotels-30 - INFO - Rule-based compare success.
2025-08-25 12:35:28,644 - evaluation_logger_Hotels-30 - INFO - Success matched: [{'name': 'Location_to_Lat_Long', 'arguments': {'query': 'Tokyo Tower'}}]
2025-08-25 12:35:28,644 - evaluation_logger_Hotels-30 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "business_status": "OPERATIONAL",
                "formatted_address": "4 Chome-2-8 Shibakoen, Minato City, Tokyo 105-0011, Japan",
                "geometry": {
                    "location": {
                        "lat": 35.6585805,
                        "lng": 139.7454329
                    },
                    "viewport": {
                        "northeast": {
                            "lat": 35.66031637989272,
                            "lng": 139.7469715298927
                        },
                        "southwest": {
                            "lat": 35.65761672010728,
                            "lng": 139.7442718701072
                        }
                    }
                },
                "name": "Tokyo Tower",
                "opening_hours": {
                    "open_now": true
                },
                "place_id": "ChIJCewJkL2LGGAR3Qmk0vCTGkg",
                "plus_code": {
                    "compound_code": "MP5W+C5 Minato City, Tokyo, Japan",
                    "global_code": "8Q7XMP5W+C5"
                },
                "rating": 4.5,
                "reference": "ChIJCewJkL2LGGAR3Qmk0vCTGkg",
                "types": [
                    "art_gallery",
                    "tourist_attraction",
                    "shopping_mall",
                    "landmark",
                    "point_of_interest",
                    "establishment"
                ],
                "user_ratings_total": 77508
            }
        ]
    }
]

2025-08-25 12:35:40,312 - evaluation_logger_Hotels-30 - INFO - Function Calls: 
[
    {
        "name": "Search_Hotels_By_Coordinates",
        "arguments": {
            "latitude": "35.6585805",
            "longitude": "139.7454329",
            "arrival_date": "2024-11-10",
            "departure_date": "2024-11-20",
            "radius": 20,
            "price_min": 200,
            "price_max": 300
        }
    }
]

2025-08-25 12:35:40,313 - evaluation_logger_Hotels-30 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Hotels_By_Coordinates",
        "arguments": {
            "arrival_date": "2024-11-10",
            "departure_date": "2024-11-20",
            "latitude": "35.6585805",
            "longitude": "139.7454329",
            "price_max": 300,
            "price_min": 200,
            "radius": 20
        }
    },
    {
        "name": "Get_Hotel_Reviews(Tips)",
        "arguments": {
            "hotel_id": "11393900"
        }
    },
    {
        "name": "Get_Hotel_Reviews(Tips)",
        "arguments": {
            "hotel_id": "2518958"
        }
    }
]

2025-08-25 12:35:40,313 - evaluation_logger_Hotels-30 - INFO - Start compare_single_call: 
{'name': 'Search_Hotels_By_Coordinates', 'arguments': {'arrival_date': '2024-11-10', 'departure_date': '2024-11-20', 'latitude': '35.6585805', 'longitude': '139.7454329', 'price_max': 300, 'price_min': 200, 'radius': 20}}
{'name': 'Search_Hotels_By_Coordinates', 'arguments': {'arrival_date': '2024-11-10', 'departure_date': '2024-11-20', 'latitude': '35.6585805', 'longitude': '139.7454329', 'price_max': 300, 'price_min': 200, 'radius': 20}}
2025-08-25 12:35:40,313 - evaluation_logger_Hotels-30 - INFO - Rule-based compare success.
2025-08-25 12:35:40,313 - evaluation_logger_Hotels-30 - INFO - Success matched: [{'name': 'Search_Hotels_By_Coordinates', 'arguments': {'arrival_date': '2024-11-10', 'departure_date': '2024-11-20', 'latitude': '35.6585805', 'longitude': '139.7454329', 'price_max': 300, 'price_min': 200, 'radius': 20}}]
2025-08-25 12:35:40,313 - evaluation_logger_Hotels-30 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "b_max_los_data": {
                "is_fullon": 0,
                "default_los": 30,
                "has_extended_los": 1,
                "extended_los": 90,
                "max_allowed_los": 90,
                "experiment": "long_stays_ios_extend_los_3"
            },
            "unfiltered_count": 6742,
            "filters": [
                {
                    "field": "price",
                    "title": "Your budget (for 10 nights)"
                },
                {
                    "field": "tdb",
                    "title": "Bed preference"
                },
                {
                    "field": "roomfacility",
                    "title": "Room facilities"
                },
                {
                    "title": "Free cancellation ",
                    "field": "fc"
                },
                {
                    "title": "Online payment",
                    "field": "pmt"
                }
            ],
            "primary_count": 2,
            "extended_count": 0,
            "result": [
                {
                    "hotel_id": 11393900,
                    "is_tpi_exclusive_property": 0,
                    "countrycode": "jp",
                    "genius_discount_percentage": 0,
                    "city": "Kawasaki",
                    "ufi": -233143,
                    "class": 2,
                    "last_reservation_data": {
                        "last_reservation_ellapsed_months": 1
                    },
                    "hotel_name_trans": "Hotel Plus Hostel TOKYO KAWASAKI",
                    "default_language": "ja",
                    "accommodation_type": 203,
                    "checkout": {
                        "until": "11:00"
                    },
                    "type": "property_card",
                    "min_total_price": 34425.55,
                    "is_no_prepayment_block": 0,
                    "currencycode": "JPY",
                    "hotel_name": "Hotel Plus Hostel TOKYO KAWASAKI",
                    "id": "property_card_11393900",
                    "city_in_trans": "in Kawasaki",
                    "longitude": 139.698557613492,
                    "timezone": "Asia/Tokyo",
                    "is_free_cancellable": 0,
                    "review_score_word": "Good",
                    "is_geo_rate": 1,
                    "unit_configuration_label": "<b>Bed in dormitory</b>: 1 bed",
                    "preferred_plus": 0,
                    "soldout": 0,
                    "class_is_estimated": 0,
                    "extended": 0,
                    "bwallet": {
                        "hotel_eligibility": 0
                    },
                    "composite_price_breakdown": {
                        "items": [
                            {
                                "item_amount": {
                                    "value": 0,
                                    "amount_rounded": "US$0",
                                    "currency": "USD",
                                    "amount_unrounded": "US$0"
                                },
                                "name": "City tax",
                                "details": "0 % City tax",
                                "base": {
                                    "kind": "percentage",
                                    "percentage": 0
                                },
                                "kind": "charge",
                                "inclusion_type": "included"
                            },
                            {
                                "name": "VAT",
                                "details": "10 % VAT",
                                "item_amount": {
                                    "amount_unrounded": "US$22.24",
                                    "amount_rounded": "US$22",
                                    "value": 22.2386469589147,
                                    "currency": "USD"
                                },
                                "kind": "charge",
                                "inclusion_type": "included",
                                "base": {
                                    "percentage": 10,
                                    "kind": "percentage"
                                }
                            },
                            {
                                "details": "You’re getting a reduced rate because Booking.com is paying part of the price.",
                                "base": {
                                    "kind": "bsb"
                                },
                                "identifier": "BSB",
                                "kind": "discount",
                                "item_amount": {
                                    "currency": "USD",
                                    "amount_rounded": "US$20",
                                    "value": 19.5700328586411,
                                    "amount_unrounded": "US$19.57"
                                },
                                "name": "Booking.com pays"
                            },
                            {
                                "details": "You’re getting a reduced rate because this property is offering a discount.",
                                "kind": "discount",
                                "identifier": "last-minute-deal",
                                "base": {
                                    "kind": "rate"
                                },
                                "name": "Last-minute Deal",
                                "item_amount": {
                                    "currency": "USD",
                                    "value": 12.8749717265119,
                                    "amount_rounded": "US$13",
                                    "amount_unrounded": "US$12.87"
                                }
                            }
                        ],
                        "all_inclusive_amount": {
                            "currency": "USD",
                            "value": 225.055083689421,
                            "amount_rounded": "US$225",
                            "amount_unrounded": "US$225.06"
                        },
                        "price_display_config": [
                            {
                                "value": 0,
                                "key": "use_nightly_prices"
                            }
                        ],
                        "gross_amount_hotel_currency": {
                            "currency": "JPY",
                            "amount_rounded": "¥34,426",
                            "value": 34425.55,
                            "amount_unrounded": "¥34,426"
                        },
                        "charges_details": {
                            "mode": "all_included",
                            "amount": {
                                "currency": "USD",
                                "value": 0
                            }
                        },
                        "has_long_stays_monthly_rate_price": 0,
                        "strikethrough_amount": {
                            "amount_rounded": "US$258",
                            "value": 257.500088274574,
                            "currency": "USD",
                            "amount_unrounded": "US$257.50"
                        },
                        "all_inclusive_amount_hotel_currency": {
                            "currency": "JPY",
                            "amount_rounded": "¥34,426",
                            "value": 34425.55,
                            "amount_unrounded": "¥34,426"
                        },
                        "has_long_stays_weekly_rate_price": 0,
                        "excluded_amount": {
                            "currency": "USD",
                            "amount_rounded": "US$0",
                            "value": 0,
                            "amount_unrounded": "US$0"
                        },
                        "gross_amount_per_night": {
                            "amount_rounded": "US$23",
                            "value": 22.5055083689421,
                            "currency": "USD",
                            "amount_unrounded": "US$22.51"
                        },
                        "client_translations": {
                            "tooltip_total_text": "Total"
                        },
                        "gross_amount": {
                            "currency": "USD",
                            "value": 225.055083689421,
                            "amount_rounded": "US$225",
                            "amount_unrounded": "US$225.06"
                        },
                        "net_amount": {
                            "currency": "USD",
                            "value": 202.816436730506,
                            "amount_rounded": "US$203",
                            "amount_unrounded": "US$202.82"
                        },
                        "discounted_amount": {
                            "amount_unrounded": "US$32.45",
                            "amount_rounded": "US$32",
                            "value": 32.445004585153,
                            "currency": "USD"
                        },
                        "strikethrough_amount_per_night": {
                            "amount_unrounded": "US$25.75",
                            "amount_rounded": "US$26",
                            "value": 25.7500088274574,
                            "currency": "USD"
                        },
                        "included_taxes_and_charges_amount": {
                            "amount_unrounded": "US$22.24",
                            "currency": "USD",
                            "value": 22.2386469589147,
                            "amount_rounded": "US$22"
                        }
                    },
                    "default_wishlist_name": "Kawasaki",
                    "review_score": 7.6,
                    "review_nr": 710,
                    "block_ids": [
                        "1139390001_386822059_0_0_0"
                    ],
                    "latitude": 35.527040398756,
                    "is_smart_deal": 0,
                    "checkin": {
                        "from": "15:00",
                        "until": "00:00"
                    },
                    "main_photo_id": 537662745,
                    "preferred": 1,
                    "hotel_include_breakfast": 0,
                    "is_genius_deal": 0,
                    "hotel_has_vb_boost": 0
                },
                {
                    "hotel_id": 2518958,
                    "min_total_price": 36000,
                    "is_no_prepayment_block": 1,
                    "badges": [
                        {
                            "text": "Mobile-only price",
                            "badge_variant": "constructive",
                            "id": "Mobile Rate"
                        }
                    ],
                    "checkout": {
                        "until": "10:00",
                        "from": "07:00"
                    },
                    "accommodation_type": 216,
                    "hotel_name_trans": "\"Cherry House\" is Direct to Narita,Haneda AP, Disney, Asakusa, Skytree Tower, Tokyo",
                    "default_language": "ja",
                    "type": "property_card",
                    "booking_home": {
                        "quality_class": 0,
                        "segment": 0,
                        "group": "hotels_and_others",
                        "is_booking_home": 1
                    },
                    "city_in_trans": "in Matsudo",
                    "currencycode": "JPY",
                    "id": "property_card_2518958",
                    "hotel_name": "\"Cherry House\" is Direct to Narita,Haneda AP, Disney, Asakusa, Skytree Tower, Tokyo",
                    "countrycode": "jp",
                    "is_tpi_exclusive_property": 0,
                    "ufi": -235889,
                    "city": "Matsudo",
                    "last_reservation_data": {
                        "last_reservation_ellapsed_months": 1
                    },
                    "class": 2,
                    "genius_discount_percentage": 0,
                    "bwallet": {
                        "hotel_eligibility": 0
                    },
                    "composite_price_breakdown": {
                        "benefits": [
                            {
                                "kind": "badge",
                                "badge_variant": "constructive",
                                "identifier": "mobile-rate",
                                "details": "You’re getting a reduced rate compared to the rate available on a computer or laptop.",
                                "name": "Mobile-only price"
                            }
                        ],
                        "price_display_config": [
                            {
                                "key": "use_nightly_prices",
                                "value": 0
                            }
                        ],
                        "items": [
                            {
                                "kind": "charge",
                                "inclusion_type": "included",
                                "base": {
                                    "kind": "per_stay",
                                    "base_amount": 10
                                },
                                "name": "City tax",
                                "item_amount": {
                                    "amount_unrounded": "US$0.07",
                                    "currency": "USD",
                                    "amount_rounded": "US$0",
                                    "value": 0.0653744337242023
                                }
                            },
                            {
                                "base": {
                                    "percentage": 10,
                                    "kind": "percentage"
                                },
                                "kind": "charge",
                                "inclusion_type": "included",
                                "item_amount": {
                                    "amount_unrounded": "US$21.39",
                                    "currency": "USD",
                                    "value": 21.3893260884913,
                                    "amount_rounded": "US$21"
                                },
                                "name": "VAT",
                                "details": "10 % VAT"
                            },
                            {
                                "details": "You’re getting a reduced weekly rate because this property is offering lower prices to guests who stay for 7 nights or longer.",
                                "item_amount": {
                                    "amount_unrounded": "US$294.18",
                                    "amount_rounded": "US$294",
                                    "value": 294.18495175891,
                                    "currency": "USD"
                                },
                                "name": "Weekly rate",
                                "base": {
                                    "kind": "rate"
                                },
                                "identifier": "weekly_rate",
                                "kind": "discount"
                            },
                            {
                                "details": "You’re getting a reduced rate compared to the rate available on a computer or laptop.",
                                "name": "Mobile-only price",
                                "item_amount": {
                                    "amount_unrounded": "US$26.15",
                                    "amount_rounded": "US$26",
                                    "value": 26.1497734896809,
                                    "currency": "USD"
                                },
                                "kind": "discount",
                                "base": {
                                    "kind": "rate"
                                },
                                "identifier": "mobile-discount"
                            }
                        ],
                        "all_inclusive_amount": {
                            "amount_unrounded": "US$235.35",
                            "currency": "USD",
                            "value": 235.347961407128,
                            "amount_rounded": "US$235"
                        },
                        "gross_amount_hotel_currency": {
                            "amount_unrounded": "¥36,000",
                            "value": 36000,
                            "amount_rounded": "¥36,000",
                            "currency": "JPY"
                        },
                        "all_inclusive_amount_hotel_currency": {
                            "amount_rounded": "¥36,000",
                            "value": 36000,
                            "currency": "JPY",
                            "amount_unrounded": "¥36,000"
                        },
                        "has_long_stays_monthly_rate_price": 0,
                        "charges_details": {
                            "amount": {
                                "currency": "USD",
                                "value": 0
                            },
                            "mode": "all_included"
                        },
                        "strikethrough_amount": {
                            "amount_unrounded": "US$555.68",
                            "currency": "USD",
                            "value": 555.682686655719,
                            "amount_rounded": "US$556"
                        },
                        "has_long_stays_weekly_rate_price": 1,
                        "excluded_amount": {
                            "amount_rounded": "US$0",
                            "value": 0,
                            "currency": "USD",
                            "amount_unrounded": "US$0"
                        },
                        "gross_amount_per_night": {
                            "amount_unrounded": "US$23.53",
                            "currency": "USD",
                            "amount_rounded": "US$24",
                            "value": 23.5347961407128
                        },
                        "client_translations": {
                            "tooltip_total_text": "Total"
                        },
                        "included_taxes_and_charges_amount": {
                            "amount_unrounded": "US$21.45",
                            "amount_rounded": "US$21",
                            "value": 21.4547005222155,
                            "currency": "USD"
                        },
                        "gross_amount": {
                            "currency": "USD",
                            "amount_rounded": "US$235",
                            "value": 235.347961407128,
                            "amount_unrounded": "US$235.35"
                        },
                        "net_amount": {
                            "amount_unrounded": "US$213.89",
                            "amount_rounded": "US$214",
                            "value": 213.893260884913,
                            "currency": "USD"
                        },
                        "discounted_amount": {
                            "currency": "USD",
                            "value": 320.334725248591,
                            "amount_rounded": "US$320",
                            "amount_unrounded": "US$320.33"
                        },
                        "strikethrough_amount_per_night": {
                            "currency": "USD",
                            "amount_rounded": "US$56",
                            "value": 55.5682686655719,
                            "amount_unrounded": "US$55.57"
                        }
                    },
                    "class_is_estimated": 0,
                    "urgency_message": "Only 1 left at this price on Booking.com",
                    "extended": 0,
                    "main_photo_id": 124108487,
                    "preferred": 0,
                    "checkin": {
                        "from": "14:00",
                        "until": "22:00"
                    },
                    "is_smart_deal": 0,
                    "hotel_has_vb_boost": 0,
                    "is_genius_deal": 0,
                    "hotel_include_breakfast": 0,
                    "review_score": 4.5,
                    "default_wishlist_name": "Matsudo",
                    "latitude": 35.7874981,
                    "block_ids": [
                        "251895811_395701895_1_0_0"
                    ],
                    "review_nr": 52,
                    "review_score_word": "Disappointing",
                    "timezone": "Asia/Tokyo",
                    "longitude": 139.9628522,
                    "is_free_cancellable": 0,
                    "soldout": 0,
                    "unit_configuration_label": "<b>Room with shared bathroom</b>: 1 bed",
                    "preferred_plus": 0
                }
            ],
            "count": 2,
            "page_loading_threshold": 10,
            "has_low_availability": 1,
            "applied_filters": [
                {
                    "name": "US$200 - US$300 (for 10 nights)",
                    "generic_id": "price::USD-200-300",
                    "field": "price",
                    "primary_count": 0
                }
            ],
            "room_distribution": [
                {
                    "adults": "1"
                }
            ],
            "unfiltered_primary_count": 6742
        }
    }
]

2025-08-25 12:35:53,464 - evaluation_logger_Hotels-30 - INFO - Function Calls: 
[
    {
        "name": "Get_Hotel_Reviews(Tips)",
        "arguments": {
            "hotel_id": "11393900"
        }
    },
    {
        "name": "Get_Hotel_Reviews(Tips)",
        "arguments": {
            "hotel_id": "2518958"
        }
    }
]

2025-08-25 12:35:53,464 - evaluation_logger_Hotels-30 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Hotel_Reviews(Tips)",
        "arguments": {
            "hotel_id": "11393900"
        }
    },
    {
        "name": "Get_Hotel_Reviews(Tips)",
        "arguments": {
            "hotel_id": "2518958"
        }
    }
]

2025-08-25 12:35:53,464 - evaluation_logger_Hotels-30 - INFO - Start compare_single_call: 
{'name': 'Get_Hotel_Reviews(Tips)', 'arguments': {'hotel_id': '11393900'}}
{'name': 'Get_Hotel_Reviews(Tips)', 'arguments': {'hotel_id': '11393900'}}
2025-08-25 12:35:53,464 - evaluation_logger_Hotels-30 - INFO - Rule-based compare success.
2025-08-25 12:35:53,464 - evaluation_logger_Hotels-30 - INFO - Start compare_single_call: 
{'name': 'Get_Hotel_Reviews(Tips)', 'arguments': {'hotel_id': '2518958'}}
{'name': 'Get_Hotel_Reviews(Tips)', 'arguments': {'hotel_id': '2518958'}}
2025-08-25 12:35:53,464 - evaluation_logger_Hotels-30 - INFO - Rule-based compare success.
2025-08-25 12:35:53,464 - evaluation_logger_Hotels-30 - INFO - Success matched: [{'name': 'Get_Hotel_Reviews(Tips)', 'arguments': {'hotel_id': '11393900'}}, {'name': 'Get_Hotel_Reviews(Tips)', 'arguments': {'hotel_id': '2518958'}}]
2025-08-25 12:35:53,465 - evaluation_logger_Hotels-30 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "count": 25,
            "sort_options": [
                {
                    "sort_option_default": 1,
                    "sort_option_id": "sort_most_relevant",
                    "title": "Most relevant"
                },
                {
                    "sort_option_id": "sort_recent_desc",
                    "title": "Date (newer to older)",
                    "sort_option_default": 0
                },
                {
                    "sort_option_default": 0,
                    "title": "Close to property score",
                    "sort_option_id": "proximity_to_hotel_average"
                },
                {
                    "sort_option_default": 0,
                    "title": "Review score (high to low)",
                    "sort_option_id": "sort_score_desc"
                },
                {
                    "sort_option_default": 0,
                    "title": "From your country",
                    "sort_option_id": "user_country"
                }
            ],
            "result": [
                {
                    "is_incentivised": 0,
                    "author": {
                        "nr_reviews": 0,
                        "user_id": 800781823,
                        "type_string": "Solo traveller",
                        "helpful_vote_count": 0,
                        "type": "solo_traveller",
                        "name": "Rayanne",
                        "countrycode": "jp"
                    },
                    "date": "2024-10-21 02:56:33",
                    "review_hash": "5a1a506a5a328892",
                    "review_id": 5096066823,
                    "travel_purpose": "leisure",
                    "no_user_title": 0,
                    "reviewng": 1,
                    "average_score": 3.20000004768372,
                    "is_moderated": 0,
                    "cons": "I had to fix my own locker in order for it to lock, and the laundry machines and vending machines were clearly aging and several were out of order.",
                    "pros": "The area around the hotel felt a little dangerous, but the hotel's security put me right at ease. I also liked the manga reading room, and the lounge was pretty comfortable to use. The beds were surprisingly comfortable as well.",
                    "hotel_id": 11393900,
                    "stayed_room_info": {
                        "room_name": "Single Bed in Female Dormitory Room",
                        "checkout": "2024-10-15",
                        "room_id": 1139390002,
                        "checkin": "2024-10-12",
                        "num_nights": 3
                    },
                    "helpful_vote_count": 0,
                    "languagecode": "en-gb",
                    "title": "Very comfortable for the price.",
                    "countrycode": "jp"
                },
                {
                    "helpful_vote_count": 0,
                    "languagecode": "en-gb",
                    "hotelier_response_date": 1729430502,
                    "title": "Hotel plus Hostel is most value for money! It is super clean and quiet throughout my stay. And the staff were very frien",
                    "countrycode": "sg",
                    "average_score": 3.59999990463257,
                    "is_moderated": 0,
                    "cons": "I wish the bed were firmer for the single room with shared toilet.",
                    "hotel_id": 11393900,
                    "pros": "It is very clean and quiet.",
                    "stayed_room_info": {
                        "num_nights": 4,
                        "room_id": 1139390005,
                        "checkin": "2024-10-14",
                        "room_name": "Single Room with Shared Bathroom - Female  Only",
                        "checkout": "2024-10-18"
                    },
                    "no_user_title": 0,
                    "reviewng": 1,
                    "travel_purpose": "leisure",
                    "review_hash": "416256a3c3b3ec43",
                    "review_id": 5095650909,
                    "date": "2024-10-20 01:42:51",
                    "hotelier_response": "Thank you very much for choosing our hotel.\nWe are very pleased to receive your compliments.\nWe look forward to having the opportunity to serve you again.\nAll of our staff look forward to serving you again.\n\nHotel+Hostel Tokyo Kawasaki",
                    "is_incentivised": 0,
                    "author": {
                        "countrycode": "sg",
                        "name": "Jolin",
                        "helpful_vote_count": 0,
                        "type": "solo_traveller",
                        "nr_reviews": 0,
                        "user_id": 867192178,
                        "type_string": "Solo traveller"
                    }
                },
                {
                    "average_score": 2.79999995231628,
                    "pros": "Location and price",
                    "is_moderated": 0,
                    "cons": "As I got early check in aproval no extra charges  but once I reached 7am  they charge me 2000 jpy which is don't like",
                    "hotel_id": 11393900,
                    "stayed_room_info": {
                        "room_name": "Single Bed in Male Dormitory Room",
                        "checkout": "2024-10-15",
                        "num_nights": 1,
                        "room_id": 1139390001,
                        "checkin": "2024-10-14"
                    },
                    "languagecode": "en-gb",
                    "helpful_vote_count": 0,
                    "title": "Pleasant",
                    "hotelier_response_date": 1729010818,
                    "countrycode": "ae",
                    "travel_purpose": "leisure",
                    "no_user_title": 1,
                    "reviewng": 1,
                    "review_hash": "cb3a498e196fc157",
                    "review_id": 5094260137,
                    "hotelier_response": "Thank you for choosing our hotel. We are glad to hear you good location and good price. We will make effort based on your feedback. Thank you for posting your review.",
                    "is_incentivised": 0,
                    "author": {
                        "name": "Wajid",
                        "countrycode": "ae",
                        "helpful_vote_count": 0,
                        "type": "solo_traveller",
                        "user_id": 479352321,
                        "type_string": "Solo traveller",
                        "nr_reviews": 0
                    },
                    "date": "2024-10-15 14:15:42"
                },
                {
                    "date": "2024-10-09 08:11:27",
                    "author": {
                        "nr_reviews": 0,
                        "type_string": "Solo traveller",
                        "user_id": 347358383,
                        "countrycode": "in",
                        "name": "N",
                        "helpful_vote_count": 1,
                        "type": "solo_traveller"
                    },
                    "is_incentivised": 0,
                    "hotelier_response": "Thank you for using our hotel. I am glad to hear you had a good stay in our hotel. I am sorry that you feel difficult to communicate with staffs. We are going to do best for a language when you come back to the hotel next time. We look forward to seeing you again. Thank you. \nH+H Tokyo Kawasaki",
                    "review_id": 5092011351,
                    "review_hash": "a8f3e56a0c5eacc9",
                    "reviewng": 1,
                    "no_user_title": 0,
                    "travel_purpose": "leisure",
                    "title": "2 night 3days ..i had a good time staying there. I shall for sure recommended to all my friends",
                    "hotelier_response_date": 1728639399,
                    "helpful_vote_count": 1,
                    "reviewer_photos": [
                        {
                            "500_500": "https://cf.bstatic.com/xdata/images/xphoto/max500_ao/395778080.jpg?k=838d475e1d9bb5c74b821dc13cde8abcca285af1a57a22063535cfe7632e0f01&o=",
                            "1280_900": "https://cf.bstatic.com/xdata/images/xphoto/max1280x900/395778080.jpg?k=838d475e1d9bb5c74b821dc13cde8abcca285af1a57a22063535cfe7632e0f01&o=",
                            "60_60": "https://cf.bstatic.com/xdata/images/xphoto/square60_ao/395778080.jpg?k=838d475e1d9bb5c74b821dc13cde8abcca285af1a57a22063535cfe7632e0f01&o=",
                            "90_90": "https://cf.bstatic.com/xdata/images/xphoto/square90/395778080.jpg?k=838d475e1d9bb5c74b821dc13cde8abcca285af1a57a22063535cfe7632e0f01&o="
                        },
                        {
                            "90_90": "https://cf.bstatic.com/xdata/images/xphoto/square90/395779378.jpg?k=fe997b9fb04ddb58162aa805d0aa6d214d285c80855b1e4af4bdcc871a402649&o=",
                            "60_60": "https://cf.bstatic.com/xdata/images/xphoto/square60_ao/395779378.jpg?k=fe997b9fb04ddb58162aa805d0aa6d214d285c80855b1e4af4bdcc871a402649&o=",
                            "500_500": "https://cf.bstatic.com/xdata/images/xphoto/max500_ao/395779378.jpg?k=fe997b9fb04ddb58162aa805d0aa6d214d285c80855b1e4af4bdcc871a402649&o=",
                            "1280_900": "https://cf.bstatic.com/xdata/images/xphoto/max1280x900/395779378.jpg?k=fe997b9fb04ddb58162aa805d0aa6d214d285c80855b1e4af4bdcc871a402649&o="
                        }
                    ],
                    "languagecode": "en-us",
                    "countrycode": "in",
                    "is_moderated": 0,
                    "cons": "it was difficult to communicate with the staff because of the language barrier but then they put effort to help us. which was nice of them",
                    "hotel_id": 11393900,
                    "pros": "The fact that its  only a few mins walk to Kawasaki stations (Bus and Train) that's the best part of the hostel....\r\nAlso, in the evening you can take a stroll and hang around the locality for a drinks and good food...",
                    "average_score": 3.20000004768372,
                    "stayed_room_info": {
                        "room_name": "Single Bed in Female Dormitory Room",
                        "checkout": "2024-10-04",
                        "room_id": 1139390002,
                        "checkin": "2024-10-02",
                        "num_nights": 2
                    }
                },
                {
                    "countrycode": "in",
                    "helpful_vote_count": 0,
                    "languagecode": "en-gb",
                    "title": "Very good",
                    "hotelier_response_date": 1728373991,
                    "stayed_room_info": {
                        "room_name": "Single Bed in Male Dormitory Room",
                        "checkout": "2024-09-10",
                        "room_id": 1139390001,
                        "checkin": "2024-09-08",
                        "num_nights": 2
                    },
                    "hotel_id": 11393900,
                    "is_moderated": 0,
                    "cons": "Price little bit high",
                    "pros": "Nice breakfast",
                    "average_score": 3.20000004768372,
                    "no_user_title": 1,
                    "reviewng": 1,
                    "travel_purpose": "leisure",
                    "review_hash": "c5901497ba5c3f08",
                    "review_id": 5091458547,
                    "date": "2024-10-07 15:53:27",
                    "author": {
                        "type": "solo_traveller",
                        "helpful_vote_count": 0,
                        "countrycode": "in",
                        "name": "Sekuri",
                        "type_string": "Solo traveller",
                        "user_id": 443882621,
                        "nr_reviews": 0
                    },
                    "is_incentivised": 0,
                    "hotelier_response": "Thank you very much for choosing our hotel.\nBased on your feedback, we will make every effort to improve in the future.\nThank you very much for your valuable feedback.\nOur entire staff sincerely looks forward to serving you again.\nH+H Tokyo Kawasaki"
                }
            ]
        }
    },
    {
        "status": true,
        "message": "Success",
        "data": {
            "count": 25,
            "result": [
                {
                    "is_moderated": 0,
                    "author": {
                        "user_id": 19162845,
                        "type_string": "Solo traveller",
                        "helpful_vote_count": 0,
                        "name": "Nundog",
                        "countrycode": "au",
                        "type": "solo_traveller",
                        "nr_reviews": 0
                    },
                    "is_incentivised": 0,
                    "title": "3 night stay - Solo Traveller",
                    "cons": "A fair walking distance from goku St. Shared amenities which are very outdated. Room has a padlock on outside for security if you wish to lock your door but can easily be taken off with a Phillips head screwdriver",
                    "review_hash": "2fad333c9a559207",
                    "stayed_room_info": {
                        "num_nights": 3,
                        "room_id": 251895826,
                        "checkin": "2024-03-24",
                        "checkout": "2024-03-27",
                        "room_name": "Budget Double Room"
                    },
                    "languagecode": "en-gb",
                    "review_id": 5018680413,
                    "pros": "I liked that I had amenities to myself, there were no other guests staying in the other rooms.",
                    "countrycode": "au",
                    "date": "2024-04-15 22:46:13",
                    "reviewng": 1,
                    "hotel_id": 2518958,
                    "helpful_vote_count": 0,
                    "no_user_title": 0,
                    "travel_purpose": "leisure",
                    "average_score": 2.40000009536743
                },
                {
                    "countrycode": "de",
                    "no_user_title": 0,
                    "travel_purpose": "leisure",
                    "average_score": 2.40000009536743,
                    "date": "2023-11-06 07:30:17",
                    "reviewng": 1,
                    "hotel_id": 2518958,
                    "helpful_vote_count": 0,
                    "review_id": 5001666487,
                    "pros": "Very economic.",
                    "stayed_room_info": {
                        "num_nights": 28,
                        "checkout": "2023-11-01",
                        "room_id": 251895824,
                        "checkin": "2023-10-04",
                        "room_name": "Deluxe Double Room"
                    },
                    "languagecode": "en-gb",
                    "review_hash": "54c9355ff2369d66",
                    "is_moderated": 0,
                    "author": {
                        "nr_reviews": 0,
                        "countrycode": "de",
                        "type": "solo_traveller",
                        "name": "Sven",
                        "helpful_vote_count": 0,
                        "type_string": "Solo traveller",
                        "user_id": 64325100
                    },
                    "is_incentivised": 0,
                    "title": "One has to Malice that its quite a commute into Tokyo; the price is good though."
                },
                {
                    "review_id": 3060329727,
                    "pros": "very old house.",
                    "countrycode": "ph",
                    "helpful_vote_count": 0,
                    "hotel_id": 2518958,
                    "reviewng": 1,
                    "date": "2023-08-22 05:37:16",
                    "average_score": 2,
                    "travel_purpose": "leisure",
                    "no_user_title": 0,
                    "is_incentivised": 0,
                    "is_moderated": 0,
                    "author": {
                        "name": "Christobal",
                        "type": "review_category_group_of_friends",
                        "countrycode": "ph",
                        "nr_reviews": 0,
                        "type_string": "Group of friends",
                        "user_id": 24170586,
                        "helpful_vote_count": 0
                    },
                    "cons": "none",
                    "title": "we’re a bit upset because of the comfort room is only 1 for 7 rooms. imagine that. so we have to wait for our turn befor",
                    "review_hash": "6d6e60709a32e05f",
                    "stayed_room_info": {
                        "room_name": "Family Room",
                        "num_nights": 12,
                        "checkin": "2023-08-08",
                        "room_id": 251895808,
                        "checkout": "2023-08-20"
                    },
                    "languagecode": "en-us"
                },
                {
                    "is_moderated": 0,
                    "author": {
                        "user_id": 75469042,
                        "type_string": "Solo traveller",
                        "helpful_vote_count": 1,
                        "name": "Clpo",
                        "type": "solo_traveller",
                        "countrycode": "fr",
                        "nr_reviews": 0
                    },
                    "is_incentivised": 0,
                    "cons": "Far from the train station; no reception on arrival, no lock on the bathroom door... The whole apartment needs a refurbishment.",
                    "title": "Disappointing",
                    "languagecode": "en-gb",
                    "stayed_room_info": {
                        "room_name": "Economy Quadruple Room",
                        "num_nights": 1,
                        "checkin": "2023-05-20",
                        "room_id": 251895828,
                        "checkout": "2023-05-21"
                    },
                    "review_hash": "9d73d59a314f493d",
                    "review_id": 3156084225,
                    "pros": "My interlocutor Tom-san was friendly and helpful. The place is quiet. There is a supermarket and some kombini at 8mn walking.",
                    "countrycode": "fr",
                    "average_score": 2,
                    "no_user_title": 0,
                    "travel_purpose": "leisure",
                    "reviewng": 1,
                    "hotel_id": 2518958,
                    "helpful_vote_count": 1,
                    "date": "2023-05-23 08:45:04"
                },
                {
                    "languagecode": "en-gb",
                    "stayed_room_info": {
                        "num_nights": 3,
                        "checkout": "2022-12-20",
                        "checkin": "2022-12-17",
                        "room_id": 251895812,
                        "room_name": "Economy Quadruple Room"
                    },
                    "review_hash": "fbc2dca0a95ce57d",
                    "is_moderated": 0,
                    "author": {
                        "type_string": "Group of friends",
                        "user_id": 0,
                        "helpful_vote_count": 4,
                        "nr_reviews": 0,
                        "name": "Alejandro",
                        "type": "review_category_group_of_friends",
                        "countrycode": "mx"
                    },
                    "is_incentivised": 0,
                    "cons": "AC would turn off at night at -2 Celsius because of voltage overload, too many guests at once, which made it a VERY bad night, facilities are broken, the owner is VERY lovely and I would like to meet him again, but the house I kinda falling apart, one of the bathrooms is out of commission, and what once seemed to be a lovely garden is filled with ruined furniture and garbage, for some reason guests staying there are VERY dirty, they leave the bathroom dirty, shower dirty, they are loud (stayed 3 nights and 3 different guests were like that), a VERY simple lock is provided as security measure for a wooden door locked behind 2 uneven screws, which only takes a little bit of \"foreigner\" and determination to open without leaving a trace, which made me feel uneasy while I was away with my very valuable belongings in the room, it's a 20 min walk to the nearest station, which after a long day feels like hours, overall I DO NOT recommend the place, you're probably better off anywhere else.",
                    "title": "Uncomfortable",
                    "countrycode": "mx",
                    "average_score": 1.60000002384186,
                    "no_user_title": 0,
                    "travel_purpose": "leisure",
                    "hotel_id": 2518958,
                    "reviewng": 1,
                    "helpful_vote_count": 4,
                    "date": "2022-12-20 21:42:23",
                    "review_id": 4609337394,
                    "pros": "Away from the city"
                }
            ],
            "sort_options": [
                {
                    "sort_option_id": "sort_most_relevant",
                    "sort_option_default": 1,
                    "title": "Most relevant"
                },
                {
                    "sort_option_default": 0,
                    "title": "Date (newer to older)",
                    "sort_option_id": "sort_recent_desc"
                },
                {
                    "sort_option_id": "proximity_to_hotel_average",
                    "title": "Close to property score",
                    "sort_option_default": 0
                },
                {
                    "sort_option_id": "sort_score_desc",
                    "sort_option_default": 0,
                    "title": "Review score (high to low)"
                },
                {
                    "sort_option_id": "user_country",
                    "title": "From your country",
                    "sort_option_default": 0
                }
            ]
        }
    }
]

2025-08-25 12:38:58,756 - evaluation_logger_Hotels-30 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [MyBatis 的日志模块](https://github.com/YunaiV/mybatis-3/tree/master/src/main/java/org/apache/ibatis/logging) ，对应 `logging` 包。如下图所示：[![`logging` 包](http://static.iocoder.cn/images/MyBatis/2020_01_31/01.png)](http://static.iocoder.cn/images/MyBatis/2020_01_31/01.png)`logging` 包

在 [《精尽 MyBatis 源码分析 —— 项目结构一览》](http://svip.iocoder.cn/MyBatis/intro) 中，简单介绍了这个模块如下：

> 无论在开发测试环境中，还是在线上生产环境中，日志在整个系统中的地位都是非常重要的。良好的日志功能可以帮助开发人员和测试人员快速定位 Bug 代码，也可以帮助运维人员快速定位性能瓶颈等问题。目前的 Java 世界中存在很多优秀的日志框架，例如 Log4j、 Log4j2、Slf4j 等。
>
> MyBatis 作为一个设计优良的框架，除了提供详细的日志输出信息，还要能够集成多种日志框架，其日志模块的一个主要功能就是**集成第三方日志框架**。

本文涉及的类如下图所示：![类图](http://static.iocoder.cn/images/MyBatis/2020_01_31/02.png)

- 从图的**上面**部分，我们可以看到，MyBatis 直接使用了多种第三方日志框架；
- 从图的**下面**部分，我们可以看到，MyBatis 提供了多种第三方日志框架的集成功能。而这种方式，就是通过适配器模式来实现的。

下面，我们逐小节来分享。

# 2. Log 接口

`org.apache.ibatis.logging.Log` ，MyBatis Log 接口。代码如下：

```java
// Log.java

public interface Log {

    boolean isDebugEnabled();

    boolean isTraceEnabled();

    void error(String s, Throwable e);

    void error(String s);

    void debug(String s);

    void trace(String s);

    void warn(String s);

}
```

- 定义了日志的接口。

## 2.1 LogFactory

`org.apache.ibatis.logging.LogFactory` ，Log 工厂类。代码如下：

```java
// LogFactory.java

public final class LogFactory {

    /**
     * Marker to be used by logging implementations that support markers.
     */
    public static final String MARKER = "MYBATIS";

    /**
     * 使用的 Log 的构造方法
     */
    private static Constructor<? extends Log> logConstructor;

    static {
        // <1> 尝试依次初始化每个日志框架的 Log 构造方法
        tryImplementation(LogFactory::useSlf4jLogging);
        tryImplementation(LogFactory::useCommonsLogging);
        tryImplementation(LogFactory::useLog4J2Logging);
        tryImplementation(LogFactory::useLog4JLogging);
        tryImplementation(LogFactory::useJdkLogging);
        tryImplementation(LogFactory::useNoLogging);
    }

    private LogFactory() {
        // disable construction
    }

    public static Log getLog(Class<?> aClass) {
        return getLog(aClass.getName());
    }

    public static Log getLog(String logger) {
        try {
            return logConstructor.newInstance(logger);
        } catch (Throwable t) {
            throw new LogException("Error creating logger for logger " + logger + ".  Cause: " + t, t);
        }
    }

    public static synchronized void useCustomLogging(Class<? extends Log> clazz) {
        setImplementation(clazz);
    }

    public static synchronized void useSlf4jLogging() {
        setImplementation(org.apache.ibatis.logging.slf4j.Slf4jImpl.class);
    }

    public static synchronized void useCommonsLogging() {
        setImplementation(org.apache.ibatis.logging.commons.JakartaCommonsLoggingImpl.class);
    }

    public static synchronized void useLog4JLogging() {
        setImplementation(org.apache.ibatis.logging.log4j.Log4jImpl.class);
    }

    public static synchronized void useLog4J2Logging() {
        setImplementation(org.apache.ibatis.logging.log4j2.Log4j2Impl.class);
    }

    public static synchronized void useJdkLogging() {
        setImplementation(org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl.class);
    }

    public static synchronized void useStdOutLogging() {
        setImplementation(org.apache.ibatis.logging.stdout.StdOutImpl.class);
    }

    public static synchronized void useNoLogging() {
        setImplementation(org.apache.ibatis.logging.nologging.NoLoggingImpl.class);
    }

    private static void tryImplementation(Runnable runnable) {
        if (logConstructor == null) {
            try {
                runnable.run();
            } catch (Throwable t) {
                // ignore
            }
        }
    }

    private static void setImplementation(Class<? extends Log> implClass) {
        try {
            // 获得参数为 String 的构造方法
            Constructor<? extends Log> candidate = implClass.getConstructor(String.class);
            // 创建 Log 对象
            Log log = candidate.newInstance(LogFactory.class.getName());
            if (log.isDebugEnabled()) {
                log.debug("Logging initialized using '" + implClass + "' adapter.");
            }
            // 创建成功，意味着可以使用，设置为 logConstructor
            logConstructor = candidate;
        } catch (Throwable t) {
            throw new LogException("Error setting Log implementation.  Cause: " + t, t);
        }
    }

}
```

- `logConstructor` 静态属性，使用的 Log 的构造方法。在 `<1>` 处的静态代码块中，会尝试依次初始化每个日志框架的 Log 构造方法。而初始化的方式，就是调用 `#setImplementation(Class<? extends Log> implClass)` 方法。而 `#tryImplementation(Runnable runnable)` 方法，会保证只有 `logConstructor` 为空时，才会执行初始化。
- `#setImplementation(Class<? extends Log> implClass)` 方法，会初始化 `logConstructor` 。代码如下：
  - 首先，获得参数为 String 的构造方法。
  - 然后，创建 Log 对象。通过调用 `Log#isDebugEnabled()` 方法，判断是否初始化成功。如果成功，则赋值给 `logConstructor` 。
- 其它方法，主要是提供不同的日志框架的初始化。例如说，`#useSlf4jLogging()` 方法，使用的是 SLF4J 。并且，所有的方法，都添加了 `synchronized` 关键字，避免并发问题。

# 3. 第三方日志框架

在 `logging` 包下，MyBatis 内置了一大批的 Log 实现类，如下图所示：![Log 实现类](http://static.iocoder.cn/images/MyBatis/2020_01_31/03.png)

- 每个实现类，代码都非常简单，感兴趣的胖友，自己简单看下即可。
- 另外，`StdOutImpl` 和 `NoLoggingImpl` 这两个实现类，是不需要依赖任何第三方日志框架。

# 4. 适配器模式

在 `logging` 包下，还有 `jdbc` 包。它主要是将一些数据库操作（例如 JDBC ）的日志进行封装，按照统一的格式进行打印。所以，`jdbc` 包，也可以理解成是**适配器模式**的运用。并且，`jdbc` 包，**只有**在 DEBUG 的情况下，才会生效。

## 4.1 BaseJdbcLogger

`org.apache.ibatis.logging.jdbc.BaseJdbcLogger` ，实现 Log 接口，BaseJdbcLogger 抽象类，作为下面子类的基类。代码如下：

```java
// BaseJdbcLogger.java

public abstract class BaseJdbcLogger implements Log {

    /**
     * SET 方法的通用前缀
     */
    protected static final String SET_METHOD_PREFIX = "set";
    /**
     * 执行 SQL 的方法的前缀
     */
    protected static final String EXECUTE_METHOD_PREFIX = "execute";
    /**
     * 设置参数的方法的数组
     */
    protected static final String[] SET_METHODS = new String[]{"setString", "setNString", "setInt", "setByte", "setShort", "setBytes", "setBoolean", "setLong", "setFloat", "setDouble", "setBigDecimal", "setDate", "setTime", "setTimestamp", "setAsciiStream", "setBinaryStream", "setObject", "setCharacterStream", "setNCharacterStream", "setBlob", "setClob", "setNClob", "setURL", "setNull",};
    /**
     * 执行 SQL 的方法的数组
     */
    protected static final String[] EXECUTE_METHODS = new String[]{"execute", "executeUpdate", "executeQuery", "addBatch"};

    /**
     * PreparedStatement 的参数的映射
     *
     * KEY：参数的位置
     * VALUE：参数的值
     */
    private final Map<Object, Object> columnMap = new HashMap<>();

    /**
     * PreparedStatement 的参数列表
     */
    private final List<Object> columnValues = new ArrayList<>();

    /**
     * Log 对象
     */
    protected Log statementLog;
    /**
     * 查询的层级，一般用于完整的调用链
     */
    protected int queryStack;

    /**
     * Constructor
     *
     * @param log  the log
     * @param queryStack the query stack
     */
    public BaseJdbcLogger(Log log, int queryStack) {
        this.statementLog = log;
        if (queryStack == 0) {
            this.queryStack = 1;
        } else {
            this.queryStack = queryStack;
        }
    }

    // ... 省略一些方法

}
```

- 代码比较简单，胖友自己看注释。

## 4.2 ConnectionLogger

`org.apache.ibatis.logging.jdbc.ConnectionLogger` ，继承 BaseJdbcLogger 类，Connection 日志增强类，负责打印连接信息和 SQL 语句。并且，支持 debug 和 trace 级别的日志。

### 4.2.1 构造方法

```java
// ConnectionLogger.java

/**
 * Connection 的代理
 */
private final Connection connection;

private ConnectionLogger(Connection conn, Log statementLog, int queryStack) {
    super(statementLog, queryStack);
    this.connection = conn;
}
```

### 4.2.2 newInstance

```java
// ConnectionLogger.java

public static Connection newInstance(Connection conn, Log statementLog, int queryStack) {
    // 创建 ConnectionLogger 动态代理
    InvocationHandler handler = new ConnectionLogger(conn, statementLog, queryStack);
    ClassLoader cl = Connection.class.getClassLoader();
    return (Connection) Proxy.newProxyInstance(cl, new Class[]{Connection.class}, handler);
}
```

- 创建 Connection 的代理对象。其中，InvocationHandler 为 ConnectionLogger 对象。

### 4.2.3 invoke

```java
// ConnectionLogger.java

@Override
public Object invoke(Object proxy, Method method, Object[] params)
        throws Throwable {
    try {
        // 如果调用的是 Object 的方法，直接调用
        if (Object.class.equals(method.getDeclaringClass())) {
            return method.invoke(this, params);
        }
        // 如果调用的是 prepareStatement 方法
        if ("prepareStatement".equals(method.getName())) {
            if (isDebugEnabled()) {
                debug(" Preparing: " + removeBreakingWhitespace((String) params[0]), true);
            }
            // 执行方法
            PreparedStatement stmt = (PreparedStatement) method.invoke(connection, params);
            // 创建 PreparedStatement 的代理对象
            stmt = PreparedStatementLogger.newInstance(stmt, statementLog, queryStack);
            return stmt;
        }
        // 如果调用的是 prepareCall 方法
        else if ("prepareCall".equals(method.getName())) {
            if (isDebugEnabled()) {
                debug(" Preparing: " + removeBreakingWhitespace((String) params[0]), true);
            }
            // 执行方法
            PreparedStatement stmt = (PreparedStatement) method.invoke(connection, params);
            // 创建 PreparedStatement 的代理对象
            stmt = PreparedStatementLogger.newInstance(stmt, statementLog, queryStack);
            return stmt;
        }
        // 如果调用的是 createStatement 方法
        else if ("createStatement".equals(method.getName())) {
            // 执行方法
            Statement stmt = (Statement) method.invoke(connection, params);
            // 创建 Statement 的代理对象
            stmt = StatementLogger.newInstance(stmt, statementLog, queryStack);
            return stmt;
        } else {
            return method.invoke(connection, params);
        }
    } catch (Throwable t) {
        throw ExceptionUtil.unwrapThrowable(t);
    }
}
```

- 根据不同的方法，进行不同的日志的打印。
- 并且，对于需要打印 SQL 的情况，创建对应的 Statement 的代理对象。例如：`"prepareStatement"` 方法，创建 PreparedStatement 的代理对象。

## 4.3 PreparedStatementLogger

`org.apache.ibatis.logging.jdbc.PreparedStatementLogger` ，继承 BaseJdbcLogger 类，PreparedStatement 日志增强类，负责打印参数信息。并且，支持 debug 和 trace 级别的日志。

### 4.3.1 构造方法

```java
// PreparedStatementLogger.java

/**
 * PreparedStatement 对象
 */
private final PreparedStatement statement;

private PreparedStatementLogger(PreparedStatement stmt, Log statementLog, int queryStack) {
    super(statementLog, queryStack);
    this.statement = stmt;
}
```

### 4.3.2 newInstance

```java
// PreparedStatementLogger.java

public static PreparedStatement newInstance(PreparedStatement stmt, Log statementLog, int queryStack) {
    // 创建 PreparedStatementLogger 动态代理
    InvocationHandler handler = new PreparedStatementLogger(stmt, statementLog, queryStack);
    ClassLoader cl = PreparedStatement.class.getClassLoader();
    return (PreparedStatement) Proxy.newProxyInstance(cl, new Class[]{PreparedStatement.class, CallableStatement.class}, handler);
}
```

- 创建 PreparedStatement 的代理对象。其中，InvocationHandler 为 PreparedStatementLogger 对象。

### 4.3.3 invoke

```java
// PreparedStatementLogger.java

@Override
public Object invoke(Object proxy, Method method, Object[] params) throws Throwable {
    try {
        // 如果调用的是 Object 的方法，直接调用
        if (Object.class.equals(method.getDeclaringClass())) {
            return method.invoke(this, params);
        }
        // 如果调用的是 execute 相关的方法
        if (EXECUTE_METHODS.contains(method.getName())) {
            if (isDebugEnabled()) {
                debug("Parameters: " + getParameterValueString(), true);
            }
            // 清除 columnMap 和 columnValues
            clearColumnInfo();
            // 执行方法
            if ("executeQuery".equals(method.getName())) {
                ResultSet rs = (ResultSet) method.invoke(statement, params);
                return rs == null ? null : ResultSetLogger.newInstance(rs, statementLog, queryStack);
            } else {
                return method.invoke(statement, params);
            }
        }
        // 如果调用的是 set 相关方法
        else if (SET_METHODS.contains(method.getName())) {
            // 设置参数到 columnMap 和 columnValues 中
            if ("setNull".equals(method.getName())) {
                setColumn(params[0], null);
            } else {
                setColumn(params[0], params[1]);
            }
            return method.invoke(statement, params);
        }
        // 如果调用的是 getResultSet 方法
        else if ("getResultSet".equals(method.getName())) {
            // 执行方法
            ResultSet rs = (ResultSet) method.invoke(statement, params);
            return rs == null ? null : ResultSetLogger.newInstance(rs, statementLog, queryStack);
        }
        // 如果调用的是 getUpdateCount 方法
        else if ("getUpdateCount".equals(method.getName())) {
            // 执行方法
            int updateCount = (Integer) method.invoke(statement, params);
            if (updateCount != -1) {
                debug("   Updates: " + updateCount, false);
            }
            return updateCount;
        } else {
            return method.invoke(statement, params);
        }
    } catch (Throwable t) {
        throw ExceptionUtil.unwrapThrowable(t);
    }
}
```

- 根据不同的方法，进行不同的日志的打印。
- 并且，对于 `EXECUTE_METHODS` 和 `"getResultSet"` 方法，会创建 ResultSet 的代理对象。

## 4.4 ResultSetLogger

`org.apache.ibatis.logging.jdbc.ResultSetLogger` ，继承 BaseJdbcLogger 类，ResultSet 日志增强类，负责打印结果信息。并且，支持 debug 和 trace 级别的日志。

### 4.4.1 构造方法

```java
// ResultSetLogger.java

/**
 * ResultSet 对象
 */
private final ResultSet rs;
/**
 * 统计读取的记录数
 */
private int rows;
/**
 * 第一行，是否需要打印表头
 */
private boolean first = true;

private ResultSetLogger(ResultSet rs, Log statementLog, int queryStack) {
    super(statementLog, queryStack);
    this.rs = rs;
}
```

### 4.4.2 newInstance

```java
// ResultSetLogger.java

public static ResultSet newInstance(ResultSet rs, Log statementLog, int queryStack) {
    // 创建 ResultSetLogger 动态代理
    InvocationHandler handler = new ResultSetLogger(rs, statementLog, queryStack);
    ClassLoader cl = ResultSet.class.getClassLoader();
    return (ResultSet) Proxy.newProxyInstance(cl, new Class[]{ResultSet.class}, handler);
}
```

- 创建 ResultSet 的代理对象。其中，InvocationHandler 为 ResultSetLogger 对象。

### 4.4.3 invoke

```java
// ResultSetLogger.java

@Override
public Object invoke(Object proxy, Method method, Object[] params) throws Throwable {
    try {
        // 如果调用的是 Object 的方法，直接调用
        if (Object.class.equals(method.getDeclaringClass())) {
            return method.invoke(this, params);
        }
        // 执行方法
        Object o = method.invoke(rs, params);
        // 如果调用的是 next 方法
        if ("next".equals(m

2025-08-25 12:39:06,434 - evaluation_logger_Hotels-30 - INFO - Complete Result: {'score': 0, 'reason': "The response does not address any of the requested information in the user's query about hotels in Tokyo."}
2025-08-25 12:39:12,953 - evaluation_logger_Hotels-30 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:39:12,953 - evaluation_logger_Hotels-30 - INFO - Message: Success.
2025-08-25 12:39:12,953 - evaluation_logger_Hotels-30 - INFO - Success turn num = 3
2025-08-25 12:39:12,953 - evaluation_logger_Hotels-30 - INFO - ----------------------------------------------------------------------------------------------------
