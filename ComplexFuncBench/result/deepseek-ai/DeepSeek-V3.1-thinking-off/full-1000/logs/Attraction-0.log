2025-08-25 12:52:37,562 - evaluation_logger_Attraction-0 - INFO - Test Example Attraction-0
2025-08-25 12:52:37,562 - evaluation_logger_Attraction-0 - INFO - Query: Check out the most trending tourist spots in Manchester for my family trip.
2025-08-25 12:52:47,967 - evaluation_logger_Attraction-0 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Manchester"
        }
    }
]

2025-08-25 12:52:47,967 - evaluation_logger_Attraction-0 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Manchester"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNjAyNTEyfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:52:47,967 - evaluation_logger_Attraction-0 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Manchester'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Manchester'}}
2025-08-25 12:52:47,967 - evaluation_logger_Attraction-0 - INFO - Rule-based compare success.
2025-08-25 12:52:47,967 - evaluation_logger_Attraction-0 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Manchester'}}]
2025-08-25 12:52:47,967 - evaluation_logger_Attraction-0 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI4QkJRTzhHUWZWIiwidWZpIjotMjYwMjUxMn0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Manchester Private Transfer from central Manchester to Manchester Airport",
                    "productId": "PR8BBQO8GQfV",
                    "productSlug": "pr8bbqo8gqfv-manchester-private-transfer-from-central-manchester-to-manchester-a",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -2602512,
                    "cityName": "Manchester",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJsWlRsTkl2amVRIiwidWZpIjotMjYwMjUxMn0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Self-Guided Manchester Scavenger Hunt: Mighty Manchester",
                    "productId": "PRlZTlNIvjeQ",
                    "productSlug": "prlztlnivjeq-manchester-scavenger-hunt",
                    "taxonomySlug": "tours",
                    "cityUfi": -2602512,
                    "cityName": "Manchester",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI4eXRiZnhmdG1JIiwidWZpIjotMjYwMjUxMn0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Manchester to Manchester Airport (MAN) - Departure Private Transfer",
                    "productId": "PR8ytbfxftmI",
                    "productSlug": "pr8ytbfxftmi-manchester-to-manchester-airport-man-departure-private-transfer",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -2602512,
                    "cityName": "Manchester",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJqRG1KZm05T2FDIiwidWZpIjotMjYwMjUxMn0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Manchester Airport (MAN) to Manchester - Arrival Private Transfer",
                    "productId": "PRjDmJfm9OaC",
                    "productSlug": "prjdmjfm9oac-manchester-airport-man-to-manchester-arrival-private-transfer",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -2602512,
                    "cityName": "Manchester",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJ3VEw4THhWalRaIiwidWZpIjotMjYwMjUxMn0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Manchester River Tour",
                    "productId": "PRwTL8LxVjTZ",
                    "productSlug": "prwtl8lxvjtz-manchester-river-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -2602512,
                    "cityName": "Manchester",
                    "countryCode": "gb"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0yNjAyNTEyfQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -2602512,
                    "country": "United Kingdom",
                    "cityName": "Manchester",
                    "productCount": 278,
                    "cc1": "gb"
                }
            ]
        }
    }
]

2025-08-25 12:52:57,898 - evaluation_logger_Attraction-0 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNjAyNTEyfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:52:57,898 - evaluation_logger_Attraction-0 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNjAyNTEyfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:52:57,898 - evaluation_logger_Attraction-0 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNjAyNTEyfQ==', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNjAyNTEyfQ==', 'sortBy': 'trending'}}
2025-08-25 12:52:57,898 - evaluation_logger_Attraction-0 - INFO - Rule-based compare success.
2025-08-25 12:52:57,898 - evaluation_logger_Attraction-0 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNjAyNTEyfQ==', 'sortBy': 'trending'}}]
2025-08-25 12:52:57,899 - evaluation_logger_Attraction-0 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRwTL8LxVjTZ",
                    "name": "Manchester River Tour",
                    "slug": "prwtl8lxvjtz-manchester-river-tour",
                    "shortDescription": "A one-hour river cruise to take in the city sights",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 15.61,
                        "currency": "USD",
                        "publicAmount": 15.61
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 59,
                        "percentage": "83%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.2,
                            "total": 210
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Manchester",
                        "ufi": -2602512
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIkhUIVh26pR"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIMoqtjzJgws"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2wSwl9Y2zi"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIBfJrJ9tMZ2"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForTours",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRMDJDPj6kGD",
                    "name": "Manchester City Stadium Guided Tour",
                    "slug": "prmdjdpj6kgd-manchester-city-stadium-guided-tour",
                    "shortDescription": "A visit to see behind the scenes at Manchester City's stadium",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 33.82,
                        "currency": "USD",
                        "publicAmount": 33.82
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 108,
                        "percentage": "94%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.8,
                            "total": 192
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Manchester",
                        "ufi": -2602512
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIaXAMrln4J9"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIghNJq4PSbu"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIaLdU2hyzsC"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIH7nwdL8Zsd"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIQDqCZSGaCU"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI7XqWLZC0G7"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OISR6No6I8bG"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0jWoJqoFpi"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIyuzR5aswJm"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIhS1BdPtfTR"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIQS6vVJilpv"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIorUEzECsOP"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIxoMqlTuTeE"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OInCID41cfgu"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXzXe1G8WLE"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIFxZeOYGPFB"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIpazKdwRNGn"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIaD99vIjFaY"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OICZW8HDp0j0"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI9Jeoezrp7r"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIDQY9B76UC4"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIxCui7tOT68"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2xTUQJXPKT"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIQLRyMOnhnc"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OISd0wvN3wZ9"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForLandmarks",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "highlyRated",
                            "value": true,
                            "rank": 3
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRkdj3nMvKaC",
                    "name": "Manchester City Stadium Tour",
                    "slug": "prkdj3nmvkac-manchester-city-stadium-tour",
                    "shortDescription": "An immersive audio-visual tour, with visit to the pitch and players’ dressing rooms",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 33.82,
                        "currency": "USD",
                        "publicAmount": 33.82
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 28,
                        "percentage": "96%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 186
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Manchester",
                        "ufi": -2602512
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OILdph6HpjLt"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUauFjZgovf"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIu4KMah3HWv"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXD9Ndou24j"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 4
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForLandmarks",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "popularFor2Travelers",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRmPmcKnaJ5X",
                    "name": "Manchester City River Tour",
                    "slug": "prmpmcknaj5x-city-river-cruise",
                    "shortDescription": "A 60-minute boat cruise along Manchester's historic Ship Canal and the River Irwell",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 16.32,
                        "currency": "USD",
                        "publicAmount": 16.32
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 108,
                        "percentage": "77%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4,
                            "total": 159
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Manchester",
                        "ufi": -2602512
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1UKPhpHcK3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIIl9gy0fmkm"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIyC9SrJAzMq"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvNqu0IpgGh"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIf5fVzbZnNp"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIG2XVNwLGkn"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIMyjyqpEXnz"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUN4U1PCdc3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUfayT2pdtR"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRg9OxmujP2"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OImZFYkVEZlA"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIYPkx2S4TJC"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI8Dc15vt5Fq"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIefcEotyVNG"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRoKgxgA6Rkh",
                    "name": "Manchester Afternoon Walking Tour",
                    "slug": "prokgxga6rkh-manchester-afternoon-walking-tour",
                    "shortDescription": "If you only have a few days in the city, or you want to discover its secrets and explore the main...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 22.11,
                        "currency": "USD",
                        "publicAmount": 22.11
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 97
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Manchester",
                        "ufi": -2602512
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIpaWJudmI5c"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIdmZNnyB1mV"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIk927pMjwnx"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 7
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 278,
                "filteredProductCount": 278
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 30
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 16
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 14
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Food & drinks",
                        "tagname": "food-drinks",
                        "productCount": 5
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums, arts & culture",
                        "tagname": "museums-arts-culture",
                        "productCount": 4
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 264
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Manchester",
                        "tagname": "-2602512",
                        "productCount": 277
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Castleton",
                        "tagname": "-2592059",
                        "productCount": 1
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 36
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 13
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 78
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 63
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 90
                    }
                ]
            }
        }
    }
]

2025-08-25 12:55:03,632 - evaluation_logger_Attraction-0 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring Boot 源码分析 —— SpringApplication》](http://svip.iocoder.cn/Spring-Boot/SpringApplication/) 的**初始化**的源码解析。

在 SpringApplication 实例初始化的过程中，它会进行一些初始化的动作。同时，随着 `SpringApplication` 的逐步使用，也会增加一些初始化的逻辑。当然，这不是我们在乎的，我们在乎的是，它到底初始化了什么信息。

# 2. 构造方法

`SpringApplication` 的构造方法，用于初始化 `SpringApplication` 对象。它有多个构造方法，代码如下：

```java
// SpringApplication.java

/**
 * 源（来源）的数组
 */
private Set<Class<?>> primarySources;
/**
 * 资源加载器
 */
private ResourceLoader resourceLoader;
/**
 * 主应用类
 */
private Class<?> mainApplicationClass;
/**
 * 应用上下文初始化器（ApplicationContextInitializer）数组
 */
private List<ApplicationContextInitializer<?>> initializers;
/**
 * 应用事件监听器（ApplicationListener）数组
 */
private List<ApplicationListener<?>> listeners;

public SpringApplication(Class<?>... primarySources) {
    this(null, primarySources);
}

public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    // <1> 推断 Web 应用类型
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
    // <2> 设置应用上下文初始化器（ApplicationContextInitializer）
    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
    // <3> 设置应用事件监听器（ApplicationListener）
    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    // <4> 推断主应用类
    this.mainApplicationClass = deduceMainApplicationClass();
}
```

- `primarySources` 属性，源（来源）的数组。在文初的示例中，就是我们传递的 `DemoApplication.class`。

- `resourceLoader` 属性，资源加载器。默认为 `null`。

- `mainApplicationClass` 属性，主应用类。在文初的示例中，就是我们传递的 `DemoApplication.class`。

- `initializers` 属性，应用上下文初始化器（ApplicationContextInitializer）数组。通过 `<2>` 处进行加载。

- `listeners` 属性，应用事件监听器（ApplicationListener）数组。通过 `<3>` 处进行加载。

- `<1>` 处，调用 `WebApplicationType#deduceFromClasspath()` 方法，推断 Web 应用类型。Web 应用类型是 `WebApplicationType` 枚举，一共有三种：NONE、SERVLET、REACTIVE。详细解析，见 [「2.1 WebApplicationType」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

- `<2>` 处，设置应用上下文初始化器（ApplicationContextInitializer）数组。详细解析，见 [「2.2 设置 ApplicationContextInitializer」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

- `<3>` 处，设置应用事件监听器（ApplicationListener）数组。详细解析，见 [「2.3 设置 ApplicationListener」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

- `<4>` 处，推断主应用类。详细解析，见 [「2.4 推断主应用类」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

## 2.1 WebApplicationType

`org.springframework.boot.WebApplicationType` ，Web 应用类型枚举。代码如下：

```java
// WebApplicationType.java

public enum WebApplicationType {

    /**
     * 非 Web 项目
     */
    NONE,
    /**
     * Servlet Web 项目
     */
    SERVLET,
    /**
     * Reactive Web 项目
     */
    REACTIVE;

    private static final String[] SERVLET_INDICATOR_CLASSES = { "javax.servlet.Servlet",
            "org.springframework.web.context.ConfigurableWebApplicationContext" };

    private static final String WEBMVC_INDICATOR_CLASS = "org.springframework.web.servlet.DispatcherServlet";
    private static final String WEBFLUX_INDICATOR_CLASS = "org.springframework.web.reactive.DispatcherHandler";
    private static final String JERSEY_INDICATOR_CLASS = "org.glassfish.jersey.servlet.ServletContainer";
    private static final String SERVLET_APPLICATION_CONTEXT_CLASS = "org.springframework.web.context.WebApplicationContext";
    private static final String REACTIVE_APPLICATION_CONTEXT_CLASS = "org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext";

    /**
     * 推断 Web 应用类型。
     *
     * 通过判断是否存在指定的类，从而进行推断。
     *
     * @return Web 应用类型
     */
    static WebApplicationType deduceFromClasspath() {
        // 如果存在 org.springframework.web.reactive.DispatcherHandler ，并且不存在 org.springframework.web.servlet.DispatcherServlet 和 org.glassfish.jersey.servlet.ServletContainer ，则定义为 Reactive 类型。
        if (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null) && !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null)
                && !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) {
            return WebApplicationType.REACTIVE;
        }
        // 如果不存在 javax.servlet.Servlet 和 org.springframework.web.context.ConfigurableWebApplicationContext 任何一个类，则定义为 None 类型。
        for (String className : SERVLET_INDICATOR_CLASSES) {
            if (!ClassUtils.isPresent(className, null)) {
                return WebApplicationType.NONE;
            }
        }
        // 否则，定义为 Servlet 类型
        return WebApplicationType.SERVLET;
    }

    // ... 省略其它方法
}
```

- 通过判断是否存在指定的类，从而进行推断。

## 2.2 设置 ApplicationContextInitializer

`#setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers)` 方法，设置应用上下文初始化器（ApplicationContextInitializer）数组。代码如下：

```java
// SpringApplication.java

public void setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers) {
	this.initializers = new ArrayList<>(initializers);
}
```

- 那么，`#getSpringFactoriesInstances(Class<T> type)` 方法，如何获得指定类型对应的对象们呢？详细解析，见 [「2.5 getSpringFactoriesInstances」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

## 2.3 设置 ApplicationListener

`#setListeners(Collection<? extends ApplicationListener<?>> listeners)` 方法，设置应用事件监听器（ApplicationListener）数组。代码如下：

```java
// SpringApplication.java

public void setListeners(Collection<? extends ApplicationListener<?>> listeners) {
	this.listeners = new ArrayList<>(listeners);
}
```

- 那么，`#getSpringFactoriesInstances(Class<T> type)` 方法，如何获得指定类型对应的对象们呢？详细解析，见 [「2.5 getSpringFactoriesInstances」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

## 2.4 推断主应用类

`#deduceMainApplicationClass()` 方法，推断主应用类。代码如下：

```java
// SpringApplication.java

private Class<?> deduceMainApplicationClass() {
    try {
        // 获得当前 StackTraceElement 数组
        StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();
        // 遍历 StackTraceElement 数组，找到主应用类
        for (StackTraceElement stackTraceElement : stackTrace) {
            if ("main".equals(stackTraceElement.getMethodName())) {
                return Class.forName(stackTraceElement.getClassName());
            }
        }
    } catch (ClassNotFoundException ex) {
        // Swallow and continue
    }
    return null;
}
```

- 通过异常方式，获取当前 StackTraceElement 数组，然后遍历数组，找到方法名为 `"main"` 的 StackTraceElement 元素，从而获得主应用类。

## 2.5 getSpringFactoriesInstances

`#getSpringFactoriesInstances(Class<T> type)` 方法，获得指定类型对应的对象们。代码如下：

```java
// SpringApplication.java

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type) {
    return getSpringFactoriesInstances(type, new Class<?>[] {});
}

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, Object... args) {
    ClassLoader classLoader = getClassLoader();
    // Use names and ensure unique to protect against duplicates
    // <1> 加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组
    Set<String> names = new LinkedHashSet<>(SpringFactoriesLoader.loadFactoryNames(type, classLoader));
    // <2> 创建对象们
    List<T> instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);
    // <3> 排序对象们
    AnnotationAwareOrderComparator.sort(instances);
    return instances;
}
```

- `<1>` 处，调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组。

  - 关于 `SpringFactoriesLoader` 的详细解析，见 [《【死磕 Spring】—— IoC 之加载 BeanDefinition》](http://svip.iocoder.cn/Spring/IoC-load-BeanDefinitions/?vip) 的 [「3. SpringFactoriesLoader」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 小节。

- `<2>` 处，调用 `#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象们。代码如下：

  ```java
  // SpringApplication.java
  
  private <T> List<T> createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes,
  		ClassLoader classLoader, Object[] args, Set<String> names) {
  	List<T> instances = new ArrayList<>(names.size());
  	for (String name : names) {
  		try {
  			// 获得类
  			Class<?> instanceClass = ClassUtils.forName(name, classLoader);
  			// 判断类是否实现自 type
  			Assert.isAssignable(type, instanceClass);
  			// 获得构造方法
  			Constructor<?> constructor = instanceClass.getDeclaredConstructor(parameterTypes);
  			// 创建对象
  			T instance = (T) BeanUtils.instantiateClass(constructor, args);
  			instances.add(instance);
  		} catch (Throwable ex) {
  			throw new IllegalArgumentException("Cannot instantiate " + type + " : " + name, ex);
  		}
  	}
  	return instances;
  }
  ```

  - 通过反射，创建对象。

- `<3>` 处，调用 `AnnotationAwareOrderComparator#sort(List<?> list)` 方法，排序对象们。

  - 关于 `AnnotationAwareOrderComparator` 的详细解析，见 [《【死磕 Spring】—— ﻿@Order 和 Ordered》](http://svip.iocoder.cn/Spring/Order-Ordered/?vip) 。

# 3. 小结

至此，我们已经完成了 `SpringApplication` 对象的初始化。但是，此时 `SpringApplication` 还没开始启动，所以 Spring 容器也未初始化。

另外，`initializers` 和 `listeners` 属性，涉及 Spring Boot 的拓展机制，我们会在下一篇文章，详细解析。

2025-08-25 12:55:10,585 - evaluation_logger_Attraction-0 - INFO - Complete Result: {'score': 0, 'reason': 'no requested information is addressed'}
2025-08-25 12:55:16,288 - evaluation_logger_Attraction-0 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:55:16,288 - evaluation_logger_Attraction-0 - INFO - Message: Success.
2025-08-25 12:55:16,288 - evaluation_logger_Attraction-0 - INFO - Success turn num = 2
2025-08-25 12:55:16,288 - evaluation_logger_Attraction-0 - INFO - ----------------------------------------------------------------------------------------------------
