2025-08-25 12:53:17,678 - evaluation_logger_Attraction-6 - INFO - Test Example Attraction-6
2025-08-25 12:53:17,678 - evaluation_logger_Attraction-6 - INFO - Query: Check out the most trending tourist spots in Cambridge for my family trip.
2025-08-25 12:53:28,028 - evaluation_logger_Attraction-6 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Cambridge"
        }
    }
]

2025-08-25 12:53:28,028 - evaluation_logger_Attraction-6 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Cambridge"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNTkxNjU4fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:28,028 - evaluation_logger_Attraction-6 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Cambridge'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Cambridge'}}
2025-08-25 12:53:28,028 - evaluation_logger_Attraction-6 - INFO - Rule-based compare success.
2025-08-25 12:53:28,028 - evaluation_logger_Attraction-6 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Cambridge'}}]
2025-08-25 12:53:28,028 - evaluation_logger_Attraction-6 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI0b25vbU9pSkxhIiwidWZpIjotMjU5MTY1OH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Creepy Cambridge - Cambridge's Most Entertaining Ghost Walk",
                    "productId": "PR4onomOiJLa",
                    "productSlug": "pr4onomoijla-cambridge-ghost-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -2591658,
                    "cityName": "Cambridge",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJFZE9KeEJINmFWIiwidWZpIjotMjU5MTY1OH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Curious Cambridge - Cambridge's Most Entertaining History Tour",
                    "productId": "PREdOJxBH6aV",
                    "productSlug": "predojxbh6av-cambridge-history-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -2591658,
                    "cityName": "Cambridge",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJUcmhOQm9hMWpuIiwidWZpIjotMjYwMTg4OX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Discover Oxford and Cambridge",
                    "productId": "PRTrhNBoa1jn",
                    "productSlug": "prtrhnboa1jn-discover-oxford-and-cambridge",
                    "taxonomySlug": "tours",
                    "cityUfi": -2601889,
                    "cityName": "London",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJYUHlVOUlJYVpqIiwidWZpIjotMjU5MTY1OH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Private Tour of Cambridge",
                    "productId": "PRXPyU9IIaZj",
                    "productSlug": "prxpyu9iiazj-private-tour-of-cambridge",
                    "taxonomySlug": "tours",
                    "cityUfi": -2591658,
                    "cityName": "Cambridge",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJydURvVU93NU9iIiwidWZpIjotMjU5MTY1OH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Cambridge Science Tour",
                    "productId": "PRruDoUOw5Ob",
                    "productSlug": "prrudouow5ob-cambridge-science-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -2591658,
                    "cityName": "Cambridge",
                    "countryCode": "gb"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0yNTkxNjU4fQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -2591658,
                    "country": "United Kingdom",
                    "cityName": "Cambridge",
                    "productCount": 78,
                    "cc1": "gb"
                }
            ]
        }
    }
]

2025-08-25 12:53:37,864 - evaluation_logger_Attraction-6 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNTkxNjU4fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:37,864 - evaluation_logger_Attraction-6 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNTkxNjU4fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:37,864 - evaluation_logger_Attraction-6 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNTkxNjU4fQ==', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNTkxNjU4fQ==', 'sortBy': 'trending'}}
2025-08-25 12:53:37,864 - evaluation_logger_Attraction-6 - INFO - Rule-based compare success.
2025-08-25 12:53:37,864 - evaluation_logger_Attraction-6 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNTkxNjU4fQ==', 'sortBy': 'trending'}}]
2025-08-25 12:53:37,865 - evaluation_logger_Attraction-6 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PR4FoqxAnTHm",
                    "name": "Small-Group Punting Tour",
                    "slug": "pr4foqxanthm-small-group-punting-tour",
                    "shortDescription": "A guided historical tour of Cambridge along the River Cam",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 23.4,
                        "currency": "USD",
                        "publicAmount": 23.4
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 89,
                        "percentage": "97%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 277
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Cambridge",
                        "ufi": -2591658
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIJcLTUtLC5Y"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGy8z2Bkffb"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIQTavgP1cyM"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI483Axg2axx"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIPYFhNwoYn8"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForTours",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "highlyRated",
                            "value": true,
                            "rank": 3
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRzX7UrnjgCw",
                    "name": "24-hour Hop-on, Hop-off Bus Tour",
                    "slug": "przx7urnjgcw-24-hour-hop-on-hop-off-bus-tour",
                    "shortDescription": "A sightseeing bus tour to discover the culture and history of the city",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 22.1,
                        "currency": "USD",
                        "publicAmount": 22.1
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 39,
                        "percentage": "92%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.3,
                            "total": 94
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Cambridge",
                        "ufi": -2591658
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6zIfvWsylj"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZgs5IjLHAE"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGYLjBc4AOd"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI8302f4n8UT"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2Ih3PpGKFZ"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIYDCovJiBob"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIohyr3ovnMy"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIQXBeTQBfjX"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZpxZqxaiC1"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OILW9B9AchjU"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6IlxJLL4Oe"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIF9j4WhGzTD"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIljTgZb8J7P"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1wh9gc0xbL"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6bxReC2CCl"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRyPY5rGo7sB",
                    "name": "Cambridge | Alumni-Led Walking Tour w/opt Kings College Entry",
                    "slug": "prypy5rgo7sb-cambridge-college-walking-tour",
                    "shortDescription": "Our guides, Cambridge alumni or students, blend personal experiences with a passion for the city'...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 25.98,
                        "currency": "USD",
                        "publicAmount": 25.98
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 5,
                        "percentage": "60%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 209
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Cambridge",
                        "ufi": -2591658
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI00FfU0nXHi"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2Vl47fs1XP"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIT97uACxOLS"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIDbg4WMzxP5"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIsgOGlXuZtz"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIOuUnBQpv3j"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIJMpAyfpJJu"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIV3udhsibbH"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIynb2U8MUvE"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvLmdxptY58"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 3
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PR4onomOiJLa",
                    "name": "Creepy Cambridge - Cambridge's Most Entertaining Ghost Walk",
                    "slug": "pr4onomoijla-cambridge-ghost-tour",
                    "shortDescription": "What do you get if you take 2000 years of history, add lashings of ancient buildings, and mix in ...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 24.68,
                        "currency": "USD",
                        "publicAmount": 24.68
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 9,
                        "percentage": "100%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.8,
                            "total": 52
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Cambridge",
                        "ufi": -2591658
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI9h8iQonGyv"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIHu4fiBTn1C"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIyIzF9rA0Lp"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIV5BTZMYMva"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 6
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRyEPXLHW6ee",
                    "name": "Cambridge University Walking Tour",
                    "slug": "pryepxlhw6ee-cambridge-university-walking-tour",
                    "shortDescription": "A guided walking tour to explore Cambridge University and the city",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 32.49,
                        "currency": "USD",
                        "publicAmount": 32.49
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 60,
                        "percentage": "95%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 59
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Cambridge",
                        "ufi": -2591658
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvF8ExeIkz4"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIG0GMNApyuC"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXZuD7hEw8d"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIt0kZJJwvX7"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI9gVi1bR2RT"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 5
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForTours",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "highlyRated",
                            "value": true,
                            "rank": 1
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 78,
                "filteredProductCount": 78
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 31
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 26
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums, arts & culture",
                        "tagname": "museums-arts-culture",
                        "productCount": 16
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 4
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 72
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Cambridge",
                        "tagname": "-2591658",
                        "productCount": 78
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 23
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 20
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 7
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 1
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 28
                    }
                ]
            }
        }
    }
]

2025-08-25 12:55:53,129 - evaluation_logger_Attraction-6 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 前言

在上一篇文章中，我们实现了`axios`的请求和响应配置化，即用户可以配置`config`对象中的`url`、`method`、`params`和`data`属性来发起请求，其中`params`和`data`会根据请求方法不同而序列化的方式也不同。另外，我们还定义了`AxiosResponse`类型接口，用于定义响应的数据类型。

但是，在上一篇文章中，我们虽然可以正常从服务端获取响应数据，但是我们在代码中却并没有把响应数据返回给用户，也就是说用户是拿不到服务端返回的数据的。那么本篇文章，我们就来处理响应数据，让用户能够拿到服务端返回的数据。

# 2. 需求分析

首先，我们先来思考下，我们想要把响应数据返回给用户，那么我们在`axios`函数内部拿到响应数据之后应该怎么处理？我们可以返回一个`Promise`对象，并且把响应数据`resole`出去，如下：

```typescript
function axios(config: AxiosRequestConfig): Promise<AxiosResponse> {
  return new Promise((resolve, reject) => {
    // ...
    // 异步执行请求
    // ...
    // 拿到响应数据后执行resolve
    resolve(response);
  });
}
```

这样，用户就可以通过`then`方法拿到响应数据了，如下：

```typescript
axios({
  method: "get",
  url: "/api/hi",
  params: {
    a: 1,
    b: 2,
  },
}).then((res: AxiosResponse) => {
  console.log(res);
});
```

OK，我们已经知道如何处理响应数据了，那么接下来我们就来实现它。

# 3. 实现流程

首先，我们要明确一点：我们发送请求是异步的，所以我们返回一个`Promise`对象。在`Promise`对象内部，我们执行发送请求的异步操作，当拿到响应数据后，我们执行`resolve`方法，把响应数据传递出去。

那么，我们接下来就按照这个思路来改造我们的代码。

## 3.1 修改`axios`函数

我们修改`src/index.ts`文件中的`axios`函数，让其返回一个`Promise`对象，如下：

```typescript
function axios(config: AxiosRequestConfig): Promise<any> {
  return new Promise((resolve, reject) => {
    const {
      url,
      method = "get",
      params = {},
      data = {},
      headers = {},
      responseType,
    } = config;

    const request = new XMLHttpRequest();

    if (responseType) {
      request.responseType = responseType;
    }

    request.open(method.toUpperCase(), buildURL(url, params), true);

    Object.keys(headers).forEach((name) => {
      request.setRequestHeader(name, headers[name]);
    });

    request.onreadystatechange = function handleLoad() {
      if (request.readyState !== 4) {
        return;
      }

      const responseHeaders = parseHeaders(request.getAllResponseHeaders());
      const responseData =
        responseType && responseType !== "text"
          ? request.response
          : request.responseText;
      const response: AxiosResponse = {
        data: responseData,
        status: request.status,
        statusText: request.statusText,
        headers: responseHeaders,
        config,
        request,
      };
      resolve(response);
    };

    request.send(transformData(data, headers));
  });
}
```

代码说明：

- 首先，我们让`axios`函数返回一个`Promise`对象；
- 在`Promise`对象内部，我们执行发送请求的异步操作；
- 当请求状态改变时，我们判断如果`readyState`为 4，说明请求已经完成，我们就解析响应数据，并构建一个`AxiosResponse`类型的响应对象`response`；
- 然后，我们执行`resolve(response)`，把响应对象传递出去；

这样，我们就完成了`axios`函数的改造。

## 3.2 编写 demo

接下来，我们编写一个`demo`来测试下我们改造后的`axios`函数是否能够正常返回响应数据。

我们在`examples`目录下创建`addResponseData.html`文件，其内容如下：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>addResponseData demo</title>
  </head>
  <body>
    <script src="/__build__/addResponseData.js"></script>
  </body>
</html>
```

然后在`examples`目录下创建`addResponseData.ts`文件，其内容如下：

```typescript
import axios from "../../src/index";

axios({
  method: "get",
  url: "/api/hi",
  params: {
    a: 1,
    b: 2,
  },
}).then((res) => {
  console.log(res);
});

axios({
  method: "post",
  url: "/api/hi",
  data: {
    a: 1,
    b: 2,
  },
}).then((res) => {
  console.log(res);
});
```

接着，我们需要在`server.js`中添加这个接口，如下：

```javascript
// 添加get接口
router.get("/api/hi", function(req, res) {
  res.json({
    msg: "hello world",
  });
});

// 添加post接口
router.post("/api/hi", function(req, res) {
  res.json({
    msg: "hello world",
  });
});
```

最后，在根目录下的`index.html`中加上`addResponseData.html`的入口，如下：

```html
<li><a href="examples/addResponseData.html">addResponseData</a></li>
```

OK，我们验证一下，在命令行中执行：

```bash
# 同时开启客户端和服务端
npm run server | npm start
```

接着在浏览器中打开`http://localhost:8000/`，点击`addResponseData`，然后打开控制台，可以看到如下输出：

![](~@/axios/05/01.png)

从上图中可以看到，我们成功的拿到了服务端返回的响应数据，并且响应数据的格式也是我们之前定义的`AxiosResponse`类型。

# 4. 处理网络异常

虽然我们已经可以拿到响应数据了，但是我们还缺少对异常情况的处理，比如：网络异常、请求超时等。当出现这些异常情况时，我们应该触发`Promise`的`reject`，把错误信息传递出去，让用户能够处理这些异常。

那么，接下来我们就来处理网络异常情况。

## 4.1 处理网络异常错误

当网络出现异常（比如断网）的时候，此时`XMLHttpRequest`对象的`onerror`事件会被触发，我们可以在该事件的回调函数中触发`reject`，如下：

```typescript
request.onerror = function handleError() {
  reject(new Error("Network Error"));
};
```

## 4.2 处理请求超时错误

当请求超时的时候，此时`XMLHttpRequest`对象的`ontimeout`事件会被触发，我们可以在该事件的回调函数中触发`reject`，如下：

```typescript
request.ontimeout = function handleTimeout() {
  reject(new Error(`Timeout of ${timeout} ms exceeded`));
};
```

另外，我们还需要在请求配置对象中增加`timeout`属性，用于指定请求超时时间，如下：

```typescript
function axios(config: AxiosRequestConfig): Promise<any> {
  return new Promise((resolve, reject) => {
    const {
      url,
      method = "get",
      params = {},
      data = {},
      headers = {},
      responseType,
      timeout,
    } = config;

    const request = new XMLHttpRequest();

    if (responseType) {
      request.responseType = responseType;
    }

    if (timeout) {
      request.timeout = timeout;
    }

    // ...
  });
}
```

## 4.3 处理非 200 状态码

当一个请求正常返回的时候，它的状态码可能是 200、300、400、500 等，对于 2xx 的状态码，我们认为它们是正常的，但是对于其它状态码，我们也认为它们是错误的实现，我们也需要触发`reject`。

所以，我们在`onreadystatechange`事件中，当`readyState`为 4 的时候，我们判断一下状态码，如果状态码不在 200 之间，我们也触发`reject`，如下：

```typescript
request.onreadystatechange = function handleLoad() {
  if (request.readyState !== 4) {
    return;
  }

  // 如果请求出错，直接返回，不执行下面的代码
  if (request.status === 0) {
    return;
  }

  const responseHeaders = parseHeaders(request.getAllResponseHeaders());
  const responseData =
    responseType && responseType !== "text"
      ? request.response
      : request.responseText;
  const response: AxiosResponse = {
    data: responseData,
    status: request.status,
    statusText: request.statusText,
    headers: responseHeaders,
    config,
    request,
  };

  // 处理非200状态码
  if (response.status >= 200 && response.status < 300) {
    resolve(response);
  } else {
    reject(new Error(`Request failed with status code ${response.status}`));
  }
};
```

这里有一点需要注意：当网络错误或者超时错误的时候，`request.status`为 0，所以我们判断如果`request.status`为 0，我们就直接返回，不执行后面的代码。

## 4.4 编写 demo

接下来，我们编写一个`demo`来测试下异常情况。

我们在`examples`目录下创建`addError.html`文件，其内容如下：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>addError demo</title>
  </head>
  <body>
    <script src="/__build__/addError.js"></script>
  </body>
</html>
```

然后在`examples`目录下创建`addError.ts`文件，其内容如下：

```typescript
import axios from "../../src/index";

// 模拟网络错误
axios({
  method: "get",
  url: "/api/hi",
  params: {
    a: 1,
    b: 2,
  },
})
  .then((res) => {
    console.log(res);
  })
  .catch((e) => {
    console.log(e);
  });

// 模拟超时
axios({
  method: "get",
  url: "/api/hi",
  params: {
    a: 1,
    b: 2,
  },
  timeout: 2000,
})
  .then((res) => {
    console.log(res);
  })
  .catch((e) => {
    console.log(e);
  });

// 模拟状态码非200
axios({
  method: "get",
  url: "/api/status/500",
})
  .then((res) => {
    console.log(res);
  })
  .catch((e) => {
    console.log(e);
  });

axios({
  method: "get",
  url: "/api/status/404",
})
  .then((res) => {
    console.log(res);
  })
  .catch((e) => {
    console.log(e);
  });
```

接着，我们需要在`server.js`中添加这两个接口，如下：

```javascript
// 添加500状态码接口
router.get("/api/status/500", function(req, res) {
  res.status(500).json({
    msg: "hello world",
  });
});

// 添加404状态码接口
router.get("/api/status/404", function(req, res) {
  res.status(404).json({
    msg: "hello world",
  });
});
```

最后，在根目录下的`index.html`中加上`addError.html`的入口，如下：

```html
<li><a href="examples/addError.html">addError</a></li>
```

OK，我们验证一下，在命令行中执行：

```bash
# 同时开启客户端和服务端
npm run server | npm start
```

接着在浏览器中打开`http://localhost:8000/`，点击`addError`，然后打开控制台，可以看到如下输出：

![](~@/axios/05/02.png)

从上图中可以看到，我们成功的捕获了网络错误、超时错误以及非 200 状态码的错误。

# 5. 总结

本篇文章中，我们实现了响应数据的处理，让用户能够拿到服务端返回的数据。另外，我们还处理了网络异常、请求超时以及非 200 状态码等异常情况，让用户能够捕获这些异常并进行处理。

至此，我们的`axios`已经具备了基本的功能，可以正常发送请求并处理响应了。但是，我们目前的代码还比较粗糙，很多地方还可以优化，在接下来的文章中，我们会继续优化我们的代码。


2025-08-25 12:55:59,365 - evaluation_logger_Attraction-6 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any information about the most trending tourist spots in Cambridge.'}
2025-08-25 12:56:05,727 - evaluation_logger_Attraction-6 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:56:05,728 - evaluation_logger_Attraction-6 - INFO - Message: Success.
2025-08-25 12:56:05,728 - evaluation_logger_Attraction-6 - INFO - Success turn num = 2
2025-08-25 12:56:05,728 - evaluation_logger_Attraction-6 - INFO - ----------------------------------------------------------------------------------------------------
