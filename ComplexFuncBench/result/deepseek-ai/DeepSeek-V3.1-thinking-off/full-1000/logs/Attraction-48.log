2025-08-25 12:59:48,805 - evaluation_logger_Attraction-48 - INFO - Test Example Attraction-48
2025-08-25 12:59:48,805 - evaluation_logger_Attraction-48 - INFO - Query: I'm thinking about heading to Berlin. Can you tell me which museums are currently trending?
2025-08-25 12:59:56,996 - evaluation_logger_Attraction-48 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Berlin"
        }
    }
]

2025-08-25 12:59:56,996 - evaluation_logger_Attraction-48 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Berlin"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:59:56,996 - evaluation_logger_Attraction-48 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Berlin'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Berlin'}}
2025-08-25 12:59:56,996 - evaluation_logger_Attraction-48 - INFO - Rule-based compare success.
2025-08-25 12:59:56,996 - evaluation_logger_Attraction-48 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Berlin'}}]
2025-08-25 12:59:56,996 - evaluation_logger_Attraction-48 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -1746443,
                    "country": "Germany",
                    "cityName": "Berlin",
                    "productCount": 768,
                    "cc1": "de"
                }
            ]
        }
    }
]

2025-08-25 13:00:06,910 - evaluation_logger_Attraction-48 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 13:00:06,910 - evaluation_logger_Attraction-48 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 13:00:06,910 - evaluation_logger_Attraction-48 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNzQ2NDQzfQ==', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNzQ2NDQzfQ==', 'sortBy': 'trending'}}
2025-08-25 13:00:06,910 - evaluation_logger_Attraction-48 - INFO - Rule-based compare success.
2025-08-25 13:00:06,910 - evaluation_logger_Attraction-48 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNzQ2NDQzfQ==', 'sortBy': 'trending'}}]
2025-08-25 13:00:06,910 - evaluation_logger_Attraction-48 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PROwQ0SIhEow",
                    "name": "Public Transport Ticket",
                    "slug": "prowq0siheow-public-transport-ticket",
                    "shortDescription": "A ticket providing 24-hour unlimited access to Berlin's public transport system",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 12.48,
                        "currency": "USD",
                        "publicAmount": 12.48
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 932
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI58pbhPgvEO"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRAVEI2rvEWs",
                    "name": "River Cruise with Tour Guide (Ger./Engl.) Berlin. Hadynski",
                    "slug": "pravei2rvews-river-cruise-with-tour-guide-in-berlin-hadynski",
                    "shortDescription": "Enjoy our 1 hour river cruise through the old and new part of Berlin. Take in a different perspec...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 20.8,
                        "currency": "USD",
                        "publicAmount": 20.8
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 472
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIFFSv1d1B8r"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIr5gc4kT9T1"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItYkL3ICTtg"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIzgUlSEYqJX"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIrUDMloO4sc"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRwKuUPcnc2P",
                    "name": "Berlin Third Reich and Cold War 2-Hour Walking Tour",
                    "slug": "prwkuupcnc2p-berlin-third-reich-and-cold-war-2-hour-walking-tour",
                    "shortDescription": "Learn the tumultuous contemporary history of Berlin on a guided walking tour of the city's iconic...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 21.79,
                        "currency": "USD",
                        "publicAmount": 21.79
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.8,
                            "total": 386
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIapI3EeF9GZ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRyzkqvi1j7"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0cQYzWLvqJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIozzOnLWgfz"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 3
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRX5UGIrbMB5",
                    "name": "City Sightseeing Berlin Hop On Hop Off Bus Tour - All Lines (A+B)",
                    "slug": "prx5ugirbmb5-city-sightseeing-berlin-hop-on-hop-off-bus-tour-all-lines-ab",
                    "shortDescription": "Explore the very best of what Berlin has to offer aboard a City Sightseeing double-decker bus wit...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 32.84,
                        "currency": "USD",
                        "publicAmount": 32.84
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.2,
                            "total": 26
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKmpbP2q3je"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIcHsOu95K8i"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIdD4sY2DC3w"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIs4F8Vz5dLQ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0YKncBuCr9"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIDixOPb8zfP"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PRHEhfb9dVIR",
                    "name": "Panoramapunkt and Elevator Ride",
                    "slug": "prhehfb9dvir-panoramapunkt-and-elevator-ride",
                    "shortDescription": "A ride on Europe’s fastest elevator for panoramic views of the city",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 9.85,
                        "currency": "USD",
                        "publicAmount": 9.85
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 272,
                        "percentage": "93%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 353
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2yxA4CJ7Jn"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIqx5Z8l3IHj"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRhdCEiWf3u"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6dV1G3Rxg3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUIOzIMYEjf"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIoXrcVGfLRR"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIdwmkIYJ2kF"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1VMRt5F23j"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIjZzQawwmsJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI90gd4uiXfJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0rE2bJpBi5"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZelpFBfI5i"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuLj828L6rL"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OISgrzjtmov4"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 6
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForLandmarks",
                            "value": true,
                            "rank": 2
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 678,
                "filteredProductCount": 678
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 533
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Activities",
                        "tagname": "activities",
                        "productCount": 65
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Transfers & services",
                        "tagname": "transfers-services",
                        "productCount": 41
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums",
                        "tagname": "museums",
                        "productCount": 23
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Attractions",
                        "tagname": "attractions",
                        "productCount": 11
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 593
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Berlin",
                        "tagname": "-1746443",
                        "productCount": 640
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Potsdam",
                        "tagname": "-1844464",
                        "productCount": 28
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Schonefeld",
                        "tagname": "-1860228",
                        "productCount": 10
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 112
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 130
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 49
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 61
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 327
                    }
                ]
            }
        }
    }
]

2025-08-25 13:02:14,523 - evaluation_logger_Attraction-48 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring Boot 源码分析 —— SpringApplication》](http://svip.iocoder.cn/Spring-Boot/SpringApplication/) 的**初始化**的源码解析。

在 SpringApplication 的构造方法中，会进行一些初始化的工作。虽然说，它没有向 Spring 容器中添加 Bean ，但是**初始化**的过程，也是非常重要的。代码如下：

```java
// SpringApplication.java

/**
 * Create a new {@link SpringApplication} instance. The application context will load
 * beans from the specified primary sources (see {@link SpringApplication class-level}
 * documentation for details. The instance can be customized before calling
 * {@link #run(String...)}.
 * @param resourceLoader the resource loader to use
 * @param primarySources the primary bean sources
 * @see #run(Class, String[])
 * @see #setSources(Set)
 */
@SuppressWarnings({ "unchecked", "rawtypes" })
public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    // <1> 设置 resourceLoader 属性
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    // <2> 设置 primarySources 属性
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    // <3> 推断 Web 应用类型
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
    // <4> 设置 ApplicationContextInitializer
    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
    // <5> 设置 ApplicationListener
    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    // <6> 推断主类
    this.mainApplicationClass = deduceMainApplicationClass();
}
```

- `<1>` 处，设置 `resourceLoader` 属性。
- `<2>` 处，设置 `primarySources` 属性。
- `<3>` 处，调用 `WebApplicationType#deduceFromClasspath()` 方法，推断 Web 应用类型。详细解析，见 [「2. 推断 Web 应用类型」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<4>` 处，设置 `ApplicationContextInitializer` 属性。详细解析，见 [「3. 设置 ApplicationContextInitializer」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<5>` 处，设置 `ApplicationListener` 属性。详细解析，见 [「4. 设置 ApplicationListener」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<6>` 处，调用 `#deduceMainApplicationClass()` 方法，推断主类。详细解析，见 [「5. 推断主类」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

# 2. 推断 Web 应用类型

`webApplicationType` 属性，Web 应用类型。在 `org.springframework.boot.WebApplicationType` 枚举类中，一共有三种：

```java
// WebApplicationType.java

public enum WebApplicationType {

    /**
     * The application should not run as a web application and should not start an
     * embedded web server.
     */
    NONE,

    /**
     * The application should run as a servlet-based web application and should start an
     * embedded servlet web server.
     */
    SERVLET,

    /**
     * The application should run as a reactive web application and should start an
     * embedded reactive web server.
     */
    REACTIVE;

}
```

- `NONE`：非 Web 项目。
- `SERVLET`：Servlet Web 项目。
- `REACTIVE`：响应式 Web 项目。

## 2.1 deduceFromClasspath

`WebApplicationType#deduceFromClasspath()` 方法，通过 classpath ，推断 Web 应用类型。代码如下：

```java
// WebApplicationType.java

private static final String[] SERVLET_INDICATOR_CLASSES = { "javax.servlet.Servlet",
		"org.springframework.web.context.ConfigurableWebApplicationContext" };

private static final String WEBMVC_INDICATOR_CLASS = "org.springframework.web.servlet.DispatcherServlet";
private static final String WEBFLUX_INDICATOR_CLASS = "org.springframework.web.reactive.DispatcherHandler";
private static final String JERSEY_INDICATOR_CLASS = "org.glassfish.jersey.servlet.ServletContainer";

static WebApplicationType deduceFromClasspath() {
    // 如果存在 REACTIVE 相关的类，则返回 REACTIVE
    if (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null) && !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null)
            && !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) {
        return WebApplicationType.REACTIVE;
    }
    // 如果不存在 SERVLET 相关的类，则返回 NONE
    for (String className : SERVLET_INDICATOR_CLASSES) {
        if (!ClassUtils.isPresent(className, null)) {
            return WebApplicationType.NONE;
        }
    }
    // 否则，返回 SERVLET
    return WebApplicationType.SERVLET;
}
```

- 逻辑比较简单，胖友自己看下注释。

# 3. 设置 ApplicationContextInitializer

`initializers` 属性，ApplicationContextInitializer 数组。ApplicationContextInitializer 是 Spring 框架的接口，实现该接口，并实现 `#initialize(C applicationContext)` 方法，可以在 Spring 容器被刷新之前进行初始化。

## 3.1 getSpringFactoriesInstances

在设置 `initializers` 属性时，会调用 `#getSpringFactoriesInstances(Class<T> type)` 方法，获得 `type` 类型对应的，在 `META-INF/spring.factories` 里配置的类名的数组。代码如下：

```java
// SpringApplication.java

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type) {
    return getSpringFactoriesInstances(type, new Class<?>[] {});
}

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, Object... args) {
    ClassLoader classLoader = getClassLoader();
    // Use names and ensure unique to protect against duplicates
    // <1> 加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组
    Set<String> names = new LinkedHashSet<>(SpringFactoriesLoader.loadFactoryNames(type, classLoader));
    // <2> 创建对象
    List<T> instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);
    // <3> 排序
    AnnotationAwareOrderComparator.sort(instances);
    return instances;
}
```

- `<1>` 处，调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组。关于 SpringFactoriesLoader 的详细解析，见 [《【死磕 Spring】—— IoC 之加载 BeanDefinition》](http://svip.iocoder.cn/Spring/IoC-load-BeanDefinitions/?vip) 的 [「3. loadFactoryNames」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 小节。
- `<2>` 处，调用 `#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象数组。详细解析，见 [「3.2 createSpringFactoriesInstances」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<3>` 处，调用 `AnnotationAwareOrderComparator#sort(List<?> list)` 方法，排序对象数组。关于 OrderComparator ，在 [《【死磕 Spring】—— ApplicationContext 相关接口架构分析》](http://svip.iocoder.cn/Spring/ApplicationContext/?vip) 有详细解析。

## 3.2 createSpringFactoriesInstances

`#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象数组。代码如下：

```java
// SpringApplication.java

/**
 * 创建对象数组
 *
 * @param type 类型
 * @param parameterTypes 构造方法的参数类型
 * @param classLoader 类加载器
 * @param args 参数
 * @param names 类名集合
 * @param <T> 泛型
 * @return 对象数组
 */
@SuppressWarnings("unchecked")
private <T> List<T> createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes,
        ClassLoader classLoader, Object[] args, Set<String> names) {
    List<T> instances = new ArrayList<>(names.size());
    for (String name : names) {
        try {
            // 获得类
            Class<?> instanceClass = ClassUtils.forName(name, classLoader);
            // 判断类是否实现 type 接口
            Assert.isAssignable(type, instanceClass);
            // 获得构造方法
            Constructor<?> constructor = instanceClass.getDeclaredConstructor(parameterTypes);
            // 创建对象
            T instance = (T) BeanUtils.instantiateClass(constructor, args);
            instances.add(instance);
        } catch (Throwable ex) {
            throw new IllegalArgumentException("Cannot instantiate " + type + " : " + name, ex);
        }
    }
    return instances;
}
```

- 代码比较简单，胖友自己看下注释。

## 3.3 setInitializers

`#setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers)` 方法，设置 `initializers` 属性。代码如下：

```java
// SpringApplication.java

public void setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers) {
	this.initializers = new ArrayList<>(initializers);
}
```

# 4. 设置 ApplicationListener

`listeners` 属性，ApplicationListener 数组。ApplicationListener 是 Spring 框架的接口，实现该接口，并实现 `#onApplicationEvent(E event)` 方法，监听 Spring 容器中发布的事件。

## 4.1 setListeners

`#setListeners(Collection<? extends ApplicationListener<?>> listeners)` 方法，设置 `listeners` 属性。代码如下：

```java
// SpringApplication.java

public void setListeners(Collection<? extends ApplicationListener<?>> listeners) {
	this.listeners = new ArrayList<>(listeners);
}
```

# 5. 推断主类

`mainApplicationClass` 属性，主类。即我们 Spring Boot 应用的入口类，上面有 `@SpringBootApplication` 注解，并且有 `#main(String[] args)` 方法。

## 5.1 deduceMainApplicationClass

`#deduceMainApplicationClass()` 方法，推断主类。代码如下：

```java
// SpringApplication.java

private Class<?> deduceMainApplicationClass() {
    try {
        // 获得当前 StackTraceElement 数组
        StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();
        // 遍历 StackTraceElement 数组，找到方法名为 main 的类
        for (StackTraceElement stackTraceElement : stackTrace) {
            if ("main".equals(stackTraceElement.getMethodName())) {
                return Class.forName(stackTraceElement.getClassName());
            }
        }
    } catch (ClassNotFoundException ex) {
        // Swallow and continue
    }
    return null;
}
```

- 通过获得当前 StackTraceElement 数组，然后遍历，判断哪个执行 `#main(String[] args)` 方法，从而获得主类。

# 6. 小结

至此，SpringApplication 的初始化完成。后续，我们开始看看 `#run(String... args)` 方法的执行。

2025-08-25 13:02:19,240 - evaluation_logger_Attraction-48 - INFO - Complete Result: {'score': 0, 'reason': 'no requested information is addressed'}
2025-08-25 13:02:25,763 - evaluation_logger_Attraction-48 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:02:25,763 - evaluation_logger_Attraction-48 - INFO - Message: Success.
2025-08-25 13:02:25,763 - evaluation_logger_Attraction-48 - INFO - Success turn num = 2
2025-08-25 13:02:25,763 - evaluation_logger_Attraction-48 - INFO - ----------------------------------------------------------------------------------------------------
