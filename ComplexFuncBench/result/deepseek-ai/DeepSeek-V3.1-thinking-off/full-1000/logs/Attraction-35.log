2025-08-25 12:58:07,529 - evaluation_logger_Attraction-35 - INFO - Test Example Attraction-35
2025-08-25 12:58:07,529 - evaluation_logger_Attraction-35 - INFO - Query: Our company is planning a trip to Paris for the employees. What is the highest-rated attraction there?
2025-08-25 12:58:15,651 - evaluation_logger_Attraction-35 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Paris"
        }
    }
]

2025-08-25 12:58:15,651 - evaluation_logger_Attraction-35 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Paris"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNDU2OTI4fQ==",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 12:58:15,651 - evaluation_logger_Attraction-35 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Paris'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Paris'}}
2025-08-25 12:58:15,651 - evaluation_logger_Attraction-35 - INFO - Rule-based compare success.
2025-08-25 12:58:15,651 - evaluation_logger_Attraction-35 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Paris'}}]
2025-08-25 12:58:15,651 - evaluation_logger_Attraction-35 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJYMUNnVGxJOFJWIiwidWZpIjotMTQ1NjkyOH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Menu Dinner Paris Night Cruise Bateaux Parisien",
                    "productId": "PRX1CgTlI8RV",
                    "productSlug": "prx1cgtli8rv-menu-dinner-paris-night-cruise-bateaux-parisien",
                    "taxonomySlug": "tours",
                    "cityUfi": -1456928,
                    "cityName": "Paris",
                    "countryCode": "fr"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJpWjkxWVhRODNyIiwidWZpIjotMTQ1NjkyOH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Paris Service Privilege Lunch Cruise - Bateaux Parisien",
                    "productId": "PRiZ91YXQ83r",
                    "productSlug": "priz91yxq83r-paris-service-privilege-lunch-cruise-bateaux-parisien",
                    "taxonomySlug": "tours",
                    "cityUfi": -1456928,
                    "cityName": "Paris",
                    "countryCode": "fr"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI0S0t3VkV6TkZxIiwidWZpIjotMTQ1NjkyOH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Paris Dinner Cruise - Bateaux Parisien Seine River",
                    "productId": "PR4KKwVEzNFq",
                    "productSlug": "pr4kkwveznfq-paris-dinner-cruise-bateaux-parisien-seine-river",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -1456928,
                    "cityName": "Paris",
                    "countryCode": "fr"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJmem5mRk95Skh0IiwidWZpIjotMTQ1NjkyOH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "The Parisian Experience: Styling & Shopping Experience in Paris",
                    "productId": "PRfznfFOyJHt",
                    "productSlug": "prfznffoyjht-the-fashionista-experience-personal-shopping-and-styling-experience",
                    "taxonomySlug": "tours",
                    "cityUfi": -1456928,
                    "cityName": "Paris",
                    "countryCode": "fr"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJDazUycEQ2ZExFIiwidWZpIjotMTQ1NjkyOH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Solo in Paris: Chanel Style Photoshoot & Fun with a Parisian",
                    "productId": "PRCk52pD6dLE",
                    "productSlug": "prck52pd6dle-premium-paris-photoshoot-with-a-fashion-photographer",
                    "taxonomySlug": "tours",
                    "cityUfi": -1456928,
                    "cityName": "Paris",
                    "countryCode": "fr"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0xNDU2OTI4fQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -1456928,
                    "country": "France",
                    "cityName": "Paris",
                    "productCount": 3202,
                    "cc1": "fr"
                }
            ]
        }
    }
]

2025-08-25 12:58:25,810 - evaluation_logger_Attraction-35 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNDU2OTI4fQ==",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 12:58:25,810 - evaluation_logger_Attraction-35 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNDU2OTI4fQ==",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 12:58:25,810 - evaluation_logger_Attraction-35 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNDU2OTI4fQ==', 'sortBy': 'attr_book_score'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNDU2OTI4fQ==', 'sortBy': 'attr_book_score'}}
2025-08-25 12:58:25,810 - evaluation_logger_Attraction-35 - INFO - Rule-based compare success.
2025-08-25 12:58:25,810 - evaluation_logger_Attraction-35 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNDU2OTI4fQ==', 'sortBy': 'attr_book_score'}}]
2025-08-25 12:58:25,810 - evaluation_logger_Attraction-35 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PRct8rEMbWLD",
                    "name": "Admission to the Musée d'Orsay",
                    "slug": "prct8rembwld-admission-to-the-musee-dorsay",
                    "shortDescription": "A visit to a famous art museum housed in a former railway station",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 19.12,
                        "currency": "USD",
                        "publicAmount": 19.12
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 2,
                        "percentage": "100%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 1485
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Paris",
                        "ufi": -1456928
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIHpz1cRc2iw"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRgFnm0q2pM7",
                    "name": "Montparnasse Tower Observation Deck",
                    "slug": "prgfnm0q2pm7-montparnasse-tower-observation-deck",
                    "shortDescription": "Admission to a sky-high observation deck with 360-degree views over Paris",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 19.66,
                        "currency": "USD",
                        "publicAmount": 19.66
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 109,
                        "percentage": "91%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 593
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Paris",
                        "ufi": -1456928
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIQJxgYgy0hi"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUDh3aCk8mo"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIihZeDOGnJX"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PRza0ZCg7YzS",
                    "name": "Admission to the Arc de Triomphe's Rooftop",
                    "slug": "prza0zcg7yzs-admission-to-the-arc-de-triomphes-rooftop",
                    "shortDescription": "A ticket to visit one of the best viewing points in Paris",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 17.48,
                        "currency": "USD",
                        "publicAmount": 17.48
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 416,
                        "percentage": "90%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 763
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Paris",
                        "ufi": -1456928
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIY1MIiF0M6C"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGj1nxmOTxr"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 8
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForLandmarks",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRjYfiTKUhFz",
                    "name": "Admission to Disneyland® Paris",
                    "slug": "prjyfitkuhfz-one-day-admission-to-disneylandr-paris",
                    "shortDescription": "A ticket to experience the best of one or two Disney® theme parks in Paris",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 61.17,
                        "currency": "USD",
                        "publicAmount": 61.17
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 1884,
                        "percentage": "88%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 3864
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Paris",
                        "ufi": -1456928
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIwyusiWUhnN"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI3odKMlgKSK"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OImI20ad7f2W"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvl9TTLMX3q"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINApUHr2SHS"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIoDlt3mP2AU"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIeAkgGLAZqi"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbuudRJtwKn"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIFkjsIuR7ER"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI24G4jFEdzF"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForAttractions",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRN0YvDeIrz7",
                    "name": "Arc de Triomphe Admission",
                    "slug": "prn0yvdeirz7-arc-de-triomphe-skip-the-line-admission",
                    "shortDescription": "A ticket to visit the famous historical landmark and enjoy panoramic views",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 17.48,
                        "currency": "USD",
                        "publicAmount": 17.48
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 45,
                        "percentage": "80%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 617
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Paris",
                        "ufi": -1456928
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGf8D5DQSFk"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 5
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 3202,
                "filteredProductCount": 3202
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 494
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums, arts & culture",
                        "tagname": "museums-arts-culture",
                        "productCount": 314
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 251
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 186
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Food & drinks",
                        "tagname": "food-drinks",
                        "productCount": 78
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 2354
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Paris",
                        "tagname": "-1456928",
                        "productCount": 3113
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Versailles",
                        "tagname": "-1475811",
                        "productCount": 57
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Marne-la-Vallee",
                        "tagname": "-1449817",
                        "productCount": 29
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Grisy Suisnes",
                        "tagname": "-1430775",
                        "productCount": 1
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Rungis",
                        "tagname": "-1463315",
                        "productCount": 1
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 219
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 267
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 386
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 460
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 1980
                    }
                ]
            }
        }
    }
]

2025-08-25 13:00:34,924 - evaluation_logger_Attraction-35 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring Boot 源码分析 —— SpringApplication》](http://svip.iocoder.cn/Spring-Boot/SpringApplication/) 的**初始化**的源码解析。

在 SpringApplication 实例初始化的过程中，会进行**初始化阶段**。而初始化阶段，主要会做如下几件事情：

1. 设置 `primarySources` 属性
2. 设置 `webApplicationType` 属性
3. 设置 `initializers` 属性
4. 设置 `listeners` 属性
5. 设置 `mainApplicationClass` 属性

# 2. 构造方法

SpringApplication 提供了多个构造方法，用于初始化。代码如下：

```java
// SpringApplication.java

public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    // <1> 推断 Web 应用类型
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
    // <2> 设置应用上下文初始化器
    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
    // <3> 设置事件监听器
    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    // <4> 推断应用方法
    this.mainApplicationClass = deduceMainApplicationClass();
}

public SpringApplication(Class<?>... primarySources) {
    this(null, primarySources);
}
```

- 两个构造方法，实际是同一个。差别在于，是否传递了 `resourceLoader` 参数。
- `<1>` 处，调用 `WebApplicationType#deduceFromClasspath()` 方法，推断 Web 应用类型。详细解析，见 [「2.1 WebApplicationType」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<2>` 处，设置应用上下文初始化器（ApplicationContextInitializer）。详细解析，见 [「2.2 设置 Initializers」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<3>` 处，设置事件监听器（ApplicationListener）。详细解析，见 [「2.3 设置 Listeners」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<4>` 处，调用 `#deduceMainApplicationClass()` 方法，推断应用方法。详细解析，见 [「2.4 推断应用方法」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

## 2.1 WebApplicationType

`org.springframework.boot.WebApplicationType` ，Spring Boot 应用类型枚举。代码如下：

```java
// WebApplicationType.java

public enum WebApplicationType {

    /**
     * 非 Web 项目
     */
    NONE,
    /**
     * Servlet Web 项目
     */
    SERVLET,
    /**
     * Reactive Web 项目
     */
    REACTIVE;

    private static final String[] SERVLET_INDICATOR_CLASSES = { "javax.servlet.Servlet",
            "org.springframework.web.context.ConfigurableWebApplicationContext" };

    private static final String WEBMVC_INDICATOR_CLASS = "org.springframework.web.servlet.DispatcherServlet";

    private static final String WEBFLUX_INDICATOR_CLASS = "org.springframework.web.reactive.DispatcherHandler";

    private static final String JERSEY_INDICATOR_CLASS = "org.glassfish.jersey.servlet.ServletContainer";

    private static final String SERVLET_APPLICATION_CONTEXT_CLASS = "org.springframework.web.context.WebApplicationContext";

    private static final String REACTIVE_APPLICATION_CONTEXT_CLASS = "org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext";

    /**
     * 根据类路径，推断 Web 应用类型
     *
     * @return 应用类型
     */
    static WebApplicationType deduceFromClasspath() {
        // 如果存在 org.springframework.web.reactive.DispatcherHandler ，但是不存在 org.springframework.web.servlet.DispatcherServlet 和 org.glassfish.jersey.servlet.ServletContainer ，则定义为 REACTIVE 类型
        if (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null) && !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null)
                && !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) {
            return WebApplicationType.REACTIVE;
        }
        // 如果不存在 javax.servlet.Servlet 和 org.springframework.web.context.ConfigurableWebApplicationContext 中的任何一个，则定义为 NONE 类型
        for (String className : SERVLET_INDICATOR_CLASSES) {
            if (!ClassUtils.isPresent(className, null)) {
                return WebApplicationType.NONE;
            }
        }
        // 否则，定义为 SERVLET 类型
        return WebApplicationType.SERVLET;
    }

    // ... 省略其它方法
}
```

- 根据类路径上是否存在特定的类，进行判断。逻辑比较简单，看下注释噢。

## 2.2 设置 Initializers

`#setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers)` 方法，设置应用上下文初始化器（ApplicationContextInitializer）。代码如下：

```java
// SpringApplication.java

/**
 * 应用上下文初始化器集合
 */
private List<ApplicationContextInitializer<?>> initializers;

public void setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers) {
	this.initializers = new ArrayList<>(initializers);
}
```

- 那么，这些 ApplicationContextInitializer 从哪里来呢？答案在 `#getSpringFactoriesInstances(Class<T> type)` 方法中。代码如下：

  ```java
  // SpringApplication.java
  
  private <T> Collection<T> getSpringFactoriesInstances(Class<T> type) {
  	return getSpringFactoriesInstances(type, new Class<?>[] {});
  }
  
  private <T> Collection<T> getSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, Object... args) {
  	ClassLoader classLoader = getClassLoader();
  	// Use names and ensure unique to protect against duplicates
  	// <1> 加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组
  	Set<String> names = new LinkedHashSet<>(SpringFactoriesLoader.loadFactoryNames(type, classLoader));
  	// <2> 创建对象
  	List<T> instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);
  	// <3> 排序
  	AnnotationAwareOrderComparator.sort(instances);
  	return instances;
  }
  ```

  - `<1>` 处，调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组。

    - 在 `spring-boot` 项目中的 `META-INF/spring.factories` 文件中，默认有 ApplicationContextInitializer 的如下配置：

      ```properties
      # Initializers
      org.springframework.context.ApplicationContextInitializer=\
      org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\
      org.springframework.boot.context.ContextIdApplicationContextInitializer,\
      org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\
      org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer
      ```

    - 在 `spring-boot-autoconfigure` 项目中的 `META-INF/spring.factories` 文件中，默认有 ApplicationContextInitializer 的如下配置：

      ```properties
      # Initializers
      org.springframework.context.ApplicationContextInitializer=\
      org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\
      org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener
      ```

    - 当然，如果项目中有自定义的配置，也会被读取到。

  - `<2>` 处，调用 `#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象。代码如下：

    ```java
    // SpringApplication.java
    
    private <T> List<T> createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes,
    		ClassLoader classLoader, Object[] args, Set<String> names) {
    	List<T> instances = new ArrayList<>(names.size());
    	for (String name : names) {
    		try {
    			Class<?> instanceClass = ClassUtils.forName(name, classLoader);
    			Assert.isAssignable(type, instanceClass);
    			Constructor<?> constructor = instanceClass.getDeclaredConstructor(parameterTypes);
    			T instance = (T) BeanUtils.instantiateClass(constructor, args);
    			instances.add(instance);
    		} catch (Throwable ex) {
    			throw new IllegalArgumentException("Cannot instantiate " + type + " : " + name, ex);
    		}
    	}
    	return instances;
    }
    ```

    - 通过反射，创建对象。

  - `<3>` 处，调用 `AnnotationAwareOrderComparator#sort(List<?> list)` 方法，排序对象。

    - 关于 Order 排序，可以看看 [《【死磕 Spring】—— IoC 之深入分析 ﻿BeanFactoryPostProcessor》](http://svip.iocoder.cn/Spring/IoC-BeanFactoryPostProcessor/) 的 [「3.2 Order」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 小节。

## 2.3 设置 Listeners

`#setListeners(Collection<? extends ApplicationListener<?>> listeners)` 方法，设置事件监听器（ApplicationListener）。代码如下：

```java
// SpringApplication.java

/**
 * 事件监听器集合
 */
private List<ApplicationListener<?>> listeners;

public void setListeners(Collection<? extends ApplicationListener<?>> listeners) {
	this.listeners = new ArrayList<>(listeners);
}
```

- 那么，这些 ApplicationListener 从哪里来呢？答案也是 `#getSpringFactoriesInstances(Class<T> type)` 方法中。

  - 在 `spring-boot` 项目中的 `META-INF/spring.factories` 文件中，默认有 ApplicationListener 的如下配置：

    ```properties
    # Application Listeners
    org.springframework.context.ApplicationListener=\
    org.springframework.boot.ClearCachesApplicationListener,\
    org.springframework.boot.builder.ParentContextCloserApplicationListener,\
    org.springframework.boot.context.FileEncodingApplicationListener,\
    org.springframework.boot.context.config.AnsiOutputApplicationListener,\
    org.springframework.boot.context.config.ConfigFileApplicationListener,\
    org.springframework.boot.context.config.DelegatingApplicationListener,\
    org.springframework.boot.context.logging.ClasspathLoggingApplicationListener,\
    org.springframework.boot.context.logging.LoggingApplicationListener,\
    org.springframework.boot.liquibase.LiquibaseServiceApplicationListener
    ```

  - 当然，如果项目中有自定义的配置，也会被读取到。

## 2.4 推断应用方法

`#deduceMainApplicationClass()` 方法，推断应用方法。代码如下：

```java
// SpringApplication.java

private Class<?> deduceMainApplicationClass() {
	try {
		// 获得当前 StackTraceElement 数组
		StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();
		// 遍历，查找 main 方法
		for (StackTraceElement stackTraceElement : stackTrace) {
			if ("main".equals(stackTraceElement.getMethodName())) {
				return Class.forName(stackTraceElement.getClassName());
			}
		}
	} catch (ClassNotFoundException ex) {
		// Swallow and continue
	}
	return null;
}
```

- 通过异常的方式，获取当前 StackTraceElement 数组，然后遍历，查找 `main` 方法，从而获得对应的类。

# 3. 小结

至此，SpringApplication 的初始化完成。后续，我们开始看看 `#run(String... args)` 方法的执行流程。

2025-08-25 13:00:39,906 - evaluation_logger_Attraction-35 - INFO - Complete Result: {'score': 0, 'reason': 'no requested information is addressed'}
2025-08-25 13:00:46,167 - evaluation_logger_Attraction-35 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:00:46,167 - evaluation_logger_Attraction-35 - INFO - Message: Success.
2025-08-25 13:00:46,167 - evaluation_logger_Attraction-35 - INFO - Success turn num = 2
2025-08-25 13:00:46,167 - evaluation_logger_Attraction-35 - INFO - ----------------------------------------------------------------------------------------------------
