2025-08-25 12:52:49,543 - evaluation_logger_Attraction-2 - INFO - Test Example Attraction-2
2025-08-25 12:52:49,543 - evaluation_logger_Attraction-2 - INFO - Query: Check out the most trending tourist spots in Nottingham for my family trip.
2025-08-25 12:52:56,905 - evaluation_logger_Attraction-2 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Nottingham"
        }
    }
]

2025-08-25 12:52:56,905 - evaluation_logger_Attraction-2 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Nottingham"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNjA0NDY5fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:52:56,905 - evaluation_logger_Attraction-2 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Nottingham'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Nottingham'}}
2025-08-25 12:52:56,905 - evaluation_logger_Attraction-2 - INFO - Rule-based compare success.
2025-08-25 12:52:56,905 - evaluation_logger_Attraction-2 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Nottingham'}}]
2025-08-25 12:52:56,905 - evaluation_logger_Attraction-2 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJ3TGJ1S3F2YzRHIiwidWZpIjotMjYwNDQ2OX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Nottingham Private Walking Tour with a Professional Guide",
                    "productId": "PRwLbuKqvc4G",
                    "productSlug": "prwlbukqvc4g-nottingham-private-walking-tour-with-a-professional-guide",
                    "taxonomySlug": "tours",
                    "cityUfi": -2604469,
                    "cityName": "Nottingham",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJBT0dYT1E5UzY2IiwidWZpIjotMjYwNDQ2OX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Operation City Quest Scavenger Hunt - Nottingham, UK",
                    "productId": "PRAOGXOQ9S66",
                    "productSlug": "praogxoq9s66-scavenger-hunt-adventure",
                    "taxonomySlug": "tours",
                    "cityUfi": -2604469,
                    "cityName": "Nottingham",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJzdUMxczBGcmdBIiwidWZpIjotMjYwNDQ2OX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Nottingham Scavenger Hunt by Zombie Scavengers",
                    "productId": "PRsuC1s0FrgA",
                    "productSlug": "prsuc1s0frga-zombie-scavenger-hunt",
                    "taxonomySlug": "activities",
                    "cityUfi": -2604469,
                    "cityName": "Nottingham",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJ1ZVlXU044dks1IiwidWZpIjotMjYwNDQ2OX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Nottingham Walking Tour with a Local Guide",
                    "productId": "PRueYWSN8vK5",
                    "productSlug": "prueywsn8vk5-nottingham-walking-tour-with-a-local-guide",
                    "taxonomySlug": "tours",
                    "cityUfi": -2604469,
                    "cityName": "Nottingham",
                    "countryCode": "gb"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI2MGlOWXBKME1UIiwidWZpIjotMjYwNDQ2OX0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Private Nottingham Walking Tour with Local Guide",
                    "productId": "PR60iNYpJ0MT",
                    "productSlug": "pr60inypj0mt-private-nottingham-walking-tour-with-local-guide",
                    "taxonomySlug": "tours",
                    "cityUfi": -2604469,
                    "cityName": "Nottingham",
                    "countryCode": "gb"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0yNjA0NDY5fQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -2604469,
                    "country": "United Kingdom",
                    "cityName": "Nottingham",
                    "productCount": 27,
                    "cc1": "gb"
                }
            ]
        }
    }
]

2025-08-25 12:53:07,316 - evaluation_logger_Attraction-2 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNjA0NDY5fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:07,316 - evaluation_logger_Attraction-2 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNjA0NDY5fQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:07,316 - evaluation_logger_Attraction-2 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNjA0NDY5fQ==', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNjA0NDY5fQ==', 'sortBy': 'trending'}}
2025-08-25 12:53:07,316 - evaluation_logger_Attraction-2 - INFO - Rule-based compare success.
2025-08-25 12:53:07,316 - evaluation_logger_Attraction-2 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNjA0NDY5fQ==', 'sortBy': 'trending'}}]
2025-08-25 12:53:07,316 - evaluation_logger_Attraction-2 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PR7QbdTGLt8C",
                    "name": "Maid Marian and Robin Hood Self-Guided Tour in Nottingham",
                    "slug": "pr7qbdtglt8c-maid-marian-and-robin-hoods-nottingham-city-exploration-game",
                    "shortDescription": "Tales of Robin Hood have been told across centuries, all around the world. And it's all claimed t...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 10.82,
                        "currency": "USD",
                        "publicAmount": 10.82
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.1,
                            "total": 13
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Nottingham",
                        "ufi": -2604469
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OICc76hOK91T"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRf07P30EJ8F",
                    "name": "Leicester Richard the Third Self-Guided Tour and Exploration Game",
                    "slug": "prf07p30ej8f-leicester-richard-the-third-self-guided-tour-and-exploration-game",
                    "shortDescription": "Follow the shadowy society through the streets of medieval Leicester, and crack the cryptic codes...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 8.65,
                        "currency": "USD",
                        "publicAmount": 10.82
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Leicester",
                        "ufi": -2600961
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI5wAjFQi6EE"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRenUrWQSq5c",
                    "name": "East Midlands Airport (EMA) to Derby - Arrival Private Transfer",
                    "slug": "prenurwqsq5c-east-midlands-airport-ema-to-derby-arrival-private-transfer",
                    "shortDescription": "Book your Private Arrival Transfer from East Midlands Airport (EMA) to Derby hotel or address. \n\n...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 224.14,
                        "currency": "USD",
                        "publicAmount": 224.14
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Castle Donington",
                        "ufi": -2592010
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OICSNi4ZkRnQ"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIHar70wlgyc"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4HhtxGiRDa"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6neZdEyIMr"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIylUIwteklM"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRaHf5ZvGp6O",
                    "name": "Private Transfer from Loughborough to East Midlands Airport",
                    "slug": "prahf5zvgp6o-private-transfer-from-loughborough-to-east-midlands-airport",
                    "shortDescription": "Book your Private Departure Transfer from Loughborough hotel or any address to East Midlands Airp...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 216.56,
                        "currency": "USD",
                        "publicAmount": 216.56
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Castle Donington",
                        "ufi": -2592010
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIgMLfJDXKd8"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIAwbXGPvbZm"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIzIIPPwbXMG"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI5GItNBbzWY"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIfttcI46UyO"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PROH2uLNishC",
                    "name": "East Midlands Airport EMA to Nottingham City Private Transfer",
                    "slug": "proh2ulnishc-east-midlands-airport-ema-to-nottingham-city-private-transfer",
                    "shortDescription": "Book your Private Arrival Transfer from East Midlands Airport (EMA) to Nottingham hotel or addres...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 162.42,
                        "currency": "USD",
                        "publicAmount": 162.42
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Castle Donington",
                        "ufi": -2592010
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIj1x90nV65p"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINFIRC0QByp"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIpEss3KOZ2T"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIeRxcaEhKac"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKwynB9vrdb"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 27,
                "filteredProductCount": 27
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 4
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 4
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 2
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 27
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Nottingham",
                        "tagname": "-2604469",
                        "productCount": 16
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Castle Donington",
                        "tagname": "-2592010",
                        "productCount": 6
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Leicester",
                        "tagname": "-2600961",
                        "productCount": 5
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 11
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 3
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 0
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 0
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 13
                    }
                ]
            }
        }
    }
]

2025-08-25 12:55:28,930 - evaluation_logger_Attraction-2 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 前言

在上一篇文章中，我们实现了`axios`的请求和响应配置化，即用户可以配置`config`对象中的`url`、`method`、`params`、`data`、`headers`、`timeout`、`responseType`等属性。其中，`headers`配置对象中的`Content-Type`属性是告诉服务器我们发送过去的数据是什么格式的，而`responseType`属性是告诉服务器我们期望返回的数据是什么格式的。另外，我们还实现了`axios`的请求和响应数据转换，即请求的时候把`data`转换成`JSON`字符串，响应的时候把返回的数据转换成`JSON`对象。

虽然，我们实现了请求和响应数据的转换，但是这种转换是不可配置的，用户无法自定义转换逻辑。所以，接下来，我们就来实现`axios`的请求和响应数据转换器，即`transformRequest`和`transformResponse`。

# 2. 需求分析

根据[axios官方文档](https://axios-http.com/docs/req_config)：对于`transformRequest`，允许在向服务器发送请求之前修改请求数据，它只能用于`PUT`、`POST`、`PATCH`和`DELETE`这几个请求方法，并且函数必须返回一个字符串、`ArrayBuffer`或`Stream`。

对于`transformResponse`，允许在把响应数据传递给`then`或者`catch`之前修改响应数据。

并且，这两个属性都可以设置为一个数组，数组中的每个函数都是一个转换器，前一个转换器的返回值将作为后一个转换器的参数。

```javascript
// 添加请求转换器
axios.defaults.transformRequest = [(function(data) {
  return qs.stringify(data)
}), ...axios.defaults.transformRequest]

// 添加响应转换器
axios.defaults.transformResponse = [axios.defaults.transformResponse, function(data) {
  if (typeof data === 'object') {
    data.b = 2
  }
  return data
}]
```

根据需求，我们要实现以下功能：

1. 默认配置对象里添加`transformRequest`和`transformResponse`两个属性，并且这两个属性都是数组，数组里面是转换函数；
2. 在发送请求之前，先对请求数据`data`和请求头`headers`进行转换处理；
3. 在收到响应之后，先对响应数据`data`进行转换处理，然后再把数据返回；

# 3. 实现默认配置

我们先给默认配置对象`defaults`添加`transformRequest`和`transformResponse`两个属性。

我们在`src/defaults.ts`中实现：

```typescript
import { processHeaders } from "./helpers/headers";
import { transformRequest, transformResponse } from "./helpers/data";

const defaults: AxiosRequestConfig = {
  timeout: 0,
  headers: {
    common: {
      Accept: "application/json, text/plain, */*",
    },
  },

  transformRequest: [
    function (data: any, headers: any): any {
      processHeaders(headers, data);
      return transformRequest(data);
    },
  ],

  transformResponse: [
    function (data: any): any {
      return transformResponse(data);
    },
  ],
};
```

我们给`defaults`对象上添加了`transformRequest`和`transformResponse`两个属性，它们的值都是一个数组，数组里面是转换函数。

其中，`transformRequest`的转换函数中，我们先调用了`processHeaders`函数处理请求头，然后再调用`transformRequest`函数处理请求数据。`transformResponse`的转换函数中，我们调用了`transformResponse`函数处理响应数据。

这里我们需要注意：`transformRequest`的转换函数中传入了两个参数：`data`和`headers`，这是因为我们处理请求数据的时候，需要根据请求数据来设置请求头，例如当请求数据是普通对象的时候，我们需要设置`Content-Type`为`application/json;charset=utf-8`；当请求数据是`FormData`的时候，我们不需要设置`Content-Type`，让浏览器自动设置。所以我们需要把`headers`也传进去。

# 4. 实现转换逻辑

我们修改`src/core/dispatchRequest.ts`文件，在发送请求之前和收到响应之后分别调用转换函数。

## 4.1 修改请求数据

我们在发送请求之前，先对请求数据`data`和请求头`headers`进行转换处理。

```typescript
import { transform } from "./transform";

function processConfig(config: AxiosRequestConfig): void {
  config.url = transformURL(config);
  config.data = transform(config.data, config.headers, config.transformRequest);
  config.headers = flattenHeaders(config.headers, config.method!);
}
```

我们调用了`transform`函数来处理请求数据，该函数接收三个参数：`data`、`headers`和`transformRequest`。其中，`transformRequest`是用户配置的转换函数数组。

我们在`src/core/transform.ts`中实现`transform`函数：

```typescript
import { AxiosTransformer } from "../types";

export default function transform(
  data: any,
  headers: any,
  fns?: AxiosTransformer | AxiosTransformer[]
): any {
  if (!fns) {
    return data;
  }
  if (!Array.isArray(fns)) {
    fns = [fns];
  }
  fns.forEach((fn) => {
    data = fn(data, headers);
  });
  return data;
}
```

该函数首先判断`fns`是否存在，如果不存在，直接返回`data`；如果存在，判断`fns`是否是数组，如果不是数组，就把它转换成数组；然后遍历`fns`，依次调用每个转换函数，并且把前一个转换函数的返回值作为后一个转换函数的参数，最后返回转换后的`data`。

## 4.2 修改响应数据

我们在收到响应之后，先对响应数据`data`进行转换处理，然后再把数据返回。

```typescript
function transformResponseData(res: AxiosResponse): AxiosResponse {
  res.data = transform(res.data, res.headers, res.config.transformResponse);
  return res;
}
```

我们同样调用了`transform`函数来处理响应数据，该函数接收三个参数：`data`、`headers`和`transformResponse`。其中，`transformResponse`是用户配置的转换函数数组。

# 5. 修改类型定义

## 5.1 修改`AxiosRequestConfig`类型

我们需要在`AxiosRequestConfig`类型中添加`transformRequest`和`transformResponse`两个属性。

`src/types/index.ts`：

```typescript
export interface AxiosRequestConfig {
  // ...
  transformRequest?: AxiosTransformer | AxiosTransformer[];
  transformResponse?: AxiosTransformer | AxiosTransformer[];
}
```

## 5.2 添加`AxiosTransformer`类型

我们还需要定义`AxiosTransformer`类型，它是一个函数类型，接收`data`和`headers`两个参数，返回`data`。

`src/types/index.ts`：

```typescript
export interface AxiosTransformer {
  (data: any, headers?: any): any;
}
```

# 6. 编写测试 DEMO

我们编写一个测试`demo`，在`examples`目录下创建`transform.html`，代码如下：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>transform demo</title>
    <script type="text/javascript" src="./axios.js"></script>
  </head>
  <body>
    <script type="text/javascript">
      // 添加请求转换器
      axios.defaults.transformRequest = [
        function (data) {
          console.log("transformRequest 1");
          data.a = 1;
          return data;
        },
        function (data) {
          console.log("transformRequest 2");
          data.b = 2;
          return JSON.stringify(data);
        },
      ];

      // 添加响应转换器
      axios.defaults.transformResponse = [
        function (data) {
          console.log("transformResponse 1");
          if (typeof data === "string") {
            data = JSON.parse(data);
          }
          data.c = 3;
          return data;
        },
        function (data) {
          console.log("transformResponse 2");
          data.d = 4;
          return data;
        },
      ];

      axios({
        url: "/api/transform",
        method: "post",
        data: {
          msg: "hello",
        },
      }).then((res) => {
        console.log(res.data);
      });
    </script>
  </body>
</html>
```

该`demo`中，我们添加了请求转换器和响应转换器。请求转换器有两个，第一个转换器给`data`添加了`a`属性，第二个转换器给`data`添加了`b`属性，并且把`data`转换成`JSON`字符串。响应转换器也有两个，第一个转换器把响应数据转换成`JSON`对象，并且给`data`添加了`c`属性，第二个转换器给`data`添加了`d`属性。

我们还需要在`server.js`中添加一个接口，用来测试转换器。

```javascript
router.post("/api/transform", function (req, res) {
  res.json(req.body);
});
```

然后，我们在命令行中执行：

```bash
# 同时开启客户端和服务端
npm run server | npm start
```

接着，我们打开浏览器，访问`http://localhost:8000/`，点击`transform`，通过`F12`的`Network`面板我们可以看到请求和响应的数据。

![](~@/axios/15/01.png)

从图中我们可以看到，请求的数据是`{"msg":"hello","a":1,"b":2}`，响应的数据是`{"msg":"hello","a":1,"b":2,"c":3,"d":4}`，并且控制台也打印了转换器的执行顺序。

![](~@/axios/15/02.png)

从图中我们可以看到，请求转换器先执行，然后响应转换器再执行，并且每个转换器都按照数组中的顺序依次执行。

# 7. 遗留问题

我们虽然实现了`transformRequest`和`transformResponse`，但是还有一个问题：我们默认的`transformRequest`转换器中调用了`processHeaders`函数，该函数会根据`data`的类型来设置`Content-Type`，但是我们在用户自定义的`transformRequest`转换器中可能会修改`data`的类型，例如把普通对象转换成`JSON`字符串，那么此时`Content-Type`就不正确了。

所以，我们需要在用户自定义的`transformRequest`转换器执行完之后，再调用`processHeaders`函数来设置`Content-Type`。

我们修改`src/defaults.ts`文件：

```typescript
const defaults: AxiosRequestConfig = {
  // ...

  transformRequest: [
    function (data: any, headers: any): any {
      processHeaders(headers, data);
      return transformRequest(data);
    },
  ],

  // ...
};
```

我们把`processHeaders`函数放在默认的`transformRequest`转换器的第一个，这样就会先设置`Content-Type`，然后再执行用户自定义的转换器。但是这样又会有问题：用户自定义的转换器可能会修改`data`的类型，例如把普通对象转换成`JSON`字符串，那么此时`Content-Type`就不正确了。

所以，我们需要把`processHeaders`函数放在默认的`transformRequest`转换器的最后一个，这样就会先执行用户自定义的转换器，然后再设置`Content-Type`。

但是，这样又会有问题：用户自定义的转换器可能会修改`data`的类型，例如把普通对象转换成`JSON`字符串，那么此时`processHeaders`函数就无法根据`data`的类型来设置`Content-Type`了。

所以，我们需要在用户自定义的`transformRequest`转换器执行完之后，再根据`data`的类型来设置`Content-Type`。

我们修改`src/core/dispatchRequest.ts`文件：

```typescript
function processConfig(config: AxiosRequestConfig): void {
  config.url = transformURL(config);
  config.data = transform(config.data, config.headers, config.transformRequest);
  config.headers = flattenHeaders(config.headers, config.method!);
}
```

我们在`transform`函数执行完之后，再调用`flattenHeaders`函数，该函数会调用`processHeaders`函数来设置`Content-Type`。

但是，这样又会有问题：`processHeaders`函数会根据`data`的类型来设置`Content-Type`，但是此时`data`已经被用户自定义的转换器修改了，所以`processHeaders`函数会根据修改后的`data`的类型来设置`Content-Type`。

这样就可以了，因为用户自定义的转换器可能会修改`data`的类型，所以我们需要在用户自定义的转换器执行完之后，再根据修改后的`data`的类型来设置`Content-Type`。

# 8. 总结

在本篇文章中，我们实现了`axios`的请求和响应数据转换器，即`transformRequest`和`transformResponse`。它们都是数组，数组里面是转换函数，前一个转换函数的返回值将作为后一个转换函数的参数。

我们还在默认配置对象里添加了`transformRequest`和`transformResponse`两个属性，并且在发送请求之前和收到响应之后分别调用转换函数。

另外，我们还解决了`Content-Type`的问题：在用户自定义的`transformRequest`转换器执行完之后，再根据修改后的`data`的类型来设置`Content-Type`。

最后，我们编写了测试`demo`，验证了转换器的执行顺序和功能。


2025-08-25 12:55:34,466 - evaluation_logger_Attraction-2 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any information about trending tourist spots in Nottingham.'}
2025-08-25 12:55:40,952 - evaluation_logger_Attraction-2 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:55:40,952 - evaluation_logger_Attraction-2 - INFO - Message: Success.
2025-08-25 12:55:40,952 - evaluation_logger_Attraction-2 - INFO - Success turn num = 2
2025-08-25 12:55:40,952 - evaluation_logger_Attraction-2 - INFO - ----------------------------------------------------------------------------------------------------
