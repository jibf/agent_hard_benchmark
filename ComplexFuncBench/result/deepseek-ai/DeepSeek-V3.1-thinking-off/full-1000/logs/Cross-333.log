2025-08-25 12:20:20,334 - evaluation_logger_Cross-333 - INFO - Test Example Cross-333
2025-08-25 12:20:20,334 - evaluation_logger_Cross-333 - INFO - Query: I'm going to arrive at Berlin Central Train Station at 12:12pm on December 12th, 2024. Could you look up detailed info about the most trending attractions in Berlin for me? I'm going to take a taxi to the hottest attractions 10 minutes after my train gets there. 
2025-08-25 12:20:29,580 - evaluation_logger_Cross-333 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Berlin"
        }
    }
]

2025-08-25 12:20:29,580 - evaluation_logger_Cross-333 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Berlin"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:20:29,580 - evaluation_logger_Cross-333 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Berlin'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Berlin'}}
2025-08-25 12:20:29,580 - evaluation_logger_Cross-333 - INFO - Rule-based compare success.
2025-08-25 12:20:29,580 - evaluation_logger_Cross-333 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Berlin'}}]
2025-08-25 12:20:29,580 - evaluation_logger_Cross-333 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -1746443,
                    "country": "Germany",
                    "cityName": "Berlin",
                    "productCount": 762,
                    "cc1": "de"
                }
            ]
        }
    }
]

2025-08-25 12:20:39,911 - evaluation_logger_Cross-333 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:20:39,914 - evaluation_logger_Cross-333 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0xNzQ2NDQzfQ==",
            "sortBy": "trending"
        }
    },
    {
        "name": "Taxi_Search_Location",
        "arguments": {
            "query": "Berlin Central Train Station"
        }
    },
    {
        "name": "Taxi_Search_Location",
        "arguments": {
            "query": "Berlin TV Tower"
        }
    },
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit"
        }
    }
]

2025-08-25 12:20:39,914 - evaluation_logger_Cross-333 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNzQ2NDQzfQ==', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNzQ2NDQzfQ==', 'sortBy': 'trending'}}
2025-08-25 12:20:39,914 - evaluation_logger_Cross-333 - INFO - Rule-based compare success.
2025-08-25 12:20:39,914 - evaluation_logger_Cross-333 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0xNzQ2NDQzfQ==', 'sortBy': 'trending'}}]
2025-08-25 12:20:39,915 - evaluation_logger_Cross-333 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PRrKFcd1d3Ph",
                    "name": "Berlin TV Tower with Restaurant and Bar Visit",
                    "slug": "prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit",
                    "shortDescription": "An experience with panoramic views of Berlin",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 27.55,
                        "currency": "USD",
                        "publicAmount": 27.55
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 44,
                        "percentage": "95%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 392
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIx8WijBMKLW"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIDKsiafQzAW"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINcsae8PL6s"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIMxJng44gkB"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4bcaRtYAce"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIMmZy4REsax"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "popularFor2Travelers",
                            "value": true,
                            "rank": 4
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRWL8NhwQNrZ",
                    "name": "2.5-hour Sightseeing Boat Cruise",
                    "slug": "prwl8nhwqnrz-25-hour-sightseeing-boat-cruise",
                    "shortDescription": "A chance to embark on a sightseeing boat cruise on the Spree",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 32.17,
                        "currency": "USD",
                        "publicAmount": 32.17
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 229,
                        "percentage": "87%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.2,
                            "total": 391
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIANh76iL1On"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6wisyxwz76"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIfp6vYFCTZr"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvmgY7JU9OU"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbCbQgPenhf"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIaAVtYW8Mt3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXFW7LEqu0c"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2I5ZImfskM"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIP81vYfOWsI"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXoklGAsvn9"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGYnhI1Zb0C"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIp8Cyurqlj0"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIfvkAOBAjt4"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIssmnOxiHct"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIC9qYvP5b49"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIaxWOaonrgF"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIwNXpNYWW8y"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIu2IeUhLC0o"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIa6ulxag2GV"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIfxj7nX1Xik"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIhskgb0g0PG"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRv0dChDocE"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIhrqwdI1D0i"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIromtVvyZU1"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRX5UGIrbMB5",
                    "name": "City Sightseeing Berlin Hop On Hop Off Bus Tour - All Lines (A+B)",
                    "slug": "prx5ugirbmb5-city-sightseeing-berlin-hop-on-hop-off-bus-tour-all-lines-ab",
                    "shortDescription": "Explore the very best of what Berlin has to offer aboard a City Sightseeing double-decker bus wit...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 33.4,
                        "currency": "USD",
                        "publicAmount": 33.4
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.3,
                            "total": 20
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKmpbP2q3je"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIcHsOu95K8i"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIdD4sY2DC3w"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIs4F8Vz5dLQ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0YKncBuCr9"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIDixOPb8zfP"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PRHEhfb9dVIR",
                    "name": "Panoramapunkt and Elevator Ride",
                    "slug": "prhehfb9dvir-panoramapunkt-and-elevator-ride",
                    "shortDescription": "A ride on Europe’s fastest elevator for panoramic views of the city",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 10.02,
                        "currency": "USD",
                        "publicAmount": 10.02
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 272,
                        "percentage": "93%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 346
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2yxA4CJ7Jn"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIqx5Z8l3IHj"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRhdCEiWf3u"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6dV1G3Rxg3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUIOzIMYEjf"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIoXrcVGfLRR"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIdwmkIYJ2kF"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1VMRt5F23j"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIjZzQawwmsJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI90gd4uiXfJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0rE2bJpBi5"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZelpFBfI5i"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuLj828L6rL"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OISgrzjtmov4"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForLandmarks",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRGdt4RxRMvN",
                    "name": "BODY WORLDS Berlin Admission",
                    "slug": "prgdt4rxrmvn-body-worlds-berlin-entrance-tickets",
                    "shortDescription": "An interactive experience to study how the human body works",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 21.15,
                        "currency": "USD",
                        "publicAmount": 21.15
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 186,
                        "percentage": "96%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 248
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Berlin",
                        "ufi": -1746443
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OITPpMVceN0A"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIIQRN8kWkSA"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItagkq2psdb"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIdNxRPczuXC"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXYnmZYrtTJ"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIFq7pnIxnU3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI9frBAt2CSP"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIEOEkmb94D2"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIULl6TE6IcU"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIoP8nevL66p"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGhMjXAFxCs"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGLtLmlo43u"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRfN67tcwn0"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbYxL2lfyYH"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRTwge1d1aC"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIxAK0UU21M5"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIgPnKP183OM"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2ZRQ23ZdoF"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGEEmVXZJ6B"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIJL5i2dhvRQ"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIA10Y5Urcj4"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIsIp4SrBI97"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIfDd4NDVIpQ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUhYHMgayp7"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIo7M7CKv062"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 4
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForMuseums",
                            "value": true,
                            "rank": 2
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 761,
                "filteredProductCount": 761
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 611
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Activities",
                        "tagname": "activities",
                        "productCount": 70
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums",
                        "tagname": "museums",
                        "productCount": 35
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Transfers & services",
                        "tagname": "transfers-services",
                        "productCount": 23
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Attractions",
                        "tagname": "attractions",
                        "productCount": 11
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 653
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Berlin",
                        "tagname": "-1746443",
                        "productCount": 724
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Potsdam",
                        "tagname": "-1844464",
                        "productCount": 33
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Schonefeld",
                        "tagname": "-1860228",
                        "productCount": 4
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 136
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 167
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 66
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 63
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 332
                    }
                ]
            }
        }
    }
]

2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Function Calls: 
[
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit"
        }
    },
    {
        "name": "Taxi_Search_Location",
        "arguments": {
            "query": "Berlin Central Train Station"
        }
    },
    {
        "name": "Taxi_Search_Location",
        "arguments": {
            "query": "Berlin TV Tower"
        }
    }
]

2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Golden Function Call: 
[
    {
        "name": "Taxi_Search_Location",
        "arguments": {
            "query": "Berlin Central Train Station"
        }
    },
    {
        "name": "Taxi_Search_Location",
        "arguments": {
            "query": "Berlin TV Tower"
        }
    },
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit"
        }
    },
    {
        "name": "Search_Taxi",
        "arguments": {
            "pick_up_place_id": "ChIJe-ff-71RqEcRqvy8lRR4PHo",
            "drop_off_place_id": "ChIJ6_8UkB9OqEcRoeRJQ0j8-sg",
            "pick_up_date": "2024-12-12",
            "pick_up_time": "12:22"
        }
    }
]

2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Start compare_single_call: 
{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit'}}
{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit'}}
2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Rule-based compare success.
2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Start compare_single_call: 
{'name': 'Taxi_Search_Location', 'arguments': {'query': 'Berlin Central Train Station'}}
{'name': 'Taxi_Search_Location', 'arguments': {'query': 'Berlin Central Train Station'}}
2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Rule-based compare success.
2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Start compare_single_call: 
{'name': 'Taxi_Search_Location', 'arguments': {'query': 'Berlin TV Tower'}}
{'name': 'Taxi_Search_Location', 'arguments': {'query': 'Berlin TV Tower'}}
2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Rule-based compare success.
2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Success matched: [{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit'}}, {'name': 'Taxi_Search_Location', 'arguments': {'query': 'Berlin Central Train Station'}}, {'name': 'Taxi_Search_Location', 'arguments': {'query': 'Berlin TV Tower'}}]
2025-08-25 12:20:53,090 - evaluation_logger_Cross-333 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProduct",
            "additionalInfo": "For security reasons, it's not permitted to bring food, drinks, prams, skateboards, scooters, bicycles, large pieces of luggage, weapons and dangerous materials.\r\n\r\nBags and luggage can be stored free of charge. \r\n\r\nPlease note that animals are not allowed on the tour, except for service dogs.\r\n\r\nPlease make sure that your ticket is with you for the entire duration of your visit.\r\n\r\nPlease note that you must show a valid ticket when requested.\r\n\r\nPlease note that each table at the restaurant can accommodate a maximum of four participants. \r\n\r\nFor safety reasons, the TV Tower can be closed at any time and without prior warning. In such situations, only people with tickets that have already been purchased will be provided with a refund. \r\n\r\nPlease note that this ticket guarantees you go directly to the security check and then the lift. \r\n\r\nPlease note that delays may occur when going through security and waiting for the lifts.\r\n\r\nChildren aged 0–3 years can enter for free. \r\n\r\nFor safety reasons in case of evacuation, please note that this tour is not suitable for wheelchair users and people with reduced mobility.\n\nPlease bring your ticket with you to the attraction.\n\nBe aware that operators may cancel for unforeseen reasons.\n\nYou need to be 18 years or older to book or be accompanied by an adult. ",
            "applicableTerms": [
                {
                    "__typename": "TermsConditions",
                    "policyProvider": "Booking.com"
                },
                {
                    "__typename": "TermsConditions",
                    "policyProvider": "Musement"
                }
            ],
            "cancellationPolicy": {
                "__typename": "AttractionsCancellationPolicy",
                "hasFreeCancellation": false
            },
            "description": "This skip-the-line ticket offers you the chance to visit one of Berlin's major landmarks and experience the city and its surroundings from above. \r\n\r\nAt an altitude of more than 200 metres, you can enjoy the panorama while seated at the restaurant – where dining is compulsory, with à la carte options provided. The restaurant makes one to two rotations per hour, giving you the chance to see Germany’s capital and nearby areas within a radius of 70 km. After this culinary experience of the special kind, you’re free to visit the observation deck which boasts Berlin’s highest bar.",
            "flags": [
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "popularFor2Travelers",
                    "value": true,
                    "rank": 4
                }
            ],
            "id": "PRrKFcd1d3Ph",
            "isBookable": true,
            "name": "Berlin TV Tower with Restaurant and Bar Visit",
            "notIncluded": [
                "Food and drinks"
            ],
            "offers": [
                {
                    "__typename": "Offer",
                    "availabilityType": "date_time",
                    "id": "OFYPhn4neLlc"
                },
                {
                    "__typename": "Offer",
                    "availabilityType": "date_time",
                    "id": "OFDn0VSO2WVt"
                }
            ],
            "onSiteRequirements": {
                "__typename": "OnSiteRequirements"
            },
            "operatedBy": "TV-Turm Alexanderplatz Gastronomiegesellschaft mbH // Berliner Fernsehturm",
            "representativePrice": {
                "__typename": "AttractionsPrice",
                "chargeAmount": 27.58,
                "currency": "USD",
                "publicAmount": 27.58
            },
            "reviews": {
                "__typename": "AttractionsGetReviewsResponse",
                "total": 221,
                "reviews": [
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSicLSKqq6X6",
                        "epochMs": 1727080793000,
                        "language": "de",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Dirk",
                            "cc1": "de"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSHOWuG1wqM4",
                        "epochMs": 1726914969000,
                        "language": "da",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Michael",
                            "cc1": "dk"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSrIIMZLexnp",
                        "epochMs": 1726758235000,
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Andrzej",
                            "cc1": "pl"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSGIZ3S3emCx",
                        "content": "Fed oplevelse at se Berlin så højt oppe fra og alt omkring Berlin.",
                        "epochMs": 1726738190000,
                        "language": "da",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Jørn",
                            "cc1": "de"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSuZd9AfxlAB",
                        "epochMs": 1726414604000,
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Ryng"
                        }
                    }
                ]
            },
            "reviewsStats": {
                "__typename": "AttractionsProductReviewStats",
                "allReviewsCount": 44,
                "percentage": "95%",
                "combinedNumericStats": {
                    "__typename": "AttractionsProductCombinedReviewStats",
                    "average": 4.5,
                    "total": 392
                }
            },
            "shortDescription": "An experience with panoramic views of Berlin",
            "slug": "prrkfcd1d3ph-berlin-tv-tower-with-restaurant-and-bar-visit",
            "supportedFeatures": {
                "__typename": "AttractionsProductSupportedFeatures",
                "nativeApp": true,
                "nativeAppBookProcess": true,
                "liveAvailabilityCheckSupported": true
            },
            "uniqueSellingPoints": [
                "Skip-the-line admission to one of the city's major landmarks",
                "Visit to the observation deck featuring Berlin's highest bar",
                "Chance to dine at the restaurant while enjoying stunning views"
            ],
            "ufiDetails": {
                "__typename": "AttractionLocationResponse",
                "ufi": -1746443,
                "bCityName": "Berlin"
            },
            "whatsIncluded": [
                "Skip-the-line admission to the Berlin TV Tower",
                "Table reservation at the revolving restaurant Sphere"
            ]
        }
    },
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "name": "Berlin Central Station",
                "googlePlaceId": "ChIJe-ff-71RqEcRqvy8lRR4PHo",
                "city": "Berlin",
                "latitude": 52.525,
                "countryCode": "de",
                "types": "train_station",
                "longitude": 13.369403,
                "country": "Germany"
            }
        ]
    },
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "latitude": 52.520863,
                "name": "Berlin TV Tower",
                "countryCode": "de",
                "longitude": 13.409575,
                "types": "monument",
                "googlePlaceId": "ChIJ6_8UkB9OqEcRoeRJQ0j8-sg",
                "country": "Germany",
                "city": "Berlin"
            }
        ]
    }
]

2025-08-25 12:21:10,788 - evaluation_logger_Cross-333 - INFO - Function Calls: 
[
    {
        "name": "Search_Taxi",
        "arguments": {
            "pick_up_place_id": "ChIJe-ff-71RqEcRqvy8lRR4PHo",
            "drop_off_place_id": "ChIJ6_8UkB9OqEcRoeRJQ0j8-sg",
            "pick_up_date": "2024-12-12",
            "pick_up_time": "12:22"
        }
    }
]

2025-08-25 12:21:10,788 - evaluation_logger_Cross-333 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Taxi",
        "arguments": {
            "drop_off_place_id": "ChIJ6_8UkB9OqEcRoeRJQ0j8-sg",
            "pick_up_date": "2024-12-12",
            "pick_up_place_id": "ChIJe-ff-71RqEcRqvy8lRR4PHo",
            "pick_up_time": "12:22"
        }
    }
]

2025-08-25 12:21:10,788 - evaluation_logger_Cross-333 - INFO - Start compare_single_call: 
{'name': 'Search_Taxi', 'arguments': {'drop_off_place_id': 'ChIJ6_8UkB9OqEcRoeRJQ0j8-sg', 'pick_up_date': '2024-12-12', 'pick_up_place_id': 'ChIJe-ff-71RqEcRqvy8lRR4PHo', 'pick_up_time': '12:22'}}
{'name': 'Search_Taxi', 'arguments': {'drop_off_place_id': 'ChIJ6_8UkB9OqEcRoeRJQ0j8-sg', 'pick_up_date': '2024-12-12', 'pick_up_place_id': 'ChIJe-ff-71RqEcRqvy8lRR4PHo', 'pick_up_time': '12:22'}}
2025-08-25 12:21:10,788 - evaluation_logger_Cross-333 - INFO - Rule-based compare success.
2025-08-25 12:21:10,788 - evaluation_logger_Cross-333 - INFO - Success matched: [{'name': 'Search_Taxi', 'arguments': {'drop_off_place_id': 'ChIJ6_8UkB9OqEcRoeRJQ0j8-sg', 'pick_up_date': '2024-12-12', 'pick_up_place_id': 'ChIJe-ff-71RqEcRqvy8lRR4PHo', 'pick_up_time': '12:22'}}]
2025-08-25 12:21:10,788 - evaluation_logger_Cross-333 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "results": [
                {
                    "resultId": "b0620808-1c0b-4573-be6d-94e3013ae729",
                    "legPriceBreakdown": [
                        {
                            "supplierName": "VIP Black Car",
                            "supplierLocationId": 6317,
                            "journeyDirection": "OUTBOUND",
                            "price": {
                                "amount": "48.52",
                                "currencyCode": "USD"
                            },
                            "supplierId": 2533
                        }
                    ],
                    "geniusDiscount": false,
                    "category": "Executive",
                    "descriptionLocalised": "Plenty of space to travel in comfort.",
                    "vehicleType": "EXECUTIVE",
                    "discountType": "NONE",
                    "price": {
                        "currencyCode": "USD",
                        "amount": "48.52"
                    },
                    "drivingDistance": 4.7,
                    "bags": 4,
                    "description": "Executive",
                    "priceRuleId": 19218,
                    "meetGreet": true,
                    "janusResultReference": "2",
                    "duration": 15,
                    "passengerCapacity": 4,
                    "supplierId": 2533,
                    "categoryLocalised": "Executive",
                    "cancellationLeadTimeMinutes": 1440,
                    "nonRefundable": false,
                    "supplierName": "VIP Black Car"
                },
                {
                    "priceRuleId": 19217,
                    "bags": 3,
                    "description": "Standard",
                    "price": {
                        "currencyCode": "USD",
                        "amount": "49.19"
                    },
                    "discountType": "NONE",
                    "drivingDistance": 4.7,
                    "descriptionLocalised": "Perfect for solo travellers, couples and small families.",
                    "vehicleType": "STANDARD",
                    "category": "Standard",
                    "geniusDiscount": false,
                    "legPriceBreakdown": [
                        {
                            "supplierName": "Talixo",
                            "supplierLocationId": 5169,
                            "journeyDirection": "OUTBOUND",
                            "price": {
                                "amount": "49.19",
                                "currencyCode": "USD"
                            },
                            "supplierId": 2507
                        }
                    ],
                    "resultId": "b3c6a4e5-ba9b-455d-b478-bbca4605f38a",
                    "supplierName": "Talixo",
                    "nonRefundable": false,
                    "cancellationLeadTimeMinutes": 180,
                    "categoryLocalised": "Standard",
                    "supplierId": 2507,
                    "passengerCapacity": 3,
                    "duration": 15,
                    "janusResultReference": "1",
                    "meetGreet": true
                },
                {
                    "resultId": "2ef73642-7c48-4c9e-a227-b3a2e721da83",
                    "legPriceBreakdown": [
                        {
                            "journeyDirection": "OUTBOUND",
                            "supplierLocationId": 4275,
                            "supplierName": "Lets Drive GmbH",
                            "supplierId": 2451,
                            "price": {
                                "amount": "65.68",
                                "currencyCode": "USD"
                            }
                        }
                    ],
                    "geniusDiscount": false,
                    "category": "People Carrier",
                    "drivingDistance": 4.7,
                    "discountType": "NONE",
                    "price": {
                        "amount": "65.68",
                        "currencyCode": "USD"
                    },
                    "vehicleType": "LARGE",
                    "descriptionLocalised": "Great choice for families.",
                    "priceRuleId": 19221,
                    "description": "People Carrier",
                    "bags": 4,
                    "janusResultReference": "5",
                    "meetGreet": false,
                    "passengerCapacity": 4,
                    "duration": 15,
                    "supplierId": 2451,
                    "categoryLocalised": "People carrier",
                    "cancellationLeadTimeMinutes": 120,
                    "nonRefundable": false,
                    "supplierName": "Lets Drive GmbH"
                },
                {
                    "legPriceBreakdown": [
                        {
                            "supplierName": "Lets Drive GmbH",
                            "journeyDirection": "OUTBOUND",
                            "supplierLocationId": 4280,
                            "price": {
                                "amount": "65.68",
                                "currencyCode": "USD"
                            },
                            "supplierId": 2451
                        }
                    ],
                    "geniusDiscount": false,
                    "resultId": "f2b64cd5-7244-4079-9429-44836c40e2ce",
                    "drivingDistance": 4.7,
                    "discountType": "NONE",
                    "price": {
                        "currencyCode": "USD",
                        "amount": "65.68"
                    },
                    "vehicleType": "LARGE",
                    "descriptionLocalised": "Ideal for small groups.",
                    "priceRuleId": 19222,
                    "bags": 10,
                    "description": "Large People Carrier",
                    "category": "Large People Carrier",
                    "supplierId": 2451,
                    "categoryLocalised": "Large people carrier",
                    "janusResultReference": "6",
                    "meetGreet": false,
                    "passengerCapacity": 8,
                    "duration": 15,
                    "nonRefundable": false,
                    "supplierName": "Lets Drive GmbH",
                    "cancellationLeadTimeMinutes": 120
                },
                {
                    "supplierId": 2451,
                    "categoryLocalised": "Executive people carrier",
                    "janusResultReference": "3",
                    "meetGreet": false,
                    "passengerCapacity": 7,
                    "duration": 15,
                    "nonRefundable": false,
                    "supplierName": "Lets Drive GmbH",
                    "cancellationLeadTimeMinutes": 120,
                    "legPriceBreakdown": [
                        {
                            "supplierName": "Lets Drive GmbH",
                            "supplierLocationId": 4280,
                            "journeyDirection": "OUTBOUND",
                            "price": {
                                "currencyCode": "USD",
                                "amount": "65.68"
                            },
                            "supplierId": 2451
                        }
                    ],
                    "geniusDiscount": false,
                    "resultId": "52727925-abd2-44f5-b359-e707e96b0231",
                    "price": {
                        "amount": "65.68",
                        "currencyCode": "USD"
                    },
                    "discountType": "NONE",
                    "drivingDistance": 4.7,
                    "descriptionLocalised": "Perfect for groups that want a touch of luxury.",
                    "vehicleType": "LARGE_EXECUTIVE",
                    "priceRuleId": 19219,
                    "bags": 7,
                    "description": "Executive People Carrier",
                    "category": "Executive People Carrier"
                }
            ],
            "journeys": [
                {
                    "janusSearchReference": "67d9d03b-d9f9-43d5-8087-2964be685e1b",
                    "pickupLocation": {
                        "city": "Berlin",
                        "country": "DE",
                        "postcode": "10557",
                        "timezone": "Europe/Berlin",
                        "establishment": "Berlin Central Train Station",
                        "name": "Berlin Central Train Station, Hauptbahnhof, Europaplatz 1, 10557 Berlin, Germany",
                        "description": "Hauptbahnhof, Europaplatz 1, 10557 Berlin, Germany",
                        "locationType": "STATION",
                        "locationId": "ChIJe-ff-71RqEcRqvy8lRR4PHo"
                    },
                    "journeyDirection": "OUTBOUND",
                    "requestedPickupDateTime": "2024-12-12T12:22:00",
                    "dropOffLocation": {
                        "postcode": "10178",
                        "establishment": "Berlin TV Tower",
                        "name": "Berlin TV Tower, Panoramastraße 1A, 10178 Berlin, Germany",
                        "description": "Panoramastraße 1A, 10178 Berlin, Germany",
                        "city": "Berlin",
                        "locationType": "GEO",
                        "locationId": "ChIJ6_8UkB9OqEcRoeRJQ0j8-sg",
                        "country": "DE"
                    }
                }
            ]
        }
    }
]

2025-08-25 12:23:20,573 - evaluation_logger_Cross-333 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring Boot 源码分析 —— SpringApplication》](http://svip.iocoder.cn/Spring-Boot/SpringApplication/) 的**第一篇**文章，我们来一起看看 SpringApplication 的**构建**。

在 Spring Boot 中，SpringApplication 是一个用于启动 Spring 应用的**引导类**。它的 `#run(String... args)` 方法，启动 Spring 应用。代码如下：

```java
// SpringApplication.java

public static ConfigurableApplicationContext run(Class<?> primarySource, String... args) {
	return run(new Class<?>[] { primarySource }, args);
}

public static ConfigurableApplicationContext run(Class<?>[] primarySources, String[] args) {
	return new SpringApplication(primarySources).run(args);
}
```

- 一般情况下，我们使用**第一个**方法，传入我们**自己**的 Spring Boot 主类（ Main 类）即可。
- 而实际上，核心是**第二个**方法。它会创建一个 SpringApplication 对象，然后调用其 `#run(args)` 方法。

# 2. 构造方法

我们先来看看 SpringApplication 的构造方法，代码如下：

```java
// SpringApplication.java

/**
 * 资源加载器
 */
private ResourceLoader resourceLoader;
/**
 * 主要的 Java Config 类的数组
 */
private Set<Class<?>> primarySources;
/**
 * Web 应用类型
 */
private WebApplicationType webApplicationType;

public SpringApplication(Class<?>... primarySources) {
    this(null, primarySources);
}

public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    // 判断 Web 应用类型
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
    // 设置初始化器
    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
    // 设置监听器
    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    // 推断主类
    this.mainApplicationClass = deduceMainApplicationClass();
}
```

- 虽然构造方法的代码不多，但是每一行都是关键。我们逐行来看看。

## 2.1 resourceLoader

`resourceLoader` 属性，资源加载器。可以暂时不理解，后续文章会详细解析。

## 2.2 primarySources

`primarySources` 属性，主要的 Java Config 类的数组。在文初的示例，就是 `DemoApplication` 类。

## 2.3 webApplicationType

`webApplicationType` 属性，Web 应用类型。通过 `WebApplicationType#deduceFromClasspath()` 方法，通过 classpath 来推断。代码如下：

```java
// WebApplicationType.java

static WebApplicationType deduceFromClasspath() {
    // 如果存在 REACTIVE 相关的类，则返回 REACTIVE
    if (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null) && !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null)
            && !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) {
        return WebApplicationType.REACTIVE;
    }
    // 如果不存在 SERVLET 相关的类，则返回 NONE
    for (String className : SERVLET_INDICATOR_CLASSES) {
        if (!ClassUtils.isPresent(className, null)) {
            return WebApplicationType.NONE;
        }
    }
    // 否则，返回 SERVLET
    return WebApplicationType.SERVLET;
}
```

- Web 应用类型，一共有三种：NONE、SERVLET、REACTIVE。
- 三种类型的简单说明如下：
  - NONE：非 Web 类型。
  - SERVLET：基于 Servlet 的 Web 类型。
  - REACTIVE：基于 Reactive 的 Web 类型。目前 Spring5 提供了对 Reactive 的支持。
- 具体的判断逻辑，看下代码注释。

## 2.4 setInitializers

`setInitializers` 方法，设置初始化器。而 `#getSpringFactoriesInstances(ApplicationContextInitializer.class)` 方法，获得 `ApplicationContextInitializer` 类型的初始化器数组。代码如下：

```java
// SpringApplication.java

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type) {
    return getSpringFactoriesInstances(type, new Class<?>[] {});
}

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, Object... args) {
    ClassLoader classLoader = getClassLoader();
    // Use names and ensure unique to protect against duplicates
    // <1> 加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组
    Set<String> names = new LinkedHashSet<>(SpringFactoriesLoader.loadFactoryNames(type, classLoader));
    // <2> 创建对象
    List<T> instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);
    // <3> 排序
    AnnotationAwareOrderComparator.sort(instances);
    return instances;
}
```

- `<1>` 处：调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组。

  - 在 Spring Boot 中，`META-INF/spring.factories` 配置如下：

    ```properties
    # Initializers
    org.springframework.context.ApplicationContextInitializer=\
    org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\
    org.springframework.boot.context.ContextIdApplicationContextInitializer,\
    org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\
    org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer
    ```

    - 所以，此处会获得 4 个 ApplicationContextInitializer 实现类。

  - 关于 SpringFactoriesLoader 的详细解析，见 [《精尽 Spring Boot 源码分析 —— 应用程序启动器》](http://svip.iocoder.cn/Spring-Boot/SpringFactoriesLoader/) 。

- `<2>` 处：调用 `#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象。代码如下：

  ```java
  // SpringApplication.java
  
  private <T> List<T> createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes,
  		ClassLoader classLoader, Object[] args, Set<String> names) {
  	List<T> instances = new ArrayList<>(names.size());
  	for (String name : names) {
  		try {
  			Class<?> instanceClass = ClassUtils.forName(name, classLoader);
  			Assert.isAssignable(type, instanceClass);
  			Constructor<?> constructor = instanceClass.getDeclaredConstructor(parameterTypes);
  			T instance = (T) BeanUtils.instantiateClass(constructor, args);
  			instances.add(instance);
  		} catch (Throwable ex) {
  			throw new IllegalArgumentException("Cannot instantiate " + type + " : " + name, ex);
  		}
  	}
  	return instances;
  }
  ```

  - 通过反射，创建对象。

- `<3>` 处：排序。排序规则，基于 `@Order` 注解。

- 创建完 ApplicationContextInitializer 对象数组后，会调用 `#setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers)` 方法，进行设置。代码如下：

  ```java
  // SpringApplication.java
  
  public void setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers) {
  	this.initializers = new ArrayList<>();
  	this.initializers.addAll(initializers);
  }
  ```

  - 此处设置的 `initializers` 属性，在后续 Spring 容器的初始化会被使用。

## 2.5 setListeners

`setListeners` 方法，设置监听器。而 `#getSpringFactoriesInstances(ApplicationListener.class)` 方法，获得 `ApplicationListener` 类型的监听器数组。

- 具体的逻辑，和 `#setInitializers` 方法类似。

- 在 Spring Boot 中，`META-INF/spring.factories` 配置如下：

  ```properties
  # Application Listeners
  org.springframework.context.ApplicationListener=\
  org.springframework.boot.ClearCachesApplicationListener,\
  org.springframework.boot.builder.ParentContextCloserApplicationListener,\
  org.springframework.boot.context.FileEncodingApplicationListener,\
  org.springframework.boot.context.config.AnsiOutputApplicationListener,\
  org.springframework.boot.context.config.ConfigFileApplicationListener,\
  org.springframework.boot.context.config.DelegatingApplicationListener,\
  org.springframework.boot.context.logging.ClasspathLoggingApplicationListener,\
  org.springframework.boot.context.logging.LoggingApplicationListener,\
  org.springframework.boot.liquibase.LiquibaseServiceApplicationListener
  ```

  - 所以，此处会获得 9 个 ApplicationListener 实现类。

- 创建完 ApplicationListener 对象数组后，会调用 `#setListeners(Collection<? extends ApplicationListener<?>> listeners)` 方法，进行设置。代码如下：

  ```java
  // SpringApplication.java
  
  public void setListeners(Collection<? extends ApplicationListener<?>> listeners) {
  	this.listeners = new ArrayList<>();
  	this.listeners.addAll(listeners);
  }
  ```

  - 此处设置的 `listeners` 属性，在后续 Spring 容器的初始化会被使用。

## 2.6 deduceMainApplicationClass

`deduceMainApplicationClass` 方法，推断主类。代码如下：

```java
// SpringApplication.java

private Class<?> mainApplicationClass;

private Class<?> deduceMainApplicationClass() {
    try {
        // 获得当前 StackTraceElement 数组
        StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();
        // 遍历 StackTraceElement 数组，找到最后一个调用的类
        for (StackTraceElement stackTraceElement : stackTrace) {
            if ("main".equals(stackTraceElement.getMethodName())) {
                return Class.forName(stackTraceElement.getClassName());
            }
        }
    } catch (ClassNotFoundException ex) {
        // Swallow and continue
    }
    return null;
}
```

- 通过异常的方式，获取当前 StackTraceElement 数组。
- 然后，遍历 StackTraceElement 数组，找到最后一个调用的类。因为，这个类，就是 Main 类。

# 3. 小结

至此，SpringApplication 对象就创建完成了。整个过程，如下图：

![SpringApplication 构造方法](SpringApplication 构造方法.png)

- 比较关键的是，`#getSpringFactoriesInstances(...)` 方法，获得相应的初始化器和监听器。

2025-08-25 12:23:27,116 - evaluation_logger_Cross-333 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about trending attractions in Berlin or taxi information.'}
2025-08-25 12:23:33,327 - evaluation_logger_Cross-333 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:23:33,327 - evaluation_logger_Cross-333 - INFO - Message: Success.
2025-08-25 12:23:33,327 - evaluation_logger_Cross-333 - INFO - Success turn num = 4
2025-08-25 12:23:33,327 - evaluation_logger_Cross-333 - INFO - ----------------------------------------------------------------------------------------------------
