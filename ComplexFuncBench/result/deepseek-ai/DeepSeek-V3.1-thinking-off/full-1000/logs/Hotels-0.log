2025-08-25 12:30:50,300 - evaluation_logger_Hotels-0 - INFO - Test Example Hotels-0
2025-08-25 12:30:50,300 - evaluation_logger_Hotels-0 - INFO - Query: My friend and his family are planning a trip to Paris from December 20 to December 25, 2024. There are two adults and two kids in the group, aged seven and ten. Could you suggest some hotels?
2025-08-25 12:30:58,623 - evaluation_logger_Hotels-0 - INFO - Function Calls: 
[
    {
        "name": "Search_Hotel_Destination",
        "arguments": {
            "query": "Paris"
        }
    }
]

2025-08-25 12:30:58,623 - evaluation_logger_Hotels-0 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Hotel_Destination",
        "arguments": {
            "query": "Paris"
        }
    },
    {
        "name": "Search_Hotels",
        "arguments": {
            "search_type": "city",
            "dest_id": -1456928,
            "arrival_date": "2024-12-20",
            "departure_date": "2024-12-25",
            "adults": 2,
            "children_age": "7,10"
        }
    }
]

2025-08-25 12:30:58,623 - evaluation_logger_Hotels-0 - INFO - Start compare_single_call: 
{'name': 'Search_Hotel_Destination', 'arguments': {'query': 'Paris'}}
{'name': 'Search_Hotel_Destination', 'arguments': {'query': 'Paris'}}
2025-08-25 12:30:58,623 - evaluation_logger_Hotels-0 - INFO - Rule-based compare success.
2025-08-25 12:30:58,623 - evaluation_logger_Hotels-0 - INFO - Success matched: [{'name': 'Search_Hotel_Destination', 'arguments': {'query': 'Paris'}}]
2025-08-25 12:30:58,623 - evaluation_logger_Hotels-0 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "dest_id": "-1456928",
                "search_type": "city",
                "cc1": "fr",
                "label": "Paris, Ile de France, France",
                "hotels": 7561,
                "city_name": "Paris",
                "latitude": 48.85668,
                "nr_hotels": 7561,
                "longitude": 2.3514764,
                "country": "France",
                "region": "Ile de France",
                "roundtrip": "GgEwIAAoATICZW46BVBhcmlzQABKAFAA",
                "lc": "en",
                "dest_type": "city",
                "name": "Paris",
                "type": "ci"
            }
        ]
    }
]

2025-08-25 12:31:10,086 - evaluation_logger_Hotels-0 - INFO - Function Calls: 
[
    {
        "name": "Search_Hotels",
        "arguments": {
            "dest_id": -1456928,
            "search_type": "city",
            "arrival_date": "2024-12-20",
            "departure_date": "2024-12-25",
            "adults": 2,
            "children_age": "7,10"
        }
    }
]

2025-08-25 12:31:10,087 - evaluation_logger_Hotels-0 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Hotels",
        "arguments": {
            "adults": 2,
            "arrival_date": "2024-12-20",
            "children_age": "7,10",
            "departure_date": "2024-12-25",
            "dest_id": -1456928,
            "search_type": "city"
        }
    }
]

2025-08-25 12:31:10,087 - evaluation_logger_Hotels-0 - INFO - Start compare_single_call: 
{'name': 'Search_Hotels', 'arguments': {'adults': 2, 'arrival_date': '2024-12-20', 'children_age': '7,10', 'departure_date': '2024-12-25', 'dest_id': -1456928, 'search_type': 'city'}}
{'name': 'Search_Hotels', 'arguments': {'adults': 2, 'arrival_date': '2024-12-20', 'children_age': '7,10', 'departure_date': '2024-12-25', 'dest_id': -1456928, 'search_type': 'city'}}
2025-08-25 12:31:10,087 - evaluation_logger_Hotels-0 - INFO - Rule-based compare success.
2025-08-25 12:31:10,087 - evaluation_logger_Hotels-0 - INFO - Success matched: [{'name': 'Search_Hotels', 'arguments': {'adults': 2, 'arrival_date': '2024-12-20', 'children_age': '7,10', 'departure_date': '2024-12-25', 'dest_id': -1456928, 'search_type': 'city'}}]
2025-08-25 12:31:10,087 - evaluation_logger_Hotels-0 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "hotels": [
                {
                    "hotel_id": 12246693,
                    "accessibilityLabel": "La Tour Eiffel CC beaugrenelle Appartement.\n3 out of 5 for property rating.\n7.0 Good 5 reviews.\n‎15th arr.‬ • ‎4.9 km from centre‬.\n Entire apartment – 66 m² : 4 beds • 1 bedroom • 2 living rooms • 1 bathroom.\nOriginal price 702 USD. Current price 579 USD..\nIncludes taxes and charges.",
                    "property": {
                        "wishlistName": "Paris",
                        "checkinDate": "2024-12-20",
                        "currency": "EUR",
                        "checkoutDate": "2024-12-25",
                        "countryCode": "fr",
                        "checkin": {
                            "fromTime": "16:00",
                            "untilTime": "23:30"
                        },
                        "longitude": 2.2858807,
                        "isPreferred": true,
                        "reviewScore": 7,
                        "name": "La Tour Eiffel CC beaugrenelle Appartement",
                        "qualityClass": 3,
                        "position": 0,
                        "ufi": -1456928,
                        "reviewCount": 5,
                        "latitude": 48.8463546,
                        "isFirstPage": true,
                        "rankingPosition": 0,
                        "accuratePropertyClass": 0,
                        "priceBreakdown": {
                            "grossPrice": {
                                "currency": "USD",
                                "value": 578.678828330108
                            },
                            "benefitBadges": [
                                {
                                    "identifier": "Mobile Rate",
                                    "text": "Mobile-only price",
                                    "explanation": "Mobile-only price",
                                    "variant": "constructive"
                                }
                            ],
                            "strikethroughPrice": {
                                "currency": "USD",
                                "value": 701.758822898623
                            }
                        },
                        "propertyClass": 0,
                        "mainPhotoId": 568298846,
                        "id": 12246693,
                        "optOutFromGalleryChanges": 0,
                        "reviewScoreWord": "Good",
                        "blockIds": [
                            "1224669301_394573571_8_0_0"
                        ],
                        "checkout": {
                            "fromTime": "06:00",
                            "untilTime": "11:00"
                        }
                    }
                },
                {
                    "hotel_id": 11722364,
                    "accessibilityLabel": "Appartement Assomption paris.\n4 out of 5 for property rating.\n7.7 Good 4 reviews.\n‎16th arr.‬ • ‎6 km from centre‬.\n Entire apartment – 42 m² : 3 beds • 1 bedroom • 1 living room • 1 bathroom.\nOriginal price 799 USD. Current price 597 USD..\nIncludes taxes and charges.",
                    "property": {
                        "rankingPosition": 1,
                        "isFirstPage": true,
                        "accuratePropertyClass": 0,
                        "id": 11722364,
                        "mainPhotoId": 536798908,
                        "priceBreakdown": {
                            "strikethroughPrice": {
                                "currency": "USD",
                                "value": 799.136128075458
                            },
                            "benefitBadges": [
                                {
                                    "variant": "constructive",
                                    "explanation": "Mobile-only price",
                                    "text": "Mobile-only price",
                                    "identifier": "Mobile Rate"
                                }
                            ],
                            "grossPrice": {
                                "value": 596.803752228235,
                                "currency": "USD"
                            }
                        },
                        "propertyClass": 0,
                        "checkout": {
                            "untilTime": "12:00",
                            "fromTime": "06:00"
                        },
                        "blockIds": [
                            "1172236401_389756606_6_0_0"
                        ],
                        "reviewScoreWord": "Good",
                        "optOutFromGalleryChanges": 0,
                        "currency": "EUR",
                        "checkinDate": "2024-12-20",
                        "checkoutDate": "2024-12-25",
                        "wishlistName": "Paris",
                        "longitude": 2.2690894,
                        "checkin": {
                            "fromTime": "16:00",
                            "untilTime": "00:00"
                        },
                        "countryCode": "fr",
                        "position": 1,
                        "qualityClass": 4,
                        "name": "Appartement Assomption paris",
                        "reviewScore": 7.7,
                        "isPreferred": true,
                        "latitude": 48.8549435,
                        "reviewCount": 4,
                        "ufi": -1456928
                    }
                },
                {
                    "hotel_id": 57064,
                    "accessibilityLabel": "Novotel Suites Paris Montreuil Vincennes.\n4 out of 5 stars.\n7.7 Good 6779 reviews.\n‎20th arr.‬ • ‎4.7 km from centre‬.\n Private suite : 3 beds.\n801 USD.\nIncludes taxes and charges.",
                    "property": {
                        "name": "Novotel Suites Paris Montreuil Vincennes",
                        "reviewScore": 7.7,
                        "isPreferred": true,
                        "qualityClass": 0,
                        "position": 2,
                        "ufi": -1456928,
                        "reviewCount": 6779,
                        "latitude": 48.8560072655289,
                        "wishlistName": "Paris",
                        "checkinDate": "2024-12-20",
                        "checkoutDate": "2024-12-25",
                        "currency": "EUR",
                        "countryCode": "fr",
                        "checkin": {
                            "fromTime": "14:00",
                            "untilTime": "00:00"
                        },
                        "longitude": 2.41509854793549,
                        "priceBreakdown": {
                            "grossPrice": {
                                "value": 800.623060519604,
                                "currency": "USD"
                            }
                        },
                        "propertyClass": 4,
                        "mainPhotoId": 127140817,
                        "id": 57064,
                        "optOutFromGalleryChanges": 0,
                        "reviewScoreWord": "Good",
                        "blockIds": [
                            "5706405_94275123_2_2_0"
                        ],
                        "checkout": {
                            "untilTime": "12:00",
                            "fromTime": "00:00"
                        },
                        "isFirstPage": true,
                        "rankingPosition": 2,
                        "accuratePropertyClass": 4
                    }
                },
                {
                    "hotel_id": 11847281,
                    "accessibilityLabel": "All Suites Appart & Hotel Paris 13 Porte d'Italie.\n4 out of 5 for property rating.\n7.5 Good 135 reviews.\n‎13th arr.‬ • ‎4.5 km from centre‬.\n Entire studio – 33 m² : 2 beds • 1 bedroom • 1 bathroom.\n818 USD.\nIncludes taxes and charges.",
                    "property": {
                        "optOutFromGalleryChanges": 0,
                        "blockIds": [
                            "1184728107_393497790_0_2_0"
                        ],
                        "reviewScoreWord": "Good",
                        "checkout": {
                            "untilTime": "12:00",
                            "fromTime": "04:00"
                        },
                        "propertyClass": 0,
                        "priceBreakdown": {
                            "grossPrice": {
                                "value": 817.774584030736,
                                "currency": "USD"
                            }
                        },
                        "mainPhotoId": 543539296,
                        "id": 11847281,
                        "accuratePropertyClass": 0,
                        "isFirstPage": true,
                        "rankingPosition": 3,
                        "ufi": -1456928,
                        "latitude": 48.816777,
                        "reviewCount": 135,
                        "name": "All Suites Appart & Hotel Paris 13 Porte d'Italie",
                        "reviewScore": 7.5,
                        "isPreferred": true,
                        "qualityClass": 4,
                        "position": 3,
                        "countryCode": "fr",
                        "checkin": {
                            "fromTime": "14:00",
                            "untilTime": "00:00"
                        },
                        "longitude": 2.3576,
                        "wishlistName": "Paris",
                        "checkoutDate": "2024-12-25",
                        "checkinDate": "2024-12-20",
                        "currency": "EUR"
                    }
                },
                {
                    "hotel_id": 5163757,
                    "accessibilityLabel": "MEININGER Hotel Paris Porte de Vincennes.\n7.9 Good 9197 reviews.\n‎12th arr.‬ • ‎4.7 km from centre‬.\n Hotel room : 4 beds.\n607 USD.\nIncludes taxes and charges.",
                    "property": {
                        "longitude": 2.413063,
                        "countryCode": "fr",
                        "checkin": {
                            "fromTime": "15:00",
                            "untilTime": "00:00"
                        },
                        "wishlistName": "Paris",
                        "checkoutDate": "2024-12-25",
                        "currency": "EUR",
                        "checkinDate": "2024-12-20",
                        "reviewCount": 9197,
                        "latitude": 48.844105,
                        "ufi": -1456928,
                        "position": 4,
                        "isPreferred": true,
                        "reviewScore": 7.9,
                        "name": "MEININGER Hotel Paris Porte de Vincennes",
                        "qualityClass": 0,
                        "accuratePropertyClass": 0,
                        "isFirstPage": true,
                        "rankingPosition": 4,
                        "reviewScoreWord": "Good",
                        "blockIds": [
                            "516375704_179102182_0_2_0"
                        ],
                        "checkout": {
                            "untilTime": "11:00",
                            "fromTime": "00:00"
                        },
                        "optOutFromGalleryChanges": 0,
                        "mainPhotoId": 582215893,
                        "id": 5163757,
                        "propertyClass": 0,
                        "priceBreakdown": {
                            "grossPrice": {
                                "currency": "USD",
                                "value": 606.698250393747
                            }
                        }
                    }
                }
            ],
            "meta": [
                {
                    "title": "4741 properties"
                }
            ],
            "appear": [
                {
                    "component": {
                        "props": {
                            "content": {
                                "props": {
                                    "fitContentWidth": true,
                                    "items": [
                                        {
                                            "props": {
                                                "component": {
                                                    "props": {
                                                        "spacing": "spacing_half",
                                                        "items": [
                                                            {
                                                                "props": {
                                                                    "text": [
                                                                        {
                                                                            "text": "Commission paid and other benefits may affect an accommodation's ranking.",
                                                                            "font": "body_2"
                                                                        },
                                                                        {
                                                                            "text": "  ",
                                                                            "color": "foreground",
                                                                            "font": "strong_2"
                                                                        },
                                                                        {
                                                                            "color": "action_foreground",
                                                                            "text": "Find out more",
                                                                            "font": "body_2",
                                                                            "linkActions": [
                                                                                {}
                                                                            ]
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        },
                                        {},
                                        {
                                            "props": {
                                                "component": {
                                                    "props": {
                                                        "accessibilityLabel": "Close",
                                                        "tertiaryTintedColor": "foreground",
                                                        "icon": "close",
                                                        "variant": "tertiary_tinted"
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            },
                            "fill": true
                        }
                    },
                    "id": "cma"
                },
                {
                    "component": {
                        "props": {
                            "text": "Properties with these icons have been awarded Booking.com's quality rating for homes"
                        }
                    },
                    "id": "banner_qualityrating"
                },
                {},
                {
                    "component": {
                        "props": {
                            "text": "Get instant access to our Genius loyalty programme and enjoy discounts at properties worldwide.",
                            "title": "Sign in and save money"
                        }
                    },
                    "id": "signin_now"
                },
                {
                    "accessibilityLabel": "B&B HOTEL Paris Porte de la Villette.\n3 out of 5 stars.\n6.7 Pleasant 669 reviews.\n‎19th arr.‬ • ‎6 km from centre‬.\n Hotel room : 3 beds.\nOriginal price 792 USD. Current price 710 USD..\nIncludes taxes and charges.\nFree cancellation.\nNo prepayment needed.",
                    "component": {
                        "props": {
                            "component": {
                                "props": {
                                    "component": {
                                        "props": {
                                            "items": [
                                                {
                                                    "props": {
                                                        "component": {
                                                            "props": {
                                                                "cornerRadius": "radius_200",
                                                                "component": {
                                                                    "props": {
                                                                        "source": "https://cf.bstatic.com/xdata/images/hotel/450x600/558159617.jpg?k=ff9aa82175aeab050523fb64f4224f109e56c765761d535762e6ff3c96b61f33&o="
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "width": 130
                                                    }
                                                },
                                                {
                                                    "props": {
                                                        "component": {
                                                            "props": {
                                                                "items": [
                                                                    {
                                                                        "props": {
                                                                            "items": [
                                                                                {
                                                                                    "props": {
                                                                                        "spacing": "spacing_1x",
                                                                                        "items": [
                                                                                            {
                                                                                                "props": {
                                                                                                    "text": "B&B HOTEL Paris Porte de la Villette",
                                                                                                    "font": "strong_2"
                                                                                                }
                                                                                            },
                                                                                            {
                                                                                                "props": {
                                                                                                    "items": [
                                                                                                        {
                                                                                                            "props": {
                                                                                                                "component": {
                                                                                                                    "props": {
                                                                                                                        "size": "small",
                                                                                                                        "value": 3
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                {
                                                                                    "props": {
                                                                                        "component": {
                                                                                            "props": {
                                                                                                "wishlistName": "Paris",
                                                                                                "propertyId": 1575799,
                                                                                                "destinationId": "city::-1456928"
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        "props": {
                                                                            "component": {
                                                                                "props": {
                                                                                    "score": "6.7",
                                                                                    "inline": true,
                                                                                    "size": "small",
                                                                                    "title": "Pleasant",
                                                                                    "subtitle": "669 reviews"
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    {
                                                                        "props": {
                                                                            "component": {
                                                                                "props": {
                                                                                    "items": [
                                                                                        {
                                                                                            "props": {
                                                                                                "component": {
                                                                                                    "props": {
                                                                                                        "spacing": "spacing_half",
                                                                                                        "items": [
                                                                                                            {
                                                                                                                "props": {
                                                                                                                    "component": {
                                                                                                                        "props": {
                                                                                                                            "size": "smaller",
                                                                                                                            "name": "geo_pin"
                                                                                                                        }
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            {
                                                                                                                "props": {
                                                                                                                    "text": "‎19th arr.‬ • ‎6 km from centre‬"
                                                                                                                }
                                                                                                            }
                                                                                                        ]
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    {
                                                                        "props": {
                                                                            "component": {
                                                                                "props": {
                                                                                    "component": {
                                                                                        "props": {
                                                                                            "variant": "constructive",
                                                                                            "text": "Mobile-only price"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    {
                                                                        "props": {
                                                                            "component": {
                                                                                "props": {
                                                                                    "items": [
                                                                                        {},
                                                                                        {
                                                                                            "props": {
                                                                                                "alignment": "trailing",
                                                                                                "text": [
                                                                                                    {
                                                                                                        "font": "strong_2",
                                                                                                        "text": "Hotel room"
                                                                                                    },
                                                                                                    {
                                                                                                        "text": ": 3 beds",
                                                                                                        "font": "body_2"
                                                                                                    }
                                                                                                ]
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            ]
        }
    }
]

2025-08-25 12:34:20,188 - evaluation_logger_Hotels-0 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 前言

在上一篇文章中，我们实现了`axios`的请求和响应配置化，即用户可以配置`config`对象中的`url`、`method`、`params`、`data`、`headers`、`timeout`、`responseType`等属性。其中，`headers`配置对象中的`Content-Type`属性是告诉服务器我们发送过去的数据是什么格式，而`responseType`属性是告诉服务器我们期望返回的数据是什么格式。另外，我们还实现了配置的默认值以及配置的合并策略。

但是，在之前的代码中，我们虽然可以配置`data`为任意类型，但是真正发送给服务器的数据必须是`XMLHttpRequest.send(body)` 中`body`支持的类型，包括：`Document`、`BodyInit`、`null`类型，而`BodyInit`包括了`Blob`、`BufferSource`、`FormData`、`URLSearchParams`、`ReadableStream`、`USVString`，当没有数据的时候还可以是`null`。

所以，当我们传递普通`object`对象给`data`的时候，我们是无法直接发送给服务器的，我们需要把它转换成`JSON`字符串，而这个过程我们把它叫做**数据转换**。

另外，当我们从服务器获取到响应数据后，我们也需要根据`responseType`的值把响应数据转换成相应的格式，而这个过程我们也把它叫做**数据转换**。

那么接下来，我们就为`axios`添加数据转换的功能。

# 2. 需求分析

根据上面的描述，我们总结出以下需求：

- 在请求之前，将请求数据`data`根据请求头`headers`中的`Content-Type`转换成对应格式；
- 在响应之后，将响应数据`data`根据响应头`headers`中的`Content-Type`转换成对应格式；

# 3. 请求数据转换

根据需求，我们要在请求发送之前将请求数据`data`根据请求头`headers`中的`Content-Type`转换成对应格式。而我们知道，`headers`中的`Content-Type`属性是告诉服务器我们发送过去的数据是什么格式，所以当`data`为普通对象的时候，我们需要根据`Content-Type`来转换`data`。

例如：

- 如果`Content-Type`是`application/json`，那么我们应该把`data`转换成`JSON`字符串；
- 如果`Content-Type`是`application/x-www-form-urlencoded`，那么我们应该把`data`转换成`URL`参数；

由于我们之前已经给`headers`配置了默认值，默认的`Content-Type`是`application/json;charset=utf-8`，所以这里我们就先实现将普通对象转换成`JSON`字符串，至于转换成`URL`参数我们后续再实现。

OK，思路已经有了，下面我们就开始实现。

## 3.1 修改默认配置

我们首先修改`src/defaults.ts`中`headers`的默认配置，我们给`headers`的默认配置添加一个属性：`common`，该属性意味着对于所有类型的请求都要配置该属性。我们在`common`中配置`Content-Type`的默认值为：`application/json;charset=utf-8`。

```typescript
// src/defaults.ts

const defaults: AxiosRequestConfig = {
  timeout: 0,
  headers: {
    common: {
      Accept: "application/json, text/plain, */*",
      "Content-Type": "application/json;charset=utf-8",
    },
  },
};
```

## 3.2 修改请求头配置合并策略

由于我们修改了默认配置中`headers`的结构，所以之前写的请求头配置合并策略已经不再适用，我们需要重写合并策略。

我们希望的合并策略是：

- 默认配置`headers`对象里的`common`、`get`、`post`等属性分别对应的是每种请求方法下的请求头配置；
- 用户配置的`headers`对象可以配置`common`、`get`、`post`等，也可以配置请求头字段，如：`Content-Type`等；
- 合并后的`headers`对象是一个扁平化的对象，没有`common`、`get`、`post`等属性；

例如，默认配置为：

```javascript
headers: {
  common: {
    Accept: "application/json, text/plain, */*",
  },
  post: {
    "Content-Type":"application/json;charset=utf-8"
  }
}
```

用户配置为：

```javascript
headers: {
  Authorization: "123456",
  post: {
    "Content-Type":"application/x-www-form-urlencoded"
  }
}
```

那么，合并后的`headers`为：

```javascript
headers: {
  Accept: "application/json, text/plain, */*",
  Authorization: "123456",
  "Content-Type":"application/x-www-form-urlencoded"
}
```

所以，我们需要重写`headers`的合并策略，如下：

```typescript
// src/core/mergeConfig.ts

import { isPlainObject, deepMerge } from "../helpers/util";

const strats = Object.create(null);

// 默认合并策略
function defaultStrat(val1: any, val2: any): any {
  return typeof val2 !== "undefined" ? val2 : val1;
}

// 只接受自定义配置合并策略
function fromVal2Strat(val1: any, val2: any): any {
  if (typeof val2 !== "undefined") {
    return val2;
  }
}

// 复杂对象合并策略
function deepMergeStrat(val1: any, val2: any): any {
  if (isPlainObject(val2)) {
    return deepMerge(val1, val2);
  } else if (typeof val2 !== "undefined") {
    return val2;
  } else if (isPlainObject(val1)) {
    return deepMerge(val1);
  } else {
    return val1;
  }
}

const stratKeysFromVal2 = ["url", "params", "data"];
stratKeysFromVal2.forEach((key) => {
  strats[key] = fromVal2Strat;
});

const stratKeysDeepMerge = ["headers"];
stratKeysDeepMerge.forEach((key) => {
  strats[key] = deepMergeStrat;
});

export default function mergeConfig(
  config1: AxiosRequestConfig,
  config2?: AxiosRequestConfig
): AxiosRequestConfig {
  if (!config2) {
    config2 = {};
  }

  const config = Object.create(null);

  for (let key in config2) {
    mergeField(key);
  }

  for (let key in config1) {
    if (!config2[key]) {
      mergeField(key);
    }
  }

  function mergeField(key: string): void {
    const strat = strats[key] || defaultStrat;
    config[key] = strat(config1[key], config2![key]);
  }

  return config;
}
```

这里，我们定义了一个`deepMergeStrat`合并策略，该策略会判断如果`val2`是普通对象，那么就会与`val1`（如果也是普通对象）进行深合并，否则就返回`val2`（如果`val2`不为`undefined`）或`val1`。

然后，我们给`headers`属性添加`deepMergeStrat`合并策略。

## 3.3 实现转换逻辑

接下来，我们就要实现请求数据的转换逻辑。

我们创建一个`src/helpers/data.ts`文件，该文件里存放处理数据相关的工具函数。

```typescript
// src/helpers/data.ts

import { isPlainObject } from "./util";

export function transformRequest(data: any): any {
  if (isPlainObject(data)) {
    return JSON.stringify(data);
  }
  return data;
}
```

该函数用于转换请求数据，逻辑非常简单：判断如果`data`是普通对象，那么就转换成`JSON`字符串，否则原封不动返回。

然后，我们在发送请求之前调用该函数转换请求数据。

```typescript
// src/core/xhr.ts

import { transformRequest } from "../helpers/data";

export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      url,
      method = "get",
      data = null,
      headers,
      responseType,
      timeout,
    } = config;

    const request = new XMLHttpRequest();

    // 设置响应类型
    if (responseType) {
      request.responseType = responseType;
    }

    // 设置超时时间
    if (timeout) {
      request.timeout = timeout;
    }

    request.open(method.toUpperCase(), url!, true);

    request.onreadystatechange = function handleLoad() {
      if (request.readyState !== 4) {
        return;
      }
      if (request.status === 0) {
        return;
      }

      const responseHeaders = parseHeaders(request.getAllResponseHeaders());
      const responseData =
        responseType && responseType !== "text"
          ? request.response
          : request.responseText;
      const response: AxiosResponse = {
        data: responseData,
        status: request.status,
        statusText: request.statusText,
        headers: responseHeaders,
        config,
        request,
      };
      resolve(response);
    };

    request.onerror = function handleError() {
      reject(new Error("Network Error"));
    };

    request.ontimeout = function handleTimeout() {
      reject(new Error(`Timeout of ${timeout} ms exceeded`));
    };

    // 设置请求头
    Object.keys(headers).forEach((name) => {
      if (data === null && name.toLowerCase() === "content-type") {
        delete headers[name];
      } else {
        request.setRequestHeader(name, headers[name]);
      }
    });

    // 转换请求数据
    let transformData = transformRequest(data);

    request.send(transformData);
  });
}
```

OK，请求数据转换功能就实现了，我们编写`examples/data-transform`目录下的`index.html`文件来测试下。

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>data-transform示例</title>
  </head>
  <body>
    <script src="/__build__/data-transform.js"></script>
  </body>
</html>
```

```typescript
// examples/data-transform/app.ts

import axios from "../../src/index";

axios({
  method: "post",
  url: "/api/data-transform/post",
  data: {
    a: 1,
    b: 2,
  },
});
```

然后，我们通过`npm run dev`启动开发服务器，打开浏览器，访问：`http://localhost:8000/`，然后点击`data-transform`，通过`F12`的`Network`部分我们可以看到发送的请求信息：

![](~@/axios/08/01.png)

从图中可以看到，我们的请求数据已经成功被转换成`JSON`字符串了。

# 4. 响应数据转换

根据需求，我们还要在响应之后将响应数据`data`根据响应头`headers`中的`Content-Type`转换成对应格式。

例如：

- 如果`Content-Type`是`application/json`，那么我们应该把`data`从`JSON`字符串转换成`JSON`对象；
- 如果`Content-Type`是`text/plain`，那么我们原封不动返回；

由于我们之前已经给`responseType`设置了默认值`json`，并且服务器返回的`Content-Type`也是`application/json`，所以这里我们就先实现将`JSON`字符串转换成`JSON`对象。

OK，思路已经有了，下面我们就开始实现。

## 4.1 实现转换逻辑

我们在`src/helpers/data.ts`文件中添加转换响应数据的函数。

```typescript
// src/helpers/data.ts

import { isPlainObject } from "./util";

export function transformRequest(data: any): any {
  if (isPlainObject(data)) {
    return JSON.stringify(data);
  }
  return data;
}

export function transformResponse(data: any): any {
  if (typeof data === "string") {
    try {
      data = JSON.parse(data);
    } catch (e) {
      // do nothing
    }
  }
  return data;
}
```

该函数用于转换响应数据，逻辑也非常简单：判断如果`data`是字符串，那么就尝试把它转换成`JSON`对象，如果转换失败，就原封不动返回，否则返回转换后的`JSON`对象。

然后，我们在获取到响应数据之后调用该函数转换响应数据。

```typescript
// src/core/xhr.ts

import { transformRequest, transformResponse } from "../helpers/data";

export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      url,
      method = "get",
      data = null,
      headers,
      responseType,
      timeout,
    } = config;

    const request = new XMLHttpRequest();

    // 设置响应类型
    if (responseType) {
      request.responseType = responseType;
    }

    // 设置超时时间
    if (timeout) {
      request.timeout = timeout;
    }

    request.open(method.toUpperCase(), url!, true);

    request.onreadystatechange = function handleLoad() {
      if (request.readyState !== 4) {
        return;
      }
      if (request.status === 0) {
        return;
      }

      const responseHeaders = parseHeaders(request.getAllResponseHeaders());
      const responseData =
        responseType && responseType !== "text"
          ? request.response
          : request.responseText;
      const response: AxiosResponse = {
        data: transformResponse(responseData),
        status: request.status,
        statusText: request.statusText,
        headers: responseHeaders,
        config,
        request,
      };
      resolve(response);
    };

    request.onerror = function handleError() {
      reject(new Error("Network Error"));
    };

    request.ontimeout = function handleTimeout() {
      reject(new Error(`Timeout of ${timeout} ms exceeded`));
    };

    // 设置请求头
    Object.keys(headers).forEach((name) => {
      if (data === null && name.toLowerCase() === "content-type") {
        delete headers[name];
      } else {
        request.setRequestHeader(name, headers[name]);
      }
    });

    // 转换请求数据
    let transformData = transformRequest(data);

    request.send(transformData);
  });
}
```

OK，响应数据转换功能就实现了，我们编写`examples/data-transform`目录下的`index.html`文件来测试下。

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>data-transform示例</title>
  </head>
  <body>
    <script src="/__build__/data-transform.js"></script>
  </body>
</html>
```

```typescript
// examples/data-transform/app.ts

import axios from "../../src/index";

axios({
  method: "post",
  url: "/api/data-transform/post",
  data: {
    a: 1,
    b: 2,
  },
}).then((res) => {
  console.log(res);
});
```

然后，我们通过`npm run dev`启动开发服务器，打开浏览器，访问：`http://localhost:8000/`，然后点击`data-transform`，通过`F12`的`Console`部分我们可以看到打印的响应信息：

![](~@/axios/08/02.png)

从图中可以看到，我们的响应数据已经成功被转换成`JSON`对象了。

# 5. 修改默认配置

我们之前已经给`headers`配置了默认值，但是我们把`headers`的默认配置分成了`common`、`get`、`post`等属性，所以我们需要修改默认配置，让默认配置的`headers`对象里的`common`、`get`、`post`等属性分别对应的是每种请求方法下的请求头配置。

```typescript
// src/defaults.ts

const defaults: AxiosRequestConfig = {
  timeout: 0,
  headers: {
    common: {
      Accept: "application/json, text/plain, */*",
    },
  },
};

const methodsNoData = ["delete", "get", "head", "options"];

methodsNoData.forEach((method) => {
  defaults.headers[method] = {};
});

const methodsWithData = ["post", "put", "patch"];

methodsWithData.forEach((method) => {
  defaults.headers[method] = {
    "Content-Type": "application/json;charset=utf-8",
  };
});

export default defaults;
```

这里，我们首先定义了一个`defaults`对象，该对象包含了`timeout`和`headers`两个属性。其中，`headers`属性是一个对象，该对象包含了`common`属性，该属性意味着对于所有类型的请求都要配置该属性。

然后，我们定义了`methodsNoData`数组，该数组包含了不需要携带数据的请求方法，对于这些请求方法，我们给它们的`headers`属性设置为空对象。

最后，我们定义了`methodsWithData`数组，该数组包含了需要携带数据的请求方法，对于这些请求方法，我们给它们的`headers`属性设置`Content-Type`为`application/json;charset=utf-8`。

这样，我们就实现了默认配置的`headers`对象里的`common`、`get`、`post`等属性分别对应的是每种请求方法下的请求头配置。

# 6. 修改合并策略

由于我们修改了默认配置中`headers`的结构，所以之前写的请求头配置合并策略已经不再适用，我们需要重写合并策略。

我们希望的合并策略是：

- 默认配置`headers`对象里的`common`、`get`、`post`等属性分别对应的是每种请求方法下的请求头配置；
- 用户配置的`headers`对象可以配置`common`、`get`、`post`等，也可以配置请求头字段，如：`Content-Type`等；
- 合并后的`headers`对象是一个扁平化的对象，没有`common`、`get`、`post`等属性；

例如，默认配置为：

```javascript
headers: {
  common: {
    Accept: "application/json, text/plain, */*",
  },
  post: {
    "Content-Type":"application/json;charset=utf-8"
  }
}
```

用户配置为：

```javascript
headers: {
  Authorization: "123456",
  post: {
    "Content-Type":"application/x-www-form-urlencoded"
  }
}
```

那么，合并后的`headers`为：

```javascript
headers: {
  Accept: "application/json, text/plain, */*",
  Authorization: "123456",
  "Content-Type":"application/x-www-form-urlencoded"
}
```

所以，我们需要重写`headers`的合并策略，如下：

```typescript
// src/core/mergeConfig.ts

import { isPlainObject, deepMerge } from "../helpers/util";

const strats = Object.create(null);

// 默认合并策略
function defaultStrat(val1: any, val2: any): any {
  return

2025-08-25 12:34:27,946 - evaluation_logger_Hotels-0 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about hotels in Paris for the specified dates and group composition.'}
2025-08-25 12:34:33,806 - evaluation_logger_Hotels-0 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:34:33,806 - evaluation_logger_Hotels-0 - INFO - Message: Success.
2025-08-25 12:34:33,806 - evaluation_logger_Hotels-0 - INFO - Success turn num = 2
2025-08-25 12:34:33,806 - evaluation_logger_Hotels-0 - INFO - ----------------------------------------------------------------------------------------------------
