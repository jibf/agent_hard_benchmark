2025-08-25 12:12:09,885 - evaluation_logger_Cross-273 - INFO - Test Example Cross-273
2025-08-25 12:12:09,885 - evaluation_logger_Cross-273 - INFO - Query: I want to know about fun attractions in the cities near the The Hollywood Roosevelt. Can you provide me with detailed information about these attractions?
2025-08-25 12:12:20,499 - evaluation_logger_Cross-273 - INFO - Function Calls: 
[
    {
        "name": "Location_to_Lat_Long",
        "arguments": {
            "query": "The Hollywood Roosevelt"
        }
    }
]

2025-08-25 12:12:20,499 - evaluation_logger_Cross-273 - INFO - Golden Function Call: 
[
    {
        "name": "Location_to_Lat_Long",
        "arguments": {
            "query": "The Hollywood Roosevelt"
        }
    },
    {
        "name": "Get_Nearby_Cities",
        "arguments": {
            "latitude": "34.1011504",
            "longitude": "-118.3417817"
        }
    }
]

2025-08-25 12:12:20,499 - evaluation_logger_Cross-273 - INFO - Start compare_single_call: 
{'name': 'Location_to_Lat_Long', 'arguments': {'query': 'The Hollywood Roosevelt'}}
{'name': 'Location_to_Lat_Long', 'arguments': {'query': 'The Hollywood Roosevelt'}}
2025-08-25 12:12:20,499 - evaluation_logger_Cross-273 - INFO - Rule-based compare success.
2025-08-25 12:12:20,499 - evaluation_logger_Cross-273 - INFO - Success matched: [{'name': 'Location_to_Lat_Long', 'arguments': {'query': 'The Hollywood Roosevelt'}}]
2025-08-25 12:12:20,499 - evaluation_logger_Cross-273 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "business_status": "OPERATIONAL",
                "formatted_address": "7000 Hollywood Blvd, Los Angeles, CA 90028, United States",
                "geometry": {
                    "location": {
                        "lat": 34.1011504,
                        "lng": -118.3417817
                    },
                    "viewport": {
                        "northeast": {
                            "lat": 34.10253667989272,
                            "lng": -118.3402731201073
                        },
                        "southwest": {
                            "lat": 34.09983702010728,
                            "lng": -118.3429727798927
                        }
                    }
                },
                "name": "The Hollywood Roosevelt",
                "opening_hours": {
                    "open_now": true
                },
                "place_id": "ChIJazD_QyG_woARwKuHsRqY0nU",
                "plus_code": {
                    "compound_code": "4M25+F7 Los Angeles, California",
                    "global_code": "85634M25+F7"
                },
                "rating": 4.4,
                "reference": "ChIJazD_QyG_woARwKuHsRqY0nU",
                "types": [
                    "lodging",
                    "point_of_interest",
                    "establishment"
                ],
                "user_ratings_total": 5232
            }
        ]
    }
]

2025-08-25 12:12:30,118 - evaluation_logger_Cross-273 - INFO - Function Calls: 
[
    {
        "name": "Get_Nearby_Cities",
        "arguments": {
            "latitude": "34.1011504",
            "longitude": "-118.3417817"
        }
    }
]

2025-08-25 12:12:30,118 - evaluation_logger_Cross-273 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Nearby_Cities",
        "arguments": {
            "latitude": "34.1011504",
            "longitude": "-118.3417817"
        }
    },
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Beverly Hills"
        }
    }
]

2025-08-25 12:12:30,118 - evaluation_logger_Cross-273 - INFO - Start compare_single_call: 
{'name': 'Get_Nearby_Cities', 'arguments': {'latitude': '34.1011504', 'longitude': '-118.3417817'}}
{'name': 'Get_Nearby_Cities', 'arguments': {'latitude': '34.1011504', 'longitude': '-118.3417817'}}
2025-08-25 12:12:30,118 - evaluation_logger_Cross-273 - INFO - Rule-based compare success.
2025-08-25 12:12:30,118 - evaluation_logger_Cross-273 - INFO - Success matched: [{'name': 'Get_Nearby_Cities', 'arguments': {'latitude': '34.1011504', 'longitude': '-118.3417817'}}]
2025-08-25 12:12:30,118 - evaluation_logger_Cross-273 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "cc1": "us",
                "dest_id": 20011622,
                "country": "United States",
                "region": "California",
                "latitude": 34.073600769043,
                "nr_hotels": 12,
                "longitude": -118.399002075195,
                "dest_type": "city",
                "name": "Beverly Hills"
            }
        ]
    }
]

2025-08-25 12:12:39,281 - evaluation_logger_Cross-273 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Beverly Hills"
        }
    }
]

2025-08-25 12:12:39,281 - evaluation_logger_Cross-273 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Beverly Hills"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOjIwMDExNjIyfQ=="
        }
    }
]

2025-08-25 12:12:39,282 - evaluation_logger_Cross-273 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Beverly Hills'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Beverly Hills'}}
2025-08-25 12:12:39,282 - evaluation_logger_Cross-273 - INFO - Rule-based compare success.
2025-08-25 12:12:39,282 - evaluation_logger_Cross-273 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Beverly Hills'}}]
2025-08-25 12:12:39,282 - evaluation_logger_Cross-273 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "destinations": [
                {
                    "id": "eyJ1ZmkiOjIwMDExNjIyfQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": 20011622,
                    "country": "United States",
                    "cityName": "Beverly Hills",
                    "productCount": 735,
                    "cc1": "us"
                }
            ]
        }
    }
]

2025-08-25 12:12:48,685 - evaluation_logger_Cross-273 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOjIwMDExNjIyfQ==",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:12:48,685 - evaluation_logger_Cross-273 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOjIwMDExNjIyfQ=="
        }
    }
]

2025-08-25 12:12:49,275 - evaluation_logger_Cross-273 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOjIwMDExNjIyfQ==', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOjIwMDExNjIyfQ=='}}
2025-08-25 12:12:51,814 - evaluation_logger_Cross-273 - INFO - Response-based compare success.
2025-08-25 12:12:51,814 - evaluation_logger_Cross-273 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOjIwMDExNjIyfQ=='}}]
2025-08-25 12:12:51,815 - evaluation_logger_Cross-273 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PRgumD7AGgw6",
                    "name": "Universal Studios Hollywood General Admission Ticket",
                    "slug": "prgumd7aggw6-universal-studios-hollywood-general-admission",
                    "shortDescription": "A one-day ticket providing admission to Universal Studios Hollywood",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 109.05,
                        "currency": "USD",
                        "publicAmount": 109.05
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 8,
                        "percentage": "88%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.4,
                            "total": 395
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Los Angeles",
                        "ufi": 20014181
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI8pkVO05Rr3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINLc2YBzABz"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIO0xe6hsjvq"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIqwCPJm0s1U"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIsgwmp3gOUw"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIqYt6fLR2qw"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PR95VlQVGQx8",
                    "name": "Authentic 3-Hour Hollywood to Beverly Hills Tour",
                    "slug": "pr95vlqvgqx8-authentic-3-hour-hollywood-to-beverly-hills-tour",
                    "shortDescription": "By using our small air conditioned vehicles, we will get you access that other companies only dre...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 49,
                        "currency": "USD",
                        "publicAmount": 49
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 189
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Los Angeles",
                        "ufi": 20014181
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIzQcXfFIuOY"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIPtQ8ycwQF2"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRr5SQc8T4Jw",
                    "name": "Three-hour Sightseeing Tour",
                    "slug": "prr5sqc8t4jw-three-hour-sightseeing-tour",
                    "shortDescription": "Tour exploring legendary landmarks and destinations in Hollywood with a secret stop at the sign",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 51.15,
                        "currency": "USD",
                        "publicAmount": 55
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 43,
                        "percentage": "91%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 596
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Los Angeles",
                        "ufi": 20014181
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIk311Ji9rQx"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINiYN3mYsHV"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OICMNPOtN0sM"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIpIXqQiRuDo"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIT2PnL3Xso6"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItUZg88LyoK"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIwUq7wXqk7L"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIm0uWr2E5av"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKGJn2xcL9O"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIhVhPQTbE7C"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 6
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRZ59CiS6E7B",
                    "name": "Swan Boat Night Ride at Echo Park Lake",
                    "slug": "prz59cis6e7b-swan-boat-night-ride-at-echo-park-lake",
                    "shortDescription": "A one-hour evening boat rental",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 13,
                        "currency": "USD",
                        "publicAmount": 13
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 39,
                        "percentage": "95%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.4,
                            "total": 110
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Los Angeles",
                        "ufi": 20014181
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIIqrx3r7OX8"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIBKGwf9EjuC"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 4
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForTours",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRQwLWelvIGf",
                    "name": "Hollywood Sightseeing and Celebrity Homes Tour",
                    "slug": "prqwlwelvigf-hollywood-sightseeing-and-celebrity-homes-tour",
                    "shortDescription": "A guided tour exploring landmarks and filming locations, with a drive through a celebrity neighbourhood",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 39,
                        "currency": "USD",
                        "publicAmount": 39
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 18,
                        "percentage": "94%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 136
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Los Angeles",
                        "ufi": 20014181
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI9A2Yw2Zyh1"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OImrzzu0EgQW"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIxKNaZFVPVZ"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 5
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 735,
                "filteredProductCount": 735
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Best reviewed",
                    "value": "highest_weighted_rating"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 167
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 99
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 80
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums, arts & culture",
                        "tagname": "museums-arts-culture",
                        "productCount": 75
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Food & drinks",
                        "tagname": "food-drinks",
                        "productCount": 18
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 666
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Los Angeles",
                        "tagname": "20014181",
                        "productCount": 542
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Buena Park",
                        "tagname": "20011850",
                        "productCount": 69
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Santa Monica",
                        "tagname": "20015803",
                        "productCount": 69
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Long Beach",
                        "tagname": "20014160",
                        "productCount": 36
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Malibu",
                        "tagname": "20014259",
                        "productCount": 15
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 105
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 106
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 103
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 93
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 341
                    }
                ]
            }
        }
    }
]

2025-08-25 12:15:19,477 - evaluation_logger_Cross-273 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 前言

在上一篇文章中，我们实现了`axios`的请求和响应配置化，即用户可以配置`config`对象中的`url`、`method`、`params`、`data`、`headers`、`timeout`、`responseType`等属性。其中，`headers`配置对象中的`Content-Type`属性是告诉服务器我们发送过去的数据是什么格式的，而`responseType`属性是告诉服务器我们期望返回的数据是什么格式的。另外，我们还实现了配置的默认值以及配置的合并策略。

但是，在之前的代码中，我们虽然可以配置`data`，但是我们并没有对`data`做任何处理，我们只是把它在请求的时候直接发给了服务器。然而，`data`的类型可能是`string`，也可能是普通对象`object`，甚至是`URLSearchParams`对象、`FormData`对象、`Blob`对象、`ArrayBuffer`对象等等。另外，当我们传入的`data`为普通对象的时候，我们应该把它转换成`JSON`字符串，因为普通对象是无法在网络上传输的，必须转换成字符串才行。所以，我们接下来要做的就是对`data`做一层转换处理。

# 2. 需求分析

根据需求，我们要对请求时候的`data`做如下处理：

- 如果`data`是普通对象`object`，那么需要把它转换成`JSON`字符串，并且将请求头`headers`中的`Content-Type`设为`application/json;charset=utf-8`；
- 如果`data`是`URLSearchParams`对象，那么需要把它转换成字符串，并且将请求头`headers`中的`Content-Type`设为`application/x-www-form-urlencoded;charset=utf-8`；
- 如果`data`是`FormData`对象、`Blob`对象、`ArrayBuffer`对象等等，则不对`data`做任何处理，并且也不设置`headers`中的`Content-Type`，使用浏览器默认的即可；

另外，我们还要考虑到，如果用户已经手动配置了`headers`中的`Content-Type`，那我们就不做任何处理了，直接使用用户配置的即可。

# 3. 实现 transformRequest 函数

根据需求分析，我们需要在发送请求之前对`data`做一层转换处理，并且还要根据转换后的`data`类型来设置请求头`headers`中的`Content-Type`。所以，我们定义一个`transformRequest`函数来处理这件事情。

我们在`src`目录下创建`helpers`文件夹，并在该文件夹下创建`data.ts`文件：

```typescript
// src/helpers/data.ts
import { isPlainObject } from "./util";

export function transformRequest(data: any): any {
  if (isPlainObject(data)) {
    return JSON.stringify(data);
  }
  return data;
}
```

该函数接收一个`data`参数，该参数就是用户配置的`data`，我们首先判断该`data`是否为普通对象，如果是，则将其转换成`JSON`字符串并返回；如果不是，则原封不动的返回。

另外，我们还需要一个工具函数`isPlainObject`来判断一个值是否为普通对象，我们在`src/helpers`目录下创建`util.ts`文件：

```typescript
// src/helpers/util.ts

const toString = Object.prototype.toString;

export function isPlainObject(val: any): val is Object {
  return toString.call(val) === "[object Object]";
}
```

# 4. 修改之前的逻辑

我们定义了`transformRequest`函数，接下来就要在发送请求之前调用该函数对`data`进行转换。

在`src/xhr.ts`文件中，我们在发送请求之前调用`transformRequest`函数：

```typescript
// src/xhr.ts
import { transformRequest } from "./helpers/data";

export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      data = null,
      url,
      method = "get",
      headers,
      responseType,
      timeout,
    } = config;

    const request = new XMLHttpRequest();

    // 设置返回数据类型
    if (responseType) {
      request.responseType = responseType;
    }

    // 设置超时时间
    if (timeout) {
      request.timeout = timeout;
    }

    request.open(method.toUpperCase(), url, true);

    // 监听请求状态变化
    request.onreadystatechange = function handleLoad() {
      if (request.readyState !== 4) {
        return;
      }
      if (request.status === 0) {
        return;
      }
      const responseHeaders = request.getAllResponseHeaders();
      const responseData =
        responseType && responseType !== "text"
          ? request.response
          : request.responseText;
      const response: AxiosResponse = {
        data: responseData,
        status: request.status,
        statusText: request.statusText,
        headers: responseHeaders,
        config,
        request,
      };
      handleResponse(response);
    };

    // 处理网络错误
    request.onerror = function handleError() {
      reject(new Error("Network Error"));
    };

    // 处理超时错误
    request.ontimeout = function handleTimeout() {
      reject(new Error(`Timeout of ${timeout} ms exceeded`));
    };

    // 处理请求头
    Object.keys(headers).forEach((name) => {
      if (data === null && name.toLowerCase() === "content-type") {
        delete headers[name];
      } else {
        request.setRequestHeader(name, headers[name]);
      }
    });

    // 发送请求
    request.send(transformRequest(data));
  });
}
```

我们只需在发送请求的时候将`data`用`transformRequest`函数转换一下即可。

另外，我们还要根据转换后的`data`类型来设置请求头`headers`中的`Content-Type`，但是注意：如果用户已经手动配置了`headers`中的`Content-Type`，那我们就不做任何处理了，直接使用用户配置的即可。

所以，我们还需要一个处理请求头的函数，我们暂且叫它`processHeaders`，该函数的作用就是根据`data`的类型来设置`Content-Type`，如果用户已经配置了，那就不设置。

我们在`src/helpers`目录下创建`headers.ts`文件：

```typescript
// src/helpers/headers.ts
import { isPlainObject } from "./util";

export function processHeaders(headers: any, data: any): any {
  if (isPlainObject(data)) {
    if (headers && !headers["Content-Type"]) {
      headers["Content-Type"] = "application/json;charset=utf-8";
    }
  }
  return headers;
}
```

该函数接收两个参数：`headers`和`data`。首先判断`data`是否为普通对象，如果是，并且`headers`存在并且`headers`中没有`Content-Type`属性，那么我们就给`headers`设置`Content-Type`属性为`application/json;charset=utf-8`，最后返回`headers`。

然后，我们在`src/xhr.ts`文件中引入该函数，并在设置请求头之前调用：

```typescript
// src/xhr.ts
import { transformRequest } from "./helpers/data";
import { processHeaders } from "./helpers/headers";

export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      data = null,
      url,
      method = "get",
      headers,
      responseType,
      timeout,
    } = config;

    const request = new XMLHttpRequest();

    // 设置返回数据类型
    if (responseType) {
      request.responseType = responseType;
    }

    // 设置超时时间
    if (timeout) {
      request.timeout = timeout;
    }

    request.open(method.toUpperCase(), url, true);

    // 监听请求状态变化
    request.onreadystatechange = function handleLoad() {
      if (request.readyState !== 4) {
        return;
      }
      if (request.status === 0) {
        return;
      }
      const responseHeaders = request.getAllResponseHeaders();
      const responseData =
        responseType && responseType !== "text"
          ? request.response
          : request.responseText;
      const response: AxiosResponse = {
        data: responseData,
        status: request.status,
        statusText: request.statusText,
        headers: responseHeaders,
        config,
        request,
      };
      handleResponse(response);
    };

    // 处理网络错误
    request.onerror = function handleError() {
      reject(new Error("Network Error"));
    };

    // 处理超时错误
    request.ontimeout = function handleTimeout() {
      reject(new Error(`Timeout of ${timeout} ms exceeded`));
    };

    // 处理请求头
    const processedHeaders = processHeaders(headers, data);
    Object.keys(processedHeaders).forEach((name) => {
      if (data === null && name.toLowerCase() === "content-type") {
        delete processedHeaders[name];
      } else {
        request.setRequestHeader(name, processedHeaders[name]);
      }
    });

    // 发送请求
    request.send(transformRequest(data));
  });
}
```

OK，这样我们就实现了对请求`data`的转换处理。

# 5. 编写 demo

接下来，我们编写 `demo` 来测试下我们刚刚实现的功能。

在 `examples` 目录下创建 `transformData`目录，并在该目录下创建 `index.html`:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>transformData demo</title>
  </head>
  <body>
    <script src="/__build__/transformData.js"></script>
  </body>
</html>
```

接着再创建 `app.ts` 作为入口文件：

```typescript
import axios from "../../src/index";

// 发送普通对象
axios({
  method: "post",
  url: "/api/transformData/post",
  data: {
    a: 1,
    b: 2,
  },
});

// 发送 URLSearchParams 对象
const paramsString = "q=URLUtils.searchParams&topic=api";
const searchParams = new URLSearchParams(paramsString);

axios({
  method: "post",
  url: "/api/transformData/post",
  data: searchParams,
});
```

接着在 `server.js` 添加新的接口路由：

```javascript
// 添加transformData接口
router.post("/api/transformData/post", function(req, res) {
  res.json(req.body);
});
```

最后在根目录下的 `index.html` 中加上启动该 `demo` 的入口：

```html
<li><a href="examples/transformData">transformData</a></li>
```

OK, 我们在命令行中执行：

```bash
# 同时开启客户端和服务端
npm run server | npm start
```

接着我们打开 `chrome` 浏览器，访问 <http://localhost:8000/> 即可访问我们的 `demo` 了，我们点击 `transformData`，通过`F12`的 `network` 部分我们可以看到发送了两个请求，第一个请求的 `Request Headers` 里设置了 `Content-Type: application/json;charset=utf-8`，并且 `Request Payload` 是一个 JSON 字符串 `{"a":1,"b":2}`；第二个请求的 `Request Headers` 里没有设置 `Content-Type` 属性，使用浏览器默认的，并且 `Request Payload` 是 `q=URLUtils.searchParams&topic=api`。

![](~@/axios/07/01.png)

![](~@/axios/07/02.png)

OK，这样我们就实现了对请求`data`的转换处理。

# 6. 遗留问题

虽然我们已经实现了对请求`data`的转换处理，但是目前我们只处理了普通对象和`URLSearchParams`对象，并没有处理`FormData`对象、`Blob`对象、`ArrayBuffer`对象等等，这是因为这些对象在浏览器中可以直接发送，不需要做任何处理，所以我们暂时先不处理。

另外，我们还需要处理响应`data`，因为服务器返回给我们的`data`可能是`JSON`字符串，我们需要把它转换成`JavaScript`对象，这样用户拿到的就是转换之后的对象了。关于响应`data`的转换处理，我们会在下一篇文章中介绍。

# 7. 总结

本篇文章中，我们实现了对请求`data`的转换处理，主要做了以下三件事情：

- 定义了`transformRequest`函数，用于将请求的`data`进行转换；
- 定义了`processHeaders`函数，用于根据转换后的`data`类型来设置请求头`headers`中的`Content-Type`；
- 在发送请求之前调用这两个函数对`data`和`headers`进行处理。

最后，我们编写了`demo`，测试了我们的功能，结果符合我们的预期。


2025-08-25 12:15:24,773 - evaluation_logger_Cross-273 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about fun attractions near The Hollywood Roosevelt.'}
2025-08-25 12:15:31,050 - evaluation_logger_Cross-273 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:15:31,050 - evaluation_logger_Cross-273 - INFO - Message: Success.
2025-08-25 12:15:31,050 - evaluation_logger_Cross-273 - INFO - Success turn num = 4
2025-08-25 12:15:31,050 - evaluation_logger_Cross-273 - INFO - ----------------------------------------------------------------------------------------------------
