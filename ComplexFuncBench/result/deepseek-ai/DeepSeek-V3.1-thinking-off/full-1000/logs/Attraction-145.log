2025-08-25 13:14:02,908 - evaluation_logger_Attraction-145 - INFO - Test Example Attraction-145
2025-08-25 13:14:02,909 - evaluation_logger_Attraction-145 - INFO - Query: I am in Spain and interested in beach activities. Check for beach activities in Barcelona with available tickets after 10 AM on November 23, 2024. If not, check Ibiza for tickets after 10 AM on November 27. I'd like to know the detailed activity information.
2025-08-25 13:14:10,591 - evaluation_logger_Attraction-145 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Barcelona beach activities"
        }
    }
]

2025-08-25 13:14:10,591 - evaluation_logger_Attraction-145 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Beach, Barcelona"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "pra2bgifqjci-padi-course-and-diving-in-levante-beach-barcelona",
            "date": "2024-11-23"
        }
    }
]

2025-08-25 13:14:11,269 - evaluation_logger_Attraction-145 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Barcelona beach activities'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Beach, Barcelona'}}
2025-08-25 13:14:20,282 - evaluation_logger_Attraction-145 - DEBUG - LLM-based comparison output: {'is_equal': True, 'reason': "The queries 'Barcelona beach activities' and 'Beach, Barcelona' both aim to find beach-related attractions in Barcelona. The order and phrasing of the query terms differ, but the meaning and intent are the same, making the function calls equivalent."}
2025-08-25 13:14:20,282 - evaluation_logger_Attraction-145 - INFO - LLM-based compare success.
2025-08-25 13:14:20,282 - evaluation_logger_Attraction-145 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Beach, Barcelona'}}]
2025-08-25 13:14:20,282 - evaluation_logger_Attraction-145 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJBMkJHSWZxSmNJIiwidWZpIjotMzcyNDkwfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "PADI Course and Diving in Levante Beach, Barcelona",
                    "productId": "PRA2BGIfqJcI",
                    "productSlug": "pra2bgifqjci-padi-course-and-diving-in-levante-beach-barcelona",
                    "taxonomySlug": "activities",
                    "cityUfi": -372490,
                    "cityName": "Barcelona",
                    "countryCode": "es"
                }
            ]
        }
    }
]

2025-08-25 13:14:30,006 - evaluation_logger_Attraction-145 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "pra2bgifqjci-padi-course-and-diving-in-levante-beach-barcelona",
            "date": "2024-11-23"
        }
    }
]

2025-08-25 13:14:30,006 - evaluation_logger_Attraction-145 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-11-23",
            "slug": "pra2bgifqjci-padi-course-and-diving-in-levante-beach-barcelona"
        }
    },
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Beach, Ibiza"
        }
    }
]

2025-08-25 13:14:30,006 - evaluation_logger_Attraction-145 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-23', 'slug': 'pra2bgifqjci-padi-course-and-diving-in-levante-beach-barcelona'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-23', 'slug': 'pra2bgifqjci-padi-course-and-diving-in-levante-beach-barcelona'}}
2025-08-25 13:14:30,006 - evaluation_logger_Attraction-145 - INFO - Rule-based compare success.
2025-08-25 13:14:30,006 - evaluation_logger_Attraction-145 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-11-23', 'slug': 'pra2bgifqjci-padi-course-and-diving-in-levante-beach-barcelona'}}]
2025-08-25 13:14:30,007 - evaluation_logger_Attraction-145 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-11-23T09:00:00+01:00",
                "timeSlotId": "ATS-PRA2BGIfqJcI-202411230900-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Spanish - Tour guide",
                                "language": "es",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Italian - Tour guide",
                                "language": "it",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFAx1PvPIUik",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 12-60)"
                                },
                                "id": "ATO-f1a567ed-aa75-4671-afd9-7f3283cb10f4_PRA2BGIfqJcI_20241123_0900",
                                "offerItemId": "OIM7EEQssUvp",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 290,
                                    "currency": "EUR",
                                    "publicAmount": 290
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 312.48,
                                    "currency": "USD",
                                    "publicAmount": 312.48
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "it",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 12-60)"
                                },
                                "id": "ATO-37250e1e-d3cd-4dbe-a530-20a08746f2d2_PRA2BGIfqJcI_20241123_0900",
                                "offerItemId": "OIM7EEQssUvp",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 290,
                                    "currency": "EUR",
                                    "publicAmount": 290
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 312.48,
                                    "currency": "USD",
                                    "publicAmount": 312.48
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 12-60)"
                                },
                                "id": "ATO-b4fa56d2-987b-4ba6-9b5e-6492aa3b6aea_PRA2BGIfqJcI_20241123_0900",
                                "offerItemId": "OIM7EEQssUvp",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 290,
                                    "currency": "EUR",
                                    "publicAmount": 290
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 312.48,
                                    "currency": "USD",
                                    "publicAmount": 312.48
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 6,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "PADI Course and Diving in Levante Beach, Barcelona",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 6,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:14:38,560 - evaluation_logger_Attraction-145 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Ibiza beach activities"
        }
    }
]

2025-08-25 13:14:38,560 - evaluation_logger_Attraction-145 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Beach, Ibiza"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "przee9yuu97a-safari-beach-tour-ibiza",
            "date": "2024-11-27"
        }
    }
]

2025-08-25 13:14:39,193 - evaluation_logger_Attraction-145 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Ibiza beach activities'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Beach, Ibiza'}}
2025-08-25 13:14:47,848 - evaluation_logger_Attraction-145 - DEBUG - LLM-based comparison output: {'is_equal': True, 'reason': "The queries 'Ibiza beach activities' and 'Beach, Ibiza' both refer to searching for beach-related activities in Ibiza. The order and phrasing of the words differ, but the meaning and intent of the search are the same, making the function calls equivalent."}
2025-08-25 13:14:47,848 - evaluation_logger_Attraction-145 - INFO - LLM-based compare success.
2025-08-25 13:14:47,848 - evaluation_logger_Attraction-145 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Beach, Ibiza'}}]
2025-08-25 13:14:47,848 - evaluation_logger_Attraction-145 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJaRUU5WXV1OTdBIiwidWZpIjotMzg1NzIyfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Safari Beach Tour Ibiza",
                    "productId": "PRZEE9Yuu97A",
                    "productSlug": "przee9yuu97a-safari-beach-tour-ibiza",
                    "taxonomySlug": "tours",
                    "cityUfi": -385722,
                    "cityName": "Ibiza Town",
                    "countryCode": "es"
                }
            ]
        }
    }
]

2025-08-25 13:14:57,438 - evaluation_logger_Attraction-145 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "przee9yuu97a-safari-beach-tour-ibiza",
            "date": "2024-11-27"
        }
    }
]

2025-08-25 13:14:57,438 - evaluation_logger_Attraction-145 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-11-27",
            "slug": "przee9yuu97a-safari-beach-tour-ibiza"
        }
    }
]

2025-08-25 13:14:57,438 - evaluation_logger_Attraction-145 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-27', 'slug': 'przee9yuu97a-safari-beach-tour-ibiza'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-27', 'slug': 'przee9yuu97a-safari-beach-tour-ibiza'}}
2025-08-25 13:14:57,438 - evaluation_logger_Attraction-145 - INFO - Rule-based compare success.
2025-08-25 13:14:57,438 - evaluation_logger_Attraction-145 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-11-27', 'slug': 'przee9yuu97a-safari-beach-tour-ibiza'}}]
2025-08-25 13:14:57,438 - evaluation_logger_Attraction-145 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-11-27T11:00:00+01:00",
                "timeSlotId": "ATS-PRZEE9Yuu97A-202411271100-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Spanish - Tour guide",
                                "language": "es",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "description": "Land Rover Defender\r\nPickup included",
                        "id": "OFxpNB3z9tTj",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 11-99)"
                                },
                                "id": "ATO-9bba4285-9a94-4c4f-a39f-54ebfa9b90ce_PRZEE9Yuu97A_20241127_1100",
                                "offerItemId": "OICMmH9WT4wU",
                                "type": "adult",
                                "tieredPricing": true,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 180,
                                    "currency": "EUR",
                                    "publicAmount": 180
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 193.95,
                                    "currency": "USD",
                                    "publicAmount": 193.95
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 4,
                                "minPerReservation": 4,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 11-99)"
                                },
                                "id": "ATO-1386a34c-2312-4b4e-8f7b-c11caaa2c892_PRZEE9Yuu97A_20241127_1100",
                                "offerItemId": "OICMmH9WT4wU",
                                "type": "adult",
                                "tieredPricing": true,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 180,
                                    "currency": "EUR",
                                    "publicAmount": 180
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 193.95,
                                    "currency": "USD",
                                    "publicAmount": 193.95
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 8,
                                "minPerReservation": 5,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 11-99)"
                                },
                                "id": "ATO-5bc34255-1c7b-4d52-bb64-7b5f2bdf464f_PRZEE9Yuu97A_20241127_1100",
                                "offerItemId": "OICMmH9WT4wU",
                                "type": "adult",
                                "tieredPricing": true,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 180,
                                    "currency": "EUR",
                                    "publicAmount": 180
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 193.95,
                                    "currency": "USD",
                                    "publicAmount": 193.95
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 4,
                                "minPerReservation": 4,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 11-99)"
                                },
                                "id": "ATO-8ca6488e-f7c9-4fd7-a53e-7594674b8573_PRZEE9Yuu97A_20241127_1100",
                                "offerItemId": "OICMmH9WT4wU",
                                "type": "adult",
                                "tieredPricing": true,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 180,
                                    "currency": "EUR",
                                    "publicAmount": 180
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 193.95,
                                    "currency": "USD",
                                    "publicAmount": 193.95
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 8,
                                "minPerReservation": 5,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 1-10)"
                                },
                                "id": "ATO-7346159b-94f3-42f3-86b9-044c275fe942_PRZEE9Yuu97A_20241127_1100",
                                "offerItemId": "OIwGZuZdsDDL",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 0,
                                    "currency": "EUR",
                                    "publicAmount": 0
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 0,
                                    "currency": "USD",
                                    "publicAmount": 0
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 8,
                                "minPerReservation": 1,
                                "label": "Child"
                            }
                        ],
                        "label": "Safari Beach Tours Ibiza",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": true,
                            "maxOfferItemsPerReservation": 8,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:17:36,851 - evaluation_logger_Attraction-145 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring Boot 源码分析 —— SpringApplication》](http://svip.iocoder.cn/Spring-Boot/SpringApplication/) 的**初始化**的源码解析。

在 SpringApplication 实例初始化的过程中，会进行**初始化阶段**。而初始化阶段，主要会做如下几件事情：

1. 设置 `primarySources` 属性
2. 设置 `webApplicationType` 属性
3. 设置 `initializers` 属性
4. 设置 `listeners` 属性
5. 设置 `mainApplicationClass` 属性

# 2. 构造方法

SpringApplication 有**三个**构造方法，分别是：

- `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)`
- `#SpringApplication(Class<?>... primarySources)`
- `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 的**私有**构造方法

## 2.1 SpringApplication

`#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 方法，代码如下：

```java
// SpringApplication.java

public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    // <1> 推断 Web 应用类型
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
    // <2> 设置应用上下文初始化器
    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
    // <3> 设置监听器
    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    // <4> 推断应用方法类
    this.mainApplicationClass = deduceMainApplicationClass();
}
```

- `<1>` 处，调用 `WebApplicationType#deduceFromClasspath()` 方法，推断 Web 应用类型。详细解析，见 [「3. WebApplicationType」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<2>` 处，设置应用上下文初始化器（ApplicationContextInitializer）。详细解析，见 [「4. ApplicationContextInitializer」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<3>` 处，设置监听器（ApplicationListener）。详细解析，见 [「5. ApplicationListener」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。
- `<4>` 处，调用 `#deduceMainApplicationClass()` 方法，推断应用方法类。详细解析，见 [「6. mainApplicationClass」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

## 2.2 SpringApplication

`#SpringApplication(Class<?>... primarySources)` 方法，代码如下：

```java
// SpringApplication.java

public SpringApplication(Class<?>... primarySources) {
    this(null, primarySources);
}
```

- 内部调用 `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 方法。

## 2.3 SpringApplication

`#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 的**私有**构造方法，代码如下：

```java
// SpringApplication.java

private SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
}
```

- 该方法，仅仅设置了 `resourceLoader`、`primarySources`、`webApplicationType` 属性。而 `initializers`、`listeners`、`mainApplicationClass` 属性，并未设置。

那么问题就来了，SpringApplication 什么时候会使用这个构造方法呢？答案在 `SpringApplicationBuilder#run(String... args)` 方法中，代码如下：

```java
// SpringApplicationBuilder.java

public ConfigurableApplicationContext run(String... args) {
    // ... 省略其它代码
    SpringApplication application = new SpringApplication(this.applicationContextClass);
    // ... 省略其它代码
    return application.run(args);
}
```

- 关于 SpringApplicationBuilder 类，我们后续文章，详细解析。

# 3. WebApplicationType

`org.springframework.boot.WebApplicationType` ，Spring Boot Web 应用类型**枚举**。代码如下：

```java
// WebApplicationType.java

public enum WebApplicationType {

    /**
     * 非 Web 项目
     */
    NONE,
    /**
     * Servlet Web 项目
     */
    SERVLET,
    /**
     * Reactive Web 项目
     */
    REACTIVE;

}
```

## 3.1 deduceFromClasspath

`#deduceFromClasspath()` **静态**方法，通过 classpath ，推断 Web 应用类型。代码如下：

```java
// WebApplicationType.java

private static final String[] SERVLET_INDICATOR_CLASSES = { "javax.servlet.Servlet",
        "org.springframework.web.context.ConfigurableWebApplicationContext" };

private static final String WEBMVC_INDICATOR_CLASS = "org.springframework.web.servlet.DispatcherServlet";

private static final String WEBFLUX_INDICATOR_CLASS = "org.springframework.web.reactive.DispatcherHandler";

private static final String JERSEY_INDICATOR_CLASS = "org.glassfish.jersey.servlet.ServletContainer";

private static final String SERVLET_APPLICATION_CONTEXT_CLASS = "org.springframework.web.context.WebApplicationContext";

private static final String REACTIVE_APPLICATION_CONTEXT_CLASS = "org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext";

static WebApplicationType deduceFromClasspath() {
    // REACTIVE 相关的类存在
    if (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null) && !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null)
            && !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) {
        return WebApplicationType.REACTIVE;
    }
    // SERVLET 相关的类不存在
    for (String className : SERVLET_INDICATOR_CLASSES) {
        if (!ClassUtils.isPresent(className, null)) {
            return WebApplicationType.NONE;
        }
    }
    // 默认，返回 SERVLET
    return WebApplicationType.SERVLET;
}
```

- 根据 classpath 中，是否存在对应的类，进行判断。
- 默认情况下，返回的是 `WebApplicationType.SERVLET` 。

# 4. ApplicationContextInitializer

`org.springframework.context.ApplicationContextInitializer` ，应用上下文初始化器接口。代码如下：

```java
// ApplicationContextInitializer.java

@FunctionalInterface
public interface ApplicationContextInitializer<C extends ConfigurableApplicationContext> {

    /**
     * Initialize the given application context.
     * @param applicationContext the application to initialize
     */
    void initialize(C applicationContext);

}
```

- 目的是，允许我们对 ConfigurableApplicationContext 进行**自定义初始化**。例如，注册一些 PropertySource 等等。

## 4.1 getSpringFactoriesInstances

在 `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 方法中，会调用 `#getSpringFactoriesInstances(Class<T> type)` 方法，获得指定类型对应的、在 `META-INF/spring.factories` 里的类名的数组。代码如下：

```java
// SpringApplication.java

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type) {
    return getSpringFactoriesInstances(type, new Class<?>[] {});
}

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, Object... args) {
    ClassLoader classLoader = getClassLoader();
    // Use names and ensure unique to protect against duplicates
    // <1> 加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组
    Set<String> names = new LinkedHashSet<>(SpringFactoriesLoader.loadFactoryNames(type, classLoader));
    // <2> 创建对象
    List<T> instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);
    // <3> 排序
    AnnotationAwareOrderComparator.sort(instances);
    return instances;
}
```

- `<1>` 处，调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组。
- `<2>` 处，调用 `#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象数组。
- `<3>` 处，调用 `AnnotationAwareOrderComparator#sort(List<?> list)` 方法，排序对象数组。

### 4.1.1 loadFactoryNames

`SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组。代码如下：

```java
// SpringFactoriesLoader.java

public static final String FACTORIES_RESOURCE_LOCATION = "META-INF/spring.factories";

public static List<String> loadFactoryNames(Class<?> factoryClass, @Nullable ClassLoader classLoader) {
    String factoryClassName = factoryClass.getName();
    // 加载
    return loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());
}

private static Map<String, List<String>> loadSpringFactories(@Nullable ClassLoader classLoader) {
    MultiValueMap<String, String> result = cache.get(classLoader);
    if (result != null) {
        return result;
    }

    try {
        // 加载 FACTORIES_RESOURCE_LOCATION
        Enumeration<URL> urls = (classLoader != null ?
                classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :
                ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));
        result = new LinkedMultiValueMap<>();
        while (urls.hasMoreElements()) {
            URL url = urls.nextElement();
            UrlResource resource = new UrlResource(url);
            // 解析，并添加到 result 中
            Properties properties = PropertiesLoaderUtils.loadProperties(resource);
            for (Map.Entry<?, ?> entry : properties.entrySet()) {
                String factoryClassName = ((String) entry.getKey()).trim();
                for (String factoryName : StringUtils.commaDelimitedListToStringArray((String) entry.getValue())) {
                    result.add(factoryClassName, factoryName.trim());
                }
            }
        }
        cache.put(classLoader, result);
        return result;
    } catch (IOException ex) {
        throw new IllegalArgumentException("Unable to load factories from location [" +
                FACTORIES_RESOURCE_LOCATION + "]", ex);
    }
}
```

- 比较简单，胖友自己瞅瞅。

### 4.1.2 createSpringFactoriesInstances

`#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象数组。代码如下：

```java
// SpringApplication.java

private <T> List<T> createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes,
        ClassLoader classLoader, Object[] args, Set<String> names) {
    List<T> instances = new ArrayList<>(names.size());
    for (String name : names) {
        try {
            Class<?> instanceClass = ClassUtils.forName(name, classLoader);
            Assert.isAssignable(type, instanceClass);
            Constructor<?> constructor = instanceClass.getDeclaredConstructor(parameterTypes);
            T instance = (T) BeanUtils.instantiateClass(constructor, args);
            instances.add(instance);
        } catch (Throwable ex) {
            throw new IllegalArgumentException("Cannot instantiate " + type + " : " + name, ex);
        }
    }
    return instances;
}
```

- 通过**反射**，创建对象。

## 4.2 setInitializers

在 `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 方法中，会调用 `#setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers)` 方法，设置 `initializers` 属性。代码如下：

```java
// SpringApplication.java

/**
 * 应用上下文初始化器集合
 */
private List<ApplicationContextInitializer<?>> initializers;

public void setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers) {
    this.initializers = new ArrayList<>(initializers);
}
```

# 5. ApplicationListener

`org.springframework.context.ApplicationListener` ，Spring 事件监听器接口。代码如下：

```java
// ApplicationListener.java

@FunctionalInterface
public interface ApplicationListener<E extends ApplicationEvent> extends EventListener {

    /**
     * Handle an application event.
     * @param event the event to respond to
     */
    void onApplicationEvent(E event);

}
```

- 目的是，监听 Spring 事件。例如，Spring 内置的 ApplicationStartedEvent、ApplicationEnvironmentPreparedEvent 等等。

## 5.1 getSpringFactoriesInstances

在 `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 方法中，会调用 `#getSpringFactoriesInstances(Class<T> type)` 方法，获得 ApplicationListener 类型的对象数组。具体的逻辑，和 [「4.1 getSpringFactoriesInstances」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 是一样的。

## 5.2 setListeners

在 `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 方法中，会调用 `#setListeners(Collection<? extends ApplicationListener<?>> listeners)` 方法，设置 `listeners` 属性。代码如下：

```java
// SpringApplication.java

/**
 * 应用事件监听器集合
 */
private List<ApplicationListener<?>> listeners;

public void setListeners(Collection<? extends ApplicationListener<?>> listeners) {
    this.listeners = new ArrayList<>(listeners);
}
```

# 6. mainApplicationClass

在 `#SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources)` 方法中，会调用 `#deduceMainApplicationClass()` 方法，推断应用方法类。代码如下：

```java
// SpringApplication.java

private Class<?> deduceMainApplicationClass() {
    try {
        // 获得当前 StackTraceElement 数组
        StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();
        // 遍历，判断哪个执行 main 方法
        for (StackTraceElement stackTraceElement : stackTrace) {
            if ("main".equals(stackTraceElement.getMethodName())) {
                return Class.forName(stackTraceElement.getClassName());
            }
        }
    } catch (ClassNotFoundException ex) {
        // Swallow and continue
    }
    return null;
}
```

- 通过异常的方式，获取当前 StackTraceElement 数组，然后遍历，判断哪个执行 `#main(String[] args)` 方法，从而获得对应的类。

# 7. 小结

至此，SpringApplication 的初始化完成。后续，我们开始看看 `#run(String... args)` 方法的执行流程。

2025-08-25 13:17:41,535 - evaluation_logger_Attraction-145 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about beach activities in Barcelona or Ibiza.'}
2025-08-25 13:17:47,780 - evaluation_logger_Attraction-145 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:17:47,781 - evaluation_logger_Attraction-145 - INFO - Message: Success.
2025-08-25 13:17:47,781 - evaluation_logger_Attraction-145 - INFO - Success turn num = 4
2025-08-25 13:17:47,781 - evaluation_logger_Attraction-145 - INFO - ----------------------------------------------------------------------------------------------------
