2025-08-25 13:06:00,391 - evaluation_logger_Attraction-88 - INFO - Test Example Attraction-88
2025-08-25 13:06:00,391 - evaluation_logger_Attraction-88 - INFO - Query: Check the ticket availability for the top-rated tourist attraction in Oslo on December 1, 2024, and provide detailed information about it.
2025-08-25 13:06:10,449 - evaluation_logger_Attraction-88 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Oslo"
        }
    }
]

2025-08-25 13:06:10,450 - evaluation_logger_Attraction-88 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Oslo"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNzM4Mzd9",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 13:06:10,450 - evaluation_logger_Attraction-88 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Oslo'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Oslo'}}
2025-08-25 13:06:10,450 - evaluation_logger_Attraction-88 - INFO - Rule-based compare success.
2025-08-25 13:06:10,450 - evaluation_logger_Attraction-88 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Oslo'}}]
2025-08-25 13:06:10,450 - evaluation_logger_Attraction-88 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJ1VkdGa1E4eUttIiwidWZpIjotMjczODM3fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "2 Hour Sea Kayak Tour on Oslofjord from Central Oslo",
                    "productId": "PRuVGFkQ8yKm",
                    "productSlug": "pruvgfkq8ykm-2-hour-sea-kayak-tour-on-oslofjord-from-central-oslo",
                    "taxonomySlug": "tours",
                    "cityUfi": -273837,
                    "cityName": "Oslo",
                    "countryCode": "no"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJlcGpvdldrS0IwIiwidWZpIjotMjczODM3fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Oslo Airport Transfers : Oslo Airport OSL to Oslo City in Business Car",
                    "productId": "PRepjovWkKB0",
                    "productSlug": "prepjovwkkb0-oslo-airport-transfers-oslo-airport-osl-to-oslo-city-in-business-ca",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -273837,
                    "cityName": "Oslo",
                    "countryCode": "no"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJYbDBHQjZGa0V5IiwidWZpIjotMjczODM3fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Oslo Airport Transfers : Oslo Airport OSL to Oslo City in Business Van",
                    "productId": "PRXl0GB6FkEy",
                    "productSlug": "prxl0gb6fkey-oslo-airport-transfers-oslo-airport-osl-to-oslo-city-in-business-va",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -273837,
                    "cityName": "Oslo",
                    "countryCode": "no"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFIyQ1VUUElFUmE2IiwidWZpIjotMjczODM3fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Oslo City Walks - In the Heart of Oslo",
                    "productId": "PR2CUTPIERa6",
                    "productSlug": "pr2cutpiera6-oslo-city-walks-in-the-heart-of-oslo",
                    "taxonomySlug": "tours",
                    "cityUfi": -273837,
                    "cityName": "Oslo",
                    "countryCode": "no"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJUeHVUaDN1MllrIiwidWZpIjotMjczODM3fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Oslo Airport Transfers : Oslo City to Oslo Airport OSL in Business Van",
                    "productId": "PRTxuTh3u2Yk",
                    "productSlug": "prtxuth3u2yk-oslo-airport-transfers-oslo-city-to-oslo-airport-osl-in-business-va",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -273837,
                    "cityName": "Oslo",
                    "countryCode": "no"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0yNzM4Mzd9",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -273837,
                    "country": "Norway",
                    "cityName": "Oslo",
                    "productCount": 167,
                    "cc1": "no"
                },
                {
                    "id": "eyJ1ZmkiOi0yNjAxODg5fQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -2601889,
                    "country": "United Kingdom",
                    "cityName": "London",
                    "productCount": 2898,
                    "cc1": "gb"
                }
            ]
        }
    }
]

2025-08-25 13:06:20,905 - evaluation_logger_Attraction-88 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNzM4Mzd9",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 13:06:20,905 - evaluation_logger_Attraction-88 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yNzM4Mzd9",
            "sortBy": "attr_book_score"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prxkdlbreosn-three-hour-bike-city-tour",
            "date": "2024-12-01"
        }
    },
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "prxkdlbreosn-three-hour-bike-city-tour"
        }
    }
]

2025-08-25 13:06:20,905 - evaluation_logger_Attraction-88 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNzM4Mzd9', 'sortBy': 'attr_book_score'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNzM4Mzd9', 'sortBy': 'attr_book_score'}}
2025-08-25 13:06:20,905 - evaluation_logger_Attraction-88 - INFO - Rule-based compare success.
2025-08-25 13:06:20,905 - evaluation_logger_Attraction-88 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yNzM4Mzd9', 'sortBy': 'attr_book_score'}}]
2025-08-25 13:06:20,905 - evaluation_logger_Attraction-88 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRXKdLbReosN",
                    "name": "Oslo Highlights Bike Tour",
                    "slug": "prxkdlbreosn-three-hour-bike-city-tour",
                    "shortDescription": "See the highlights of Oslo in one afternoon on a leisurely paced, 3-hour bike tour. Suitable for ...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 44.81,
                        "currency": "USD",
                        "publicAmount": 44.81
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 4,
                        "percentage": "75%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.9,
                            "total": 151
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Oslo",
                        "ufi": -273837
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItf74RjSvsa"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIApY4gpmme2"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIn3PiCdSCg3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZeXL4l4Vnp"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 8
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "highlyRated",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRqKwvtEe5pf",
                    "name": "Free City Walking Tour in Oslo",
                    "slug": "prqkwvtee5pf-free-city-walking-tour-in-oslo",
                    "shortDescription": "Discover the heart of Oslo on this 1.5-hour long free city walking tour.\nYou will see the Opera H...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 3.22,
                        "currency": "USD",
                        "publicAmount": 3.22
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 58
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Oslo",
                        "ufi": -273837
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIgfo4XonPKU"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIhfAYYY1nRa"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 4
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRBlK4CvSj5Z",
                    "name": "The Viking Planet Experience",
                    "slug": "prblk4cvsj5z-the-viking-planet-experience",
                    "shortDescription": "A digital museum to discover the world of the Vikings through VR",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 24.05,
                        "currency": "USD",
                        "publicAmount": 24.05
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 42,
                        "percentage": "81%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.3,
                            "total": 81
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Oslo",
                        "ufi": -273837
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4fM8hTzcQ0"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2cBP4OIMF2"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI2m275z6MWi"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuorDs53Cxb"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIJJX9ZAyMaX"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4D7aDqekAz"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 6
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForActivities",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRgbHAfgTOyI",
                    "name": "48-hour City Tour on a Hop-on Hop-off Bus",
                    "slug": "prgbhafgtoyi-48-hour-city-tour-on-a-hop-on-hop-off-bus",
                    "shortDescription": "Exploration of Oslo on board an environmentally-friendly bus, with stops along the way",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 49.91,
                        "currency": "USD",
                        "publicAmount": 49.91
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 3.7,
                            "total": 7
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Oslo",
                        "ufi": -273837
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIOd52HqP4yA"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvgE8gXBUcU"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIeNe6aVs8ku"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIieqk6WhnW0"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIoGXZWoR8j4"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKSoEhcbGNk"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIcWbZNSoZ4w"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIzKrFxukTU7"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIXQgynlaGGF"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIrDD5XvD8wH"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIs4ZDmq6n0N"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRzMY7Lz7Q3w",
                    "name": "Walking Tour of Historic Oslo",
                    "slug": "przmy7lz7q3w-free-tour-of-oslo-in-spanish",
                    "shortDescription": "Our Free Tour lasts 2 hours and we will show you the city of Oslo from a different perspective, y...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 16.16,
                        "currency": "USD",
                        "publicAmount": 16.16
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 3.4,
                            "total": 5
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Oslo",
                        "ufi": -273837
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIVFn0WqoBuD"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKr5hjlAadK"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIsfra0W2dlJ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6rlqK7BVt6"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 168,
                "filteredProductCount": 168
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 30
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 25
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums, arts & culture",
                        "tagname": "museums-arts-culture",
                        "productCount": 7
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 3
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Travel services & rentals",
                        "tagname": "travel-services-rental",
                        "productCount": 1
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 148
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Oslo",
                        "tagname": "-273837",
                        "productCount": 168
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 15
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 21
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 15
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 19
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 101
                    }
                ]
            }
        }
    }
]

2025-08-25 13:06:30,790 - evaluation_logger_Attraction-88 - INFO - Function Calls: 
[
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "prxkdlbreosn-three-hour-bike-city-tour"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prxkdlbreosn-three-hour-bike-city-tour",
            "date": "2024-12-01"
        }
    }
]

2025-08-25 13:06:30,790 - evaluation_logger_Attraction-88 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-12-01",
            "slug": "prxkdlbreosn-three-hour-bike-city-tour"
        }
    },
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "prxkdlbreosn-three-hour-bike-city-tour"
        }
    }
]

2025-08-25 13:06:30,790 - evaluation_logger_Attraction-88 - INFO - Start compare_single_call: 
{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'prxkdlbreosn-three-hour-bike-city-tour'}}
{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'prxkdlbreosn-three-hour-bike-city-tour'}}
2025-08-25 13:06:30,790 - evaluation_logger_Attraction-88 - INFO - Rule-based compare success.
2025-08-25 13:06:30,790 - evaluation_logger_Attraction-88 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-01', 'slug': 'prxkdlbreosn-three-hour-bike-city-tour'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-01', 'slug': 'prxkdlbreosn-three-hour-bike-city-tour'}}
2025-08-25 13:06:30,790 - evaluation_logger_Attraction-88 - INFO - Rule-based compare success.
2025-08-25 13:06:30,790 - evaluation_logger_Attraction-88 - INFO - Success matched: [{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'prxkdlbreosn-three-hour-bike-city-tour'}}, {'name': 'Get_Availability', 'arguments': {'date': '2024-12-01', 'slug': 'prxkdlbreosn-three-hour-bike-city-tour'}}]
2025-08-25 13:06:30,791 - evaluation_logger_Attraction-88 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProduct",
            "additionalInfo": "Public transportation options are available nearby\n\nSpecialized infant seats are available\n\nNot recommended for travelers with spinal injuries\n\nNot recommended for travelers with poor cardiovascular health\n\nSuitable for all physical fitness levels\n\nNot wheelchair accessible\n\nPlease bring your ticket with you to the attraction.\n\nBe aware that operators may cancel for unforeseen reasons.\n\nYou need to be 18 years or older to book or be accompanied by an adult. ",
            "applicableTerms": [
                {
                    "__typename": "TermsConditions",
                    "policyProvider": "Booking.com"
                },
                {
                    "__typename": "TermsConditions",
                    "policyProvider": "Viator"
                }
            ],
            "cancellationPolicy": {
                "__typename": "AttractionsCancellationPolicy",
                "hasFreeCancellation": true
            },
            "description": "See the highlights of Oslo in one afternoon on a leisurely paced, 3-hour bike tour. Suitable for all fitness levels, your tour takes in top Oslo sights, like Frognerparken (Vigeland Park), Aker Brygge shipyard, the Royal Palace, City Hall and Akershus Castle. Following an expert guide, you’ll discover all the insider information about this gorgeous Scandinavian city while exploring its best sites.\n\nThis small-group Oslo bike tour is limited to 15 people, ensuring you'll receive personal attention from your guide.\n\nFrom 01 November 2023 – 29 February 2024 we alter the tour to accommodate winter conditions. We equip our bikes with spiked tires so that we can explore Oslo’s sights safely. Sites visited can change based on weather and seasonal activities such as Christmas markets, and are chosen by our guides based on being safely accessible. Please note that this winter tour is recommended only for individuals with cycling experience and is only available to those over the age of 12.",
            "flags": [
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "bestseller",
                    "value": true,
                    "rank": 8
                },
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "highlyRated",
                    "value": true,
                    "rank": 1
                }
            ],
            "id": "PRXKdLbReosN",
            "isBookable": true,
            "labels": [
                {
                    "__typename": "AttractionsLabel",
                    "text": "Free cancellation",
                    "type": "free_cancellation"
                }
            ],
            "name": "Oslo Highlights Bike Tour",
            "notIncluded": [
                "Food and drinks Entrance fees"
            ],
            "offers": [
                {
                    "__typename": "Offer",
                    "availabilityType": "date_time",
                    "id": "OFMNLFLJFlDP"
                }
            ],
            "onSiteRequirements": {
                "__typename": "OnSiteRequirements"
            },
            "operatedBy": "Viking Biking & Hiking",
            "representativePrice": {
                "__typename": "AttractionsPrice",
                "chargeAmount": 44.81,
                "currency": "USD",
                "publicAmount": 44.81
            },
            "reviews": {
                "__typename": "AttractionsGetReviewsResponse",
                "total": 22,
                "reviews": [
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSwZQXQO0Gv9",
                        "epochMs": 1727188539000,
                        "language": "de",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Melanie",
                            "cc1": "at"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RS0QV5lxWETm",
                        "content": "Fuimos dos adultos con tres niños y el paseo en bici es apto para todos. Oslo es una ciudad magnífica para recorrerla en bici. Tranquila y con pocos coches. La guía muy simpática. Nos encantó!!",
                        "epochMs": 1724665080000,
                        "language": "es",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "ANA MARÍA",
                            "cc1": "es"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSN3aSP3olHn",
                        "epochMs": 1724486485000,
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Thomas",
                            "cc1": "at"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RS6Xz8EHyIDk",
                        "content": "Assolutamente da consigliare . La guida Alicia ci ha portato in zone della città che da soli non avremmo mai visitato. Spiegazioni dettagliate e interessanti dei luoghi e dei monumenti . Il massimo dei voti per questa esperienza 👍🏻",
                        "epochMs": 1724261828000,
                        "language": "it",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Patrizia",
                            "cc1": "it"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSMojzeLRoTG",
                        "content": "A faire dès votre arrivée en ville !! Notre guide Shaf a rendu cette visite très intéressante , sympathique avec un anglais facile à comprendre.",
                        "epochMs": 1723928348000,
                        "language": "fr",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "alice",
                            "cc1": "fr"
                        }
                    }
                ]
            },
            "reviewsStats": {
                "__typename": "AttractionsProductReviewStats",
                "allReviewsCount": 4,
                "percentage": "75%",
                "combinedNumericStats": {
                    "__typename": "AttractionsProductCombinedReviewStats",
                    "average": 4.9,
                    "total": 151
                }
            },
            "slug": "prxkdlbreosn-three-hour-bike-city-tour",
            "supportedFeatures": {
                "__typename": "AttractionsProductSupportedFeatures",
                "nativeApp": true,
                "nativeAppBookProcess": true,
                "liveAvailabilityCheckSupported": true
            },
            "ufiDetails": {
                "__typename": "AttractionLocationResponse",
                "ufi": -273837,
                "bCityName": "Oslo"
            },
            "whatsIncluded": [
                "Professional guide",
                "Use of a bike and helmet"
            ]
        }
    },
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-01T10:00:00+01:00",
                "timeSlotId": "ATS-PRXKdLbReosN-202412011000-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFMNLFLJFlDP",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 18-99)"
                                },
                                "id": "ATO-371568eb-2204-490f-8364-70a337f3e841_PRXKdLbReosN_20241201_1000",
                                "offerItemId": "OIApY4gpmme2",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 45.92,
                                    "currency": "EUR",
                                    "publicAmount": 45.92
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 49.48,
                                    "currency": "USD",
                                    "publicAmount": 49.48
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 9,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 12-17)"
                                },
                                "id": "ATO-f1bc807a-6571-431f-bd04-b951d102c183_PRXKdLbReosN_20241201_1000",
                                "offerItemId": "OItf74RjSvsa",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 41.59,
                                    "currency": "EUR",
                                    "publicAmount": 41.59
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 44.81,
                                    "currency": "USD",
                                    "publicAmount": 44.81
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 9,
                                "minPerReservation": 1,
                                "label": "Child"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 6-11)"
                                },
                                "id": "ATO-5c878c29-ebfd-4ee9-a0c3-b8eddbf0635e_PRXKdLbReosN_20241201_1000",
                                "offerItemId": "OIn3PiCdSCg3",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 36.39,
                                    "currency": "EUR",
                                    "publicAmount": 36.39
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 39.21,
                                    "currency": "USD",
                                    "publicAmount": 39.21
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 9,
                                "minPerReservation": 1,
                                "label": "Child"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 1-5)"
                                },
                                "id": "ATO-f0d78f74-a14c-4752-977e-32e9ee0a6c64_PRXKdLbReosN_20241201_1000",
                                "offerItemId": "OIZeXL4l4Vnp",
                                "type": "infant",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 36.39,
                                    "currency": "EUR",
                                    "publicAmount": 36.39
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 39.21,
                                    "currency": "USD",
                                    "publicAmount": 39.21
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 9,
                                "minPerReservation": 1,
                                "label": "Infant"
                            }
                        ],
                        "label": "Oslo Highlights Bike Tour",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": true,
                            "maxOfferItemsPerReservation": 9,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:09:44,081 - evaluation_logger_Attraction-88 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 MyBatis 的日志模块，对应 `logging` 包。如下图所示：[![`logging` 包](http://static.iocoder.cn/images/MyBatis/2020_02_07/01.png)](http://static.iocoder.cn/images/MyBatis/2020_02_07/01.png)`logging` 包

在 [《精尽 MyBatis 源码解析 —— 项目结构一览》](http://svip.iocoder.cn/MyBatis/intro) 中，简单介绍了这个模块如下：

> 无论在开发测试环境中，还是在线上生产环境中，日志在整个系统中的地位都是非常重要的。良好的日志功能可以帮助开发人员和测试人员快速定位 Bug 代码，也可以帮助运维人员快速定位性能瓶颈等问题。目前的 Java 世界中存在很多优秀的日志框架，例如 Log4j、 Log4j2、Slf4j 等。
>
> MyBatis 作为一个设计优良的框架，除了提供详细的日志输出信息，还要能够集成多种日志框架，其日志模块的一个主要功能就是**集成第三方日志框架**。

本文涉及的类如下图所示：![类图](http://static.iocoder.cn/images/MyBatis/2020_02_07/02.png)

- 从图的**上面**部分，我们可以看到，MyBatis 直接使用了多种第三方日志框架。所以，我们需要引入对应的日志框架 JAR 包。
- 从图的**下面**部分，我们可以看到，MyBatis 提供了 `LogFactory` 类，用于创建对应的 Log 对象。

另外，`Jdk14LoggingImpl`、`Log4jImpl` 等等 Log 实现类，都是对应封装了第三方日志框架的 Log 类。也就是说，**MyBatis 的日志模块，是桥接器模式的一种典型应用**。

下面，让我们开始干源码吧。

# 2. LogFactory

`org.apache.ibatis.logging.LogFactory` ，Log 工厂类。

## 2.1 构造方法

```java
// LogFactory.java

/**
 * Marker to be used by logging implementations that support markers
 */
public static final String MARKER = "MYBATIS";

/**
 * 使用的 Log 的构造方法
 */
private static Constructor<? extends Log> logConstructor;

static {
    // <1> 尝试依次初始化每个日志框架的对应的 Log 构造方法
    tryImplementation(LogFactory::useSlf4jLogging);
    tryImplementation(LogFactory::useCommonsLogging);
    tryImplementation(LogFactory::useLog4J2Logging);
    tryImplementation(LogFactory::useLog4JLogging);
    tryImplementation(LogFactory::useJdkLogging);
    tryImplementation(LogFactory::useNoLogging);
}
```

- `logConstructor` 静态属性，使用的 Log 的构造方法。

- `<1>` 处，在类加载时，通过 `#tryImplementation(Runnable runnable)` 方法，尝试依次初始化每个日志框架的对应的 Log 构造方法。代码如下：

  ```java
  // LogFactory.java
  
  private static void tryImplementation(Runnable runnable) {
      if (logConstructor == null) {
          try {
              runnable.run();
          } catch (Throwable t) {
              // ignore
          }
      }
  }
  ```

  - 当 `logConstructor` 为空时，执行 `runnable` 的方法。如果执行成功，则 `logConstructor` 会被赋值。那么，后续的日志框架，则不会继续初始化。

- `#useSlf4jLogging()` 方法，尝试使用 Slf4j 。代码如下：

  ```java
  // LogFactory.java
  
  public static synchronized void useSlf4jLogging() {
      setImplementation(org.apache.ibatis.logging.slf4j.Slf4jImpl.class);
  }
  ```

  - 调用 `#setImplementation(Class<? extends Log> implClass)` 方法，设置使用的 `logConstructor` 。代码如下：

    ```java
    // LogFactory.java
    
    private static void setImplementation(Class<? extends Log> implClass) {
        try {
            // 获得参数为 String 的构造方法
            Constructor<? extends Log> candidate = implClass.getConstructor(String.class);
            // 创建 Log 对象
            Log log = candidate.newInstance(LogFactory.class.getName());
            if (log.isDebugEnabled()) {
                log.debug("Logging initialized using '" + implClass + "' adapter.");
            }
            // 创建成功，意味着可以使用，设置为 logConstructor
            logConstructor = candidate;
        } catch (Throwable t) {
            throw new LogException("Error setting Log implementation.  Cause: " + t, t);
        }
    }
    ```

    - 通过反射，获取参数为 `String.class` 的构造方法，并创建 Log 对象后，确认日志框架可用，才设置为 `logConstructor` 。

  - 其它 `#useCommonsLogging()`、`#useLog4J2Logging()` 等等方法，也是类似的逻辑。代码如下：

    ```java
    // LogFactory.java
    
    public static synchronized void useCommonsLogging() {
        setImplementation(org.apache.ibatis.logging.commons.JakartaCommonsLoggingImpl.class);
    }
    
    public static synchronized void useLog4JLogging() {
        setImplementation(org.apache.ibatis.logging.log4j.Log4jImpl.class);
    }
    
    public static synchronized void useLog4J2Logging() {
        setImplementation(org.apache.ibatis.logging.log4j2.Log4j2Impl.class);
    }
    
    public static synchronized void useJdkLogging() {
        setImplementation(org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl.class);
    }
    
    public static synchronized void useStdOutLogging() {
        setImplementation(org.apache.ibatis.logging.stdout.StdOutImpl.class);
    }
    
    public static synchronized void useNoLogging() {
        setImplementation(org.apache.ibatis.logging.nologging.NoLoggingImpl.class);
    }
    ```

## 2.2 getLog

`#getLog(...)` 方法，获得 Log 对象。代码如下：

```java
// LogFactory.java

public static Log getLog(Class<?> aClass) {
    return getLog(aClass.getName());
}

public static Log getLog(String logger) {
    try {
        return logConstructor.newInstance(logger);
    } catch (Throwable t) {
        throw new LogException("Error creating logger for logger " + logger + ".  Cause: " + t, t);
    }
}
```

- 通过 `logConstructor` 反射创建 Log 对象。

## 2.3 小结

LogFactory 负责**自动扫描**日志实现，并且**延迟加载**日志实现。

# 3. Log

`org.apache.ibatis.logging.Log` ，MyBatis Log 接口。代码如下：

```java
// Log.java

public interface Log {

    boolean isDebugEnabled();

    boolean isTraceEnabled();

    void error(String s, Throwable e);

    void error(String s);

    void debug(String s);

    void trace(String s);

    void warn(String s);

}
```

- 和各大日志框架的接口是**类似**的。

## 3.1 Slf4jImpl

`org.apache.ibatis.logging.slf4j.Slf4jImpl` ，实现 Log 接口，Slf4j 实现类。代码如下：

```java
// Slf4jImpl.java

public class Slf4jImpl implements Log {

    private Log log;

    public Slf4jImpl(String clazz) {
        // 使用 SLF LoggerFactory 获得 Logger 对象
        Logger logger = LoggerFactory.getLogger(clazz);

        // 如果使用的是 SLF4J 1.7 以上的版本，则使用 Slf4jLoggerImpl 对象
        if (logger instanceof LocationAwareLogger) {
            try {
                // check for slf4j >= 1.6 method signature
                logger.getClass().getMethod("log", Marker.class, String.class, int.class, String.class, Object[].class, Throwable.class);
                log = new Slf4jLocationAwareLoggerImpl((LocationAwareLogger) logger);
                return;
            } catch (SecurityException | NoSuchMethodException e) {
                // fail-back to Slf4jLoggerImpl
            }
        }

        // Logger is not LocationAwareLogger or slf4j version < 1.6
        log = new Slf4jLoggerImpl(logger);
    }

    @Override
    public boolean isDebugEnabled() {
        return log.isDebugEnabled();
    }

    @Override
    public boolean isTraceEnabled() {
        return log.isTraceEnabled();
    }

    @Override
    public void error(String s, Throwable e) {
        log.error(s, e);
    }

    @Override
    public void error(String s) {
        log.error(s);
    }

    @Override
    public void debug(String s) {
        log.debug(s);
    }

    @Override
    public void trace(String s) {
        log.trace(s);
    }

    @Override
    public void warn(String s) {
        log.warn(s);
    }

}
```

- 在构造方法中，会根据不同的情况，创建 `Slf4jLocationAwareLoggerImpl` 或 `Slf4jLoggerImpl` 对象。但是，这两个类的实现代码，都是调用 `org.slf4j.Logger` 对应的方法。

## 3.2 其它实现类

其它的 Log 实现类，代码也是类似的。感兴趣的胖友，可以自己看看。

# 4. BaseJdbcLogger

`org.apache.ibatis.logging.jdbc.BaseJdbcLogger` ，实现 Log 接口，JDBC 日志抽象基类。

## 4.1 构造方法

```java
// BaseJdbcLogger.java

/**
 * 常用的 Set 的方法名集合
 */
private static Set<String> SET_METHODS;
/**
 * 执行查询的方法名集合
 */
private static Set<String> EXECUTE_METHODS;

/**
 * 设置 SET_METHODS 和 EXECUTE_METHODS
 */
static {
    SET_METHODS = new HashSet<>();
    SET_METHODS.add("setString");
    SET_METHODS.add("setInt");
    SET_METHODS.add("setByte");
    SET_METHODS.add("setShort");
    SET_METHODS.add("setLong");
    SET_METHODS.add("setDouble");
    SET_METHODS.add("setFloat");
    SET_METHODS.add("setTimestamp");
    SET_METHODS.add("setDate");
    SET_METHODS.add("setTime");
    SET_METHODS.add("setArray");
    SET_METHODS.add("setBigDecimal");
    SET_METHODS.add("setAsciiStream");
    SET_METHODS.add("setBinaryStream");
    SET_METHODS.add("setBlob");
    SET_METHODS.add("setBoolean");
    SET_METHODS.add("setBytes");
    SET_METHODS.add("setCharacterStream");
    SET_METHODS.add("setClob");
    SET_METHODS.add("setObject");
    SET_METHODS.add("setNull");
    SET_METHODS.add("setURL");

    EXECUTE_METHODS = new HashSet<>();
    EXECUTE_METHODS.add("execute");
    EXECUTE_METHODS.add("executeUpdate");
    EXECUTE_METHODS.add("executeQuery");
    EXECUTE_METHODS.add("addBatch");
}

/**
 * Log 对象
 */
protected Log statementLog;
/**
 * 查询的层级
 */
protected int queryStack;

/**
 * 构造方法
 *
 * @param log 日志对象
 * @param queryStack 查询的层级
 */
public BaseJdbcLogger(Log log, int queryStack) {
    this.statementLog = log;
    if (queryStack == 0) {
        this.queryStack = 1;
    } else {
        this.queryStack = queryStack;
    }
}
```

- 代码比较简单，胖友自己看注释。

## 4.2 其它方法

BaseJdbcLogger 的其它方法，我们放在后面的文章，详细解析。

# 5. ConnectionLogger

`org.apache.ibatis.logging.jdbc.ConnectionLogger` ，继承 BaseJdbcLogger 类，Connection 日志增强类。

## 5.1 构造方法

```java
// ConnectionLogger.java

/**
 * Connection 对象的代理
 */
private final Connection connection;

/**
 * 构造方法
 *
 * @param conn Connection 对象
 * @param statementLog Log 对象
 * @param queryStack 查询的层级
 */
private ConnectionLogger(Connection conn, Log statementLog, int queryStack) {
    super(statementLog, queryStack);
    this.connection = conn;
}
```

## 5.2 newInstance

`#newInstance(Connection conn, Log statementLog, int queryStack)` **静态**方法，创建 Connection 的代理对象。代码如下：

```java
// ConnectionLogger.java

public static Connection newInstance(Connection conn, Log statementLog, int queryStack) {
    // 创建 InvocationHandler 对象
    InvocationHandler handler = new ConnectionLogger(conn, statementLog, queryStack);
    // 创建 ClassLoader 对象
    ClassLoader cl = Connection.class.getClassLoader();
    // 创建代理对象
    return (Connection) Proxy.newProxyInstance(cl, new Class[]{Connection.class}, handler);
}
```

- 通过 JDK 动态代理的方式，创建 Connection 的代理对象。这样，在调用 Connection 的方法时，会触发 `InvocationHandler#invoke(Object proxy, Method method, Object[] params)` 方法。

## 5.3 invoke

```java
// ConnectionLogger.java

@Override
public Object invoke(Object proxy, Method method, Object[] params) throws Throwable {
    try {
        // 如果调用的是 Object 定义的方法，直接调用
        if (Object.class.equals(method.getDeclaringClass())) {
            return method.invoke(this, params);
        }
        // 如果调用的是 prepareStatement 方法
        if ("prepareStatement".equals(method.getName())) {
            if (isDebugEnabled()) {
                debug(" Preparing: " + removeBreakingWhitespace((String) params[0]), true);
            }
            // 调用底层连接
            PreparedStatement stmt = (PreparedStatement) method.invoke(connection, params);
            // 创建 PreparedStatement 的代理对象
            stmt = PreparedStatementLogger.newInstance(stmt, statementLog, queryStack);
            return stmt;
        }
        // 如果调用的是 prepareCall 方法
        else if ("prepareCall".equals(method.getName())) {
            if (isDebugEnabled()) {
                debug(" Preparing: " + removeBreakingWhitespace((String) params[0]), true);
            }
            // 调用底层连接
            PreparedStatement stmt = (PreparedStatement) method.invoke(connection, params);
            // 创建 PreparedStatement 的代理对象
            stmt = PreparedStatementLogger.newInstance(stmt, statementLog, queryStack);
            return stmt;
        }
        // 如果调用的是 createStatement 方法
        else if ("createStatement".equals(method.getName())) {
            // 调用底层连接
            Statement stmt = (Statement) method.invoke(connection, params);
            // 创建 Statement 的代理对象
            stmt = StatementLogger.newInstance(stmt, statementLog, queryStack);
            return stmt;
        } else {
            return method.invoke(connection, params);
        }
    } catch (Throwable t) {
        throw ExceptionUtil.unwrapThrowable(t);
    }
}
```

- 根据不同的方法，进行不同的日志增强处理。例如：
  - `#prepareStatement(String sql)` 方法，打印 SQL 语句，并创建 PreparedStatement 的代理对象。
  - `#prepareCall(String sql)` 方法，打印 SQL 语句，并创建 PreparedStatement 的代理对象。
  - `#createStatement()` 方法，创建 Statement 的代理对象。
- 这样，Connection 的代理对象，就实现了对 `#prepareStatement(String sql)`、`#prepareCall(String sql)`、`#createStatement()` 方法的日志增强。

# 6. PreparedStatementLogger

`org.apache.ibatis.logging.jdbc.PreparedStatementLogger` ，继承 BaseJdbcLogger 类，PreparedStatement 日志增强类。

## 6.1 构造方法

```java
// PreparedStatementLogger.java

/**
 * PreparedStatement 对象
 */
private final PreparedStatement statement;

/**
 * 构造方法
 *
 * @param stmt PreparedStatement 对象
 * @param statementLog Log 对象
 * @param queryStack 查询的层级
 */
private PreparedStatementLogger(PreparedStatement stmt, Log statementLog, int queryStack) {
    super(statementLog, queryStack);
    this.statement = stmt;
}
```

## 6.2 newInstance

`#newInstance(PreparedStatement stmt, Log statementLog, int queryStack)` **静态**方法，创建 PreparedStatement 的代理对象。代码如下：

```java
// PreparedStatementLogger.java

public static PreparedStatement newInstance(PreparedStatement stmt, Log statementLog, int queryStack) {
    // 创建 InvocationHandler 对象
    InvocationHandler handler = new PreparedStatementLogger(stmt, statementLog, queryStack);
    // 创建 ClassLoader 对象
    ClassLoader cl = PreparedStatement.class.getClassLoader();
    // 常见代理对象
    return (PreparedStatement) Proxy.newProxyInstance(cl, new Class[]{PreparedStatement.class}, handler);
}
```

- 通过 JDK 动态代理的方式，创建 PreparedStatement 的代理对象。

## 6.3 invoke

```java
// PreparedStatementLogger.java

@Override
public Object invoke(Object proxy, Method method, Object[] params) throws Throwable {
    try {
        // 如果调用的是 Object 定义的方法，直接调用
        if (Object.class.equals(method.getDeclaringClass())) {
            return method.invoke(this, params);
        }
        // 如果调用的是 execute 系列方法
        if (EXECUTE_METHODS.contains(method.getName())) {
            if (isDebugEnabled()) {
                debug("Parameters: " + getParameterValueString(), true);
            }
            // 清除 column* 相关的属性
            clearColumnInfo();
            // 执行方法
            if ("executeQuery".equals(method.getName())) {
                ResultSet rs = (ResultSet) method.invoke(statement, params);
                return ResultSetLogger.newInstance(rs, statementLog, queryStack);
            } else {
                return method.invoke(statement, params);
            }
        }
        // 如果调用的是 set 系列方法
        else if (SET_METHODS.contains(method.getName())) {
            // 设置参数到 column* 相关的属性
            if ("setNull".equals(method.getName())) {
                setColumn

2025-08-25 13:09:50,916 - evaluation_logger_Attraction-88 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about ticket availability or details of the top-rated tourist attraction in Oslo.'}
2025-08-25 13:09:56,688 - evaluation_logger_Attraction-88 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:09:56,688 - evaluation_logger_Attraction-88 - INFO - Message: Success.
2025-08-25 13:09:56,688 - evaluation_logger_Attraction-88 - INFO - Success turn num = 3
2025-08-25 13:09:56,688 - evaluation_logger_Attraction-88 - INFO - ----------------------------------------------------------------------------------------------------
