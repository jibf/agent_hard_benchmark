2025-08-25 12:57:06,131 - evaluation_logger_Attraction-31 - INFO - Test Example Attraction-31
2025-08-25 12:57:06,131 - evaluation_logger_Attraction-31 - INFO - Query: Our company is planning a trip to Madrid for the employees. What is the highest-rated attraction there?
2025-08-25 12:57:14,275 - evaluation_logger_Attraction-31 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Madrid"
        }
    }
]

2025-08-25 12:57:14,275 - evaluation_logger_Attraction-31 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Madrid"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0zOTA2MjV9",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 12:57:14,275 - evaluation_logger_Attraction-31 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Madrid'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Madrid'}}
2025-08-25 12:57:14,275 - evaluation_logger_Attraction-31 - INFO - Rule-based compare success.
2025-08-25 12:57:14,275 - evaluation_logger_Attraction-31 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Madrid'}}]
2025-08-25 12:57:14,275 - evaluation_logger_Attraction-31 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJMMWlnNDE0dWRkIiwidWZpIjotMzkwNjI1fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Photoshoot in Madrid",
                    "productId": "PRL1ig414udd",
                    "productSlug": "prl1ig414udd-photoshoot-in-madrid",
                    "taxonomySlug": "tours",
                    "cityUfi": -390625,
                    "cityName": "Madrid",
                    "countryCode": "es"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJ1Z0hzUk4zbExKIiwidWZpIjotMzkwNjI1fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Photoshoot in Madrid",
                    "productId": "PRugHsRN3lLJ",
                    "productSlug": "prughsrn3llj-photoshoot-in-madrid",
                    "taxonomySlug": "tours",
                    "cityUfi": -390625,
                    "cityName": "Madrid",
                    "countryCode": "es"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJ4MnI3UDBrR3NNIiwidWZpIjotMzkwNjI1fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Private Transfer from Madrid Airport to Madrid Hotels",
                    "productId": "PRx2r7P0kGsM",
                    "productSlug": "prx2r7p0kgsm-private-transfer-from-madrid-airport-to-madrid-hotels",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -390625,
                    "cityName": "Madrid",
                    "countryCode": "es"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJ4NHNNblRwb2tmIiwidWZpIjotMzkwNjI1fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Imperial Madrid: Royal Palace and the Habsburg dynasty in Madrid",
                    "productId": "PRx4sMnTpokf",
                    "productSlug": "prx4smntpokf-imperial-madrid-royal-palace-and-the-habsburg-dynasty-in-madrid",
                    "taxonomySlug": "tours",
                    "cityUfi": -390625,
                    "cityName": "Madrid",
                    "countryCode": "es"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJXSVJIZlRxNXJwIiwidWZpIjotMzkwNjI1fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Private Transfer from Madrid Hotels to Madrid Airport",
                    "productId": "PRWIRHfTq5rp",
                    "productSlug": "prwirhftq5rp-private-transfer-from-madrid-hotels-to-madrid-airport",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -390625,
                    "cityName": "Madrid",
                    "countryCode": "es"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0zOTA2MjV9",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -390625,
                    "country": "Spain",
                    "cityName": "Madrid",
                    "productCount": 1157,
                    "cc1": "es"
                }
            ]
        }
    }
]

2025-08-25 12:57:24,124 - evaluation_logger_Attraction-31 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0zOTA2MjV9",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 12:57:24,124 - evaluation_logger_Attraction-31 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0zOTA2MjV9",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 12:57:24,124 - evaluation_logger_Attraction-31 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0zOTA2MjV9', 'sortBy': 'attr_book_score'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0zOTA2MjV9', 'sortBy': 'attr_book_score'}}
2025-08-25 12:57:24,124 - evaluation_logger_Attraction-31 - INFO - Rule-based compare success.
2025-08-25 12:57:24,124 - evaluation_logger_Attraction-31 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0zOTA2MjV9', 'sortBy': 'attr_book_score'}}]
2025-08-25 12:57:24,125 - evaluation_logger_Attraction-31 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PR2T3iiH5dEv",
                    "name": "Madrid Essential: Historic Center, Plaza Mayor & Royal Palace",
                    "slug": "pr2t3iih5dev-essential-madrid-tour-historic-center-plaza-mayor-royal-palace",
                    "shortDescription": "We are #1 on TripAdvisor \n\nNo other tour covers as many of Madrid's important landmarks as this t...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 3.27,
                        "currency": "USD",
                        "publicAmount": 3.27
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.9,
                            "total": 312
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Madrid",
                        "ufi": -390625
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuj3WLhHp7f"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIkhKHUk36vt"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIz8Wosd7VUe"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6PcwAZKeIL"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIoJWIpp5UE2"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUiah0pgKNo"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIkrTHJdgR5s"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0ToDYBL6R2"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINTB4XaFKfQ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIs5nk78sitr"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIz7JuynfcG8"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIGCVhXuleQ2"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIL8nf6nPU5m"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OID9Jw55P9Xv"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbDSXg0LR1L"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OInZr28rE0gU"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuuG69wSXyX"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIScaFd3TTJs"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OILKYOS1JDEd"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbiqiO2dUo8"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIronxWM4CHS"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIAe31AEOikm"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItr0wC675PH"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI6139wnTIUL"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OILJpbHe1U8S"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRgN22yoa9rx",
                    "name": "Admission to a Traditional Flamenco Show",
                    "slug": "prgn22yoa9rx-admission-to-a-traditional-flamenco-show",
                    "shortDescription": "Skip-the-line admission to watch a traditional Flamenco performance",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 30.58,
                        "currency": "USD",
                        "publicAmount": 30.58
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 66,
                        "percentage": "98%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 689
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Madrid",
                        "ufi": -390625
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIBvkcJMefJK"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4WmYzZ0B2C"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuIFVcjrvP1"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI7RR3Tpbfrr"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 6
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForActivities",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRAchb6SLTWo",
                    "name": "Ticket for Flamenco Show at Madrid Theater",
                    "slug": "prachb6sltwo-ticket-for-flamenco-show-at-madrid-theater",
                    "shortDescription": "It is the largest flamenco show in Madrid and also the most visited in the Spanish capital. It ha...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 42.6,
                        "currency": "USD",
                        "publicAmount": 42.6
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.7,
                            "total": 131
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Madrid",
                        "ufi": -390625
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OITx7xeX9on3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIjZlp1iDvet"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIY6tHypsv0Y"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PR3WzDM6qgsv",
                    "name": "Prado Museum Tickets",
                    "slug": "pr3wzdm6qgsv-prado-museum-tickets",
                    "shortDescription": "A stunning display of art by the great European masters",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 19.44,
                        "currency": "USD",
                        "publicAmount": 19.44
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 18,
                        "percentage": "94%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 869
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Madrid",
                        "ufi": -390625
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIHiwmRfYfsv"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIE2ashQtvYQ"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": false
                    },
                    "id": "PR7wl99VfqYZ",
                    "name": "Prado, Thyssen-Bornemisza & Reina Sofía Pass",
                    "slug": "pr7wl99vfqyz-prado-thyssen-bornemisza-and-reina-sofia-museums-pass",
                    "shortDescription": "Access to three of the Paseo del Arte's famous museums",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 40.42,
                        "currency": "USD",
                        "publicAmount": 40.42
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 328,
                        "percentage": "93%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 806
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Madrid",
                        "ufi": -390625
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIHw6YC7ZpPk"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIf4F6qbl4Cv"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForMuseums",
                            "value": true,
                            "rank": 1
                        }
                    ]
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 1157,
                "filteredProductCount": 1157
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 918
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Activities",
                        "tagname": "activities",
                        "productCount": 128
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Transfers & services",
                        "tagname": "transfers-services",
                        "productCount": 49
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums",
                        "tagname": "museums",
                        "productCount": 36
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Attractions",
                        "tagname": "attractions",
                        "productCount": 13
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 1021
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Madrid",
                        "tagname": "-390625",
                        "productCount": 1140
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Pena Grande",
                        "tagname": "-396042",
                        "productCount": 16
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "El Escorial",
                        "tagname": "-380642",
                        "productCount": 1
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 123
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 191
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 231
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 179
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 486
                    }
                ]
            }
        }
    }
]

2025-08-25 12:59:18,485 - evaluation_logger_Attraction-31 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 前言

在上一篇文章中，我们实现了`axios`的请求和响应配置化，即用户可以配置`config`对象中的`url`、`method`、`params`、`data`、`headers`、`timeout`、`responseType`等属性。其中，`headers`请求头属性我们只实现了配置化，并没有实现与具体业务相关的请求头配置，比如：

- `Content-Type`：请求体数据类型
- `Content-Length`：请求体数据长度
- `Accept`：希望服务端返回的数据类型
- `User-Agent`：用户代理
- `Cookie`：`cookie`信息
- ...

等等，这些请求头信息有些是固定的，有些是动态的，有些是默认的，有些是用户自定义的。所以，我们需要对请求头`headers`做一下处理。

# 2. 需求分析

我们希望`headers`配置可以是如下形式：

```javascript
headers: {
  common: {
    Accept: 'application/json, text/plain, */*'
  },
  post: {
    'Content-Type':'application/x-www-form-urlencoded'
  }
}
```

其中，`common`里是通用的请求头配置，`post`里是`post`方法独有的请求头配置，当然还可以有`get`、`put`、`patch`、`delete`等。并且，我们还可以为每个请求方法配置默认的请求头，当用户没有配置该请求头时，我们就使用默认的。

# 3. 默认请求头

首先，我们先为各个请求方法配置默认的请求头，我们在`src/defaults.ts`中为`headers`添加如下默认配置：

```typescript
const defaults: AxiosRequestConfig = {
  method: "get",
  timeout: 0,
  headers: {
    common: {
      Accept: "application/json, text/plain, */*",
    },
  },
};

const methodsNoData = ["delete", "get", "head", "options"];

methodsNoData.forEach((method) => {
  defaults.headers[method] = {};
});

const methodsWithData = ["post", "put", "patch"];

methodsWithData.forEach((method) => {
  defaults.headers[method] = {
    "Content-Type": "application/x-www-form-urlencoded",
  };
});

export default defaults;
```

我们为`headers`添加了`common`属性和`post`、`put`、`patch`、`delete`、`get`、`head`、`options`属性。并且为`common`属性配置了`Accept`字段，为`post`、`put`、`patch`方法配置了`Content-Type`字段。

# 4. 合并请求头

我们给`headers`设置了默认配置，但是用户可能也配置了`headers`，所以我们需要把用户配置的`headers`和默认的`headers`做合并。合并的逻辑是：

- 对于`common`中定义的请求头，对于所有请求方法都适用；
- 对于某个请求方法独有的请求头，只适用于该请求方法；
- 优先使用用户配置的请求头，如果用户配置了，就不再使用默认的。

合并操作在发送请求之前，我们在`src/core/xhr.ts`中的`xhr`函数里处理请求头，处理之前，我们需要把`headers`从`config`中取出，并且删除掉，因为最终发送请求的`headers`是处理后的，而不是原始的`config.headers`。

```typescript
const { headers = {}, method } = config;
```

然后，我们创建一个`flattenHeaders`工具函数来处理`headers`的合并，我们在`src/helpers/headers.ts`文件中添加该函数：

```typescript
export function flattenHeaders(headers: any, method: Method): any {
  if (!headers) {
    return headers;
  }
  headers = deepMerge(headers.common, headers[method], headers);

  const methodsToDelete = ["get", "post", "put", "patch", "delete", "head", "options", "common"];

  methodsToDelete.forEach((method) => {
    delete headers[method];
  });

  return headers;
}
```

`flattenHeaders`方法做了三件事：

1. 使用`deepMerge`方法将`headers.common`和`headers[method]`以及`headers`本身进行合并，其中`headers[method]`表示该请求方法独有的请求头配置；
2. 删除`headers`中的`common`和所有请求方法字段；
3. 返回合并后的`headers`。

其中，`deepMerge`方法在之前已经实现过，在`src/helpers/util.ts`中。

OK，合并函数创建好之后，我们就在发送请求之前使用该函数处理`config.headers`，处理之前，我们还需要把默认配置中的`headers`和用户传入的`config.headers`进行合并，因为默认配置中也有`headers`，所以我们在`src/core/mergeConfig.ts`中的`mergeConfig`函数里添加对`headers`的合并：

```typescript
import { deepMerge } from "../helpers/util";

const strat = Object.create(null);

// 默认合并策略
function defaultStrat(val1: any, val2: any): any {
  return typeof val2 !== "undefined" ? val2 : val1;
}

// 只接受自定义配置合并策略
function fromVal2Strat(val1: any, val2: any): any {
  if (typeof val2 !== "undefined") {
    return val2;
  }
}

// 复杂对象合并策略
function deepMergeStrat(val1: any, val2: any): any {
  if (isPlainObject(val2)) {
    return deepMerge(val1, val2);
  } else if (typeof val2 !== "undefined") {
    return val2;
  } else if (isPlainObject(val1)) {
    return deepMerge(val1);
  } else {
    return val1;
  }
}

const stratKeysFromVal2 = ["url", "params", "data"];

stratKeysFromVal2.forEach((key) => {
  strat[key] = fromVal2Strat;
});

const stratKeysDeepMerge = ["headers"];

stratKeysDeepMerge.forEach((key) => {
  strat[key] = deepMergeStrat;
});

export default function mergeConfig(
  config1: AxiosRequestConfig,
  config2?: AxiosRequestConfig
): AxiosRequestConfig {
  if (!config2) {
    config2 = {};
  }

  const config = Object.create(null);

  for (let key in config2) {
    mergeField(key);
  }

  for (let key in config1) {
    if (!config2[key]) {
      mergeField(key);
    }
  }

  function mergeField(key: string): void {
    const stratFn = strat[key] || defaultStrat;
    config[key] = stratFn(config1[key], config2![key]);
  }

  return config;
}
```

我们定义了一个`stratKeysDeepMerge`数组，该数组中的`key`对应的合并策略是`deepMergeStrat`，即深度合并。目前只有`headers`属性需要深度合并。

OK，合并完默认配置和用户配置的`headers`之后，我们就在发送请求之前使用`flattenHeaders`函数将`headers`打平，即把`common`和对应`method`中的`headers`合并到`headers`中，并且删除`common`和对应`method`字段。

在`src/core/xhr.ts`中：

```typescript
export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      // 取出headers
      headers,
      method,
      // ...
    } = config;

    // 创建请求
    const request = new XMLHttpRequest();

    // 初始化请求
    request.open(method.toUpperCase(), url, true);

    // 处理headers
    Object.keys(headers).forEach((name) => {
      // 如果data为null，那么设置content-type就没有意义了，所以删除掉
      if (data === null && name.toLowerCase() === "content-type") {
        delete headers[name];
      } else {
        request.setRequestHeader(name, headers[name]);
      }
    });

    // 发送请求
    request.send(data);
  });
}
```

我们添加了处理`headers`的代码，遍历`headers`，如果发现`data`为`null`，并且`headers`中有`Content-Type`字段，那么就删除掉，因为此时没有请求体，设置`Content-Type`是没有意义的。否则，就调用`request.setRequestHeader`方法设置请求头。

# 5.  demo编写

在 `examples` 目录下创建 `more` 目录，在 `more` 目录下创建 `index.html`:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>More example</title>
  </head>
  <body>
    <script src="/__build__/more.js"></script>
  </body>
</html>
```

再创建 `app.ts` 作为入口文件：

```typescript
import axios from "../../src/index";
import qs from "qs";

axios.defaults.headers.common["test2"] = 123;

axios({
  url: "/config/post",
  method: "post",
  data: qs.stringify({
    a: 1,
  }),
  headers: {
    test: "321",
  },
}).then((res) => {
  console.log(res.data);
});
```

接着在 `server/server.js` 添加新的接口路由：

```javascript
// 添加config接口
router.post("/config/post", function(req, res) {
  res.json(req.body);
});
```

然后在命令行运行：

```bash
# 同时开启客户端和服务端
npm run server | npm start
```

接着打开 chrome 浏览器，访问 `http://localhost:8000/` 即可访问我们的 demo 了，我们点击 `more`，通过`F12`的 `network` 部分我们可以看到发送的请求中已经带上了我们之前设置的默认请求头和自定义请求头：

![](~@/axios/10/01.png)

我们还可以通过`F12`的`network`部分看到请求头中已经带上了我们设置的默认请求头和自定义请求头：

![](~@/axios/10/02.png)

OK，以上就是我们为`headers`做的处理，合并了默认配置和用户配置，并且对`headers`做了扁平化处理。


2025-08-25 12:59:23,627 - evaluation_logger_Attraction-31 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about the highest-rated attraction in Madrid.'}
2025-08-25 12:59:29,456 - evaluation_logger_Attraction-31 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:59:29,456 - evaluation_logger_Attraction-31 - INFO - Message: Success.
2025-08-25 12:59:29,456 - evaluation_logger_Attraction-31 - INFO - Success turn num = 2
2025-08-25 12:59:29,456 - evaluation_logger_Attraction-31 - INFO - ----------------------------------------------------------------------------------------------------
