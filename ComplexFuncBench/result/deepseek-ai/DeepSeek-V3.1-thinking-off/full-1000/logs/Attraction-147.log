2025-08-25 13:14:08,796 - evaluation_logger_Attraction-147 - INFO - Test Example Attraction-147
2025-08-25 13:14:08,796 - evaluation_logger_Attraction-147 - INFO - Query: I am in South Africa and interested in penguins. Check for penguin activities in Cape Town with available tickets after 9 PM on November 13, 2024. If not, check Port Elizabeth for tickets before 4 AM on November 18. I'd like to know the detailed activity information.
2025-08-25 13:14:17,765 - evaluation_logger_Attraction-147 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "penguins, Cape Town"
        }
    }
]

2025-08-25 13:14:17,765 - evaluation_logger_Attraction-147 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Penguin, Cape Town"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prpui9c6nwei-cape-town-private-cape-point-penguin-tour",
            "date": "2024-11-13"
        }
    }
]

2025-08-25 13:14:18,422 - evaluation_logger_Attraction-147 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'penguins, Cape Town'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Penguin, Cape Town'}}
2025-08-25 13:14:26,382 - evaluation_logger_Attraction-147 - DEBUG - LLM-based comparison output: {'is_equal': True, 'reason': "The queries 'penguins, Cape Town' and 'Penguin, Cape Town' are equivalent because they refer to the same concept of penguin-related activities in Cape Town. The difference in capitalization and singular/plural form does not change the meaning in this context."}
2025-08-25 13:14:26,382 - evaluation_logger_Attraction-147 - INFO - LLM-based compare success.
2025-08-25 13:14:26,382 - evaluation_logger_Attraction-147 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Penguin, Cape Town'}}]
2025-08-25 13:14:26,382 - evaluation_logger_Attraction-147 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJwdWk5YzZuV0VJIiwidWZpIjotMTIxNzIxNH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Cape Town Private, Cape point Penguin Tour",
                    "productId": "PRpui9c6nWEI",
                    "productSlug": "prpui9c6nwei-cape-town-private-cape-point-penguin-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -1217214,
                    "cityName": "Cape Town",
                    "countryCode": "za"
                }
            ]
        }
    }
]

2025-08-25 13:14:36,795 - evaluation_logger_Attraction-147 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prpui9c6nwei-cape-town-private-cape-point-penguin-tour",
            "date": "2024-11-13"
        }
    }
]

2025-08-25 13:14:36,795 - evaluation_logger_Attraction-147 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-11-13",
            "slug": "prpui9c6nwei-cape-town-private-cape-point-penguin-tour"
        }
    },
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Penguin, Port Elizabeth"
        }
    }
]

2025-08-25 13:14:36,795 - evaluation_logger_Attraction-147 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-13', 'slug': 'prpui9c6nwei-cape-town-private-cape-point-penguin-tour'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-13', 'slug': 'prpui9c6nwei-cape-town-private-cape-point-penguin-tour'}}
2025-08-25 13:14:36,796 - evaluation_logger_Attraction-147 - INFO - Rule-based compare success.
2025-08-25 13:14:36,796 - evaluation_logger_Attraction-147 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-11-13', 'slug': 'prpui9c6nwei-cape-town-private-cape-point-penguin-tour'}}]
2025-08-25 13:14:36,796 - evaluation_logger_Attraction-147 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-11-13T06:00:00+02:00",
                "timeSlotId": "ATS-PRpui9c6nWEI-202411130600-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "German - Tour guide",
                                "language": "de",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Spanish - Tour guide",
                                "language": "es",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Italian - Tour guide",
                                "language": "it",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "French - Tour guide",
                                "language": "fr",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "description": "Pickup included",
                        "id": "OFmkOovTfPAM",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-993a87de-19e5-4ddd-a29f-1524025419d6_PRpui9c6nWEI_20241113_0600",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "de",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-d904897e-730d-493f-9da9-720848d5a16f_PRpui9c6nWEI_20241113_0600",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "fr",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-40165b1f-4eb6-4433-a7ba-7ba85a5dd369_PRpui9c6nWEI_20241113_0600",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-b3ade376-a1e5-4af3-8fa7-fb545eee7683_PRpui9c6nWEI_20241113_0600",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-d711d382-4bde-422a-aca7-36d87f055e48_PRpui9c6nWEI_20241113_0600",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "it",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Cape Town Private, Cape point Penguin Tour",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            },
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-11-13T09:00:00+02:00",
                "timeSlotId": "ATS-PRpui9c6nWEI-202411130900-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "German - Tour guide",
                                "language": "de",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Spanish - Tour guide",
                                "language": "es",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Italian - Tour guide",
                                "language": "it",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "French - Tour guide",
                                "language": "fr",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "description": "Pickup included",
                        "id": "OFmkOovTfPAM",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-75b386a2-0e16-4cbe-a659-3c4ac3070fac_PRpui9c6nWEI_20241113_0900",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "de",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-dcb59455-89e1-4811-b4b7-e7781d2a8da0_PRpui9c6nWEI_20241113_0900",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "fr",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-e4242a94-56c9-4225-af48-88af8f8448d6_PRpui9c6nWEI_20241113_0900",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-99053905-71c7-4747-8ed6-4e3511b1951a_PRpui9c6nWEI_20241113_0900",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-64deee6a-3079-4153-b167-364756ff0bbd_PRpui9c6nWEI_20241113_0900",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "it",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Cape Town Private, Cape point Penguin Tour",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            },
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-11-13T11:00:00+02:00",
                "timeSlotId": "ATS-PRpui9c6nWEI-202411131100-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "German - Tour guide",
                                "language": "de",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Spanish - Tour guide",
                                "language": "es",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Italian - Tour guide",
                                "language": "it",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "French - Tour guide",
                                "language": "fr",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "description": "Pickup included",
                        "id": "OFmkOovTfPAM",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-bba725df-b773-498a-a3f8-b6f72ffba051_PRpui9c6nWEI_20241113_1100",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "de",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-4435f0c1-0777-4abf-9e55-f755f91fe71d_PRpui9c6nWEI_20241113_1100",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "fr",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-f3976414-8f16-40da-9b95-15368d84bad7_PRpui9c6nWEI_20241113_1100",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-c7c09de8-9fc8-4ab0-8b3b-e3ca05c5e13b_PRpui9c6nWEI_20241113_1100",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-3d7f2b61-112a-4334-947f-116701a3b26b_PRpui9c6nWEI_20241113_1100",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "it",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Cape Town Private, Cape point Penguin Tour",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            },
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-11-13T13:00:00+02:00",
                "timeSlotId": "ATS-PRpui9c6nWEI-202411131300-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "German - Tour guide",
                                "language": "de",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Spanish - Tour guide",
                                "language": "es",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "Italian - Tour guide",
                                "language": "it",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "French - Tour guide",
                                "language": "fr",
                                "type": "guide"
                            },
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "description": "Pickup included",
                        "id": "OFmkOovTfPAM",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-029f88d0-21e7-4230-9418-1e3c5e4c0940_PRpui9c6nWEI_20241113_1300",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "de",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-43d39c90-cf40-470a-81cc-1764eb38b2b2_PRpui9c6nWEI_20241113_1300",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "fr",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-6b2856c8-79a5-48f4-aa99-ffe6c1035b2f_PRpui9c6nWEI_20241113_1300",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "es",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-ce5755bc-9b59-4391-a0bf-aefaa3bd5abc_PRpui9c6nWEI_20241113_1300",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "hasFreeCancellation": false,
                                    "isStillRefundable": false
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 16-95)"
                                },
                                "id": "ATO-7b6845ff-e11c-4443-b57e-15e05f4f5f48_PRpui9c6nWEI_20241113_1300",
                                "offerItemId": "OI3BVb8rRxPs",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 163.2,
                                    "currency": "USD",
                                    "publicAmount": 163.2
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "it",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Cape Town Private, Cape point Penguin Tour",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:14:46,552 - evaluation_logger_Attraction-147 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "penguins, Port Elizabeth"
        }
    }
]

2025-08-25 13:14:46,552 - evaluation_logger_Attraction-147 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Penguin, Port Elizabeth"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prmda59znth5-port-elizabeth-adventure-tuk-tuk-penguins-cape-recife",
            "date": "2024-11-18"
        }
    }
]

2025-08-25 13:14:47,198 - evaluation_logger_Attraction-147 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'penguins, Port Elizabeth'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Penguin, Port Elizabeth'}}
2025-08-25 13:14:54,768 - evaluation_logger_Attraction-147 - DEBUG - LLM-based comparison output: {'is_equal': True, 'reason': "The function calls are equivalent because the query parameter 'penguins, Port Elizabeth' in Function call 1 and 'Penguin, Port Elizabeth' in Function call 2 refer to the same concept of searching for penguin-related attractions in Port Elizabeth. The difference in singular and plural forms of 'penguin' does not change the meaning of the search query."}
2025-08-25 13:14:54,768 - evaluation_logger_Attraction-147 - INFO - LLM-based compare success.
2025-08-25 13:14:54,768 - evaluation_logger_Attraction-147 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Penguin, Port Elizabeth'}}]
2025-08-25 13:14:54,768 - evaluation_logger_Attraction-147 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJtZEE1OXpOVGg1IiwidWZpIjotMTI3MzQ0OH0=",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Port Elizabeth Adventure: Tuk-Tuk, Penguins, & Cape Recife",
                    "productId": "PRmdA59zNTh5",
                    "productSlug": "prmda59znth5-port-elizabeth-adventure-tuk-tuk-penguins-cape-recife",
                    "taxonomySlug": "tours",
                    "cityUfi": -1273448,
                    "cityName": "Port Elizabeth",
                    "countryCode": "za"
                }
            ]
        }
    }
]

2025-08-25 13:15:04,513 - evaluation_logger_Attraction-147 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "prmda59znth5-port-elizabeth-adventure-tuk-tuk-penguins-cape-recife",
            "date": "2024-11-18"
        }
    }
]

2025-08-25 13:15:04,513 - evaluation_logger_Attraction-147 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-11-18",
            "slug": "prmda59znth5-port-elizabeth-adventure-tuk-tuk-penguins-cape-recife"
        }
    }
]

2025-08-25 13:15:04,513 - evaluation_logger_Attraction-147 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-18', 'slug': 'prmda59znth5-port-elizabeth-adventure-tuk-tuk-penguins-cape-recife'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-11-18', 'slug': 'prmda59znth5-port-elizabeth-adventure-tuk-tuk-penguins-cape-recife'}}
2025-08-25 13:15:04,513 - evaluation_logger_Attraction-147 - INFO - Rule-based compare success.
2025-08-25 13:15:04,513 - evaluation_logger_Attraction-147 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-11-18', 'slug': 'prmda59znth5-port-elizabeth-adventure-tuk-tuk-penguins-cape-recife'}}]
2025-08-25 13:15:04,513 - evaluation_logger_Attraction-147 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": true,
                "start": "2024-11-18T00:00:00+02:00",
                "timeSlotId": "ATS-PRmdA59zNTh5-202411180000-nullnull",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "languageOptions": [
                            {
                                "__typename": "OfferLanguageOption",
                                "label": "English - Tour guide",
                                "language": "en",
                                "type": "guide"
                            }
                        ],
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "description": "Pickup included",
                        "id": "OFGq0budSAcQ",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 5-88)"
                                },
                                "id": "ATO-17a34824-0783-4d72-aeeb-8a74ba4e9abe_PRmdA59zNTh5_20241118_0000",
                                "offerItemId": "OIY65gRa2S2F",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 91.44,
                                    "currency": "EUR",
                                    "publicAmount": 91.44
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 98.53,
                                    "currency": "USD",
                                    "publicAmount": 98.53
                                },
                                "languageOption": {
                                    "__typename": "LanguageOption",
                                    "language": "en",
                                    "type": "guide"
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            }
                        ],
                        "label": "Port Elizabeth Adventure: Tuk-Tuk, Penguins, & Cape Recife",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "maxOfferItemsPerReservation": 15,
                            "minOfferItemsPerReservation": 1
                        }
                    }
                ]
            }
        ]
    }
]

2025-08-25 13:18:14,408 - evaluation_logger_Attraction-147 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring MVC 源码分析 —— 容器的初始化（二）之 Root WebApplicationContext 容器》](http://svip.iocoder.cn/Spring-MVC/context-init-Root-WebApplicationContext) 一文。

在 [《精尽 Spring MVC 源码分析 —— 容器的初始化（一）之 Servlet WebApplicationContext 容器》](http://svip.iocoder.cn/Spring-MVC/context-init-Servlet-WebApplicationContext) 中，我们已经详细分析了 Servlet WebApplicationContext 容器的初始化过程。所以，本文我们就来详细分析 Root WebApplicationContext 容器的初始化过程。

在开始之前，胖友先阅读下 [《Spring 中关于 context-param 和 init-param 的区别》](https://blog.csdn.net/slvher/article/details/41012881) 文章，了解下 `context-param` 和 `init-param` 的区别。

# 2. 环境搭建

在开始之前，胖友先搭建一个 Spring MVC 的环境。可参考 [《Spring MVC 环境搭建》](http://www.iocoder.cn/Spring-MVC/install/?self) 一文。

# 3. ContextLoaderListener

`org.springframework.web.context.ContextLoaderListener` ，实现 ServletContextListener 接口，Web 应用的监听器，主要用于初始化 Root WebApplicationContext 容器。

## 3.1 构造方法

```java
// ContextLoaderListener.java

/**
 * 创建 ContextLoaderListener 对象，并基于传入的 context 创建 Root WebApplicationContext 容器。
 *
 * @param context the application context
 */
public ContextLoaderListener(WebApplicationContext context) {
	super(context);
}

/**
 * 创建 ContextLoaderListener 对象，并基于 context 的 contextClass 类，创建 Root WebApplicationContext 容器。
 */
public ContextLoaderListener() {
}
```

- 两个构造方法，差异在于是否传入 WebApplicationContext 对象。一般情况下，我们使用**无参构造方法**。

## 3.2 contextInitialized

`#contextInitialized(ServletContextEvent event)` 方法，当 Servlet 容器启动时，触发初始化 Root WebApplicationContext 容器。代码如下：

```java
// ContextLoaderListener.java

@Override
public void contextInitialized(ServletContextEvent event) {
    // <1> 初始化 WebApplicationContext
	initWebApplicationContext(event.getServletContext());
}
```

- `<1>` 处，调用父类 ContextLoader 的 `#initWebApplicationContext(ServletContext servletContext)` 方法，初始化 WebApplicationContext 。详细解析，见 [「4. ContextLoader」](http://svip.iocoder.cn/Spring-MVC/context-init-Root-WebApplicationContext/#) 。

## 3.3 contextDestroyed

`#contextDestroyed(ServletContextEvent event)` 方法，当 Servlet 容器关闭时，触发销毁 Root WebApplicationContext 容器。代码如下：

```java
// ContextLoaderListener.java

@Override
public void contextDestroyed(ServletContextEvent event) {
    // 关闭 WebApplicationContext
	closeWebApplicationContext(event.getServletContext());
    // 进行清理
	ContextCleanupListener.cleanupAttributes(event.getServletContext());
}
```

- 两个方法，都是调用父类 ContextLoader 的方法。

# 4. ContextLoader

`org.springframework.web.context.ContextLoader` ，用于初始化 Root WebApplicationContext 容器。

## 4.1 静态属性

```java
// ContextLoader.java

/**
 * 配置参数名：Context 实现类
 */
public static final String CONTEXT_CLASS_PARAM = "contextClass";

/**
 * 配置参数名：Context 配置文件地址
 */
public static final String CONFIG_LOCATION_PARAM = "contextConfigLocation";

/**
 * 根 WebApplicationContext 在 ServletContext 中的属性名
 */
public static final String ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE = WebApplicationContext.class.getName() + ".ROOT";

/**
 * 存储创建过程中的 WebApplicationContext 对象
 *
 * 在 {@link #createWebApplicationContext(ServletContext)} 方法中，会进行设置
 */
private static final String CONTEXT_ATTRIBUTE = ContextLoader.class.getName() + ".CONTEXT";

/**
 * 是否将当前创建的 WebApplicationContext 设置到 ServletContext 中
 *
 * 在 {@link #createWebApplicationContext(ServletContext)} 方法中，会进行设置
 */
private static final AtomicBoolean active = new AtomicBoolean();
```

## 4.2 构造方法

```java
// ContextLoader.java

/**
 * 创建的 WebApplicationContext 对象
 */
@Nullable
private WebApplicationContext context;

/**
 * 创建 ContextLoader 对象
 */
public ContextLoader() {
}

/**
 * 创建 ContextLoader 对象，并设置 context 属性
 *
 * @param context the application context
 */
public ContextLoader(WebApplicationContext context) {
	this.context = context;
}
```

## 4.3 initWebApplicationContext

`#initWebApplicationContext(ServletContext servletContext)` 方法，初始化 WebApplicationContext 。代码如下：

```java
// ContextLoader.java

public WebApplicationContext initWebApplicationContext(ServletContext servletContext) {
    // <1> 如果已经存在 ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE 对应的 WebApplicationContext 对象，则抛出 IllegalStateException 异常
    if (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != null) {
        throw new IllegalStateException(
                "Cannot initialize context because there is already a root application context present - " +
                "check whether you have multiple ContextLoader* definitions in your web.xml!");
    }

    // <2> 打日志
    servletContext.log("Initializing Spring root WebApplicationContext");

    // 记录日志
    Log logger = LogFactory.getLog(ContextLoader.class);
    if (logger.isInfoEnabled()) {
        logger.info("Root WebApplicationContext: initialization started");
    }

    // <3> 记录开始时间
    long startTime = System.currentTimeMillis();

    try {
        // Store context in local instance variable, to guarantee that
        // it is available on ServletContext shutdown.
        // <4> 如果 context 为空，则进行初始化
        if (this.context == null) {
            this.context = createWebApplicationContext(servletContext);
        }
        // <5> 如果 context 是 ConfigurableWebApplicationContext 类型，如果未激活，则进行配置和刷新
        if (this.context instanceof ConfigurableWebApplicationContext) {
            ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) this.context;
            if (!cwac.isActive()) { // <5.1> 如果未激活，则进行配置
                // The context has not yet been refreshed -> provide services such as
                // setting the parent context, setting the application context id, etc
                if (cwac.getParent() == null) {
                    // The context instance was injected without an explicit parent ->
                    // determine parent for root web application context, if any.
                    // <5.2> 父容器的初始化，在 Spring MVC 中基本用不到
                    ApplicationContext parent = loadParentContext(servletContext);
                    cwac.setParent(parent);
                }
                // <5.3> 配置并刷新 WebApplicationContext
                configureAndRefreshWebApplicationContext(cwac, servletContext);
            }
        }
        // <6> 将 WebApplicationContext 设置到 servletContext 中
        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context);

        // <7> 将当前 WebApplicationContext 设置到 currentContextPerThread 中
        ClassLoader ccl = Thread.currentThread().getContextClassLoader();
        if (ccl == ContextLoader.class.getClassLoader()) {
            currentContext = this.context;
        } else if (ccl != null) {
            currentContextPerThread.put(ccl, this.context);
        }

        // <8> 打日志
        if (logger.isInfoEnabled()) {
            long elapsedTime = System.currentTimeMillis() - startTime;
            logger.info("Root WebApplicationContext initialized in " + elapsedTime + " ms");
        }

        // <9> 返回 WebApplicationContext 对象
        return this.context;
    } catch (RuntimeException | Error ex) {
        logger.error("Context initialization failed", ex);
        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);
        throw ex;
    }
}
```

- `<1>` 处，如果已经存在 `ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE` 对应的 WebApplicationContext 对象，则抛出 IllegalStateException 异常。也就是说，Root WebApplicationContext 容器只能有一个。
- `<2>` 处，打日志。
- `<3>` 处，记录开始时间。
- `<4>` 处，如果 `context` 为空，则调用 `#createWebApplicationContext(ServletContext servletContext)` 方法，创建 WebApplicationContext 对象。详细解析，见 [「4.4 createWebApplicationContext」](http://svip.iocoder.cn/Spring-MVC/context-init-Root-WebApplicationContext/#) 。
- `<5>` 处，如果 `context` 是 ConfigurableWebApplicationContext 类型，如果未激活，则进行配置和刷新。
  - `<5.1>` 处，如果未激活，则进行配置。
  - `<5.2>` 处，父容器的初始化，在 Spring MVC 中基本用不到。详细解析，见 [「4.5 loadParentContext」](http://svip.iocoder.cn/Spring-MVC/context-init-Root-WebApplicationContext/#) 。
  - `<5.3>` 处，调用 `#configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc)` 方法，配置并刷新 WebApplicationContext 。详细解析，见 [「4.6 configureAndRefreshWebApplicationContext」](http://svip.iocoder.cn/Spring-MVC/context-init-Root-WebApplicationContext/#) 。
- `<6>` 处，将 WebApplicationContext 设置到 `servletContext` 中。
- `<7>` 处，将当前 WebApplicationContext 设置到 `currentContextPerThread` 中。这块逻辑，和 Spring MVC 关系不大，可以无视。
- `<8>` 处，打日志。
- `<9>` 处，返回 WebApplicationContext 对象。

## 4.4 createWebApplicationContext

`#createWebApplicationContext(ServletContext sc)` 方法，创建 WebApplicationContext 对象。代码如下：

```java
// ContextLoader.java

protected WebApplicationContext createWebApplicationContext(ServletContext sc) {
    // <1> 获得 context 的类
    Class<?> contextClass = determineContextClass(sc);
    // <2> 判断 contextClass 类型
    if (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) {
        throw new ApplicationContextException("Custom context class [" + contextClass.getName() +
                "] is not of type [" + ConfigurableWebApplicationContext.class.getName() + "]");
    }
    // <3> 创建 contextClass 对应的对象
    return (ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);
}
```

- `<1>` 处，调用 `#determineContextClass(ServletContext servletContext)` 方法，获得 context 的类。详细解析，见 [「4.4.1 determineContextClass」](http://svip.iocoder.cn/Spring-MVC/context-init-Root-WebApplicationContext/#) 。
- `<2>` 处，判断 `contextClass` 类型，必须是 ConfigurableWebApplicationContext 类型。
- `<3>` 处，创建 `contextClass` 对应的对象。

### 4.4.1 determineContextClass

`#determineContextClass(ServletContext servletContext)` 方法，获得 context 的类。代码如下：

```java
// ContextLoader.java

protected Class<?> determineContextClass(ServletContext servletContext) {
    // 获得 servletContext 的 contextClass 属性
    String contextClassName = servletContext.getInitParameter(CONTEXT_CLASS_PARAM);
    // 如果配置了，则使用该配置的
    if (contextClassName != null) {
        try {
            return ClassUtils.forName(contextClassName, ClassUtils.getDefaultClassLoader());
        } catch (ClassNotFoundException ex) {
            throw new ApplicationContextException(
                    "Failed to load custom context class [" + contextClassName + "]", ex);
        }
    // 如果未配置，则使用默认的
    } else {
        // 使用默认的 CONTEXT_CLASS 类
        contextClassName = defaultStrategies.getProperty(WebApplicationContext.class.getName());
        try {
            return ClassUtils.forName(contextClassName, ContextLoader.class.getClassLoader());
        } catch (ClassNotFoundException ex) {
            throw new ApplicationContextException(
                    "Failed to load default context class [" + contextClassName + "]", ex);
        }
    }
}
```

- 优先，从 `servletContext` 的 `contextClass` 配置项中获取。如果获取到，则使用该配置的类。
- 如果未配置，则使用默认的 `CONTEXT_CLASS` 类。而默认的 `CONTEXT_CLASS` 类，在 `ContextLoader.properties` 配置文件中。代码如下：

```properties
org.springframework.web.context.WebApplicationContext=org.springframework.web.context.support.XmlWebApplicationContext
```

- 即，默认使用 XmlWebApplicationContext 类。

## 4.5 loadParentContext

`#loadParentContext(ServletContext servletContext)` 方法，加载父容器。代码如下：

```java
// ContextLoader.java

@Nullable
protected ApplicationContext loadParentContext(ServletContext servletContext) {
    // 获得 context 的类
	ApplicationContext parentContext = null;
    // 获得 servletContext 的 locatorFactorySelector 属性
	String locatorFactorySelector = servletContext.getInitParameter(ContextLoader.LOCATOR_FACTORY_SELECTOR_PARAM);
    // 获得 servletContext 的 parentContextKey 属性
	String parentContextKey = servletContext.getInitParameter(ContextLoader.LOCATOR_FACTORY_KEY_PARAM);
	// 如果两个都不为空，则进行加载父容器
	if (locatorFactorySelector != null || parentContextKey != null) {
		// Actually, this will still only work for ContextLoader (not custom loaders)
		// 目前，这仍然仅适用于ContextLoader（不适用于自定义加载器）
		// 但是，实际目前这两个参数，都是不存在的，所以可以暂时忽略
		// 具体，可参见 https://jira.spring.io/browse/SPR-4379 讨论
		if (locatorFactorySelector == null) {
			locatorFactorySelector = defaultStrategies.getProperty(ContextLoader.LOCATOR_FACTORY_SELECTOR_PARAM);
		}
		if (parentContextKey == null) {
			parentContextKey = defaultStrategies.getProperty(ContextLoader.LOCATOR_FACTORY_KEY_PARAM);
		}
		// The parent context should be a local JNDI Environment,
		// so define it in the environment of the current context.
		// 创建 JndiLocatorDelegate 对象
		JndiLocatorDelegate jndiLocator = new JndiLocatorDelegate();
		if (locatorFactorySelector != null) {
			jndiLocator.setResourceRef(true);
		}
		try {
			// Use the selector and the context key to load the parent context from JNDI
			// 使用选择器和上下文键从JNDI加载父上下文
			Object located = jndiLocator.lookup(locatorFactorySelector, parentContextKey);
			if (located == null) {
				throw new ApplicationContextException(
						"Parent context key: '" + parentContextKey + "' not found in JNDI with selector: '" +
						locatorFactorySelector + "'");
			}
			if (!(located instanceof ApplicationContext)) {
				throw new ApplicationContextException(
						"Parent context key: '" + parentContextKey + "' in JNDI with selector: '" +
						locatorFactorySelector + "' is not of type ApplicationContext: " + located.getClass().getName());
			}
			parentContext = (ApplicationContext) located;
		} catch (NamingException ex) {
			throw new ApplicationContextException(
					"Parent context key: '" + parentContextKey + "' not found in JNDI with selector: '" +
					locatorFactorySelector + "'", ex);
		}
	}
	return parentContext;
}
```

- 这块逻辑，基本用不到，所以可以暂时无视。感兴趣的胖友，可以看看 [《Spring 中关于 context-param 和 init-param 的区别》](https://blog.csdn.net/slvher/article/details/41012881) 文章。

## 4.6 configureAndRefreshWebApplicationContext

`#configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc)` 方法，配置并刷新 WebApplicationContext 。代码如下：

```java
// ContextLoader.java

protected void configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc) {
    // <1> 如果 wac 使用了默认的编号，则重新设置 id 属性
    if (ObjectUtils.identityToString(wac).equals(wac.getId())) {
        // The application context id is still set to its original default value
        // -> assign a more useful id based on available information
        // 情况一，使用 servletContext 的 contextId 属性
        String id = sc.getInitParameter(CONTEXT_ID_PARAM);
        if (id != null) {
            wac.setId(id);
        // 情况二，自动生成
        } else {
            // Generate default id...
            wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX +
                    ObjectUtils.getDisplayString(sc.getContextPath()));
        }
    }

    // <2> 设置 wac 的 servletContext 属性
    wac.setServletContext(sc);
    // <3> 获得 contextConfigLocation 配置，即 Spring 配置文件的地址
    String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM);
    if (configLocationParam != null) {
        wac.setConfigLocation(configLocationParam);
    }

    // The wac environment's #initPropertySources will be called in any case when the context
    // is refreshed; do it eagerly here to ensure servlet property sources are in place for
    // use in any post-processing or initialization that occurs below prior to #refresh
    // <4> 获得环境变量


2025-08-25 13:18:21,649 - evaluation_logger_Attraction-147 - INFO - Complete Result: {'score': 0, 'reason': 'The response does not address any of the requested information about penguin activities or ticket availability in Cape Town or Port Elizabeth.'}
2025-08-25 13:18:27,891 - evaluation_logger_Attraction-147 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:18:27,891 - evaluation_logger_Attraction-147 - INFO - Message: Success.
2025-08-25 13:18:27,891 - evaluation_logger_Attraction-147 - INFO - Success turn num = 4
2025-08-25 13:18:27,891 - evaluation_logger_Attraction-147 - INFO - ----------------------------------------------------------------------------------------------------
