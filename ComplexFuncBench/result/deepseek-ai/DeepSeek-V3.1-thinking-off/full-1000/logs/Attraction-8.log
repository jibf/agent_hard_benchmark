2025-08-25 12:53:26,097 - evaluation_logger_Attraction-8 - INFO - Test Example Attraction-8
2025-08-25 12:53:26,097 - evaluation_logger_Attraction-8 - INFO - Query: Check out the most trending tourist spots in Montreal for my family trip.
2025-08-25 12:53:33,656 - evaluation_logger_Attraction-8 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Montreal"
        }
    }
]

2025-08-25 12:53:33,656 - evaluation_logger_Attraction-8 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Montreal"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi01Njk1NDF9",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:33,656 - evaluation_logger_Attraction-8 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Montreal'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Montreal'}}
2025-08-25 12:53:33,656 - evaluation_logger_Attraction-8 - INFO - Rule-based compare success.
2025-08-25 12:53:33,656 - evaluation_logger_Attraction-8 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Montreal'}}]
2025-08-25 12:53:33,656 - evaluation_logger_Attraction-8 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJUOFdjQnZJWlhsIiwidWZpIjotNTY5NTQxfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Transfert privé de la ville de Montréal à l'aéroport de Montréal (YUL)",
                    "productId": "PRT8WcBvIZXl",
                    "productSlug": "prt8wcbvizxl-private-transfer-from-montreal-city-to-montreal-yul-airport",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -569541,
                    "cityName": "Montréal",
                    "countryCode": "ca"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJxVFVMdTNPNzREIiwidWZpIjotNTY5NTQxfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Visite Queerstory de Montréal",
                    "productId": "PRqTULu3O74D",
                    "productSlug": "prqtulu3o74d-montreal-queerstory-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -569541,
                    "cityName": "Montréal",
                    "countryCode": "ca"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJIR0lHSWZiSTJJIiwidWZpIjotNTY5NTQxfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Visite de la ville de Montréal",
                    "productId": "PRHGIGIfbI2I",
                    "productSlug": "prhgigifbi2i-montreal-city-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -569541,
                    "cityName": "Montréal",
                    "countryCode": "ca"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJsUllUbEhHSkNzIiwidWZpIjotNTY5NTQxfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Chasse au trésor autoguidée à Montréal : les merveilles culturelles de Montréal",
                    "productId": "PRlRYTlHGJCs",
                    "productSlug": "prlrytlhgjcs-montreal-scavenger-hunt-tour",
                    "taxonomySlug": "tours",
                    "cityUfi": -569541,
                    "cityName": "Montréal",
                    "countryCode": "ca"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFJsNWtocGxoMEt4IiwidWZpIjotNTY5NTQxfQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Montréal : expérience de quête d'interdiction",
                    "productId": "PRl5khplh0Kx",
                    "productSlug": "prl5khplh0kx-montreal-prohibition-era-outdoor-escape-game",
                    "taxonomySlug": "tours",
                    "cityUfi": -569541,
                    "cityName": "Montréal",
                    "countryCode": "ca"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi01Njk1NDF9",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -569541,
                    "country": "Canada",
                    "cityName": "Montréal",
                    "productCount": 146,
                    "cc1": "ca"
                }
            ]
        }
    }
]

2025-08-25 12:53:44,610 - evaluation_logger_Attraction-8 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi01Njk1NDF9",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:44,611 - evaluation_logger_Attraction-8 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi01Njk1NDF9",
            "sortBy": "trending"
        }
    }
]

2025-08-25 12:53:44,611 - evaluation_logger_Attraction-8 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi01Njk1NDF9', 'sortBy': 'trending'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi01Njk1NDF9', 'sortBy': 'trending'}}
2025-08-25 12:53:44,611 - evaluation_logger_Attraction-8 - INFO - Rule-based compare success.
2025-08-25 12:53:44,611 - evaluation_logger_Attraction-8 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi01Njk1NDF9', 'sortBy': 'trending'}}]
2025-08-25 12:53:44,611 - evaluation_logger_Attraction-8 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRHicIYAv9Wg",
                    "name": "Croisière sur le fleuve Saint-Laurent",
                    "slug": "prhiciyav9wg-saint-lawrence-river-cruise",
                    "shortDescription": "Faites une balade en bateau pour admirer Montréal depuis le fleuve Saint-Laurent",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 44.56,
                        "currency": "USD",
                        "publicAmount": 44.56
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 54,
                        "percentage": "87%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.1,
                            "total": 78
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Montréal",
                        "ufi": -569541
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvHSPTNnZtC"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUHhyUv8dSQ"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI62OMstmLYZ"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI3NPZ6lRZ4l"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OImHo3JhZOLj"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI210x83JHDW"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI0GCdg3VtD0"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OITGXV18It3W"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIOG9p7P7fU3"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvQtY7d3Qhc"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIsu6xaUHv1U"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PR8pXs42umTY",
                    "name": "La Grande Roue de Montréal Ferris Wheel",
                    "slug": "pr8pxs42umty-la-grande-roue-de-montreal-ferris-wheel",
                    "shortDescription": "Accès à une grande roue atteignant des hauteurs de 60 mètres au-dessus des toits de Montréal",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 22.61,
                        "currency": "USD",
                        "publicAmount": 22.61
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.6,
                            "total": 23
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Montréal",
                        "ufi": -569541
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI4FwiWR1YoB"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIzOWYLnJueb"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OItD2OZYDOfA"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIM38aw7dSnh"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIVzALHomD1s"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRlY7jT7nJwT",
                    "name": "Ticket de bus à montée et descente libres valable 2 jours",
                    "slug": "prly7jt7njwt-two-day-hop-on-hop-off-bus-tour-ticket",
                    "shortDescription": "Activité à bord d'un bus à impériale avec arrêts illimités pendant 2 jours",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 48.31,
                        "currency": "USD",
                        "publicAmount": 48.31
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 63,
                        "percentage": "90%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.2,
                            "total": 45
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Montréal",
                        "ufi": -569541
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIfM0rbsFaKM"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIUd2dhNrOoL"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI74cuAOxljw"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIh1xBkvrpHf"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIe6Yr1TG008"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIcthGNh8qQM"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIxpnt9I0RAr"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRu0Uxjwaj8"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRl7Z1YdSV0m",
                    "name": "Croisière de 1 heure et demie avec brunch de 3 plats",
                    "slug": "prl7z1ydsv0m-15-hour-cruise-with-three-course-brunch",
                    "shortDescription": "Une croisière sur le fleuve Saint-Laurent",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 81.16,
                        "currency": "USD",
                        "publicAmount": 81.16
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 10,
                        "percentage": "80%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.2,
                            "total": 11
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Montréal",
                        "ufi": -569541
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIySe5g7UmIc"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIISUZe0HMJJ"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIOtbzehdkll"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIvRXI0RU6ec"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OImNwejaZKlK"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIKHUbUPNNO3"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIPo2fvwqf97"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 6
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRzsdpiPALvf",
                    "name": "Chasse au trésor de Montréal et visite autoguidée des points forts",
                    "slug": "przsdpipalvf-montreal-scavenger-hunt-and-walking-tour",
                    "shortDescription": "Utilisez des indices à chaque attraction pour trouver votre prochaine destination et mettez-vous ...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 8.93,
                        "currency": "USD",
                        "publicAmount": 8.93
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 3.2,
                            "total": 6
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Montréal",
                        "ufi": -569541
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIgBGmuZArh8"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 144,
                "filteredProductCount": 144
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Nos préférés",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Les plus populaires",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Tarif le plus bas",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Nos préférés",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Visites touristiques",
                        "tagname": "tours",
                        "productCount": 127
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Activités",
                        "tagname": "activities",
                        "productCount": 11
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Transferts et services",
                        "tagname": "transfers-services",
                        "productCount": 2
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Attractions",
                        "tagname": "attractions",
                        "productCount": 1
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Lieux d'intérêt",
                        "tagname": "landmarks",
                        "productCount": 1
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Annulation gratuite",
                        "tagname": "free_cancellation",
                        "productCount": 127
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Montréal",
                        "tagname": "-569541",
                        "productCount": 144
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 18
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 26
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 35
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 19
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 50
                    }
                ]
            }
        }
    }
]

2025-08-25 12:55:53,334 - evaluation_logger_Attraction-8 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring Boot 源码分析 —— SpringApplication》](http://svip.iocoder.cn/Spring-Boot/SpringApplication/) 的**初始化**的源码解析。

在 SpringApplication 的构造方法中，会进行一些初始化的工作。虽然说，它没有向 Spring 容器中添加 Bean 之类的操作，但是它会进行一些必要的初始化的逻辑，例如说，决定 Web 应用类型、设置初始化器( Initializer )、设置监听器( Listener ) 等等。

# 2. SpringApplication

`org.springframework.boot.SpringApplication` ，Spring 应用启动器。正如其代码注释所形容的，它提供启动 Spring 应用的功能，来自一个 Java Main 方法。

## 2.1 构造方法

构造方法，代码如下：

```java
// SpringApplication.java

/**
 * 资源加载器
 */
private ResourceLoader resourceLoader;
/**
 * 主要的 Java Config 类们
 */
private Set<Class<?>> primarySources;
/**
 * Web 应用类型
 */
private WebApplicationType webApplicationType;
/**
 * 初始化器们
 */
private List<ApplicationContextInitializer<?>> initializers;
/**
 * 监听器们
 */
private List<ApplicationListener<?>> listeners;

public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
    this.resourceLoader = resourceLoader;
    Assert.notNull(primarySources, "PrimarySources must not be null");
    this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
    // <1> 决定 Web 应用类型
    this.webApplicationType = WebApplicationType.deduceFromClasspath();
    // <2> 设置初始化器
    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
    // <3> 设置监听器
    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
    // <4> 设置主类
    this.mainApplicationClass = deduceMainApplicationClass();
}
```

`resourceLoader` 属性，资源加载器。可以暂时不理解，后续文章会详细解析。

`primarySources` 属性，主要的 Java Config 类们。在文初的示例中，就是 DemoApplication 类。

`webApplicationType` 属性，Web 应用类型。一共有三种，在 `org.springframework.boot.WebApplicationType` 枚举类中，分别是：

- `NONE` ：非 Web 类型。
- `SERVLET` ：基于 Servlet 的 Web 类型。
- `REACTIVE` ：基于 Reactive 的 Web 类型。

`initializers` 属性，ApplicationContextInitializer 数组。ApplicationContextInitializer 是 Spring 框架的接口，主要目的是允许用户在 ConfigurableApplicationContext 类型（或者子类型）的 ApplicationContext 做 refresh 方法调用前的初始化。所以，ApplicationContextInitializer 的调用时机，是在 ConfigurableApplicationContext#refresh() 方法之前。关于 ConfigurableApplicationContext 类，可以看看 [《【死磕 Spring】—— IoC 之深入分析 ApplicationContext》](http://svip.iocoder.cn/Spring/IoC-ApplicationContext/) 文章。

`listeners` 属性，ApplicationListener 数组。ApplicationListener 是 Spring 框架的事件监听器接口，具体的使用，可以看看 [《【死磕 Spring】—— IoC 之深入分析 ApplicationListener》](http://svip.iocoder.cn/Spring/IoC-ApplicationListener/) 文章。

`mainApplicationClass` 属性，调用方的主类。例如说，在文初的示例中，就是 DemoApplication 类。

`<1>` 处，调用 `WebApplicationType#deduceFromClasspath()` 方法，决定 Web 应用类型。详细解析，见 [「2.2 deduceFromClasspath」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

`<2>` 处，调用 `#getSpringFactoriesInstances(Class<T> type)` 方法，获得对应的 ApplicationContextInitializer 类型的实现类的数组，然后调用 `#setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers)` 方法，进行设置。详细解析，见 [「2.3 getSpringFactoriesInstances」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 和 [「2.4 setInitializers」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

`<3>` 处，调用 `#getSpringFactoriesInstances(Class<T> type)` 方法，获得对应的 ApplicationListener 类型的实现类的数组，然后调用 `#setListeners(Collection<? extends ApplicationListener<?>> listeners)` 方法，进行设置。详细解析，见 [「2.3 getSpringFactoriesInstances」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 和 [「2.5 setListeners」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

`<4>` 处，调用 `#deduceMainApplicationClass()` 方法，获得调用方的主类。详细解析，见 [「2.6 deduceMainApplicationClass」](http://svip.iocoder.cn/Spring-Boot/SpringApplication/#) 。

## 2.2 deduceFromClasspath

`WebApplicationType#deduceFromClasspath()` 方法，决定 Web 应用类型。代码如下：

```java
// WebApplicationType.java

private static final String[] SERVLET_INDICATOR_CLASSES = { "javax.servlet.Servlet",
		"org.springframework.web.context.ConfigurableWebApplicationContext" };

private static final String WEBMVC_INDICATOR_CLASS = "org.springframework.web.servlet.DispatcherServlet";
private static final String WEBFLUX_INDICATOR_CLASS = "org.springframework.web.reactive.DispatcherHandler";
private static final String JERSEY_INDICATOR_CLASS = "org.glassfish.jersey.servlet.ServletContainer";

static WebApplicationType deduceFromClasspath() {
    // 如果存在 REACTIVE 相关的类，则返回 REACTIVE
	if (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, null) && !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, null)
			&& !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, null)) {
		return WebApplicationType.REACTIVE;
	}
    // 如果不存在 SERVLET 相关的类，则返回 NONE
	for (String className : SERVLET_INDICATOR_CLASSES) {
		if (!ClassUtils.isPresent(className, null)) {
			return WebApplicationType.NONE;
		}
	}
    // 否则，返回 SERVLET
	return WebApplicationType.SERVLET;
}
```

逻辑比较简单，根据类路径上是否存在对应的类，来决定 Web 应用类型。

## 2.3 getSpringFactoriesInstances

`#getSpringFactoriesInstances(Class<T> type)` 方法，获得对应的类型的实现类的数组。代码如下：

```java
// SpringApplication.java

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type) {
	return getSpringFactoriesInstances(type, new Class<?>[] {});
}

private <T> Collection<T> getSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, Object... args) {
	ClassLoader classLoader = getClassLoader();
	// Use names and ensure unique to protect against duplicates
    // <1> 加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组
	Set<String> names = new LinkedHashSet<>(SpringFactoriesLoader.loadFactoryNames(type, classLoader));
    // <2> 创建对象们
	List<T> instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);
    // <3> 排序
	AnnotationAwareOrderComparator.sort(instances);
	return instances;
}
```

`<1>` 处，调用 `SpringFactoriesLoader#loadFactoryNames(Class<?> factoryClass, ClassLoader classLoader)` 方法，加载指定类型对应的，在 `META-INF/spring.factories` 里的类名的数组。

关于 SpringFactoriesLoader 的详细解析，见 [《精尽 Spring Boot 源码分析 —— SpringFactoriesLoader》](http://svip.iocoder.cn/Spring-Boot/SpringFactoriesLoader/) 文章。

`<2>` 处，调用 `#createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes, ClassLoader classLoader, Object[] args, Set<String> names)` 方法，创建对象们。代码如下：

```java
// SpringApplication.java

@SuppressWarnings("unchecked")
private <T> List<T> createSpringFactoriesInstances(Class<T> type, Class<?>[] parameterTypes,
		ClassLoader classLoader, Object[] args, Set<String> names) {
	List<T> instances = new ArrayList<>(names.size());
	for (String name : names) {
		try {
			Class<?> instanceClass = ClassUtils.forName(name, classLoader);
			Assert.isAssignable(type, instanceClass);
			Constructor<?> constructor = instanceClass.getDeclaredConstructor(parameterTypes);
			T instance = (T) BeanUtils.instantiateClass(constructor, args);
			instances.add(instance);
		} catch (Throwable ex) {
			throw new IllegalArgumentException("Cannot instantiate " + type + " : " + name, ex);
		}
	}
	return instances;
}
```

- 通过反射，创建对象。

`<3>` 处，调用 `AnnotationAwareOrderComparator#sort(List<?> list)` 方法，排序对象们。因为 `@Order` 注解可以标记排序，所以需要排序。关于 `@Order` 注解，可以看看 [《Spring 注解 @Order 作用》](https://www.jianshu.com/p/62e9a9336d46) 文章。

## 2.4 setInitializers

`#setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers)` 方法，设置初始化器们。代码如下：

```java
// SpringApplication.java

public void setInitializers(Collection<? extends ApplicationContextInitializer<?>> initializers) {
	this.initializers = new ArrayList<>();
	this.initializers.addAll(initializers);
}
```

## 2.5 setListeners

`#setListeners(Collection<? extends ApplicationListener<?>> listeners)` 方法，设置监听器们。代码如下：

```java
// SpringApplication.java

public void setListeners(Collection<? extends ApplicationListener<?>> listeners) {
	this.listeners = new ArrayList<>();
	this.listeners.addAll(listeners);
}
```

## 2.6 deduceMainApplicationClass

`#deduceMainApplicationClass()` 方法，获得调用方的主类。代码如下：

```java
// SpringApplication.java

private Class<?> deduceMainApplicationClass() {
	try {
		// 获得当前 StackTraceElement 数组
		StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();
		// 遍历 StackTraceElement 数组，找到主类
		for (StackTraceElement stackTraceElement : stackTrace) {
			if ("main".equals(stackTraceElement.getMethodName())) {
				return Class.forName(stackTraceElement.getClassName());
			}
		}
	} catch (ClassNotFoundException ex) {
		// Swallow and continue
	}
	return null;
}
```

- 通过异常的方式，获取当前 StackTraceElement 数组，然后遍历数组，找到方法名为 `"main"` 的 StackTraceElement 元素，从而获得主类。

# 3. 小结

至此，SpringApplication 的初始化完成。后续，我们开始看看 `#run(String... args)` 方法的执行。

另外，本文涉及的类，在 `spring-boot` 项目下的 `spring-boot/src/main/java/org/springframework/boot` 包下，如下图所示：[![`spring-boot` 项目](http://static.iocoder.cn/images/Spring-Boot/2021-01-07/01.jpg)](http://static.iocoder.cn/images/Spring-Boot/2021-01-07/01.jpg)`spring-boot` 项目

2025-08-25 12:55:59,073 - evaluation_logger_Attraction-8 - INFO - Complete Result: {'score': 0, 'reason': 'no requested information is addressed'}
2025-08-25 12:56:05,508 - evaluation_logger_Attraction-8 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 12:56:05,508 - evaluation_logger_Attraction-8 - INFO - Message: Success.
2025-08-25 12:56:05,508 - evaluation_logger_Attraction-8 - INFO - Success turn num = 2
2025-08-25 12:56:05,508 - evaluation_logger_Attraction-8 - INFO - ----------------------------------------------------------------------------------------------------
