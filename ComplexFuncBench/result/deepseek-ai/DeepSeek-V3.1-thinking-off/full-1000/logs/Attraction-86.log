2025-08-25 13:05:32,258 - evaluation_logger_Attraction-86 - INFO - Test Example Attraction-86
2025-08-25 13:05:32,258 - evaluation_logger_Attraction-86 - INFO - Query: Check the ticket availability for the top-rated tourist attraction in Porto on December 1, 2024, and provide detailed information about it.
2025-08-25 13:05:42,440 - evaluation_logger_Attraction-86 - INFO - Function Calls: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Porto"
        }
    }
]

2025-08-25 13:05:42,440 - evaluation_logger_Attraction-86 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attraction_Location",
        "arguments": {
            "query": "Porto"
        }
    },
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yMTczMDg4fQ==",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 13:05:42,440 - evaluation_logger_Attraction-86 - INFO - Start compare_single_call: 
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Porto'}}
{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Porto'}}
2025-08-25 13:05:42,440 - evaluation_logger_Attraction-86 - INFO - Rule-based compare success.
2025-08-25 13:05:42,440 - evaluation_logger_Attraction-86 - INFO - Success matched: [{'name': 'Search_Attraction_Location', 'arguments': {'query': 'Porto'}}]
2025-08-25 13:05:42,441 - evaluation_logger_Attraction-86 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "products": [
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI2OFpNdWp1d0hCIiwidWZpIjotMTEyMjk4fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Transfer from Trieste Airport to Portorož",
                    "productId": "PR68ZMujuwHB",
                    "productSlug": "pr68zmujuwhb-transfer-from-trieste-airport-to-portoroz",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -112298,
                    "cityName": "Buia",
                    "countryCode": "it"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI5OFFiNjhmSXJqIiwidWZpIjotODUwNzB9",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Transfer from Portorož to Malpensa Airport in Milano",
                    "productId": "PR98Qb68fIrj",
                    "productSlug": "pr98qb68firj-transfer-from-portoroz-to-malpensa-airport-in-milano",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -85070,
                    "cityName": "Koper",
                    "countryCode": "si"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFIwY2ZCaXphMGlNIiwidWZpIjotMTMyMDA3fQ==",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Airport Transfer from Venice Airport to Portorož",
                    "productId": "PR0cfBiza0iM",
                    "productSlug": "pr0cfbiza0im-airport-transfer-from-venice-airport-to-portoroz",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -132007,
                    "cityName": "Venice",
                    "countryCode": "it"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI1enp0dE5OZGNmIiwidWZpIjotODUwNzB9",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Discover Istria from Portorož - Private Tour",
                    "productId": "PR5zzttNNdcf",
                    "productSlug": "pr5zzttnndcf-private-istria-tour-from-portoroz",
                    "taxonomySlug": "tours",
                    "cityUfi": -85070,
                    "cityName": "Koper",
                    "countryCode": "si"
                },
                {
                    "id": "eyJwaW5uZWRQcm9kdWN0IjoiUFI2QXFjNnNvankyIiwidWZpIjotOTQ1OTl9",
                    "__typename": "AttractionsSearchProductSuggestion",
                    "title": "Small-Group Transfer from Ljubljana Airport to Portorož",
                    "productId": "PR6Aqc6sojy2",
                    "productSlug": "pr6aqc6sojy2-small-group-transfer-from-ljubljana-airport-to-portoroz",
                    "taxonomySlug": "transfers-services",
                    "cityUfi": -94599,
                    "cityName": "Rove",
                    "countryCode": "si"
                }
            ],
            "destinations": [
                {
                    "id": "eyJ1ZmkiOi0yMTczMDg4fQ==",
                    "__typename": "AttractionsSearchDestinationSuggestion",
                    "ufi": -2173088,
                    "country": "Portugal",
                    "cityName": "Porto",
                    "productCount": 877,
                    "cc1": "pt"
                }
            ]
        }
    }
]

2025-08-25 13:05:53,638 - evaluation_logger_Attraction-86 - INFO - Function Calls: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yMTczMDg4fQ==",
            "sortBy": "attr_book_score"
        }
    }
]

2025-08-25 13:05:53,638 - evaluation_logger_Attraction-86 - INFO - Golden Function Call: 
[
    {
        "name": "Search_Attractions",
        "arguments": {
            "id": "eyJ1ZmkiOi0yMTczMDg4fQ==",
            "sortBy": "attr_book_score"
        }
    },
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show",
            "date": "2024-12-01"
        }
    },
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show"
        }
    }
]

2025-08-25 13:05:53,638 - evaluation_logger_Attraction-86 - INFO - Start compare_single_call: 
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yMTczMDg4fQ==', 'sortBy': 'attr_book_score'}}
{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yMTczMDg4fQ==', 'sortBy': 'attr_book_score'}}
2025-08-25 13:05:53,638 - evaluation_logger_Attraction-86 - INFO - Rule-based compare success.
2025-08-25 13:05:53,638 - evaluation_logger_Attraction-86 - INFO - Success matched: [{'name': 'Search_Attractions', 'arguments': {'id': 'eyJ1ZmkiOi0yMTczMDg4fQ==', 'sortBy': 'attr_book_score'}}]
2025-08-25 13:05:53,638 - evaluation_logger_Attraction-86 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProductSearchResponse",
            "products": [
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRZgaFs5MYgZ",
                    "name": "Casa Da Guitarra Porto Fado Show",
                    "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show",
                    "shortDescription": "A chance to enjoy a fado performance and enjoy a glass of port wine",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 20.47,
                        "currency": "USD",
                        "publicAmount": 20.47
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 536,
                        "percentage": "99%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.8,
                            "total": 915
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Porto",
                        "ufi": -2173088
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIccq1wULT9x"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIgU0iY5H8sG"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIzYzmZJdHOk"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIOETNrCsfht"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIrr2iAzbPA1"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 4
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForActivities",
                            "value": true,
                            "rank": 1
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "highlyRated",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRt42G7lDMwp",
                    "name": "Porto Walking Tour - The Perfect Introduction to the City",
                    "slug": "prt42g7ldmwp-porto-walking-tour-the-perfect-introduction-to-the-city",
                    "shortDescription": "With this ticket you have access to our incredible free walking tour. This not an ordinary tour. ...",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 1.08,
                        "currency": "USD",
                        "publicAmount": 1.08
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.5,
                            "total": 971
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Porto",
                        "ufi": -2173088
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI75ckYZSx3q"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIpJV7OSL5Iu"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIMOZGwGGVNI"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 2
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRve1Cz4S70n",
                    "name": "Porto Cathedral Admission",
                    "slug": "prve1cz4s70n-porto-cathedral-admission",
                    "shortDescription": "A chance to explore the historic Porto Cathedral",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 3.23,
                        "currency": "USD",
                        "publicAmount": 3.23
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 4.3,
                            "total": 357
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Porto",
                        "ufi": -2173088
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIk8tygPQ3BX"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI7b3rNxEDM2"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OINfalKDnwGX"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestseller",
                            "value": true,
                            "rank": 3
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRsVW7qTNOcC",
                    "name": "24, 48, 72 or 96-hour Porto Card",
                    "slug": "prsvw7qtnocc-24-48-72-or-96-hour-porto-card",
                    "shortDescription": "A sightseeing pass to explore the city, with access to free transportation, attractions and discounts",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 8.08,
                        "currency": "USD",
                        "publicAmount": 8.08
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 165,
                        "percentage": "68%",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 3.5,
                            "total": 517
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Porto",
                        "ufi": -2173088
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIPTWnUclq1I"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIL3NTjGIkIV"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIuZyMabt6nq"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIyLdPU5EmTB"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIbxpH3Stf6g"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIzBNvtJOH0R"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIT7MMiYhLzn"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1IzcTc4tUu"
                                }
                            ]
                        },
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI3b3xrCbMlE"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIZqOPa8XLwc"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    },
                    "flags": [
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInMonth",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerInWeek",
                            "value": true,
                            "rank": 2
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerOnWeekends",
                            "value": true,
                            "rank": 3
                        },
                        {
                            "__typename": "AttractionsProductFlags",
                            "flag": "bestsellerForTransfersServices",
                            "value": true,
                            "rank": 1
                        }
                    ]
                },
                {
                    "__typename": "AttractionsProduct",
                    "cancellationPolicy": {
                        "__typename": "AttractionsCancellationPolicy",
                        "hasFreeCancellation": true
                    },
                    "id": "PRLp3zq0PBwJ",
                    "name": "SEA LIFE Aquarium Admission",
                    "slug": "prlp3zq0pbwj-sea-life-aquarium-admission",
                    "shortDescription": "A chance to observe marine life at Porto's SEA LIFE Aquarium",
                    "representativePrice": {
                        "__typename": "AttractionsPrice",
                        "chargeAmount": 19.34,
                        "currency": "USD",
                        "publicAmount": 19.34
                    },
                    "reviewsStats": {
                        "__typename": "AttractionsProductReviewStats",
                        "allReviewsCount": 0,
                        "percentage": "0",
                        "combinedNumericStats": {
                            "__typename": "AttractionsProductCombinedReviewStats",
                            "average": 3.5,
                            "total": 24
                        }
                    },
                    "ufiDetails": {
                        "__typename": "AttractionLocationResponse",
                        "bCityName": "Porto",
                        "ufi": -2173088
                    },
                    "offers": [
                        {
                            "__typename": "Offer",
                            "items": [
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIRKtX70T37e"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OIFquDR6bhcI"
                                },
                                {
                                    "__typename": "OfferItem",
                                    "id": "OI1ZELe3J9kt"
                                }
                            ]
                        }
                    ],
                    "supportedFeatures": {
                        "__typename": "AttractionsProductSupportedFeatures",
                        "nativeApp": true
                    }
                }
            ],
            "filterStats": {
                "__typename": "FilterStats",
                "unfilteredProductCount": 883,
                "filteredProductCount": 883
            },
            "sorters": [
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Our top picks",
                    "value": "trending"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Most popular",
                    "value": "attr_book_score"
                },
                {
                    "__typename": "AttractionsSorterOption",
                    "name": "Lowest price",
                    "value": "lowest_price"
                }
            ],
            "defaultSorter": {
                "__typename": "AttractionsSorterOption",
                "name": "Our top picks",
                "value": "trending"
            },
            "filterOptions": {
                "__typename": "FilterOptions",
                "typeFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Tours",
                        "tagname": "tours",
                        "productCount": 157
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Museums, arts & culture",
                        "tagname": "museums-arts-culture",
                        "productCount": 85
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Entertainment & tickets",
                        "tagname": "entertainment-tickets",
                        "productCount": 69
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Nature & outdoor",
                        "tagname": "nature-outdoor",
                        "productCount": 69
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Food & drinks",
                        "tagname": "food-drinks",
                        "productCount": 45
                    }
                ],
                "labelFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Free cancellation",
                        "tagname": "free_cancellation",
                        "productCount": 860
                    }
                ],
                "ufiFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "Porto",
                        "tagname": "-2173088",
                        "productCount": 878
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Maia",
                        "tagname": "-2168479",
                        "productCount": 3
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Lordelo do Ouro",
                        "tagname": "-2168124",
                        "productCount": 1
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "Valbom",
                        "tagname": "-2178094",
                        "productCount": 1
                    }
                ],
                "priceFilters": [
                    {
                        "__typename": "FilterOption",
                        "name": "US$0 - US$22",
                        "tagname": "b0",
                        "productCount": 71
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$22 - US$44",
                        "tagname": "b1",
                        "productCount": 127
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$44 - US$83",
                        "tagname": "b2",
                        "productCount": 132
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$83 - US$138",
                        "tagname": "b3",
                        "productCount": 124
                    },
                    {
                        "__typename": "FilterOption",
                        "name": "US$138+",
                        "tagname": "b4",
                        "productCount": 442
                    }
                ]
            }
        }
    }
]

2025-08-25 13:06:06,399 - evaluation_logger_Attraction-86 - INFO - Function Calls: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show",
            "date": "2024-12-01"
        }
    },
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show"
        }
    }
]

2025-08-25 13:06:06,399 - evaluation_logger_Attraction-86 - INFO - Golden Function Call: 
[
    {
        "name": "Get_Availability",
        "arguments": {
            "date": "2024-12-01",
            "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show"
        }
    },
    {
        "name": "Get_Attraction_Details",
        "arguments": {
            "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show"
        }
    }
]

2025-08-25 13:06:06,399 - evaluation_logger_Attraction-86 - INFO - Start compare_single_call: 
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-01', 'slug': 'przgafs5mygz-casa-da-guitarra-porto-fado-show'}}
{'name': 'Get_Availability', 'arguments': {'date': '2024-12-01', 'slug': 'przgafs5mygz-casa-da-guitarra-porto-fado-show'}}
2025-08-25 13:06:06,399 - evaluation_logger_Attraction-86 - INFO - Rule-based compare success.
2025-08-25 13:06:06,399 - evaluation_logger_Attraction-86 - INFO - Start compare_single_call: 
{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'przgafs5mygz-casa-da-guitarra-porto-fado-show'}}
{'name': 'Get_Attraction_Details', 'arguments': {'slug': 'przgafs5mygz-casa-da-guitarra-porto-fado-show'}}
2025-08-25 13:06:06,399 - evaluation_logger_Attraction-86 - INFO - Rule-based compare success.
2025-08-25 13:06:06,399 - evaluation_logger_Attraction-86 - INFO - Success matched: [{'name': 'Get_Availability', 'arguments': {'date': '2024-12-01', 'slug': 'przgafs5mygz-casa-da-guitarra-porto-fado-show'}}, {'name': 'Get_Attraction_Details', 'arguments': {'slug': 'przgafs5mygz-casa-da-guitarra-porto-fado-show'}}]
2025-08-25 13:06:06,400 - evaluation_logger_Attraction-86 - INFO - Observations:
[
    {
        "status": true,
        "message": "Success",
        "data": [
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-01T18:00:00Z",
                "timeSlotId": "TSyH0wZ9HVal",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFlV6uBPU9R5",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 19+)"
                                },
                                "id": "TORbWMdLtMXi",
                                "offerItemId": "OIOETNrCsfht",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 19,
                                    "currency": "EUR",
                                    "publicAmount": 19
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 20.47,
                                    "currency": "USD",
                                    "publicAmount": 20.47
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "id": "TOeMYd9soMEd",
                                "offerItemId": "OIxWakINBJ4M",
                                "type": "custom",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 16,
                                    "currency": "EUR",
                                    "publicAmount": 16
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 17.24,
                                    "currency": "USD",
                                    "publicAmount": 17.24
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Grupo - Para 10 pessoas ou mais"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "id": "TOLHhrQ765aF",
                                "offerItemId": "OIccq1wULT9x",
                                "type": "custom",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 15,
                                    "currency": "EUR",
                                    "publicAmount": 15
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 16.16,
                                    "currency": "USD",
                                    "publicAmount": 16.16
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Jovem - Dos 13 aos 19 anos"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "id": "TOQzCi4ikTYp",
                                "offerItemId": "OIXyErd7ffgd",
                                "type": "custom",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 15,
                                    "currency": "EUR",
                                    "publicAmount": 15
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 16.16,
                                    "currency": "USD",
                                    "publicAmount": 16.16
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Estudante - Estudante (<26)"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 6-12)"
                                },
                                "id": "TOVqAwVnget2",
                                "offerItemId": "OIcPSZQaZ2wU",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 10,
                                    "currency": "EUR",
                                    "publicAmount": 10
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 10.78,
                                    "currency": "USD",
                                    "publicAmount": 10.78
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Child"
                            }
                        ],
                        "label": "Entrance",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "minOfferItemsPerReservation": 0
                        }
                    }
                ]
            },
            {
                "__typename": "AttractionTimeSlot",
                "fullDay": false,
                "start": "2024-12-01T19:30:00Z",
                "timeSlotId": "TSxjx5SFE9tI",
                "timeSlotOffers": [
                    {
                        "__typename": "AttractionTimeSlotOffer",
                        "benefits": {
                            "__typename": "Benefits"
                        },
                        "id": "OFlV6uBPU9R5",
                        "items": [
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 19+)"
                                },
                                "id": "TOPxmkZYQGuD",
                                "offerItemId": "OIOETNrCsfht",
                                "type": "adult",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 19,
                                    "currency": "EUR",
                                    "publicAmount": 19
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 20.47,
                                    "currency": "USD",
                                    "publicAmount": 20.47
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Adult"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "id": "TOCdD8l7F41q",
                                "offerItemId": "OIxWakINBJ4M",
                                "type": "custom",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 16,
                                    "currency": "EUR",
                                    "publicAmount": 16
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 17.24,
                                    "currency": "USD",
                                    "publicAmount": 17.24
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Grupo - Para 10 pessoas ou mais"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "id": "TOcQmpraQ9E5",
                                "offerItemId": "OIccq1wULT9x",
                                "type": "custom",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 15,
                                    "currency": "EUR",
                                    "publicAmount": 15
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 16.16,
                                    "currency": "USD",
                                    "publicAmount": 16.16
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Jovem - Dos 13 aos 19 anos"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "id": "TOgE1Q5ySsOU",
                                "offerItemId": "OIXyErd7ffgd",
                                "type": "custom",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 15,
                                    "currency": "EUR",
                                    "publicAmount": 15
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 16.16,
                                    "currency": "USD",
                                    "publicAmount": 16.16
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Estudante - Estudante (<26)"
                            },
                            {
                                "__typename": "AttractionTimeSlotOfferItem",
                                "cancellationPolicy": {
                                    "__typename": "AttractionsCancellationPolicy",
                                    "comparedTo": "start",
                                    "hasFreeCancellation": true,
                                    "isStillRefundable": true,
                                    "percentage": 100,
                                    "period": "P1D"
                                },
                                "constraint": {
                                    "__typename": "Constraint",
                                    "label": "(age 6-12)"
                                },
                                "id": "TOOsijQoanTo",
                                "offerItemId": "OIcPSZQaZ2wU",
                                "type": "children",
                                "tieredPricing": false,
                                "price": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 10,
                                    "currency": "EUR",
                                    "publicAmount": 10
                                },
                                "convertedPrice": {
                                    "__typename": "AttractionsPrice",
                                    "chargeAmount": 10.78,
                                    "currency": "USD",
                                    "publicAmount": 10.78
                                },
                                "ticketsAvailable": 10000,
                                "maxPerReservation": 15,
                                "minPerReservation": 1,
                                "label": "Child"
                            }
                        ],
                        "label": "Entrance",
                        "reservationRestrictions": {
                            "__typename": "ReservationRestrictions",
                            "adultRequiredForReservation": false,
                            "minOfferItemsPerReservation": 0
                        }
                    }
                ]
            }
        ]
    },
    {
        "status": true,
        "message": "Success",
        "data": {
            "__typename": "AttractionsProduct",
            "additionalInfo": "Please bring your ticket with you to the attraction.\n\nBe aware that operators may cancel for unforeseen reasons.\n\nYou need to be 18 years or older to book or be accompanied by an adult. ",
            "applicableTerms": [
                {
                    "__typename": "TermsConditions",
                    "policyProvider": "Booking.com"
                },
                {
                    "__typename": "TermsConditions",
                    "policyProvider": "Musement"
                }
            ],
            "cancellationPolicy": {
                "__typename": "AttractionsCancellationPolicy",
                "hasFreeCancellation": true
            },
            "description": "This one-hour concert at Casa de Guitarra will allow you to enjoy a sensational fado performance. During the show, you'll be able to listen to live music led by a female singer and an accoustic guitar player. During the performance's intermission, you'll be treated to a glass of port wine before the concert continues. ",
            "flags": [
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "bestseller",
                    "value": true,
                    "rank": 4
                },
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "bestsellerInMonth",
                    "value": true,
                    "rank": 3
                },
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "bestsellerOnWeekends",
                    "value": true,
                    "rank": 2
                },
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "bestsellerForActivities",
                    "value": true,
                    "rank": 1
                },
                {
                    "__typename": "AttractionsProductFlags",
                    "flag": "highlyRated",
                    "value": true,
                    "rank": 2
                }
            ],
            "id": "PRZgaFs5MYgZ",
            "isBookable": true,
            "labels": [
                {
                    "__typename": "AttractionsLabel",
                    "text": "Free cancellation",
                    "type": "free_cancellation"
                }
            ],
            "name": "Casa Da Guitarra Porto Fado Show",
            "notIncluded": [
                "Pickup and drop-off",
                "Transportation"
            ],
            "offers": [
                {
                    "__typename": "Offer",
                    "availabilityType": "date_time",
                    "id": "OFlV6uBPU9R5"
                }
            ],
            "onSiteRequirements": {
                "__typename": "OnSiteRequirements"
            },
            "operatedBy": "Casa da Guitarra",
            "representativePrice": {
                "__typename": "AttractionsPrice",
                "chargeAmount": 20.47,
                "currency": "USD",
                "publicAmount": 20.47
            },
            "restrictions": [
                "Please arrive at least 15 minutes before the activity starts."
            ],
            "reviews": {
                "__typename": "AttractionsGetReviewsResponse",
                "total": 1180,
                "reviews": [
                    {
                        "__typename": "AttractionsReview",
                        "id": "RShFIqVNDKOn",
                        "epochMs": 1729775179000,
                        "language": "en-us",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Roberto",
                            "cc1": "br"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSfS0JsvFCiS",
                        "epochMs": 1729773944000,
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Matjaz",
                            "cc1": "si"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RS5ipWcXSbXn",
                        "epochMs": 1729768383000,
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Véronique",
                            "cc1": "fr"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RS6Av02Q8Hvq",
                        "epochMs": 1729721138000,
                        "language": "fr",
                        "numericRating": 5,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Sophie"
                        }
                    },
                    {
                        "__typename": "AttractionsReview",
                        "id": "RSsYILgGj1DP",
                        "epochMs": 1729682124000,
                        "numericRating": 2,
                        "user": {
                            "__typename": "AttractionsReviewUser",
                            "name": "Lennart",
                            "cc1": "se"
                        }
                    }
                ]
            },
            "reviewsStats": {
                "__typename": "AttractionsProductReviewStats",
                "allReviewsCount": 536,
                "percentage": "99%",
                "combinedNumericStats": {
                    "__typename": "AttractionsProductCombinedReviewStats",
                    "average": 4.8,
                    "total": 915
                }
            },
            "shortDescription": "A chance to enjoy a fado performance and enjoy a glass of port wine",
            "slug": "przgafs5mygz-casa-da-guitarra-porto-fado-show",
            "supportedFeatures": {
                "__typename": "AttractionsProductSupportedFeatures",
                "nativeApp": true,
                "nativeAppBookProcess": true,
                "liveAvailabilityCheckSupported": true
            },
            "uniqueSellingPoints": [
                "Chance to visit Casa de Guitarra",
                "Opportunity to listen to a live fado performance",
                "A glass of port served during the intermission"
            ],
            "ufiDetails": {
                "__typename": "AttractionLocationResponse",
                "ufi": -2173088,
                "bCityName": "Porto"
            },
            "whatsIncluded": [
                "Fado concert",
                "A glass of port"
            ]
        }
    }
]

2025-08-25 13:09:20,992 - evaluation_logger_Attraction-86 - INFO - Final Response: <｜begin▁of▁sentence｜># 1. 概述

本文，我们来分享 [《精尽 Spring MVC 源码分析 —— HandlerAdapter 组件（二）之 ServletInvocableHandlerMethod》](http://svip.iocoder.cn/Spring-MVC/HandlerAdapter-2-ServletInvocableHandlerMethod/) 。

在 [《精尽 Spring MVC 源码分析 —— HandlerAdapter 组件（一）之 HandlerAdapter》](http://svip.iocoder.cn/Spring-MVC/HandlerAdapter-1-HandlerAdapter) 中，我们已经看到，ServletInvocableHandlerMethod 是 InvocableHandlerMethod 的子类，并实现 InitializingBean 接口。主要增加了**调用结果处理**的功能。代码如下：

```java
// ServletInvocableHandlerMethod.java

public class ServletInvocableHandlerMethod extends InvocableHandlerMethod {

    /**
     * 结果处理器
     */
	private HandlerMethodReturnValueHandlerComposite returnValueHandlers;

	public ServletInvocableHandlerMethod(Object handler, Method method) {
		super(handler, method);
	}

	public ServletInvocableHandlerMethod(HandlerMethod handlerMethod) {
		super(handlerMethod);
	}

	public void setHandlerMethodReturnValueHandlers(HandlerMethodReturnValueHandlerComposite returnValueHandlers) {
		this.returnValueHandlers = returnValueHandlers;
	}

    /**
     * 执行 Handler 方法，并处理结果
     */
	public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,
			Object... providedArgs) throws Exception {
		// 执行 Handler 方法
		Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);
		// 设置 response 是否已经处理
		setResponseStatus(webRequest);

		// 如果 response 已经处理，则返回
		if (returnValue == null) {
			if (isRequestNotModified(webRequest) || getResponseStatus() != null || mavContainer.isRequestHandled()) {
				disableContentCachingIfNecessary(webRequest);
				mavContainer.setRequestHandled(true);
				return;
			}
		}
		// 如果 response 已经处理，则返回
		else if (StringUtils.hasText(getResponseStatusReason())) {
			mavContainer.setRequestHandled(true);
			return;
		}

		// 标记 response 未处理
		mavContainer.setRequestHandled(false);
		Assert.state(this.returnValueHandlers != null, "No return value handlers");
		try {
		    // 处理结果
			this.returnValueHandlers.handleReturnValue(
					returnValue, getReturnValueType(returnValue), mavContainer, webRequest);
		} catch (Exception ex) {
			if (logger.isTraceEnabled()) {
				logger.trace(formatErrorForReturnValue(returnValue), ex);
			}
			throw ex;
		}
	}

	/**
	 * Set the response status according to the {@link ResponseStatus} annotation.
	 */
	private void setResponseStatus(ServletWebRequest webRequest) throws IOException {
	    // 获得状态码
		HttpStatus status = getResponseStatus();
		if (status == null) {
			return;
		}

		// 设置状态码
		HttpServletResponse response = webRequest.getResponse();
		if (response != null) {
			String reason = getResponseStatusReason();
			if (StringUtils.hasText(reason)) {
				response.sendError(status.value(), reason);
			} else {
				response.setStatus(status.value());
			}
		}

		// To be picked up by the RedirectView
		webRequest.getRequest().setAttribute(View.RESPONSE_STATUS_ATTRIBUTE, status);
	}

	private boolean isRequestNotModified(ServletWebRequest webRequest) {
		return webRequest.isNotModified();
	}

	private void disableContentCachingIfNecessary(ServletWebRequest webRequest) {
		if (isRequestNotModified(webRequest)) {
			HttpServletResponse response = webRequest.getNativeResponse(HttpServletResponse.class);
			Assert.notNull(response, "No HttpServletResponse");
			if (StringUtils.startsWithIgnoreCase(response.getContentType(), "application/json")) {
				webRequest.disableCaching();
			}
		}
	}

}
```

# 2. InvocableHandlerMethod

`org.springframework.web.method.support.InvocableHandlerMethod` ，继承 HandlerMethod 类，可调用的 HandlerMethod 封装类。代码如下：

```java
// InvocableHandlerMethod.java

public class InvocableHandlerMethod extends HandlerMethod {

    /**
     * 参数解析器（容器）
     */
	private WebDataBinderFactory dataBinderFactory;
	/**
	 * 参数解析器（数组）
	 */
	private HandlerMethodArgumentResolverComposite resolvers = new HandlerMethodArgumentResolverComposite();
	/**
	 * 参数名发现器
	 */
	private ParameterNameDiscoverer parameterNameDiscoverer = new DefaultParameterNameDiscoverer();

	/**
	 * Create an instance from a {@code HandlerMethod}.
	 */
	public InvocableHandlerMethod(HandlerMethod handlerMethod) {
		super(handlerMethod);
	}

	/**
	 * Create an instance from a bean instance and a method.
	 */
	public InvocableHandlerMethod(Object bean, Method method) {
		super(bean, method);
	}

	/**
	 * Construct a new handler method with the given bean instance, method name and parameters.
	 * @param bean the object bean
	 * @param methodName the method name
	 * @param parameterTypes the method parameter types
	 * @throws NoSuchMethodException when the method cannot be found
	 */
	public InvocableHandlerMethod(Object bean, String methodName, Class<?>... parameterTypes) throws NoSuchMethodException {
		super(bean, methodName, parameterTypes);
	}

	/**
	 * Set the {@link WebDataBinderFactory} to be used for argument resolution.
	 */
	public void setDataBinderFactory(WebDataBinderFactory dataBinderFactory) {
		this.dataBinderFactory = dataBinderFactory;
	}

	/**
	 * Set the {@link HandlerMethodArgumentResolver}s to use to resolve method arguments.
	 */
	public void setHandlerMethodArgumentResolvers(HandlerMethodArgumentResolverComposite argumentResolvers) {
		this.resolvers = argumentResolvers;
	}

	/**
	 * Set the {@link ParameterNameDiscoverer} for resolving parameter names when needed
	 * (e.g. default request attribute name).
	 */
	public void setParameterNameDiscoverer(ParameterNameDiscoverer parameterNameDiscoverer) {
		this.parameterNameDiscoverer = parameterNameDiscoverer;
	}

	/**
	 * Invoke the method after resolving its argument values in the context of the given request.
	 * <p>Argument values are commonly resolved through {@link HandlerMethodArgumentResolver}s.
	 * The {@code providedArgs} parameter may contain argument values that are statically
	 * provided by the caller (not through resolvers).
	 * @param request the current request
	 * @param mavContainer the ModelAndViewContainer for this request
	 * @param providedArgs "given" arguments matched by type, not resolved
	 * @return the raw value returned by the invoked method
	 * @throws Exception raised if no suitable argument resolver can be found,
	 * or if the method raised an exception
	 */
	public Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer,
			Object... providedArgs) throws Exception {
		// <1> 解析参数
		Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);
		if (logger.isTraceEnabled()) {
			logger.trace("Arguments: " + Arrays.toString(args));
		}
		// <2> 执行方法
		Object returnValue = doInvoke(args);
		if (logger.isTraceEnabled()) {
			logger.trace("Returned value: " + returnValue);
		}
		return returnValue;
	}

	/**
	 * Get the method argument values for the current request.
	 */
	protected Object[] getMethodArgumentValues(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer,
			Object... providedArgs) throws Exception {
		// 获得方法参数
		MethodParameter[] parameters = getMethodParameters();
		// 参数数组
		Object[] args = new Object[parameters.length];
		// 遍历参数，解析参数
		for (int i = 0; i < parameters.length; i++) {
			MethodParameter parameter = parameters[i];
			parameter.initParameterNameDiscovery(this.parameterNameDiscoverer);
			// 获得参数
			args[i] = resolveProvidedArgument(parameter, providedArgs);
			if (args[i] != null) {
				continue;
			}
			// 使用 resolvers 解析参数
			if (this.resolvers.supportsParameter(parameter)) {
				try {
				    // 解析参数
					args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory);
					continue;
				} catch (Exception ex) {
					if (logger.isDebugEnabled()) {
						logger.debug(getArgumentResolutionErrorMessage("Failed to resolve", i), ex);
					}
					throw ex;
				}
			}
			// 如果解析失败，则抛出异常
			if (args[i] == null) {
				throw new IllegalStateException("Could not resolve method parameter at index " + parameter.getParameterIndex() + " in " + parameter.getExecutable().toGenericString() + ": " + getArgumentResolutionErrorMessage("No suitable resolver for", i));
			}
		}
		return args;
	}

	/**
	 * Attempt to resolve a method parameter from the list of provided argument values.
	 */
	@Nullable
	private Object resolveProvidedArgument(MethodParameter parameter, Object... providedArgs) {
		if (providedArgs == null) {
			return null;
		}
		// 遍历 providedArgs 数组，逐个匹配参数
		for (Object providedArg : providedArgs) {
			if (parameter.getParameterType().isInstance(providedArg)) {
				return providedArg;
			}
		}
		return null;
	}

	/**
	 * Invoke the handler method with the given argument values.
	 */
	protected Object doInvoke(Object... args) throws Exception {
		ReflectionUtils.makeAccessible(getBridgedMethod());
		try {
		    // 执行方法
			return getBridgedMethod().invoke(getBean(), args);
		} catch (IllegalArgumentException ex) {
			assertTargetBean(getBridgedMethod(), getBean(), args);
			String text = (ex.getMessage() != null ? ex.getMessage() : "Illegal argument");
			throw new IllegalStateException(getInvocationErrorMessage(text, args), ex);
		} catch (InvocationTargetException ex) {
			// Unwrap for HandlerExceptionResolvers ...
			Throwable targetException = ex.getTargetException();
			if (targetException instanceof RuntimeException) {
				throw (RuntimeException) targetException;
			} else if (targetException instanceof Error) {
				throw (Error) targetException;
			} else if (targetException instanceof Exception) {
				throw (Exception) targetException;
			} else {
				throw new IllegalStateException(getInvocationErrorMessage("Failed to invoke handler method", args), targetException);
			}
		}
	}

}
```

- 代码虽然比较长，但是核心是 `#invokeForRequest(NativeWebRequest request, ModelAndViewContainer mavContainer, Object... providedArgs)` 方法。它有两个步骤：`<1>` 处，解析参数；`<2>` 处，执行方法。

- 关于参数解析，即 `#getMethodArgumentValues(NativeWebRequest request, ModelAndViewContainer mavContainer, Object... providedArgs)` 方法，代码如下：

  ```java
  // InvocableHandlerMethod.java
  
  protected Object[] getMethodArgumentValues(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer,
          Object... providedArgs) throws Exception {
      // 获得方法参数
      MethodParameter[] parameters = getMethodParameters();
      // 参数数组
      Object[] args = new Object[parameters.length];
      // 遍历参数，解析参数
      for (int i = 0; i < parameters.length; i++) {
          MethodParameter parameter = parameters[i];
          parameter.initParameterNameDiscovery(this.parameterNameDiscoverer);
          // 获得参数
          args[i] = resolveProvidedArgument(parameter, providedArgs);
          if (args[i] != null) {
              continue;
          }
          // 使用 resolvers 解析参数
          if (this.resolvers.supportsParameter(parameter)) {
              try {
                  // 解析参数
                  args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory);
                  continue;
              } catch (Exception ex) {
                  if (logger.isDebugEnabled()) {
                      logger.debug(getArgumentResolutionErrorMessage("Failed to resolve", i), ex);
                  }
                  throw ex;
              }
          }
          // 如果解析失败，则抛出异常
          if (args[i] == null) {
              throw new IllegalStateException("Could not resolve method parameter at index " + parameter.getParameterIndex() + " in " + parameter.getExecutable().toGenericString() + ": " + getArgumentResolutionErrorMessage("No suitable resolver for", i));
          }
      }
      return args;
  }
  ```

  - 遍历方法参数，逐个解析。
  - 首先，使用 `#resolveProvidedArgument(MethodParameter parameter, Object... providedArgs)` 方法，从 `providedArgs` 中获得参数。一般情况下，`providedArgs` 是空的。
  - 然后，使用 `resolvers` 解析参数。关于 `resolvers` 的解析，我们在 [《精尽 Spring MVC 源码分析 —— HandlerAdapter 组件（三）之 HandlerMethodArgumentResolver》](http://svip.iocoder.cn/Spring-MVC/HandlerAdapter-3-HandlerMethodArgumentResolver) 中，详细解析。

- 关于方法执行，即 `#doInvoke(Object... args)` 方法，代码如下：

  ```java
  // InvocableHandlerMethod.java
  
  protected Object doInvoke(Object... args) throws Exception {
      ReflectionUtils.makeAccessible(getBridgedMethod());
      try {
          // 执行方法
          return getBridgedMethod().invoke(getBean(), args);
      } catch (IllegalArgumentException ex) {
          assertTargetBean(getBridgedMethod(), getBean(), args);
          String text = (ex.getMessage() != null ? ex.getMessage() : "Illegal argument");
          throw new IllegalStateException(getInvocationErrorMessage(text, args), ex);
      } catch (InvocationTargetException ex) {
          // Unwrap for HandlerExceptionResolvers ...
          Throwable targetException = ex.getTargetException();
          if (targetException instanceof RuntimeException) {
              throw (RuntimeException) targetException;
          } else if (targetException instanceof Error) {
              throw (Error) targetException;
          } else if (targetException instanceof Exception) {
              throw (Exception) targetException;
          } else {
              throw new IllegalStateException(getInvocationErrorMessage("Failed to invoke handler method", args), targetException);
          }
      }
  }
  ```

  - 通过反射，调用方法。

# 3. HandlerMethodReturnValueHandler

`org.springframework.web.method.support.HandlerMethodReturnValueHandler` ，HandlerMethod 返回值处理器接口。代码如下：

```java
// HandlerMethodReturnValueHandler.java

public interface HandlerMethodReturnValueHandler {

	/**
	 * 是否支持该类型
	 */
	boolean supportsReturnType(MethodParameter returnType);

	/**
	 * 处理返回值
	 *
	 * @param returnValue 返回值
	 * @param returnType 返回类型
	 * @param mavContainer ModelAndViewContainer 对象
	 * @param webRequest NativeWebRequest 对象
	 * @throws Exception 处理失败时
	 */
	void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,
			ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception;

}
```

## 3.1 HandlerMethodReturnValueHandlerComposite

`org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite` ，实现 HandlerMethodReturnValueHandler 接口，复合的 HandlerMethodReturnValueHandler 实现类。

### 3.1.1 构造方法

```java
// HandlerMethodReturnValueHandlerComposite.java

/**
 * HandlerMethodReturnValueHandler 数组
 */
private final List<HandlerMethodReturnValueHandler> returnValueHandlers = new ArrayList<>();

public HandlerMethodReturnValueHandlerComposite addHandlers(@Nullable List<? extends HandlerMethodReturnValueHandler> handlers) {
	if (handlers != null) {
		this.returnValueHandlers.addAll(handlers);
	}
	return this;
}
```

### 3.1.2 supportsReturnType

```java
// HandlerMethodReturnValueHandlerComposite.java

@Override
public boolean supportsReturnType(MethodParameter returnType) {
	// 遍历 HandlerMethodReturnValueHandler 数组，判断是否支持
	return getReturnValueHandler(returnType) != null;
}

/**
 * Return a handler for the given return type.
 * @param returnType the return type
 * @return a handler, or {@code null} if none found
 */
@Nullable
private HandlerMethodReturnValueHandler getReturnValueHandler(MethodParameter returnType) {
	// 遍历 HandlerMethodReturnValueHandler 数组，判断是否支持
	for (HandlerMethodReturnValueHandler handler : this.returnValueHandlers) {
		if (handler.supportsReturnType(returnType)) {
			return handler;
		}
	}
	return null;
}
```

### 3.1.3 handleReturnValue

```java
// HandlerMethodReturnValueHandlerComposite.java

@Override
public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,
		ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {
	// 获得 HandlerMethodReturnValueHandler 对象
	HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType);
	// 如果获取不到，则抛出 IllegalArgumentException 异常
	if (handler == null) {
		throw new IllegalArgumentException("Unknown return value type: " + returnType.getParameterType().getName());
	}
	// 处理返回值
	handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);
}

@Nullable
private HandlerMethodReturnValueHandler selectHandler(@Nullable Object value, MethodParameter returnType) {
	// 判断是否为异步返回值
	boolean isAsyncValue = isAsyncReturnValue(value, returnType);
	// 遍历 HandlerMethodReturnValueHandler 数组，判断是否支持
	for (HandlerMethodReturnValueHandler handler : this.returnValueHandlers) {
		if (isAsyncValue && !(handler instanceof AsyncHandlerMethodReturnValueHandler)) {
			continue;
		}
		if (handler.supp

2025-08-25 13:09:25,954 - evaluation_logger_Attraction-86 - INFO - Complete Result: {'score': 0, 'reason': "The response does not address any part of the user's query about ticket availability or detailed information about a tourist attraction in Porto."}
2025-08-25 13:09:32,594 - evaluation_logger_Attraction-86 - INFO - Correct Result: {'score': 0, 'reason': 'All information in the response is incorrect.'}
2025-08-25 13:09:32,594 - evaluation_logger_Attraction-86 - INFO - Message: Success.
2025-08-25 13:09:32,594 - evaluation_logger_Attraction-86 - INFO - Success turn num = 3
2025-08-25 13:09:32,594 - evaluation_logger_Attraction-86 - INFO - ----------------------------------------------------------------------------------------------------
